<!-- views/contractors.ejs -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="alternate icon" type="image/png" href="../public/assests/logo.png">
  <title>مقاولين لتجهيز وإنشاء المزارع والمنازل في سوريا – مزرعتي</title>
<meta name="description" content="ابحث عن مقاولين موثوقين لتجهيز وإنشاء المزارع والمنازل في سوريا: نجار باطون، معمرجي حجر وبلوك، تمديدات صحية وكهربائية، ديكورات، تدفئة وتبريد، ألمنيوم، مسابح، مسابح، مظلات وخدمات أخرى لتجهيز المزارع والمنازل.">

  <link rel="stylesheet" href="/Public/styles/contractorsstyle.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>

  <style>
   /* ==== VIP hero ==== */
.vip-hero-slide{position:relative;min-height:360px;border-radius:16px;overflow:hidden;background:#f6faf6;}
@media (min-width:1024px){.vip-hero-slide{min-height:520px;}}
.vip-hero-img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(.85);}
.vip-hero-overlay{position:absolute;inset:0;background:linear-gradient(90deg,rgba(0,0,0,.35),rgba(0,0,0,.15) 40%,rgba(0,0,0,0) 70%);}
.vip-hero-body{position:absolute;inset-inline:1.2rem;inset-block-end:1.1rem;color:#fff;display:grid;gap:.35rem;}
.vip-hero-title{font-size:clamp(20px,3vw,34px);margin:.25rem 0 0;}
.vip-hero-meta{opacity:.95;font-size:clamp(14px,1.5vw,16px);}
.vip-hero-cta{margin-top:.6rem;display:inline-block;padding:.5rem .9rem;border-radius:10px;background:#fff;color:#0f172a;text-decoration:none;font-weight:600;width:150px;text-align:center;}
.vip-badge{position:absolute;top:12px;inset-inline-start:12px;background:#0f172a;color:#fff;border-radius:999px;font-size:.8rem;padding:.18rem .6rem;z-index:2}
/* ==== بطاقات المقاولين (تصميم أنظف ومتناسق) ==== */

/* سلايد السويبر يأخذ ارتفاع الكرت */
.contractor-swiper .swiper-slide{
  height:auto;
}

/* الكرت الأساسي */
.contractor-card{
  position:relative;
  display:flex;
  flex-direction:column;
  gap:10px;
  padding:14px 12px 12px;
  padding-top:42px;
  border-radius:18px;
  border:1px solid #e5e7eb;
  background:linear-gradient(135deg,#ffffff,#f9fafb);
  box-shadow:0 4px 14px rgba(15,23,42,.06);
  height:100%;
  min-height:240px;
  overflow:hidden;
  transition:
    transform .16s ease,
    box-shadow .16s ease,
    border-color .16s ease,
    background .16s ease;
}

.contractor-card:hover{
  transform:translateY(-2px);
  box-shadow:0 10px 24px rgba(15,23,42,.1);
  border-color:#d1d5db;
  background:linear-gradient(135deg,#ffffff,#f3f4f6);
}

/* شارة الخطة (VIP / Premium) */
.tier-badge{
  position:absolute;
  top:10px;
  inset-inline-end:10px;
  background:#0f172a;
  color:#fff;
  border-radius:999px;
  font-size:.78rem;
  padding:.18rem .7rem;
  line-height:1;
  font-weight:700;
  letter-spacing:.3px;
}

/* السطر العلوي: صورة + معلومات */
.card-row{
  display:flex;
  align-items:center;
  gap:12px;
}

.avatar{
  width:68px;
  height:68px;
  border-radius:999px;
  overflow:hidden;
  border:3px solid #e5e7eb;
  flex-shrink:0;
}

.avatar img{
  width:100%;
  height:100%;
  object-fit:cover;
}

.info-stack{
  display:flex;
  flex-direction:column;
  gap:3px;
  min-width:0;
}

.name{
  margin:0;
  font-weight:800;
  font-size:1.02rem;
  color:#0f172a;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.specialization,
.region{
  margin:0;
  color:#64748b;
  font-size:.88rem;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* التقييم */
.rating{
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:.35rem;
  font-weight:700;
  color:#111827;
  font-size:.9rem;
}

.rating span:last-child{
  font-size:.95rem;
}

.rating small{
  color:#6b7280;
  font-weight:600;
}

/* زر صفحة المقاول */
.card-cta{
  margin-top:auto;           /* يبقي الزر دائمًا في أسفل الكرت */
  width:100%;
  text-align:center;
  border:1px solid #0f172a;
  border-radius:12px;
  padding:.5rem .85rem;
  text-decoration:none;
  color:#0f172a;
  font-weight:700;
  display:inline-block;
  font-size:.9rem;
  background:#ffffff;
  transition:
    background .14s ease,
    color .14s ease,
    border-color .14s ease;
}

.card-cta:hover{
  background:#0f172a;
  color:#ffffff;
  border-color:#0f172a;
}

/* ===== موبايل: الكرت يصبح عمودي ومركّز في المنتصف ===== */
@media (max-width:640px){
  .contractor-card{
    padding:12px 10px 10px;
    border-radius:14px;
    min-height:210px;
    box-shadow:0 3px 12px rgba(15,23,42,.08);
  }

  /* نخلي الصورة فوق والبيانات تحتها، كله في المنتصف */
  .card-row{
    flex-direction:column;
    align-items:center;
    text-align:center;
    gap:8px;
  }

  .avatar{
    width:60px;
    height:60px;
    border-width:2px;
  }

  .info-stack{
    align-items:center;
  }

  .name{
    font-size:.95rem;
    white-space:nowrap;
  }

  .specialization,
  .region{
    font-size:.8rem;
    white-space:normal;       /* يسمح بسطرين لو النص طويل */
    text-overflow:clip;
  }

  .rating{
    justify-content:center;
    font-size:.86rem;
    gap:.3rem;
  }

  .rating small{
    font-size:.8rem;
  }

  .card-cta{
    font-size:.86rem;
    padding:.42rem .7rem;
    border-radius:10px;
    margin-top:auto;          /* يبقى في أسفل الكرت حتى في الموبايل */
  }

  .tier-badge{
    font-size:.72rem;
    padding:.16rem .5rem;
    top:8px;
    inset-inline-end:8px;
  }
}

/* إخفاء عناصر الفلاتر على الهاتف فقط */
@media (max-width:640px){
  #filters .filter-dropdown > summary{display:none !important;}
  #filters .filters-form button[type="submit"]{display:none !important;}
  #filters #toggle-more{display:none !important;}
  #filters .filters-form{padding-top:0 !important;}
  #filters .filters-grid{margin-top:0 !important;}
}

/* ===== أسلوب الحارس ===== */
#contractor-gate{position:fixed;inset:0;display:none;z-index:1100;}
#contractor-gate[aria-hidden="false"]{display:block;}
#contractor-gate .gate-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45);backdrop-filter:saturate(120%) blur(2px);}
#contractor-gate .gate-card{
  position:relative;margin:6vh auto 0;max-width:560px;background:#fff;color:#0f172a;
  border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.22);animation:gatePop .18s ease-out;
}
#contractor-gate .gate-close{
  position:absolute;inset-inline-end:8px;top:6px;width:36px;height:36px;border:none;border-radius:10px;
  background:#f1f5f9;cursor:pointer;font-size:20px;line-height:1;
}
#contractor-gate h3{margin:.25rem 0 .35rem;font-size:1.25rem;font-weight:900;}
#contractor-gate .gate-note{margin:0 0 .6rem;color:#64748b;font-size:.95rem;}
#contractor-gate .gate-fields{display:grid;gap:10px;margin:.5rem 0 .8rem;}
#contractor-gate .gate-label{font-weight:700;font-size:.9rem;}
#contractor-gate .gate-input{
  width:100%;height:2.6rem;border:1px solid #e2e8f0;border-radius:12px;
  padding:.55rem .75rem;font-size:1rem;
}
#contractor-gate .gate-actions{display:flex;gap:8px;align-items:center;justify-content:flex-start;}
#contractor-gate .gate-btn{
  border:1px solid #e2e8f0;background:#fff;color:#0f172a;border-radius:12px;
  padding:.6rem .9rem;font-weight:800;cursor:pointer;
}
#contractor-gate .gate-primary{background:#0f172a;color:#fff;border-color:#0f172a;}
@keyframes gatePop{from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)}}
@media (max-width:640px){
  #contractor-gate .gate-card{margin:10vh 12px 0;padding:14px;}
  #contractor-gate h3{font-size:1.1rem;}
  #contractor-gate .gate-note{font-size:.9rem;}
  #contractor-gate .gate-input{height:2.4rem;font-size:.95rem;}
  #contractor-gate .gate-btn{padding:.5rem .8rem;font-size:.95rem;}
}
/* إخفاء نقاط السويبر في هذه الصفحة */
.contractor-swiper .swiper-pagination,
.rent-swiper .swiper-pagination,
.sale-swiper .swiper-pagination,
.vip-swiper .swiper-pagination{
  display: none !important;
}
.contractor-swiper .swiper-wrapper{
  align-items:stretch;
}

  </style>
</head>
<body>

  <%- include('partials/navbar', { isAuth: (typeof isAuth!=='undefined'?isAuth:false), user: (typeof user!=='undefined'?user:null), active: 'contractors' }) %>

 <%- include('partials/whatsapp') %>
<%- include('partials/promo-swiper', { bannersDoc }) %>
  <!-- ===== بوابة اختيار المقاولين (تخصص + محافظة) ===== -->
<div id="contractor-gate" aria-hidden="true">
  <div class="gate-backdrop" data-close="1"></div>

  <div class="gate-card" role="dialog" aria-modal="true" aria-labelledby="con-gate-title">
    <button class="gate-close" type="button" aria-label="إغلاق" data-close="1">×</button>

    <h3 id="con-gate-title">ابحث عن مقاول حسب التخصص والمحافظة</h3>
    <p class="gate-note">اختر التخصص ثم المحافظة لنُظهر نتائج أدق.</p>

    <div class="gate-fields">
     <label class="gate-label" for="gate-spec">التخصص</label>
<select id="gate-spec" class="gate-input">
  <option value="">اختر التخصص…</option>
  <option>نجار باطون</option>
  <option>معمرجي حجر وبلوك</option>
  <option>مليس</option>
  <option>مبلط</option>
  <option>فني ممدد صحية</option>
  <option>فني مدد كهرباء</option>
  <option>أنابيب ري زراعي</option>
  <option>فني جبس بورد وديكورات</option>
  <option>دهان</option>
  <option>حداد افرنجي</option>
  <option>فني تبريد وتكييف</option>
  <option>فني تدفئة مركزية وطاقة مياه شمسية</option>
  <option>نجار ألمنيوم</option>
  <option>فني تصميم وتركيب بلور</option>
  <option>نجار خشب عربي</option>
  <option>نجار خشب افرنجي</option>
  <option>فني تصميم وإنشاء مسابح</option>
  <option>فني مشتل نباتات وأشجار</option>
  <option>فني شوادر ومظلات</option>
  <option>تصميم ديكورات طين</option>
  <option>مقاول / متعهد إنشاءات</option>
</select>

      <label class="gate-label" for="gate-city">المحافظة</label>
      <select id="gate-city" class="gate-input">
        <option value="">اختر المحافظة…</option>
        <option>دمشق</option><option>ريف دمشق</option><option>حلب</option><option>حمص</option>
        <option>حماة</option><option>اللاذقية</option><option>طرطوس</option><option>إدلب</option>
        <option>دير الزور</option><option>الحسكة</option><option>الرقة</option>
        <option>درعا</option><option>القنيطرة</option><option>السويداء</option>
      </select>
    </div>

    <div class="gate-actions">
      <button id="gate-apply" class="gate-btn gate-primary" type="button">اعرض النتائج</button>
      <button class="gate-btn" type="button" data-close="1">تخطّي الآن</button>
    </div>
  </div>
</div>

  <!-- فلاتر بسيطة -->
  <section id="filters" class="section filters" aria-labelledby="filters-title">
    <div class="container">
      <details class="filter-dropdown" open>
        <summary id="filters-title">فلترة المقاولين</summary>
   <form id="contractor-filters" class="filters-form" action="#results" method="get" novalidate>
  <div class="filters-grid" style="display:grid;gap:.8rem;grid-template-columns:repeat(12,1fr)">
    <!-- التخصص: قائمة منسدلة -->
    <div class="field" style="grid-column:span 6">
      <label class="label" for="specialization">التخصص</label>
     <select id="specialization" name="specialization" class="input">
  <option value="">اختر التخصص…</option>
  <option>نجار باطون</option>
  <option>معمرجي حجر وبلوك</option>
  <option>مليس</option>
  <option>مبلط</option>
  <option>فني ممدد صحية</option>
  <option>فني مدد كهرباء</option>
  <option>أنابيب ري زراعي</option>
  <option>فني جبس بورد وديكورات</option>
  <option>دهان</option>
  <option>حداد افرنجي</option>
  <option>فني تبريد وتكييف</option>
  <option>فني تدفئة مركزية وطاقة مياه شمسية</option>
  <option>نجار ألمنيوم</option>
  <option>فني تصميم وتركيب بلور</option>
  <option>نجار خشب عربي</option>
  <option>نجار خشب افرنجي</option>
  <option>فني تصميم وإنشاء مسابح</option>
  <option>فني مشتل نباتات وأشجار</option>
  <option>فني شوادر ومظلات</option>
  <option>تصميم ديكورات طين</option>
  <option>مقاول / متعهد إنشاءات</option>
</select>
    </div>

    <!-- المحافظة: قائمة منسدلة -->
    <div class="field" style="grid-column:span 6">
      <label class="label" for="city">المحافظة</label>
      <select id="city" name="city" class="input">
        <option value="">اختر المحافظة…</option>
        <option>دمشق</option>
        <option>ريف دمشق</option>
        <option>حلب</option>
        <option>حمص</option>
        <option>حماة</option>
        <option>اللاذقية</option>
        <option>طرطوس</option>
        <option>إدلب</option>
        <option>دير الزور</option>
        <option>الحسكة</option>
        <option>الرقة</option>
        <option>درعا</option>
        <option>القنيطرة</option>
        <option>السويداء</option>
      </select>
    </div>

    <div class="field" style="grid-column:span 12;display:flex;justify-content:flex-end">
      <button class="btn btn-primary" type="submit" style="background:#0f172a;color:#fff;border:none;border-radius:10px;padding:.55rem 1rem">تطبيق</button>
    </div>
  </div>
</form>

      </details>
    </div>
  </section>
<!-- VIP -->
  <section id="vip-contractors" class="section gallery" aria-labelledby="vip-title" hidden>
    <div class="container">
      <header class="section-header">
        <h2 id="vip-title">المقاولون المتاحون</h2>
        
      </header>

      <div class="swiper vip-swiper" dir="rtl" aria-label="مقاولون VIP">
        <div class="swiper-wrapper" id="vipContractorsWrapper"></div>
        <div class="swiper-button-prev" aria-label="السابق"></div>
        <div class="swiper-button-next" aria-label="التالي"></div>
        <div class="swiper-pagination"></div>
      </div>
    </div>
  </section>

  <!-- النتائج (سويبر البطاقات بالشكل المطلوب) -->
  <section id="results" class="section list" aria-labelledby="list-title">
    <div class="container">
      <header class="section-header">
        
      </header>

      <div class="swiper contractor-swiper" dir="rtl">
        <div class="swiper-wrapper" id="contractorsWrapper">
        <% if (Array.isArray(contractors) && contractors.length) { contractors.forEach(function(c){ 
    const services = Array.isArray(c.services) ? c.services.join('، ') : (c.services || '');

    // 1️⃣ نأخذ الصورة الخام
    const rawAvatar = (c.avatar || '').toString().trim();
  const rawWork   = (Array.isArray(c.photos) && c.photos[0]) ? String(c.photos[0]).trim() : '';

  // ✅ avatar: اسمح بـ data: فقط إذا كانت قصيرة (صغيرة) — حتى ما تقتل الأداء
  const avatarOK = rawAvatar && (
    !/^data:/i.test(rawAvatar) || rawAvatar.length < 500000   // ~ 35KB تقريباً
  );

  // ✅ لا نسمح base64 لصور الأعمال أبداً
  const workOK = rawWork && !/^data:/i.test(rawWork);

  const chosen = avatarOK ? rawAvatar : (workOK ? rawWork : '');

  const img =
    (chosen && chosen.includes('res.cloudinary.com') && chosen.includes('/upload/'))
      ? chosen.replace('/upload/','/upload/f_auto,q_auto,w_160,h_160,c_fill,g_face/')
      : (chosen || '/Public/assets/contractors/default.jpg');

    const region = c.region || '';
    const tier = c.userTier || c.subscriptionTier || 'Basic';
    if (tier === 'VIP') { return; }
%>

              <div class="swiper-slide">
                <article class="contractor-card">
                  <% if (String(tier||'Basic').toLowerCase() !== 'basic') { %>
  <span class="tier-badge"><%= tier %></span>
<% } %>

                  <div class="card-row">
                    <div class="avatar"><img src="<%= img %>" alt="صورة <%= c.name || 'مقاول' %>"
     loading="lazy" decoding="async" fetchpriority="low"
     onerror="this.onerror=null;this.src='/Public/assets/contractors/default.jpg'">
</div>
                    <div class="info-stack">
                      <h3 class="name"><%= c.name || '—' %></h3>
                      <p class="specialization"><%= services || '—' %></p>
                      <p class="region"><%= region || '—' %></p>
                    </div>
                  </div>
                  <div class="rating"><small>(<%= c.ratingCount || 0 %>)</small><span><%= Number(c.ratingAvg||0).toFixed(2) %></span><span>⭐</span></div>
                  <a class="card-cta" href="/contractor/<%= c._id %>">صفحة المقاول</a>
                </article>
              </div>
          <% }) } %>
        </div>
        <div class="swiper-button-prev" aria-label="السابق"></div>
        <div class="swiper-button-next" aria-label="التالي"></div>
        <div class="swiper-pagination"></div>
      </div>
    </div>
  </section>

    <%- include('partials/promo', { promoBottom }) %>
 <%- include('partials/footer') %>

<script defer src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

  <script>
    const $  = (s,ctx=document)=>ctx.querySelector(s);
    const $$ = (s,ctx=document)=>Array.from(ctx.querySelectorAll(s));
    const htmlEscape = (s='') => String(s).replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
    function tweakCloudinary(url){
  try{
    const u = new URL(url);
    // فقط Cloudinary
    if (u.hostname.includes('res.cloudinary.com') && u.pathname.includes('/upload/')){
      // صورة صغيرة مناسبة للكرت (الدائرة 68px)
      u.pathname = u.pathname.replace(
        '/upload/',
        '/upload/f_auto,q_auto,w_160,h_160,c_fill,g_face/'
      );
      return u.toString();
    }
  } catch(_) {}
  return url;
}

    function assetPath(u){
      u = (u||'').toString().trim();
     if (/^data:image\//i.test(u)) {
    const MAX_DATA = 900000; // ~0.9MB (غيّرها إذا تحب)
    return u.length <= MAX_DATA ? u : '/public/assets/contractors/default.jpg';
  }
if (/^https?:\/\//i.test(u)) return tweakCloudinary(u);

      u = u.replace(/\\/g,'/').replace(/^\/?Public\//,'/public/').replace(/\/assests\//gi,'/assets/');
      if (u.startsWith('/uploads/') || u.startsWith('/public/')) return u;
      if (u.startsWith('/assets/')) return '/public'+u;
      if (u.startsWith('/')) return '/public'+u;
      return '/uploads/'+u;
    }
async function compressDataUrlToBlobUrl(dataUrl, size = 160, quality = 0.72){
  // يقبل data:image فقط
  if (!/^data:image\//i.test(dataUrl)) return dataUrl;

  // تحميل الصورة
  const img = new Image();
  img.decoding = 'async';

  const loaded = new Promise((resolve, reject) => {
    img.onload = () => resolve();
    img.onerror = reject;
  });
  img.src = dataUrl;
  await loaded;

  // Canvas مربع
  const canvas = document.createElement('canvas');
  canvas.width = size;
  canvas.height = size;
  const ctx = canvas.getContext('2d', { alpha: false });

  // قصّ مركزي cover
  const iw = img.naturalWidth || img.width;
  const ih = img.naturalHeight || img.height;
  const s = Math.min(iw, ih);
  const sx = Math.floor((iw - s) / 2);
  const sy = Math.floor((ih - s) / 2);

  ctx.drawImage(img, sx, sy, s, s, 0, 0, size, size);

  const blob = await new Promise(resolve =>
    canvas.toBlob(resolve, 'image/jpeg', quality)
  );
  if (!blob) return dataUrl;

  return URL.createObjectURL(blob);
}

// طبّق الضغط فقط على الصور الظاهرة (مثلاً أول 12 صورة)
async function compressVisibleAvatars(max = 12){
  const imgs = Array.from(document.querySelectorAll('.contractor-card .avatar img'))
    .slice(0, max);

  for (const el of imgs){
    const src = el.getAttribute('src') || '';
    if (/^data:image\//i.test(src)) {
      try{
        const blobUrl = await compressDataUrlToBlobUrl(src, 160, 0.72);
        el.src = blobUrl;
      }catch(_){}
    }
  }
}

    const form       = $('#contractor-filters');
    const listWrap   = $('#contractorsWrapper');
    const vipSection = $('#vip-contractors');
    const vipWrap    = $('#vipContractorsWrapper');

 function contractorSlide(c){
   const avatarRaw = (c.avatar && String(c.avatar).trim()) ? String(c.avatar).trim() : '';

  const photos = Array.isArray(c.photos) ? c.photos : [];
  // ✅ خذ أول صورة أعمال ليست data: (حتى لا نرجع base64 ضخم)
  const firstWork = photos.find(p => p && !/^data:/i.test(String(p))) || '';

  const chosen = avatarRaw || firstWork || '/public/assets/contractors/default.jpg';
  const img = /^data:/i.test(chosen) ? chosen : assetPath(chosen);

  const name  = htmlEscape(c.name || '—');
  const spec  = htmlEscape(Array.isArray(c.services) ? c.services.join('، ') : (c.services||'—'));
  const reg   = htmlEscape(c.region || '—');

  // ← طبّع الخطة ثم قرّر إظهار الشارة
  const tierRaw = (c.userTier || c.subscriptionTier || 'Basic');
  const tier    = String(tierRaw);
  const showBadge = tier.toLowerCase() !== 'basic';
  const badgeHTML = showBadge ? `<span class="tier-badge">${tier}</span>` : '';

  const rating= Number(c.ratingAvg||0).toFixed(2);
  const rcnt  = Number(c.ratingCount||0);

  return `
    <div class="swiper-slide">
      <article class="contractor-card">
        ${badgeHTML}
        <div class="card-row">
          <div class="avatar"><img src="${img}" alt="صورة ${name}" loading="lazy" onerror="this.onerror=null;this.src='/Public/assets/contractors/default.jpg'"></div>
          <div class="info-stack">
            <h3 class="name">${name}</h3>
            <p class="specialization">${spec}</p>
            <p class="region">${reg}</p>
          </div>
        </div>
        <div class="rating"><small>(${rcnt})</small><span>${rating}</span><span>⭐</span></div>
        <a class="card-cta" href="/contractor/${c._id}">صفحة المقاول</a>
      </article>
    </div>`;
}


    function vipSlide(c){
    return contractorSlide(c);

    }

    async function fetchJSON(url){
      const r = await fetch(url, { headers: { 'Accept':'application/json' }});
      if (!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      return j.data || j.rows || [];
    }

    let allContractors = [];
    let vipOnlyList    = [];
    let nonVipList     = []; 
    let listSwiper = null, vipSwiper = null;

    function destroySwiper(sw){ if (sw) try{ sw.destroy(true,true); }catch(_){ } }
function initListSwiper(){
  // ✅ انتظر Swiper إذا لم يحمّل بعد
  if (typeof window.Swiper === 'undefined') {
    setTimeout(initListSwiper, 60);
    return;
  }
  destroySwiper(listSwiper);
  listSwiper = new Swiper('.contractor-swiper', {
    watchOverflow: true,

    // ✅ مثل صفحة البيع: لا تحمل الصور دفعة واحدة
    preloadImages: false,
    lazy: { loadPrevNext: true, loadPrevNextAmount: 2 },
    watchSlidesProgress: true,

    pagination: { el: '.contractor-swiper .swiper-pagination', clickable: true },
    navigation: { nextEl: '.contractor-swiper .swiper-button-next', prevEl: '.contractor-swiper .swiper-button-prev' },
    breakpoints: {
      0:    { slidesPerView: 2.02, spaceBetween: 10 },
      480:  { slidesPerView: 2.10, spaceBetween: 12 },
      640:  { slidesPerView: 2.4,  spaceBetween: 14 },
      1024: { slidesPerView: 3.2,  spaceBetween: 18 },
      1280: { slidesPerView: 4.0,  spaceBetween: 20 }
    }
  });
}

 function initVipSwiper(){
  if (typeof window.Swiper === 'undefined') {
    setTimeout(initVipSwiper, 60);
    return;
  }
  destroySwiper(vipSwiper);
  vipSwiper = new Swiper('.vip-swiper', {
    watchOverflow: true,
    preloadImages: false,
    lazy: { loadPrevNext: true, loadPrevNextAmount: 2 },
    watchSlidesProgress: true,

    pagination: { el: '.vip-swiper .swiper-pagination', clickable: true },
    navigation: { nextEl: '.vip-swiper .swiper-button-next', prevEl: '.vip-swiper .swiper-button-prev' },
    breakpoints: {
      0:    { slidesPerView: 2.02, spaceBetween: 10 },
      480:  { slidesPerView: 2.10, spaceBetween: 12 },
      640:  { slidesPerView: 2.4,  spaceBetween: 14 },
      1024: { slidesPerView: 3.2,  spaceBetween: 18 },
      1280: { slidesPerView: 4.0,  spaceBetween: 20 }
    }
  });
}


    function renderList(list){
      listWrap.innerHTML = (list&&list.length) ? list.map(contractorSlide).join('') : `<div class="empty muted">لا توجد نتائج مطابقة.</div>`;
      initListSwiper();
      compressVisibleAvatars(12);
    }
    function renderVip(list){
      const has = Array.isArray(list) && list.length>0;
      vipSection.hidden = !has;
      vipWrap.innerHTML = has ? list.map(vipSlide).join('') : '';
      if (has) initVipSwiper(); else destroySwiper(vipSwiper);
        compressVisibleAvatars(12);
    }

   function applyFilters(){
  const qSpec = (form?.specialization?.value || '').trim().toLowerCase();
  const qCity = (form?.city?.value || '').trim().toLowerCase();

  const pass = (c) => {
    // الخدمات قد تكون Array أو نص
    const spec = (Array.isArray(c.services) ? c.services.join('، ') : (c.services || '')).toString().toLowerCase();
    // نعتمد المحافظة من حقل city (وليس region)
    const city = (c.city || '').toString().toLowerCase();

    const okSpec = !qSpec || spec.includes(qSpec);
    const okCity = !qCity || city.includes(qCity);
    return okSpec && okCity;
  };

  renderList(nonVipList.filter(pass));
  renderVip(vipOnlyList.filter(pass));
}


    (async function init(){
     const ssr = <%- JSON.stringify((typeof contractors!=='undefined' && Array.isArray(contractors)) ? contractors : []) %>;
allContractors = ssr;

//requestIdleCallback(async () => {
 // try {
   //const first = await fetchJSON('/api/contractors?limit=60');
// حمّل أكثر لاحقًا
  //  allContractors = Array.isArray(first) ? first : allContractors;

    // حضّر القوائم وحدث العرض مرة واحدة فقط
    //vipOnlyList = allContractors.filter(c => (c.subscriptionTier||'') === 'VIP');
  //  nonVipList  = allContractors.filter(c => ((c.userTier || c.subscriptionTier || 'Basic') !== 'VIP'));
   // renderList(nonVipList);
    //renderVip(vipOnlyList);
 // } catch(_) {}
//});

      try {
        vipOnlyList = allContractors.filter(c => (c.subscriptionTier||'') === 'VIP');

      } catch(_) {
        vipOnlyList = allContractors.filter(c => (c.subscriptionTier||'') === 'VIP');
      }

      // ترتيب العرض: VIP ثم Premium ثم Basic
      const rank = { VIP:0, Premium:1, Basic:2 };
     // allContractors.sort((a,b)=>(rank[a.subscriptionTier||'Basic']??9)-(rank[b.subscriptionTier||'Basic']??9));

      // بعد الترتيب:
//nonVipList = allContractors.filter(c => ((c.userTier || c.subscriptionTier || 'Basic') !== 'VIP'));

// السلايدر العام يعرض غير الـ VIP فقط
//renderList(nonVipList);

// سلايدر الـ VIP كما هو
//renderVip(vipOnlyList);
// 1) اعتمد على SSR ولا تعيد بناء DOM
initListSwiper();
compressVisibleAvatars(12);

// 2) VIP section (لو تريد) اتركه مخفيًا أولًا، أو املأه لاحقًا في idle
// vipSection.hidden = true;

// 3) جهز allContractors من SSR للفلترة فقط
vipOnlyList = allContractors.filter(c => (c.subscriptionTier||'') === 'VIP');
nonVipList  = allContractors.filter(c => ((c.userTier || c.subscriptionTier || 'Basic') !== 'VIP'));


    if (form){
  form.addEventListener('submit', e=>{ e.preventDefault(); applyFilters(); });
  // استمع لتغيّر القوائم المنسدلة أيضًا
  $$('#contractor-filters select').forEach(sel => sel.addEventListener('change', applyFilters));
}

    })();
     // جعل دوال الفلترة متاحة للحارس:
  window.applyFilters = applyFilters;
  window.setContractorFilters = (spec, city) => {
    const form = document.getElementById('contractor-filters');
    if (form) {
      if (form.specialization) form.specialization.value = spec || '';
      if (form.city)           form.city.value           = city || '';
    }
    applyFilters();
  };
  </script>
 <script>
/* ======== Contractor Gate — يظهر عند reload/navigate فقط، ولا يظهر عند الرجوع من التفاصيل ======== */
(function(){
  var gate     = document.getElementById('contractor-gate');
  var gateSpec = document.getElementById('gate-spec');
  var gateCity = document.getElementById('gate-city');
  var btnApply = document.getElementById('gate-apply');

  // حقول الفلاتر في الصفحة
  var filterForm = document.getElementById('contractor-filters');
  var filterSpec = filterForm ? filterForm.querySelector('#specialization') : null;
  var filterCity = filterForm ? filterForm.querySelector('#city') : null;

  function openGate(){ if (gate) gate.setAttribute('aria-hidden','false'); }
  function closeGate(){ if (gate) gate.setAttribute('aria-hidden','true'); } // ✅ بدون localStorage

  function navType(){
    // حديث
    try{
      if (window.performance && performance.getEntriesByType){
        var nav = performance.getEntriesByType('navigation');
        if (nav && nav[0] && nav[0].type) return nav[0].type; // navigate | reload | back_forward
      }
    }catch(e){}

    // قديم
    try{
      if (window.performance && performance.navigation){
        var t = performance.navigation.type; // 0,1,2
        if (t === 1) return 'reload';
        if (t === 2) return 'back_forward';
      }
    }catch(e){}

    return 'navigate';
  }

  // إغلاق بالضغط على الخلفية/زر ×/تخطّي
  document.addEventListener('click', function(e){
    var t = e.target;
    if (!t) return;
    if (t.dataset && t.dataset.close) return closeGate();
    if (t.classList && t.classList.contains('gate-backdrop')) return closeGate();
  });

  // تطبيق الاختيار ↔ تعبئة الفلاتر ↔ تشغيل الفلترة
  if (btnApply){
    btnApply.addEventListener('click', function(){
      var s = (gateSpec && gateSpec.value ? gateSpec.value : '').trim();
      var c = (gateCity && gateCity.value ? gateCity.value : '').trim();

      if (filterSpec) filterSpec.value = s;
      if (filterCity) filterCity.value = c;

      if (window.setContractorFilters) window.setContractorFilters(s, c);
      else if (window.applyFilters) window.applyFilters();

      closeGate();

      var results = document.getElementById('results');
      if (results && results.scrollIntoView) {
        results.scrollIntoView({ behavior:'smooth', block:'start' });
      }
    });
  }

  // ✅ افتح البوابة فقط عند: فتح جديد أو Reload
  window.addEventListener('DOMContentLoaded', function(){
    var t = navType();
    if (t === 'back_forward') return; // رجوع من التفاصيل: لا تفتح
    openGate(); // navigate أو reload: افتح دائمًا
  });

  // ✅ لو رجع من BFCache: لا نفتحها
  window.addEventListener('pageshow', function(e){
    if (e && e.persisted) closeGate();
    if (navType() === 'back_forward') closeGate();
  });

})();
</script>


  <%- include('partials/mobile-nav', { 
  activeTab: 'contractors',   // غيّرها حسب الصفحة: 'home' | 'sale' | 'rent' | 'contractors' | 'dash'
  isAuth, isAdmin, isContractor, isOwner,
}) %>
</body>
</html>
