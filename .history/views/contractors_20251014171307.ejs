<!-- views/contractors.ejs -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ÙØ§Ø±Ù…Ø±Ø² â€” Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙˆÙ†</title>
  <meta name="description" content="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† Ù…ÙˆØ«ÙˆÙ‚ÙŠÙ†: ÙƒÙ‡Ø±Ø¨Ø§Ø¡ØŒ Ù…Ø¶Ø®Ø§ØªØŒ Ø·Ø§Ù‚Ø© Ø´Ù…Ø³ÙŠØ©ØŒ Ø¨Ù†Ø§Ø¡ Ø±ÙŠÙÙŠØŒ ØªØ´Ø®ÙŠØµ ÙÙ†ÙŠØŒ ÙˆØ£Ù†Ø¸Ù…Ø© Ø§Ù„Ø±ÙŠ.">

  <link rel="stylesheet" href="/Public/styles/contractorsstyle.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>

  <style>
    /* ==== VIP hero ==== */
    .vip-hero-slide{position:relative;min-height:360px;border-radius:16px;overflow:hidden;background:#f6faf6;}
    @media (min-width:1024px){.vip-hero-slide{min-height:520px;}}
    .vip-hero-img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(.85);}
    .vip-hero-overlay{position:absolute;inset:0;background:linear-gradient(90deg,rgba(0,0,0,.35),rgba(0,0,0,.15) 40%,rgba(0,0,0,0) 70%);}
    .vip-hero-body{position:absolute;inset-inline:1.2rem;inset-block-end:1.1rem;color:#fff;display:grid;gap:.35rem;}
    .vip-hero-title{font-size:clamp(20px,3vw,34px);margin:.25rem 0 0;}
    .vip-hero-meta{opacity:.95;font-size:clamp(14px,1.5vw,16px);}
    .vip-hero-cta{margin-top:.6rem;display:inline-block;padding:.5rem .9rem;border-radius:10px;background:#fff;color:#0f172a;text-decoration:none;font-weight:600;width:150px;text-align:center;}
    .vip-badge{position:absolute;top:12px;inset-inline-start:12px;background:#0f172a;color:#fff;border-radius:999px;font-size:.8rem;padding:.18rem .6rem;z-index:2}

    /* ==== Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† (Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ø´ÙƒÙ„ Ø§Ù„ØµÙˆØ±Ø©) ==== */
    .contractor-swiper .swiper-slide{height:auto;}
    .contractor-card{
      position:relative;border:1px solid #e2e8f0;background:#fff;border-radius:16px;overflow:hidden;
      display:flex;flex-direction:column;gap:20px;padding:16px 14px;height: 300px;padding-top: 40px;
    }
    /* Ø´Ø§Ø±Ø© Ø§Ù„Ø¨Ø§Ù‚Ø© ÙÙŠ Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠØ³Ø§Ø± Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
    .tier-badge{
      position:absolute;top:10px;inset-inline-end:10px;
      background:#0f172a;color:#fff;border-radius:999px;font-size:13px;padding:.2rem .6rem;line-height:1
    }

    /* Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ: Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠØ© ÙŠÙ…ÙŠÙ† + Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø®Ø§Ù†Ø§Øª ÙŠØ³Ø§Ø±Ù‡Ø§ Ø¹Ù…ÙˆØ¯ÙŠØ§Ù‹ */
    .card-row{display:grid;grid-template-columns:auto 1fr;align-items:center;gap:12px;}
    .avatar{width:82px;height:82px;border-radius:999px;overflow:hidden;border:3px solid #eef2f7;justify-self:end}
    .avatar img{width:100%;height:100%;object-fit:cover}

    .info-stack{display:flex;flex-direction:column;gap:4px}
    .name{font-weight:800;font-size:22px;margin:0}
    .specialization,.region{margin:0;color:#475569}

    /* Ø³Ø·Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ØªØ­ØªÙ‡Ù… Ø¨Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„ÙŠÙ…ÙŠÙ† */
    .rating{display:flex;align-items:center;gap:.35rem;color:#111827;font-weight:700;justify-content:flex-start}
    .rating small{color:#6b7280;font-weight:600}

    /* Ø²Ø± Ø£Ø³ÙÙ„ Ø§Ù„ÙƒØ±Øª */
    .card-cta{margin-top:60px;width:100%;text-align:center;border:1px solid #0f172a;border-radius:12px;padding:.6rem .9rem;text-decoration:none;color:#0f172a;font-weight:600;display:inline-block}

    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³ÙˆÙŠØ¨Ø± */
    .contractor-swiper .swiper-button-prev,
    .contractor-swiper .swiper-button-next{color:#2563eb}

    /* ÙˆÙ‚Ø§ÙŠØ© Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø¹Ø§Ù…Ø© Ù‚Ø¯ ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ± */
.contractor-card img{margin-top:0!important;border-radius:0}
  </style>
</head>
<body>

  <%- include('partials/navbar', { isAuth: (typeof isAuth!=='undefined'?isAuth:false), user: (typeof user!=='undefined'?user:null), active: 'contractors' }) %>

  <a class="fab-whatsapp" href="https://wa.me/21600000000?text=%D8%A3%D8%AD%D8%AA%D8%A7%D8%AC%20%D9%85%D9%82%D8%A7%D9%88%D9%84" target="_blank" rel="noopener" aria-label="Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨">
    <span class="fab-whatsapp__icon" aria-hidden="true">ÙˆØ§ØªØ³Ø§Ø¨</span>
  </a>
<%- include('partials/promo-swiper', { bannersDoc }) %>
  
  <!-- ÙÙ„Ø§ØªØ± Ø¨Ø³ÙŠØ·Ø© -->
  <section id="filters" class="section filters" aria-labelledby="filters-title">
    <div class="container">
      <details class="filter-dropdown" open>
        <summary id="filters-title">ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</summary>
        <form id="contractor-filters" class="filters-form" action="#results" method="get" novalidate>
          <div class="filters-grid" style="display:grid;gap:.8rem;grid-template-columns:repeat(12,1fr)">
            <div class="field" style="grid-column:span 6">
              <label class="label" for="specialization">Ø§Ù„ØªØ®ØµØµ</label>
              <input id="specialization" name="specialization" type="text" placeholder="Ù…Ø«Ø§Ù„: ÙƒÙ‡Ø±Ø¨Ø§Ø¡ØŒ Ù…Ø¶Ø®Ø§ØªØŒ Ø·Ø§Ù‚Ø© Ø´Ù…Ø³ÙŠØ©â€¦">
            </div>
            <div class="field" style="grid-column:span 6">
              <label class="label" for="region">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
              <input id="region" name="region" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø±ÙŠÙ Ø¯Ù…Ø´Ù‚ØŒ Ø­Ù…ØµØŒ Ø¯Ø±Ø¹Ø§â€¦">
            </div>
            <div class="field" style="grid-column:span 12;display:flex;justify-content:flex-end">
              <button class="btn btn-primary" type="submit" style="background:#0f172a;color:#fff;border:none;border-radius:10px;padding:.55rem 1rem">ØªØ·Ø¨ÙŠÙ‚</button>
            </div>
          </div>
        </form>
      </details>
    </div>
  </section>
<!-- VIP -->
  <section id="vip-contractors" class="section gallery" aria-labelledby="vip-title" hidden>
    <div class="container">
      <header class="section-header">
        <h2 id="vip-title">Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­ÙˆÙ†</h2>
        <p class="muted">ÙŠØ¸Ù‡Ø± Ù…Ø´ØªØ±ÙƒÙˆ VIP Ùˆ Premium Ø£ÙˆÙ„Ø§Ù‹.</p>
      </header>

      <div class="swiper vip-swiper" dir="rtl" aria-label="Ù…Ù‚Ø§ÙˆÙ„ÙˆÙ† VIP">
        <div class="swiper-wrapper" id="vipContractorsWrapper"></div>
        <div class="swiper-button-prev" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚"></div>
        <div class="swiper-button-next" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ"></div>
        <div class="swiper-pagination"></div>
      </div>
    </div>
  </section>

  <!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (Ø³ÙˆÙŠØ¨Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø¨Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨) -->
  <section id="results" class="section list" aria-labelledby="list-title">
    <div class="container">
      <header class="section-header">
        
      </header>

      <div class="swiper contractor-swiper" dir="rtl">
        <div class="swiper-wrapper" id="contractorsWrapper">
          <% if (Array.isArray(contractors) && contractors.length) { contractors.forEach(function(c){ 
               const img = (Array.isArray(c.photos) && c.photos[0]) || c.avatar || '/Public/assets/contractors/default.jpg';
               const services = Array.isArray(c.services) ? c.services.join('ØŒ ') : (c.services || '');
               const region = c.region || '';
               const tier = c.subscriptionTier || 'Basic';
            %>
              <div class="swiper-slide">
                <article class="contractor-card">
                  <span class="tier-badge"><%= tier %></span>
                  <div class="card-row">
                    <div class="avatar"><img src="<%= img %>" alt="ØµÙˆØ±Ø© <%= c.name || 'Ù…Ù‚Ø§ÙˆÙ„' %>" loading="lazy" onerror="this.onerror=null;this.src='/Public/assets/contractors/default.jpg'"></div>
                    <div class="info-stack">
                      <h3 class="name"><%= c.name || 'â€”' %></h3>
                      <p class="specialization"><%= services || 'â€”' %></p>
                      <p class="region"><%= region || 'â€”' %></p>
                    </div>
                  </div>
                  <div class="rating"><small>(<%= c.ratingCount || 0 %>)</small><span><%= Number(c.ratingAvg||0).toFixed(2) %></span><span>â­</span></div>
                  <a class="card-cta" href="/contractor/<%= c._id %>">ØµÙØ­Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</a>
                </article>
              </div>
          <% }) } %>
        </div>
        <div class="swiper-button-prev" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚"></div>
        <div class="swiper-button-next" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ"></div>
        <div class="swiper-pagination"></div>
      </div>
    </div>
  </section>

  <%- include('partials/promo', { promoContractors: (typeof promoContractors!=='undefined'?promoContractors:null) }) %>
 <!--

   ========================
       Ø§Ù„ÙÙˆØªØ±
   ======================== -->
<footer class="farm-footer" dir="rtl" aria-labelledby="footer-title">
  <h2 id="footer-title" class="sr-only">ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>

  <div class="footer-top">
    <!-- Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ§Ù„ÙˆØµÙ Ø§Ù„Ù…Ø®ØªØµØ± -->
    <div class="footer-brand">
      <div class="logo-mark" aria-hidden="true">ğŸŒ¿</div>
      <div>
        <strong class="brand-name">Ù…Ø²Ø±Ø¹ØªÙŠ</strong>
        <p class="brand-desc">
          Ù…Ù†ØµÙ‘Ø© Ù„Ø¹Ø±Ø¶ ÙˆØ·Ù„Ø¨ Ø§Ù„Ù…Ø²Ø§Ø±Ø¹ (Ø¨ÙŠØ¹/Ø¥ÙŠØ¬Ø§Ø±) ÙˆØ±Ø¨Ø· Ø§Ù„Ù…Ø²Ø§Ø±Ø¹ÙŠÙ† Ø¨Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† ÙˆØ§Ù„Ø®Ø¨Ø±Ø§Ø¡.
        </p>
      </div>
    </div>

    <!-- Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø© -->
    <nav class="footer-links" aria-label="Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©">
      <div>
        <h3 class="footer-title">ØªØµÙØ­</h3>
        <ul>
          <li><a href="/sale">Ù…Ø²Ø§Ø±Ø¹ Ù„Ù„Ø¨ÙŠØ¹</a></li>
          <li><a href="/rent">Ù…Ø²Ø§Ø±Ø¹ Ù„Ù„Ø¥ÙŠØ¬Ø§Ø±</a></li>
          <li><a href="/contractors">Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙˆÙ†</a></li>
          <li><a href="/plans">Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</a></li>
        </ul>
      </div>
      <div>
        <h3 class="footer-title">Ø§Ù„Ø¯Ø¹Ù…</h3>
        <ul>
          <li><a href="/about">Ù…Ù† Ù†Ø­Ù†</a></li>
          <li><a href="/about#faq">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©</a></li>
          <li><a href="/about#privacy">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a></li>
          <li><a href="/about#terms">Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…</a></li>
        </ul>
      </div>
      <div>
        <h3 class="footer-title">ØªÙˆØ§ØµÙ„</h3>
        <ul class="contact">
          <li><a href="mailto:info@farmers.example">info@farmers</a></li>
          <li><a href="tel:+963900000000">+963 900 000</a></li>
          <li><a href="https://wa.me/963900000000" target="_blank" rel="noopener">ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¨Ø§Ø´Ø±</a></li>
        </ul>
      </div>
    </nav>
  </div>

  <div class="footer-bottom">
    <div class="social" aria-label="Ø´Ø¨ÙƒØ§Øª Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©">
      <a class="s-link" href="#" aria-label="ØªÙˆÙŠØªØ±" title="ØªÙˆÙŠØªØ±" rel="noopener">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path fill="currentColor" d="M22 5.8c-.7.3-1.5.6-2.3.7.8-.5 1.4-1.3 1.7-2.2-.8.5-1.7.9-2.6 1.1A3.9 3.9 0 0 0 12 8.6c0 .3 0 .5.1.8A11 11 0 0 1 3 5.4a3.9 3.9 0 0 0 1.2 5.2c-.6 0-1.2-.2-1.7-.5v.1c0 1.9 1.3 3.6 3.2 4-.3.1-.7.2-1 .2-.2 0-.5 0-.7-.1.5 1.6 2 2.8 3.8 2.8A7.8 7.8 0 0 1 2 19.5c1.7 1.1 3.8 1.8 6 1.8 7.2 0 11.2-6 11.2-11.2v-.5c.8-.6 1.4-1.3 1.8-2.1z"/></svg>
      </a>
      <a class="s-link" href="#" aria-label="ÙÙŠØ³Ø¨ÙˆÙƒ" title="ÙÙŠØ³Ø¨ÙˆÙƒ" rel="noopener">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path fill="currentColor" d="M13 22v-8h3l1-4h-4V7c0-1.2.3-2 2-2h2V1h-3c-3 0-5 2-5 5v4H6v4h3v8h4z"/></svg>
      </a>
      <a class="s-link" href="#" aria-label="ÙŠÙˆØªÙŠÙˆØ¨" title="ÙŠÙˆØªÙŠÙˆØ¨" rel="noopener">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path fill="currentColor" d="M23.5 6.2a3 3 0 0 0-2.1-2.1C19.2 3.5 12 3.5 12 3.5s-7.2 0-9.4.6A3 3 0 0 0 .5 6.2 31 31 0 0 0 0 12a31 31 0 0 0 .5 5.8 3 3 0 0 0 2.1 2.1c2.2.6 9.4.6 9.4.6s7.2 0 9.4-.6a3 3 0 0 0 2.1-2.1A31 31 0 0 0 24 12a31 31 0 0 0-.5-5.8zM9.8 15.5V8.6l6.2 3.5-6.2 3.4z"/></svg>
      </a>
    </div>

    <p class="copyright">
      Â© <span id="year-placeholder">2025</span> ÙØ§Ø±Ù…Ø±Ø² â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.
    </p>

    <div class="mini-links">
      <a href="/about">Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a>
      <span class="dot" aria-hidden="true">â€¢</span>
      <a href="/about">Ø§Ù„Ø´Ø±ÙˆØ·</a>
    </div>
  </div>
</footer>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script>
    const $  = (s,ctx=document)=>ctx.querySelector(s);
    const $$ = (s,ctx=document)=>Array.from(ctx.querySelectorAll(s));
    const htmlEscape = (s='') => String(s).replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
    function assetPath(u){
      u = (u||'').toString().trim();
      if (/^data:/i.test(u) || /^https?:\/\//i.test(u)) return u;
      u = u.replace(/\\/g,'/').replace(/^\/?Public\//,'/public/').replace(/\/assests\//gi,'/assets/');
      if (u.startsWith('/uploads/') || u.startsWith('/public/')) return u;
      if (u.startsWith('/assets/')) return '/public'+u;
      if (u.startsWith('/')) return '/public'+u;
      return '/uploads/'+u;
    }

    const form       = $('#contractor-filters');
    const listWrap   = $('#contractorsWrapper');
    const vipSection = $('#vip-contractors');
    const vipWrap    = $('#vipContractorsWrapper');

    function contractorSlide(c){
      const img   = assetPath((Array.isArray(c.photos)&&c.photos[0]) || c.avatar || '/Public/assets/contractors/default.jpg');
      const name  = htmlEscape(c.name || 'â€”');
      const spec  = htmlEscape(Array.isArray(c.services) ? c.services.join('ØŒ ') : (c.services||'â€”'));
      const reg   = htmlEscape(c.region || 'â€”');
      const tier  = (c.subscriptionTier || 'Basic');
      const rating= Number(c.ratingAvg||0).toFixed(2);
      const rcnt  = Number(c.ratingCount||0);
      return `
        <div class="swiper-slide">
          <article class="contractor-card">
            <span class="tier-badge">${tier}</span>
            <div class="card-row">
              <div class="avatar"><img src="${img}" alt="ØµÙˆØ±Ø© ${name}" loading="lazy" onerror="this.onerror=null;this.src='/Public/assets/contractors/default.jpg'"></div>
              <div class="info-stack">
                <h3 class="name">${name}</h3>
                <p class="specialization">${spec}</p>
                <p class="region">${reg}</p>
              </div>
            </div>
            <div class="rating"><small>(${rcnt})</small><span>${rating}</span><span>â­</span></div>
            <a class="card-cta" href="/contractor/${c._id}">ØµÙØ­Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</a>
          </article>
        </div>`;
    }

    function vipSlide(c){
      const img  = assetPath((Array.isArray(c.photos)&&c.photos[0]) || c.avatar || '/Public/assets/contractors/default.jpg');
      const name = htmlEscape(c.name || 'VIP');
      const spec = htmlEscape(Array.isArray(c.services) ? c.services.join('ØŒ ') : (c.services||'')); 
      const reg  = htmlEscape(c.region || '');
      const rating= Number(c.ratingAvg||0).toFixed(2);
      const rcnt  = Number(c.ratingCount||0);
      return `
        <div class="swiper-slide">
          <article class="vip-hero-slide">
            <span class="vip-badge">VIP</span>
            <img class="vip-hero-img" src="${img}" alt="${name}" loading="lazy" onerror="this.onerror=null;this.src='/Public/assets/contractors/default.jpg'">
            <div class="vip-hero-overlay"></div>
            <div class="vip-hero-body">
              <h3 class="vip-hero-title">${name}</h3>
              <div class="vip-hero-meta">${spec}${(spec&&reg)?' â€” ':''}${reg} â€¢ â­ ${rating} (${rcnt})</div>
              <a class="vip-hero-cta" href="/contractor/${c._id}">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</a>
            </div>
          </article>
        </div>`;
    }

    async function fetchJSON(url){
      const r = await fetch(url, { headers: { 'Accept':'application/json' }});
      if (!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      return j.data || j.rows || [];
    }

    let allContractors = [];
    let vipOnlyList    = [];
    let listSwiper = null, vipSwiper = null;

    function destroySwiper(sw){ if (sw) try{ sw.destroy(true,true); }catch(_){ } }
    function initListSwiper(){
      destroySwiper(listSwiper);
      listSwiper = new Swiper('.contractor-swiper', {
        slidesPerView: 1.05, spaceBetween: 12, watchOverflow: true,
        pagination:{ el:'.contractor-swiper .swiper-pagination', clickable:true },
        navigation:{ nextEl:'.contractor-swiper .swiper-button-next', prevEl:'.contractor-swiper .swiper-button-prev' },
        breakpoints:{ 480:{slidesPerView:1.1}, 640:{slidesPerView:1.8}, 1024:{slidesPerView:2.6}, 1280:{slidesPerView:3.2} }
      });
    }
    function initVipSwiper(){
      destroySwiper(vipSwiper);
      vipSwiper = new Swiper('.vip-swiper', {
        loop:true, centeredSlides:true, slidesPerView:1.02, spaceBetween:18, watchOverflow:true,
        pagination:{ el:'.vip-swiper .swiper-pagination', clickable:true },
        navigation:{ nextEl:'.vip-swiper .swiper-button-next', prevEl:'.vip-swiper .swiper-button-prev' }
      });
    }

    function renderList(list){
      listWrap.innerHTML = (list&&list.length) ? list.map(contractorSlide).join('') : `<div class="empty muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>`;
      initListSwiper();
    }
    function renderVip(list){
      const has = Array.isArray(list) && list.length>0;
      vipSection.hidden = !has;
      vipWrap.innerHTML = has ? list.map(vipSlide).join('') : '';
      if (has) initVipSwiper(); else destroySwiper(vipSwiper);
    }

    function applyFilters(){
      const qSpec = (form?.specialization?.value||'').trim().toLowerCase();
      const qReg  = (form?.region?.value||'').trim().toLowerCase();
      const pass = (c)=>{
        const spec = (Array.isArray(c.services)? c.services.join('ØŒ ') : (c.services||'')).toString().toLowerCase();
        const reg  = (c.region||'').toString().toLowerCase();
        return (!qSpec || spec.includes(qSpec)) && (!qReg || reg.includes(qReg));
      };
      renderList(allContractors.filter(pass));
      renderVip(vipOnlyList.filter(pass));
    }

    (async function init(){
      try {
        const apiAll = await fetchJSON('/api/contractors');
        allContractors = Array.isArray(apiAll) ? apiAll : [];
      } catch(e) {
        /* SSR fallback (Ø®Ø§Ø±Ø¬ backticks Ù„ØªÙØ§Ø¯ÙŠ Ø®Ø·Ø£ EJS) */
        const ssr = <%- JSON.stringify((typeof contractors!=='undefined' && Array.isArray(contractors)) ? contractors : []) %>;
        allContractors = ssr;
      }
      try {
        const apiVip = await fetchJSON('/api/contractors?vipOnly=1');
        vipOnlyList = Array.isArray(apiVip) ? apiVip : [];
      } catch(_) {
        vipOnlyList = allContractors.filter(c => (c.subscriptionTier||'') === 'VIP');
      }

      // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø±Ø¶: VIP Ø«Ù… Premium Ø«Ù… Basic
      const rank = { VIP:0, Premium:1, Basic:2 };
      allContractors.sort((a,b)=>(rank[a.subscriptionTier||'Basic']??9)-(rank[b.subscriptionTier||'Basic']??9));

      renderList(allContractors);
      renderVip(vipOnlyList);

      if (form){
        form.addEventListener('submit', e=>{ e.preventDefault(); applyFilters(); });
        $$('#contractor-filters input').forEach(inp=> inp.addEventListener('input', applyFilters));
      }
    })();
  </script>
</body>
</html>
