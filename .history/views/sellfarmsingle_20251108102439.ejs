<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title><%= farm ? (farm.title + ' â€” Ø§Ù„ØªÙØ§ØµÙŠÙ„') : 'Ø§Ù„Ù…Ø²Ø±Ø¹Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©' %></title>
  <meta name="description" content="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©: Ø§Ù„ØµÙˆØ±ØŒ Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŒ Ø§Ù„ÙˆØµÙØŒ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø­Ø§Ù„Ø©."/>

  <!-- Ø£Ù†Ù…Ø§Ø·Ùƒ Ø§Ù„Ø¹Ø§Ù…Ø© -->
  <link rel="stylesheet" href="/Public/styles/rentandfarmdetail.css"/>

  <!-- Leaflet + Swiper -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>

  <style>
    /* ========== Tokens ========== */
    :root{
      --bg:#f7fafc; --card:#fff; --ink:#0f172a; --muted:#64748b;
      --brand:#0f172a; --accent:#10b981; --danger:#ef4444; --ring:#0f172a22;
      --r:16px; --shadow:0 14px 36px rgba(2,6,23,.10); --container:1160px;
    }
    html,body{ background:var(--bg); color:var(--ink); }
    .container{ width:min(100%,var(--container)); margin-inline:auto; padding-inline:16px; }
    .section{ padding:1.25rem 0; }
    .card{ background:var(--card); border:1px solid #e2e8f0; border-radius:var(--r); box-shadow:var(--shadow); }
    .grid{ display:grid; gap:16px; }
    .muted{ color:var(--muted); }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.65rem 1rem; border-radius:12px; font-weight:700; text-decoration:none; cursor:pointer; }
    .btn-primary{ background:var(--accent); color:#fff; border:none; }
    .btn-outline{ background:#fff; color:var(--brand); border:1px solid var(--brand); }
    .btn-ghost{ background:#fff; color:var(--ink); border:1px solid #e2e8f0; }

    /* ========== HERO ========== */
    .hero{ position:relative; border-radius:20px; overflow:hidden; min-height:320px; margin-block:10px; background:#e2e8f0; }
    .hero__bg{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; filter:brightness(.9); }
    .hero__grad{ position:absolute; inset:0; background:
      radial-gradient(80% 60% at 80% 0%, rgba(0,0,0,.35), transparent 60%),
      linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.55) 70%);
    }
    .hero__body{ position:absolute; inset-inline:1rem; inset-block-end:1rem; color:#fff; display:grid; gap:.45rem; }
    .hero__title{ margin:0; font-size:clamp(20px,3vw,32px); font-weight:900; letter-spacing:-.2px; }
    .hero__meta{ margin:0; opacity:.95; }
    .price-chip{
      position:absolute; top:12px; inset-inline-end:12px; z-index:5;
      background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; border-radius:999px;
      padding:.25rem .65rem; font-weight:800;
    }
    .badge{ display:inline-block; padding:.22rem .6rem; border-radius:999px; font-size:.8rem; color:#fff; background:#0f172a; box-shadow:0 2px 8px rgba(0,0,0,.25); }
    .badge--vip{ background:#0f172a; } .badge--premium{ background:#8b5cf6; }
    .badge--ok{ background:#065f46; } .badge--no{ background:#991b1b; }
    .badge--video{ background:var(--danger); }
    .hero__badges{ display:flex; gap:.4rem; flex-wrap:wrap; margin-top:.25rem; }
    .hero__actions{ margin-top:.7rem; display:flex; gap:.5rem; flex-wrap:wrap; }
    .hero__cta{ background:#fff; color:#111; }

    /* ========== MAIN LAYOUT ========== */
    .main-grid{ grid-template-columns:1fr; }
    @media (min-width:1024px){ .main-grid{ grid-template-columns:2fr 1fr; align-items:start; } .aside-sticky{ position:sticky; top:16px; } }

    /* ========== Gallery + Thumbs ========== */
    .gallery .swiper-slide img{ width:100%; height:440px; object-fit:cover; border-radius:12px; }
    .gallery-thumbs .swiper-slide{ opacity:.7; cursor:pointer; }
    .gallery-thumbs .swiper-slide-thumb-active{ opacity:1; }
    .gallery-thumbs img{ width:100%; height:84px; object-fit:cover; border-radius:10px; }
    @media (max-width:480px){ .gallery .swiper-slide img{ height:260px; } .gallery-thumbs img{ height:70px; } }

    /* ========== Quick Info (icons) ========== */
    .infogrid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; }
    .info-item{ display:flex; gap:.6rem; align-items:flex-start; border:1px solid #e2e8f0; border-radius:12px; padding:.8rem; background:#fff; }
    .info-ico{ width:28px; height:28px; border-radius:8px; display:inline-grid; place-items:center; border:1px solid #e2e8f0; }
    .info-ico svg{ width:18px; height:18px; }
    .info-t h3{ margin:.05rem 0 .25rem; font-size:1rem; }
    .info-t p{ margin:0; color:var(--muted); }

    /* ========== Accordion sections ========== */
    .fold{ border:1px solid #e2e8f0; border-radius:12px; background:#fff; }
    .fold > summary{ list-style:none; cursor:pointer; padding:1rem; font-weight:800; display:flex; align-items:center; justify-content:space-between; }
    .fold > summary::marker{ content:''; }
    .fold > summary span{ color:var(--muted); font-weight:600; }
    .fold[open] > summary span{ transform:rotate(180deg); }
    .fold__body{ padding:0 1rem 1rem; color:var(--ink); }
    .chip{ background:#eef2f7; border-radius:999px; padding:.2rem .6rem; font-size:.85rem; margin:.15rem; display:inline-block; }

    /* ========== Map ========== */
    #leafletMap{ width:100%; height:380px; border-radius:12px; }
    .map-placeholder img{ max-width:100%; height:auto; border-radius:12px; }
    .map-placeholder img.static-map{ display:none; }

    /* ========== Owner slider (unchanged IDs) ========== */
    .vip-hero-slide{ position:relative; min-height:360px; border-radius:16px; overflow:hidden; background:#eef2f7; }
    .vip-hero-img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; filter:brightness(.85); }
    .vip-hero-overlay{ position:absolute; inset:0; background:linear-gradient(90deg, rgba(0,0,0,.45), rgba(0,0,0,.15) 40%, rgba(0,0,0,0) 70%); }
    .vip-hero-body{ position:absolute; inset-inline:1.2rem; inset-block-end:1.1rem; color:#fff; display:grid; gap:.35rem; }
    .vip-hero-title{ margin:.1rem 0; font-size:clamp(18px,3vw,28px); }
    .vip-hero-cta{ display:inline-block; padding:.5rem .9rem; border-radius:10px; background:#fff; color:#0f172a; text-decoration:none; width:150px; text-align:center; }

    /* ========== Mobile bottom bar ========== */
    .mobile-cta{
      position:fixed; inset-inline:0; bottom:0; z-index:70; background:#fff;
      padding:.5rem env(safe-area-inset-right) calc(.5rem + env(safe-area-inset-bottom)) env(safe-area-inset-left);
      box-shadow:0 -10px 26px rgba(2,6,23,.10); border-top:1px solid #e2e8f0; display:grid; grid-template-columns:1fr 1fr 1fr; gap:.5rem;
    }
    .mobile-cta .btn{ height:44px; border-radius:12px; }
    .btn-wa{ background:#10b981; color:#fff; border:none; }
    .btn-call{ background:#0f172a; color:#fff; border:none; }
    .btn-mail{ background:#fff; color:#0f172a; border:1px solid #0f172a; }
    @media (min-width:1024px){ .mobile-cta{ display:none; } }
    @media (max-width:1023.98px){ body{ padding-bottom:84px; } } /* Ù…Ø³Ø§Ø­Ø© ØªØ­Øª Ù„Ù„Ø¨Ø§Ø± */

    /* ØµØºØ§Ø¦Ø± */
    .prose{ line-height:1.85; }
    .prose p{ margin:.4rem 0; }
  </style>
</head>
<body>
<%
  /* ===== Helpers + Safe values ===== */
  function assetPath(u){
    u = (u||'').toString().trim();
    if (/^data:/i.test(u) || /^https?:\/\//i.test(u)) return u;
    u = u.replace(/\\/g,'/').replace(/^\/?Public\//,'/public/').replace(/\/assests\//gi,'/assets/');
    if (u.startsWith('/uploads/') || u.startsWith('/public/')) return u;
    if (u.startsWith('/assets/')) return '/public'+u;
    if (u.startsWith('/')) return '/public'+u;
    return '/uploads/'+u;
  }
  const _user        = (typeof user   !== 'undefined') ? user   : null;
  const _isAuth      = (typeof isAuth !== 'undefined') ? isAuth : false;
  const _currentPath = (typeof currentPath !== 'undefined') ? currentPath : '';
  const _banners     = (typeof bannersDoc !== 'undefined') ? bannersDoc : null;

  const photos = (Array.isArray(farm?.photos) && farm.photos.length) ? farm.photos : ['/assets/farm-default.jpg'];
  const cover  = assetPath(photos[0]);
  const ownerList = Array.isArray(sameOwnerFarms) ? sameOwnerFarms : [];
  const hasOwnerFarms = ownerList.length > 0;

  const currencySym = (farm?.currency === 'SYP') ? 'Ù„.Ø³' : '$';
  const priceText   = Number(farm?.price||0) ? (currencySym + ' ' + Number(farm.price).toLocaleString('en')) : 'â€”';
%>

<!-- Navbar + Ø£Ø¯ÙˆØ§Øª Ø«Ø§Ø¨ØªØ© (ØªÙ…Ø±ÙŠØ± Ø¢Ù…Ù†) -->
<%- include('partials/navbar', { isAuth:_isAuth, user:_user, currentPath:_currentPath }) %>
<%- include('partials/whatsapp') %>
<%- include('partials/promo-swiper', { bannersDoc:_banners }) %>

<!-- ===== Breadcrumb ===== -->
<nav class="breadcrumb" aria-label="Breadcrumb">
  <div class="container">
    <ol>
      <li><a href="/">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
      <li><a href="/sale">Ù„Ù„Ø¨ÙŠØ¹</a></li>
      <li aria-current="page"><%= farm?.title || 'â€”' %></li>
    </ol>
  </div>
</nav>

<% if (!farm) { %>
  <section class="section">
    <div class="container">
      <h1>Ø§Ù„Ù…Ø²Ø±Ø¹Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</h1>
      <p class="muted">Ø¹Ø°Ø±Ù‹Ø§ØŒ Ù„Ù… Ù†Ø¹Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.</p>
      <a class="btn btn-outline" href="/sale">Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</a>
    </div>
  </section>
<% } else { %>

<!-- ===== HERO ===== -->
<section class="section">
  <div class="container">
    <header class="hero card">
      <img class="hero__bg" src="<%= cover %>" alt="<%= farm.title %>" loading="eager" onerror="this.onerror=null;this.src='/public/assets/farm-default.jpg'">
      <div class="hero__grad"></div>

      <!-- Ø³Ø¹Ø± Ø¨Ø§Ø±Ø² -->
      <div class="price-chip"><%= priceText %><%= (String(farm.kind).toLowerCase()==='rent' ? '/Ø´Ù‡Ø±' : '') %></div>

      <div class="hero__body">
        <div class="hero__badges">
          <% const tier = (farm?.owner?.subscriptionTier || farm?.ownerTier || 'Basic'); %>
          <% if (tier==='VIP') { %><span class="badge badge--vip">VIP</span><% } %>
          <% if (tier==='Premium') { %><span class="badge badge--premium">Premium</span><% } %>
          <% const isRented = (farm.status||'available').toLowerCase()==='rented'; %>
          <span class="badge <%= isRented?'badge--no':'badge--ok' %>"><%= isRented?'Ù…Ø¤Ø¬Ù‘Ø±Ø©':'Ù…ØªØ§Ø­Ø©' %></span>
          <% if (farm.videoUrl) { %><span class="badge badge--video">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ</span><% } %>
        </div>

        <h1 class="hero__title"><%= farm.title %></h1>
        <p class="hero__meta"><%= farm.city ? (farm.area||'') + ' â€” ' + farm.city : (farm.area||'â€”') %></p>

        <div class="hero__actions">
          <a class="btn btn-primary" href="#gallery" aria-label="Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„ØµÙˆØ±">ØªØµÙÙ‘Ø­ Ø§Ù„ØµÙˆØ±</a>
          <a class="btn hero__cta" href="https://wa.me/<%= ((farm?.ownerInfo?.whatsapp)||'21600000000').replace(/\D/g,'') %>?text=<%= encodeURIComponent('Ø£Ù†Ø§ Ù…Ù‡ØªÙ… Ø¨Ù…Ø²Ø±Ø¹Ø©: ' + farm.title) %>" target="_blank" rel="noopener">ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨</a>
        </div>
      </div>
    </header>
  </div>
</section>

<!-- ===== Main ===== -->
<section class="section">
  <div class="container grid main-grid">

    <!-- LEFT: Gallery + info + description + map -->
    <div class="grid" style="gap:18px">

      <!-- Gallery with thumbs -->
      <section id="gallery" class="card" aria-labelledby="gallery-title" style="padding:1rem">
        <h2 id="gallery-title" style="margin:0 0 .75rem">Ø§Ù„Ù…Ø¹Ø±Ø¶</h2>

        <div class="swiper gallery-main" aria-label="ØµÙˆØ± Ø§Ù„Ù…Ø²Ø±Ø¹Ø©">
          <div class="swiper-wrapper" id="galleryMain">
            <% photos.forEach(function(src){ %>
              <div class="swiper-slide"><img src="<%= assetPath(src) %>" alt="<%= farm.title %>" loading="lazy"/></div>
            <% }) %>
          </div>
          <div class="swiper-button-prev" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚"></div>
          <div class="swiper-button-next" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ"></div>
          <div class="swiper-pagination"></div>
        </div>

        <div class="swiper gallery-thumbs" style="margin-top:.6rem">
          <div class="swiper-wrapper">
            <% photos.forEach(function(src){ %>
              <div class="swiper-slide"><img src="<%= assetPath(src) %>" alt="Ù…ØµØºÙ‘Ø±" loading="lazy"/></div>
            <% }) %>
          </div>
        </div>
      </section>

      <!-- Quick info (icons) -->
      <section class="card" aria-labelledby="quick-title" style="padding:1rem">
        <h2 id="quick-title" style="margin:0 0 .75rem">ØªÙØ§ØµÙŠÙ„ Ø³Ø±ÙŠØ¹Ø©</h2>

        <div class="infogrid">
          <!-- Ø§Ù„Ù…Ø³Ø§Ø­Ø© -->
          <article class="info-item">
            <span class="info-ico" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none"><path d="M4 4h16v16H4zM4 9h16M9 4v16" stroke="currentColor" stroke-width="1.5"/></svg>
            </span>
            <div class="info-t">
              <h3>Ø§Ù„Ù…Ø³Ø§Ø­Ø©</h3>
              <p><strong><%= Number(farm.size||0).toLocaleString('en') %></strong> Ù…Â²</p>
            </div>
          </article>

          <!-- Ø§Ù„Ø­Ø§Ù„Ø© -->
          <article class="info-item">
            <span class="info-ico" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none"><path d="M5 12l5 5L20 7" stroke="currentColor" stroke-width="1.8"/></svg>
            </span>
            <div class="info-t">
              <h3>Ø§Ù„Ø­Ø§Ù„Ø©</h3>
              <% const isRented2 = (farm.status||'available').toLowerCase()==='rented'; %>
              <p><span class="badge <%= isRented2?'badge--no':'badge--ok' %>"><%= isRented2?'Ù…Ø¤Ø¬Ù‘Ø±Ø©':'Ù…ØªØ§Ø­Ø©' %></span></p>
            </div>
          </article>

          <!-- Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
          <article class="info-item">
            <span class="info-ico" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none"><path d="M12 21s7-7 7-11a7 7 0 10-14 0c0 4 7 11 7 11z" stroke="currentColor" stroke-width="1.3"/><circle cx="12" cy="10" r="2.7" fill="currentColor"/></svg>
            </span>
            <div class="info-t">
              <h3>Ø§Ù„Ù…ÙˆÙ‚Ø¹</h3>
              <p><%= farm.city ? (farm.area||'') + ' â€” ' + farm.city : (farm.area||'â€”') %></p>
            </div>
          </article>

          <!-- Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª -->
          <article class="info-item">
            <span class="info-ico" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none"><path d="M1.5 12S5.5 5 12 5s10.5 7 10.5 7-4 7-10.5 7S1.5 12 1.5 12z" stroke="currentColor" stroke-width="1.2"/><circle cx="12" cy="12" r="3" fill="currentColor"/></svg>
            </span>
            <div class="info-t">
              <h3>Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª</h3>
              <p>ğŸ‘ï¸ <%= Number((typeof viewsCount!=='undefined'?viewsCount:farm.views)||0).toLocaleString('en') %></p>
            </div>
          </article>
        </div>
      </section>

      <!-- Video (optional) -->
      <% const __videoUrl = (farm.videoUrl||'').trim(); if (__videoUrl) { %>
      <section class="card" aria-labelledby="video-title" style="padding:1rem">
        <h2 id="video-title" style="margin:0 0 .6rem">ÙÙŠØ¯ÙŠÙˆ ØªÙØµÙŠÙ„ÙŠ</h2>
        <div class="video-frame" id="videoFrame"></div>
      </section>
      <% } %>

      <!-- Folded sections (amenities, pool, building) -->
      <% if ((farm.amenitiesDesc||'').trim()) { %>
      <details class="fold card">
        <summary>Ø§Ù„Ù…Ø±Ø§ÙÙ‚ <span>â–¾</span></summary>
        <div class="fold__body"><div class="prose"><%= farm.amenitiesDesc %></div></div>
      </details>
      <% } %>

      <% if ((farm.poolDesc||'').trim()) { %>
      <details class="fold card">
        <summary>ÙˆØµÙ Ø§Ù„Ù…Ø³Ø¨Ø­ <span>â–¾</span></summary>
        <div class="fold__body"><div class="prose"><%= farm.poolDesc %></div></div>
      </details>
      <% } %>

      <% if ((farm.buildingDesc||'').trim()) { %>
      <details class="fold card">
        <summary>ÙˆØµÙ Ø§Ù„Ø¨Ù†Ø§Ø¡ <span>â–¾</span></summary>
        <div class="fold__body"><div class="prose"><%= farm.buildingDesc %></div></div>
      </details>
      <% } %>

      <!-- Description -->
      <section id="description" class="card" aria-labelledby="desc-title" style="padding:1rem">
        <h2 id="desc-title" style="margin:0 0 .6rem">Ø§Ù„ÙˆØµÙ Ø§Ù„ÙƒØ§Ù…Ù„</h2>
        <article class="prose"><p><%= (farm.description||'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ÙØµÙ‘Ù„.') %></p></article>
      </section>

      <!-- Map -->
      <section id="map" class="card" aria-labelledby="map-title" style="padding:1rem">
        <h2 id="map-title" style="margin:0 0 .6rem">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</h2>
        <div class="map-placeholder" id="mapPlaceholder"
             data-lat="<%= farm?.location?.lat || '' %>"
             data-lng="<%= farm?.location?.lng || '' %>"
             data-address="<%= (farm?.location?.address || '').replace(/"/g,'&quot;') %>">
          <img class="static-map" src="/public/assets/location.jpg" alt="Ø®Ø±ÙŠØ·Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ©" loading="lazy"/>
        </div>
        <div id="leafletMap" aria-label="Ø®Ø±ÙŠØ·Ø© OpenStreetMap"></div>
      </section>

    </div>

    <!-- RIGHT: sticky contact -->
    <aside class="aside-sticky">
      <section class="card" style="padding:1rem">
        <h3 style="margin:.2rem 0 .6rem">Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</h3>
        <div class="grid" style="grid-template-columns:1fr; gap:.6rem">
          <div class="info-item">
            <span class="info-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M4 5h16M4 12h16M4 19h16" stroke="currentColor" stroke-width="1.6"/></svg></span>
            <div class="info-t"><h3>Ø§Ù„Ø³Ø¹Ø±</h3><p class="price"><%= priceText %></p></div>
          </div>
          <a class="btn btn-primary" href="https://wa.me/<%= ((farm?.ownerInfo?.whatsapp)||'21600000000').replace(/\D/g,'') %>?text=<%= encodeURIComponent('Ø£Ù†Ø§ Ù…Ù‡ØªÙ… Ø¨Ù…Ø²Ø±Ø¹Ø©: ' + farm.title) %>" target="_blank" rel="noopener">ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</a>
          <% if (farm?.ownerInfo?.phone) { %>
            <a class="btn btn-outline" href="tel:<%= farm.ownerInfo.phone.replace(/\s+/g,'') %>">Ø§ØªØµØ§Ù„ Ù‡Ø§ØªÙÙŠ</a>
          <% } %>
          <% if (farm?.ownerInfo?.email) { %>
            <a class="btn btn-ghost" href="mailto:<%= farm.ownerInfo.email %>">Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯</a>
          <% } %>
        </div>
      </section>
    </aside>

  </div>
</section>

<!-- Owner farms slider (keep IDs/structure) -->
<% if (hasOwnerFarms) { %>
<section class="section" aria-labelledby="owner-farms-title">
  <div class="container">
    <header class="section-header" style="margin-bottom:.75rem">
      <h2 id="owner-farms-title">Ù…Ø²Ø§Ø±Ø¹ Ø£Ø®Ø±Ù‰ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø§Ù„Ùƒ</h2>
      <p class="muted">Ù‚Ø¯ ØªÙ‡Ù…Ù‘Ùƒ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø²Ø§Ø±Ø¹ Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù…Ø§Ù„Ùƒ.</p>
    </header>

    <div class="swiper vip-swiper" dir="rtl">
      <div class="swiper-wrapper">
        <% ownerList.forEach(function(f){
             const raw = (Array.isArray(f.photos) && f.photos[0]) ? f.photos[0] : '/assets/farm-default.jpg';
             const link = (String(f.kind||'').toLowerCase()==='rent') ? ('/rent/farm/'+f._id) : ('/farm/'+f._id);
             const loc  = f.city ? ((f.area||'') + ' â€” ' + f.city) : (f.area||'â€”');
        %>
        <div class="swiper-slide">
          <article class="vip-hero-slide card" style="border:none">
            <img class="vip-hero-img" src="<%= assetPath(raw) %>" alt="<%= f.title||'Ù…Ø²Ø±Ø¹Ø©' %>" loading="lazy" onerror="this.onerror=null;this.src='/public/assets/farm-default.jpg'">
            <div class="vip-hero-overlay"></div>
            <div class="vip-hero-body">
              <h3 class="vip-hero-title"><%= f.title || 'â€”' %></h3>
              <div class="muted">
                <% const sym2=(f.currency==='SYP'?'Ù„.Ø³':'$'); %>
                <%= loc %> â€¢ <%= Number(f.size||0).toLocaleString('en') %> Ù…Â² â€¢
                <%= sym2 %><%= Number(f.price||0).toLocaleString('en') %><%= (String(f.kind).toLowerCase()==='rent' ? '/Ø´Ù‡Ø±' : '') %>
              </div>
              <a class="vip-hero-cta" href="<%= link %>">Ø§Ù„ØªÙØ§ØµÙŠÙ„</a>
            </div>
          </article>
        </div>
        <% }) %>
      </div>
      <div class="swiper-button-prev" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚"></div>
      <div class="swiper-button-next" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ"></div>
      <div class="swiper-pagination"></div>
    </div>
  </div>
</section>
<% } %>

<%- include('partials/top-sale', { items: (typeof topSale !== 'undefined' ? topSale : []) }) %>
<% } /* end if farm */ %>

<%- include('partials/footer') %>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* Swiper: owner slider */
if (document.querySelector('.vip-swiper')) {
  new Swiper('.vip-swiper', {
    loop:true, centeredSlides:true, slidesPerView:1.02, spaceBetween:18, watchOverflow:true,
    pagination:{ el:'.vip-swiper .swiper-pagination', clickable:true },
    navigation:{ nextEl:'.vip-swiper .swiper-button-next', prevEl:'.vip-swiper .swiper-button-prev' },
    breakpoints:{ 640:{slidesPerView:1.05,spaceBetween:20}, 1024:{slidesPerView:1.08,spaceBetween:22} }
  });
}

/* Swiper: gallery + thumbs */
(function(){
  const thumbsEl = document.querySelector('.gallery-thumbs');
  const mainEl   = document.querySelector('.gallery-main');
  if (!thumbsEl || !mainEl) return;
  const thumbs = new Swiper('.gallery-thumbs', {
    slidesPerView:4.2, spaceBetween:8, watchOverflow:true,
    breakpoints:{ 480:{slidesPerView:5.2}, 768:{slidesPerView:6.2} }
  });
  new Swiper('.gallery-main', {
    loop:true, spaceBetween:12, watchOverflow:true,
    pagination:{ el:'.gallery-main .swiper-pagination', clickable:true },
    navigation:{ nextEl:'.gallery-main .swiper-button-next', prevEl:'.gallery-main .swiper-button-prev' },
    thumbs:{ swiper:thumbs }
  });
})();

/* Video injection (YT/MP4) */
(function(){
  const el = document.getElementById('videoFrame'); if (!el) return;
  const url = <%- JSON.stringify((farm && farm.videoUrl) ? farm.videoUrl : '') %>; if (!url) return;
  function esc(s){return (s||'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
  try{
    const u = new URL(url);
    if (u.hostname.includes('youtu.be')){ const id=u.pathname.slice(1); el.innerHTML='<iframe src="https://www.youtube.com/embed/'+id+'" title="YouTube" frameborder="0" allowfullscreen></iframe>'; return; }
    if (u.hostname.includes('youtube.com')){ const id=u.searchParams.get('v'); if (id){ el.innerHTML='<iframe src="https://www.youtube.com/embed/'+id+'" title="YouTube" frameborder="0" allowfullscreen></iframe>'; return; } }
  }catch(_){}
  if (/\.(mp4|webm|ogg)(\?|#|$)/i.test(url)){ el.innerHTML='<video controls style="width:100%;border-radius:12px"><source src="'+esc(url)+'"></video>'; }
  else { el.innerHTML='<a class="btn btn-outline" href="'+esc(url)+'" target="_blank" rel="noopener">ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</a>'; }
})();

/* Leaflet map */
(function () {
  function ready(fn){ document.readyState!=='loading' ? fn() : document.addEventListener('DOMContentLoaded', fn); }
  ready(function(){
    var holder = document.getElementById('mapPlaceholder');
    var mapEl = document.getElementById('leafletMap');
    if (!holder || !mapEl || typeof L === 'undefined') return;
    var lat = parseFloat(holder.dataset.lat), lng = parseFloat(holder.dataset.lng), addr = holder.dataset.address || '';
    if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;
    var map = L.map(mapEl, { center:[lat,lng], zoom:14 });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap' }).addTo(map);
    var marker = L.marker([lat,lng]).addTo(map); if (addr) marker.bindPopup(addr);
    setTimeout(function(){ map.invalidateSize(); }, 200);
  });
})();
</script>

<!-- Mobile sticky CTA -->
<% const wa = ((farm?.ownerInfo?.whatsapp)||'').replace(/\D/g,''); const ph = (farm?.ownerInfo?.phone||'').replace(/\s+/g,''); const em = farm?.ownerInfo?.email||''; %>
<div class="mobile-cta" role="group" aria-label="Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„">
  <a class="btn btn-wa"   href="<%= wa ? ('https://wa.me/'+wa+'?text='+encodeURIComponent('Ø£Ù†Ø§ Ù…Ù‡ØªÙ… Ø¨Ù…Ø²Ø±Ø¹Ø©: '+farm.title)) : 'javascript:void(0)'}" target="_blank" rel="noopener" <%= wa?'':'aria-disabled="true"' %>>ÙˆØ§ØªØ³Ø§Ø¨</a>
  <a class="btn btn-call" href="<%= ph ? ('tel:'+ph) : 'javascript:void(0)' %>" <%= ph?'':'aria-disabled="true"' %>>Ø§ØªØµØ§Ù„</a>
  <a class="btn btn-mail" href="<%= em ? ('mailto:'+em) : 'javascript:void(0)' %>" <%= em?'':'aria-disabled="true"' %>>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</a>
</div>
</body>
</html>
