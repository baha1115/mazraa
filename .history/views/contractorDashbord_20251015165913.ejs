<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة المقاول — Farmers</title>
  <meta name="description" content="الملف الشخصي للمقاول، الخدمات والمناطق، المعرض، الاشتراك والإعدادات.">

  <style>
    :root{
      --g700:#047857; --g600:#059669; --g500:#10b981;
      --y500:#eab308;
      --ink:#0f172a; --ink70:#334155; --ink50:#64748b;
      --white:#fff; --bg:#f7faf7;
      --radius:16px; --rsm:12px;
      --sh1:0 10px 26px rgba(2,44,34,.10);
      --ring:0 0 0 3px rgba(5,150,105,.28);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--ink);
      font:16px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:
        radial-gradient(900px 360px at 110% -10%, #fef9c3 0%, transparent 60%),
        radial-gradient(900px 360px at -10% 120%, #ecfccb 0%, transparent 60%),
        linear-gradient(#f7fff8,#fbfdf6);
    }
    .container{width:min(1180px,92%);margin-inline:auto}
    a{color:inherit;text-decoration:none}
    img{display:block;max-width:100%}
    button{font:inherit;cursor:pointer}
    :focus-visible{outline:none;box-shadow:var(--ring);border-radius:10px}

    .topbar{position:sticky;top:0;z-index:40;background:rgba(255,255,255,.9);border-bottom:1px solid #e5e7eb;backdrop-filter:blur(8px)}
    .topbar__inner{display:flex;justify-content:space-between;align-items:center;padding:.8rem 0}
    .brand{display:flex;gap:.6rem;align-items:center;font-weight:900}
    .brand__mark{width:36px;height:36px;border-radius:10px;color:#fff;display:grid;place-items:center;background:linear-gradient(135deg,var(--g600),var(--y500))}
    .topbar__actions{display:flex;gap:.5rem}

    .btn{display:inline-flex;align-items:center;gap:.4rem;padding:.6rem .9rem;border-radius:12px;border:1px solid transparent;font-weight:800;background:linear-gradient(135deg,var(--g600),var(--g700));color:#fff;box-shadow:0 10px 24px rgba(4,120,87,.2)}
    .btn--ghost{background:#fff;border-color:#d1d5db;color:var(--ink)}
    .btn--danger{background:linear-gradient(135deg,#ef4444,#dc2626)}
    .btn--small{padding:.45rem .65rem}
    .btn--outline{background:#fff;border-color:#d1d5db;color:var(--ink)}
    .input{width:100%;padding:.65rem .8rem;border:1px solid #e2e8f0;border-radius:12px;background:#fff}

    .layout{display:grid;grid-template-columns:260px 1fr;gap:1rem;margin:1rem 0}
    .sidebar{border:1px solid #e2e8f0;border-radius:16px;background:#fff;box-shadow:var(--sh1);display:flex;flex-direction:column;min-height:60vh}
    .menu{display:grid;padding:.5rem}
    .menu__item{border:1px solid transparent;border-radius:12px;padding:.65rem .75rem;text-align:right;font-weight:800;color:var(--ink70);background:#fff}
    .menu__item:hover{background:#f9fafb}
    .menu__item.is-active{background:linear-gradient(135deg,var(--g600),var(--g700));color:#fff}
    .sidebar__footer{margin-top:auto;padding:.8rem;border-top:1px solid #e5e7eb;color:var(--ink50)}

    .content{min-width:0}
    .panel{display:none;border:1px solid #e2e8f0;border-radius:16px;background:#fff;box-shadow:var(--sh1);padding:1rem}
    .panel.is-visible{display:block}
    .panel__head{display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem}

    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.8rem}
    .field{display:grid;gap:.3rem}
    .field--full{grid-column:1/-1}
    .label{font-weight:800;color:var(--ink70)}
    .actions{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.35rem}
    .muted{color:var(--ink50)}
    .avatar{display:flex;gap:.8rem;align-items:center}
    .avatar img{width:84px;height:84px;border-radius:12px;object-fit:cover;border:1px solid #e5e7eb}

    /* معرض داخل الملف الشخصي */
    .drop{border:2px dashed #cbd5e1;border-radius:16px;padding:1rem;display:grid;place-items:center;text-align:center;background:#fafafa;margin-top:.6rem}
    .drop.is-over{background:#f1f5f9;border-color:#94a3b8}
    .drop__hint{margin:.4rem 0;color:var(--ink50)}
    .thumbs{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:.5rem;margin-top:.6rem}
    .thumb{position:relative;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;background:#0000000a}
    .thumb img{display:block;width:100%;height:110px;object-fit:cover}
    .thumb button{position:absolute;inset:.3rem .3rem auto auto;border:0;border-radius:9px;background:#fff;padding:.2rem .5rem;cursor:pointer}
    .thumb button:hover{background:#ffe7e7}

    .toasts{position:fixed;left:16px;bottom:16px;display:grid;gap:.5rem;z-index:50}
    .toast{padding:.55rem .8rem;border-radius:12px;border:1px solid #e2e8f0;background:#fff;box-shadow:var(--sh1);font-weight:800}
    .toast--ok{border-color:#a7f3d0;background:#ecfdf5;color:#065f46}
    .toast--warn{border-color:#fde68a;background:#fffbeb;color:#92400e}

    @media (max-width:980px){
      .layout{grid-template-columns:1fr}
      .grid2{grid-template-columns:1fr}
      .thumbs{grid-template-columns:repeat(3,1fr)}
    }
    @media (max-width:640px){
      .thumbs{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
  <!-- شريط علوي -->
<%- include('partials/navbar') %>

<%
  const safeUser    = (typeof user !== 'undefined' && user) ? user : {};
  const safeProfile = (typeof profile !== 'undefined' && profile) ? profile : {};
  const safeErrors  = (typeof errors !== 'undefined' && errors) ? errors : {};
%>

  <main class="container layout">
    <!-- القائمة -->
    <aside class="sidebar" aria-label="قائمة">
      <nav class="menu">
        
        <button class="menu__item is-active" data-view="profile">الملف الشخصي</button>
        <button class="menu__item" data-view="requests">طلباتي</button>
        <button class="menu__item" data-view="services" style="display: none;">التخصصات والمناطق</button>
        <button class="menu__item" data-view="subscription">الاشتراك</button>
        <button class="menu__item" data-view="settings" style="display: none;">الإعدادات</button>
      </nav>
      <div class="sidebar__footer">
        <small>© <span data-year>2025</span> Farmers</small>
      </div>
    </aside>

    <!-- المحتوى -->
    <section class="content">
      <!-- الطلبات المرسلة إلى الإدارة -->
<section id="view-requests" class="panel is-visible">
  <header class="panel__head"><h2>طلباتي</h2></header>
  <div id="requestsList" class="cards"></div>
  <p id="requestsEmpty" class="muted" hidden>لا توجد طلبات.</p>
</section>

      <!-- الملف الشخصي + المعرض + بيانات المؤسسة (كلها تُرسل معًا) -->
      <section class="panel is-visible" id="view-profile">
        <header class="panel__head"><h2>الملف الشخصي</h2></header>

        <form id="formProfile" class="form grid2" novalidate>
          <!-- بيانات المستخدم الأساسية -->
          <label class="field">
            <span class="label">الاسم الكامل</span>
            <input type="text" name="name" class="input" required value="<%= safeProfile.name || safeUser.name || '' %>" />
            <% if (safeErrors.name){ %><small class="muted" style="color:#b91c1c"><%= safeErrors.name %></small><% } %>
          </label>

          <label class="field">
            <span class="label">البريد الإلكتروني</span>
            <input type="email" name="email" class="input" required value="<%= safeProfile.email || safeUser.email || '' %>" />
            <% if (safeErrors.email){ %><small class="muted" style="color:#b91c1c"><%= safeErrors.email %></small><% } %>
          </label>

          <label class="field">
            <span class="label">الهاتف</span>
            <input type="tel" name="phone" class="input" value="<%= safeProfile.phone || '' %>" />
          </label>

      <label class="field">
  <span class="label">المنطقة</span>
  <input
    name="region"
    class="input"
    placeholder="اكتب المنطقة (مثال: ريف دمشق)"
    value="<%= safeProfile?.region || '' %>"
    list="region-suggestions"
  />
  <!-- اقتراحات اختيارية (ليست إلزامية) -->
  <datalist id="region-suggestions">
    <option value="ريف دمشق"></option>
    <option value="حماة"></option>
    <option value="حمص"></option>
    <option value="درعا"></option>
    <option value="الرياض"></option>
    <option value="القصيم"></option>
  </datalist>
</label>

          <label class="field field--full">
            <span class="label">نبذة مختصرة</span>
            <textarea name="bio" rows="3" class="input" placeholder="خبرتك ومهاراتك…"><%= safeProfile.bio || '' %></textarea>
          </label>

          <!-- بيانات المؤسسة (بديل بطاقة المقاول) -->
          <label class="field">
            <span class="label">اسم المؤسسة</span>
            <input name="companyName" class="input" required value="<%= safeProfile.companyName || '' %>">
          </label>

          <label class="field">
            <span class="label">الخدمات (افصل بفواصل)</span>
            <input name="services" class="input" placeholder="كهرباء زراعية, مضخات, طاقة شمسية" value="<%= Array.isArray(safeProfile.services)? safeProfile.services.join(', ') : (safeProfile.services||'') %>">
          </label>

          <label class="field">
            <span class="label">المحافظة</span>
            <input name="city" class="input" value="<%= safeProfile.city || '' %>">
          </label>

          <label class="field field--full">
            <span class="label">الوصف</span>
            <textarea name="description" rows="4" class="input"><%= safeProfile.description || '' %></textarea>
          </label>
     <!-- رابط فيديو (اختياري) -->
<label class="field field--full">
  <span class="label">رابط فيديو (YouTube/Vimeo أو ملف mp4)</span>
  <input name="videoUrl" class="input" placeholder="https://youtu.be/XXXX أو https://example.com/video.mp4"
         value="<%= (safeProfile?.videoUrl || '') %>">
  <small class="muted">إن وُجد، سيظهر في معاينة الأدمن.</small>
</label>

          <!-- صورة شخصية -->
          <div class="field field--full">
            <div class="avatar">
              <img id="avatarPreview" src="<%= safeProfile.avatar || '/assets/contractor-1.jpg' %>" alt="صورة شخصية" />
              <div>
                <label class="label">تغيير الصورة</label>
                <div id="avatarDrop" class="drop" tabindex="0" aria-label="رفع صورة شخصية">
                  <div>
                    <strong>اسحب وأفلت صورة هنا</strong>
                    <div class="drop__hint">أو اضغط للاختيار من جهازك</div>
                    <button type="button" class="btn btn--ghost btn--small" id="pickAvatar">اختيار صورة</button>
                    <input id="avatarInput" type="file" accept="image/*" hidden>
                  </div>
                </div>
                <small class="muted">تحفظ الصورة Base64 للتجربة.</small>
              </div>
            </div>
          </div>

          <!-- المعرض داخل الملف الشخصي -->
          <div class="field field--full">
            <span class="label">المعرض (صور الأعمال)</span>
            <div id="workDrop" class="drop" tabindex="0" aria-label="رفع صور الأعمال">
              <div>
                <strong>اسحب وأفلت الصور هنا</strong>
                <div class="drop__hint">أو اضغط للاختيار من جهازك (يدعم صور متعددة)</div>
                <button type="button" class="btn btn--ghost btn--small" id="pickWork">اختيار صور</button>
                <input id="workInput" type="file" accept="image/*" multiple hidden>
              </div>
            </div>
            <div id="thumbs" class="thumbs" aria-live="polite"></div>
          </div>

          <div class="actions field--full">
            <button class="btn" type="submit">حفظ وإرسال للمراجعة</button>
            <span class="muted">لن يُنشر أي تعديل إلا بعد موافقة الإدارة.</span>
          </div>
        </form>
      </section>

      <!-- الاشتراك -->
     <section class="panel" id="view-subscription">
  <header class="panel__head"><h2>الاشتراك</h2></header>
  <p class="muted" style="margin:.3rem 0">
    خطتك الحالية: <strong><%= (safeUser.subscriptionTier || 'Basic') %></strong>
  </p>

  <form id="contractorSubscribeForm" class="grid2" style="max-width:600px">
    <label class="field">
      <span class="label">الخطة</span>
      <select name="plan" class="input" required>
        <option value="Premium">Premium (2 نشرات)</option>
        <option value="VIP">VIP (غير محدود)</option>
      </select>
    </label>

    <label class="field">
      <span class="label">الاسم</span>
      <input name="name" class="input" placeholder="اسمك الكامل" required>
    </label>

    <label class="field">
      <span class="label">واتساب</span>
      <input name="whatsapp" class="input" placeholder="+216XXXXXXXX" required>
    </label>

    <label class="field field--full">
      <span class="label">ملاحظات (اختياري)</span>
      <textarea name="notes" rows="3" class="input" placeholder="أي تفاصيل إضافية…"></textarea>
    </label>

    <div class="actions field--full">
      <button class="btn" type="submit">إرسال الطلب وفتح واتساب</button>
      <small class="muted">سيفتح واتساب برسالة جاهزة، وسيظهر طلبك في لوحة المشرف للمراجعة.</small>
    </div>
  </form>
</section>


      <!-- الإعدادات -->
   

  <!-- تنبيهات -->
  <div id="toasts" class="toasts" aria-live="polite" aria-atomic="true"></div>
<!-- حقن القيم الابتدائية كـ JSON آمن -->
<!-- ضع هذين الوسمين (مرة واحدة فقط) في أعلى القسم الذي تضع فيه السكربتات -->
<script id="initial-photos" type="application/json">
  <%- JSON.stringify(Array.isArray(safeProfile?.photos) ? safeProfile.photos : []) %>
</script>
<script id="initial-avatar" type="application/json">
  <%- JSON.stringify(safeProfile?.avatar || "") %>
</script>

<script>
(() => {
  'use strict';
  const qs  = (s, r=document)=>r.querySelector(s);
  const qsa = (s, r=document)=>Array.from(r.querySelectorAll(s));

  /* ================= Toasts ================ */
  const toastBox = qs('#toasts');
  function toast(msg, kind='ok', ms=2200){
    const t = document.createElement('div');
    t.className = 'toast ' + (kind==='ok' ? 'toast--ok' : 'toast--warn');
    t.textContent = msg;
    toastBox?.appendChild(t);
    setTimeout(()=>t.remove(), ms);
  }

  // helper
  function esc(s){
    return (s??'').toString().replace(/[&<>"']/g, m => (
      {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
    ));
  }

  // السنة الحالية
  qsa('[data-year]').forEach(el => el.textContent = String(new Date().getFullYear()));

  /* ============== تبديل الأقسام ============== */
  const views = {
    profile:      qs('#view-profile'),
    services:     qs('#view-services'),
    subscription: qs('#view-subscription'),
    settings:     qs('#view-settings'),
    requests:     qs('#view-requests'),
  };
  qsa('.menu__item').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      qsa('.menu__item').forEach(b=>b.classList.remove('is-active'));
      btn.classList.add('is-active');
      const target = btn.dataset.view;
      Object.entries(views).forEach(([k,sec])=>sec?.classList.toggle('is-visible', k===target));
    });
  });

  /* ============== قراءة الصور ============== */
  function readAsDataURL(file){
    return new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload = ()=>resolve(r.result);
      r.onerror= reject;
      r.readAsDataURL(file);
    });
  }

  /* ============== عناصر النموذج ============== */
  const form          = qs('#formProfile');
  const avatarDrop    = qs('#avatarDrop');
  const avatarInput   = qs('#avatarInput');
  const pickAvatar    = qs('#pickAvatar');
  const avatarPreview = qs('#avatarPreview');

  const photos = JSON.parse((qs('#initial-photos')?.textContent || '[]'));
  let   avatar = JSON.parse((qs('#initial-avatar')?.textContent || '""'));

  // معرف الطلب الجاري تعديله (إن وجد)
  let editingId = null;

  /* ============== معرض الأعمال ============== */
  const workDrop  = qs('#workDrop');
  const workInput = qs('#workInput');
  const pickWork  = qs('#pickWork');
  const thumbs    = qs('#thumbs');

  function renderThumbs(){
    if (!thumbs) return;
    thumbs.innerHTML = '';
    if (!photos.length){
      const p = document.createElement('p');
      p.className='muted';
      p.textContent='لا توجد صور بعد.';
      thumbs.appendChild(p);
      return;
    }
    photos.forEach((src, i)=>{
      const t = document.createElement('div');
      t.className='thumb';
      t.innerHTML = `<img src="${src}" alt=""><button type="button" data-i="${i}">حذف</button>`;
      thumbs.appendChild(t);
    });
  }
  thumbs?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-i]'); if(!btn) return;
    const i = parseInt(btn.dataset.i,10);
    if (!Number.isNaN(i)) photos.splice(i,1);
    renderThumbs();
  });

  // إسقاط/اختيار صور المعرض
  ;['dragenter','dragover'].forEach(ev=>{
    workDrop?.addEventListener(ev, e=>{ e.preventDefault(); workDrop.classList.add('is-over'); });
  });
  ;['dragleave','drop'].forEach(ev=>{
    workDrop?.addEventListener(ev, e=>{ e.preventDefault(); workDrop.classList.remove('is-over'); });
  });
  workDrop?.addEventListener('click', ()=> workInput?.click());
  pickWork?.addEventListener('click', ()=> workInput?.click());
  workDrop?.addEventListener('drop', async (e)=>{
    const files = Array.from(e.dataTransfer?.files||[]).filter(f=>f.type.startsWith('image/'));
    if (!files.length) return toast('اختر صورًا فقط','warn');
    for (const f of files){ photos.push(await readAsDataURL(f)); }
    renderThumbs();
  });
  workInput?.addEventListener('change', async (e)=>{
    const files = Array.from(e.target.files||[]).filter(f=>f.type.startsWith('image/'));
    if (!files.length) return toast('اختر صورًا فقط','warn');
    for (const f of files){ photos.push(await readAsDataURL(f)); }
    renderThumbs();
  });

  /* ============== صورة شخصية ============== */
  ;['dragenter','dragover'].forEach(ev=>{
    avatarDrop?.addEventListener(ev, e=>{ e.preventDefault(); avatarDrop.classList.add('is-over'); });
  });
  ;['dragleave','drop'].forEach(ev=>{
    avatarDrop?.addEventListener(ev, e=>{ e.preventDefault(); avatarDrop.classList.remove('is-over'); });
  });
  avatarDrop?.addEventListener('drop', async (e)=>{
    const file = (e.dataTransfer?.files||[])[0];
    if(!file || !file.type.startsWith('image/')) return toast('اختر صورة صحيحة','warn');
    avatar = await readAsDataURL(file);
    if (avatarPreview) avatarPreview.src = avatar;
  });
  pickAvatar?.addEventListener('click', ()=> avatarInput?.click());
  avatarInput?.addEventListener('change', async (e)=>{
    const f=e.target.files?.[0];
    if(!f || !f.type.startsWith('image/')) return toast('اختر صورة صحيحة','warn');
    avatar = await readAsDataURL(f);
    if (avatarPreview) avatarPreview.src = avatar;
  });

  /* ============== حفظ الملف (POST أو PATCH) ============== */
  form?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    const payload = {
      name:        (fd.get('name')||'').toString().trim(),
      email:       (fd.get('email')||'').toString().trim(),
      phone:       (fd.get('phone')||'').toString().trim(),
      region:      (fd.get('region')||'').toString().trim(),
      bio:         (fd.get('bio')||'').toString().trim(),
      companyName: (fd.get('companyName')||'').toString().trim(),
      services:    (fd.get('services')||'').toString().split(',').map(s=>s.trim()).filter(Boolean),
      city:        (fd.get('city')||'').toString().trim(),
      description: (fd.get('description')||'').toString().trim(),
      videoUrl: (fd.get('videoUrl')||'').toString().trim(),   // ← أضِف هذا السطر
      avatar,
      photos,
      submitForReview: true
    };

    const url    = editingId ? ('/contractor/requests/' + editingId) : '/contractor/profile';
    const method = editingId ? 'PATCH' : 'POST';

    try{
      const res  = await fetch(url, { method, headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
      const json = await res.json().catch(()=>({ok:false}));
      if (json && json.ok){
        toast(editingId ? 'تم تعديل الطلب وإرساله للمراجعة' : 'تم الحفظ وإرسال التعديلات للمراجعة','ok');
        editingId = null;
        renderRequests();
      } else {
        toast(json.msg || 'تعذر الحفظ','warn');
      }
    }catch(err){
      console.error(err); toast('خطأ في الاتصال','warn');
    }
  });

  /* ============== طلباتي (كروت بسيطة) ============== */
  const reqList  = document.getElementById('requestsList');
  const reqEmpty = document.getElementById('requestsEmpty');
  let   _lastRequests = [];

  function badge(status){
    if (status === 'approved') return '<span class="pill" style="background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:.1rem .45rem;border-radius:999px">مقبول</span>';
    if (status === 'rejected') return '<span class="pill" style="background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:.1rem .45rem;border-radius:999px">مرفوض</span>';
    return '<span class="pill" style="background:#fffbeb;border:1px solid #fde68a;color:#92400e;padding:.1rem .45rem;border-radius:999px">قيد المراجعة</span>';
  }

  async function fetchMyRequests(){
    const res  = await fetch('/contractor/requests', { headers: {'Accept':'application/json'} });
    const json = await res.json();
    if (!json.ok) throw new Error(json.msg || 'fetch error');
    return json.data || [];
  }

  async function renderRequests(){
    if (!reqList) return;
    reqList.innerHTML = '';
    let rows = [];
    try { rows = await fetchMyRequests(); } catch { rows = []; }
    _lastRequests = rows;

    if (!rows.length){ if(reqEmpty) reqEmpty.hidden = false; return; }
    if (reqEmpty) reqEmpty.hidden = true;

    rows.forEach(doc=>{
      const card = document.createElement('article');
      card.className = 'card';
      card.style.display = 'grid';
      card.style.gridTemplateColumns = '72px 1fr auto';
      card.style.alignItems = 'center';
      card.style.gap = '.8rem';

      const av   = doc.avatar || '/assets/contractor-1.jpg';
      const title= doc.name || doc.companyName || '—';
      const sub  = `${esc(doc.city||'—')} — ${esc(doc.region||'—')}`;

      const videoLink = doc.videoUrl
        ? `<a href="${esc(doc.videoUrl)}" target="_blank" rel="noopener" class="btn btn--outline btn--small" style="margin-inline-start:.4rem">مشاهدة الفيديو</a>`
        : '';

      card.innerHTML = `
        <div style="width:72px;height:72px;border-radius:10px;overflow:hidden;border:1px solid #e5e7eb;background:#0b1a13">
          <img src="${av}" alt="" style="width:100%;height:100%;object-fit:cover">
        </div>
        <div>
          <div class="title" style="margin:0 0 .15rem 0">${esc(title)}</div>
          <div class="muted" style="font-size:.93rem">${sub}</div>
          <div style="margin-top:.35rem">${badge(doc.status)}${
            (doc.status==='rejected' && doc.reviewNote)
              ? `<span class="muted" style="margin-inline-start:.5rem">• السبب: ${esc(doc.reviewNote)}</span>`
              : ''
          }${videoLink}</div>
        </div>
        <div style="display:flex;gap:.4rem;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn btn--ghost btn--sm" data-act="edit"   data-id="${doc._id}">تعديل</button>
          <button class="btn btn--danger btn--sm" data-act="delete" data-id="${doc._id}">حذف</button>
        </div>
      `;
      reqList.appendChild(card);
    });
  }

  // أزرار تعديل/حذف
  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act][data-id]'); if(!btn) return;
    const id  = btn.dataset.id;
    const act = btn.dataset.act;

    if (act === 'delete'){
      if (!confirm('تأكيد حذف هذا الطلب؟')) return;
      try{
        const res  = await fetch('/contractor/requests/'+id, { method:'DELETE' });
        const json = await res.json().catch(()=>({ok:false}));
        if (json.ok){ toast('تم الحذف','ok'); renderRequests(); }
        else toast(json.msg || 'تعذّر الحذف','warn');
      }catch(_){ toast('تعذّر الاتصال','warn'); }
      return;
    }

    if (act === 'edit'){
      // نملأ فورم الملف الشخصي بقيم البطاقة + تفعيل وضع التعديل
      const doc = _lastRequests.find(x=>x._id===id); if(!doc) return;
      editingId = id;
      const setVal = (sel,val)=>{ const el=form?.querySelector(sel); if(!el) return; el.value = (val||''); };
      setVal('[name="name"]'       , doc.name || '');
      setVal('[name="email"]'      , doc.email || '');
      setVal('[name="phone"]'      , doc.phone || '');
      setVal('[name="region"]'     , doc.region || '');
      setVal('[name="companyName"]', doc.companyName || '');
      setVal('[name="services"]'   , Array.isArray(doc.services)? doc.services.join(', ') : (doc.services||''));
      setVal('[name="city"]'       , doc.city || '');
      setVal('[name="description"]', doc.description || '');
      setVal('[name="videoUrl"]'   , doc.videoUrl || '');             // ← NEW
      if (doc.avatar){ avatar = doc.avatar; if (avatarPreview) avatarPreview.src = avatar; }
      if (Array.isArray(doc.photos)){ photos.splice(0, photos.length, ...doc.photos); renderThumbs(); }

      // فعّل تبويب الملف الشخصي
      document.querySelectorAll('.menu__item').forEach(b=>b.classList.remove('is-active'));
      document.querySelector('.menu__item[data-view="profile"]')?.classList.add('is-active');
      Object.entries(views).forEach(([k,sec])=>sec?.classList.toggle('is-visible', k==='profile'));
      toast('تم تحميل البيانات في الفورم — عدّل ثم احفظ','ok');
      return;
    }
  });

  /* ============== خروج (اختياري) ============== */
  const btnLogout = qs('#btnLogout');
  btnLogout?.addEventListener('click', ()=>{ window.location.href = '/logout'; });

  /* ============== تشغيل أولي ============== */
  function init(){
    if (avatar && avatarPreview) avatarPreview.src = avatar;
    renderThumbs();
    renderRequests();
  }
 (async function contractorQuota(){
  const box = document.getElementById('contractorQuotaMsg') || document.createElement('div');
  box.id = 'contractorQuotaMsg';
  box.style.margin = '.5rem 0';
  const form = document.getElementById('contractorForm');
  if (form && !form.previousElementSibling?.id?.includes('contractorQuotaMsg')) {
    form.parentNode.insertBefore(box, form);
  }
  try{
    const r = await fetch('/contractor/quota', { headers:{'Accept':'application/json'}});
    const j = await r.json();
    if (!j.ok) throw 0;

    const { plan, limit, used, left, unlimited } = j.data;

    const limTxt = unlimited ? 'غير محدود' : String(limit);
    const lftTxt = unlimited ? 'غير محدود' : String(left);

    // اعرض الخطة في DOM
    box.innerHTML = `<small>خطتك: <b>${plan}</b> • المسموح: <b>${limTxt}</b> • المُستخدم: <b>${used}</b> • المتبقي: <b>${lftTxt}</b></small>`;

    // (اختياري) لو عندك عنصر يعرض الخطة في أعلى الصفحة:
    const planEl = document.querySelector('#planText');
    if (planEl) planEl.textContent = plan;

    const submitBtn = form?.querySelector('button[type="submit"]');
    if (submitBtn) {
      if (!unlimited && Number(left) <= 0) {
        submitBtn.disabled = true;
        submitBtn.title = 'بلغت الحد المسموح به في خطتك';
      } else {
        submitBtn.disabled = false;
        submitBtn.title = '';
      }
    }
  }catch{
    box.innerHTML = `<small class="muted">تعذّر جلب معلومات الحصّة.</small>`;
  }
})();


  init();
  
})();
</script>
<script>
(() => {
  const form = document.getElementById('contractorSubscribeForm');
  if (!form) return;

  const ADMIN_WA_PREMIUM = '+21620353915';
  const ADMIN_WA_VIP     = '+21620353915';

  function isValidWa(num){
    const n = (num||'').toString().trim().replace(/\s+/g,'');
    return /^\+?\d{6,15}$/.test(n);
  }
  function waLink(to, text){
    const num = to.replace(/\D/g,'');
    return `https://wa.me/${num}?text=${encodeURIComponent(text)}`;
  }
  function toastOk(msg){ const t=document.createElement('div'); t.className='toast toast--ok'; t.textContent=msg; document.getElementById('toasts').appendChild(t); setTimeout(()=>t.remove(),2200); }
  function toastWarn(msg){ const t=document.createElement('div'); t.className='toast toast--warn'; t.textContent=msg; document.getElementById('toasts').appendChild(t); setTimeout(()=>t.remove(),2200); }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd    = new FormData(form);
    const plan  = (fd.get('plan')||'Premium').toString();
    const name  = (fd.get('name')||'').toString().trim();
    const wa    = (fd.get('whatsapp')||'').toString().trim();
    const notes = (fd.get('notes')||'').toString().trim();

    if (!name){ return toastWarn('املأ الاسم'); }
    if (!isValidWa(wa)){ return toastWarn('رقم واتساب غير صحيح'); }

    const to   = plan === 'VIP' ? ADMIN_WA_VIP : ADMIN_WA_PREMIUM;
    const msg  = [
      'مرحباً إدارة Farmers 👋',
      `طلب اشتراك للمقاول`,
      `الخطة: ${plan}`,
      `الاسم: ${name}`,
      `واتساب: ${wa}`,
      notes ? `ملاحظات: ${notes}` : null,
      'شكراً لكم.'
    ].filter(Boolean).join('\n');

    // خزّن الطلب في النظام ليظهر للأدمن
    try{
      const res  = await fetch('/contractor/subscriptions', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ plan, name, whatsapp: wa, notes })
      });
      const json = await res.json().catch(()=>({ok:false}));
      if (!json.ok) toastWarn(json.msg || 'تعذّر حفظ الطلب في النظام');
      else toastOk('تم حفظ الطلب في النظام');
    }catch(err){
      console.warn(err);
      toastWarn('تعذّر الاتصال بالسيرفر — سيتم فتح واتساب على أي حال');
    }

    // افتح واتساب
    window.open(waLink(to, msg), '_blank', 'noopener');
  });
})();
</script>

</body>
</html>
