<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Farmers â€” Ù…Ø²Ø§Ø±Ø¹ Ù„Ù„Ø¨ÙŠØ¹</title>
  <meta name="description" content="ØªØµÙØ­ Ø§Ù„Ù…Ø²Ø§Ø±Ø¹ Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¨ÙŠØ¹ â€” ØµÙÙ‘ Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙˆØ§Ù„Ù…Ø¯ÙŠÙ†Ø© ÙˆØ§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ù…Ø³Ø§Ø­Ø©." />
  <link rel="stylesheet" href="/Public/styles/rentandfarmdetail.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <style>
    .vip-hero-slide{position:relative;min-height:360px;border-radius:16px;overflow:hidden;background:#f6faf6;}
    @media (min-width:1024px){.vip-hero-slide{min-height:520px;}}
    .vip-hero-img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center;filter:brightness(.85);}
    .vip-hero-overlay{position:absolute;inset:0;background:linear-gradient(90deg, rgba(0,0,0,.35), rgba(0,0,0,.15) 40%, rgba(0,0,0,0) 70%);}
    .vip-hero-body{position:absolute;inset-inline:1.2rem;inset-block-end:1.1rem;color:#fff;display:grid;gap:.35rem;text-align:flex-start;}
    .vip-hero-title{font-size:clamp(20px,3vw,34px);margin:.25rem 0 0;}
    .vip-hero-meta{opacity:.95;font-size:clamp(14px,1.5vw,16px);}
    .vip-hero-cta{margin-top:.6rem;display:inline-block;padding:.5rem .9rem;border-radius:10px;background:#fff;color:#0f172a;text-decoration:none;font-weight:600;width:150px;text-align:center;}
    .vip-badge{position:absolute;top:12px;inset-inline-start:12px;background:#0f172a;color:#fff;border-radius:999px;font-size:.8rem;padding:.2rem .6rem;z-index:4;box-shadow:0 2px 8px rgba(0,0,0,.25)}

    /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© Ø¯Ø§Ø®Ù„ Ø³ÙˆÙŠØ¨Ø± */
    .sale-swiper .swiper-slide{height:auto;}
    .farm-card{display:block;border:1px solid #e2e8f0;border-radius:14px;overflow:hidden;background:#fff}
    .farm-card img{width:100%;height:220px;object-fit:cover}
    .farm-body{padding:.8rem}
    .farm-title{margin:.2rem 0 .4rem;font-size:1.05rem}
    .farm-location,.farm-price{margin:0 0 .25rem;color:#475569}
    .btn.btn-outline{width:80%; display:inline-block;border:1px solid #0f172a;text-align: center; border-radius:10px;padding:.35rem .7rem;text-decoration:none}
    .badge{text-align: center;max-width: 50px; position:absolute;top:10px;inset-inline-start:10px;background:#0f172a;color:#fff;border-radius:999px;font-size:.75rem;padding:.15rem .5rem}
    .badge--video{text-align:center; inset-inline-start:auto;inset-inline-end:60px;background:#ef4444}
    .badge, .badge--video { z-index: 4;}
    /* ÙÙ„Ø§ØªØ± */
    .filter-dropdown summary{cursor:pointer;display:flex;align-items:center;gap:.5rem;font-weight:600;user-select:none;}
    .filter-dropdown summary::after{content:"â–¾";transition:.2s;font-size:.9rem;opacity:.9;}
    .filter-dropdown[open] summary::after{transform:rotate(180deg);}
    .filters-form{padding:.75rem 0 0;}
    .filters-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;}
    .field .label{display:block;margin:.2rem 0 .35rem}
    .field input,.field select{height:2.6rem;width:100%;padding:.75rem .9rem;border:1px solid #e2e8f0;border-radius:12px;}
    .field--actions{display:flex;align-items:flex-end}
    .btn.btn-primary{background:#0f172a;color:#fff;border:none;border-radius:10px;padding:.55rem 1rem}

    .empty{padding:2rem;text-align:center}
    .badge{position:absolute;top:10px;inset-inline-start:10px;border-radius:999px;font-size:.75rem;padding:.15rem .6rem;color:#fff;z-index:4}
.badge--vip{background:#0f172a;}
.badge--premium{background:#8b5cf6;} /* Ø¨Ù†ÙØ³Ø¬ÙŠ */
.badge--basic{background:#64748b;}   /* Ø±Ù…Ø§Ø¯ÙŠ */
.badge--video{width:fit-content; position:absolute;top:10px;inset-inline-end:10px;background:#ef4444;color:#fff;border-radius:999px;font-size:.75rem;padding:.15rem .6rem;z-index:4}
.meta-views{color:#fff;padding:.15rem .5rem;font-size:.75rem;z-index:4}

  </style>
</head>
<body>
<%
  const _isAuth      = (typeof isAuth !== 'undefined') ? isAuth : false;
  const _user        = (typeof user   !== 'undefined') ? user   : null;
  const _currentPath = (typeof currentPath !== 'undefined') ? currentPath : '/sale';
  const _farmsSSR    = (typeof farms !== 'undefined' && Array.isArray(farms)) ? farms : [];
  function esc(x){ return String(x ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
  function num(n){ const v = Number(n); return Number.isFinite(v) ? v : 0; }
%>

<%- include('partials/navbar', { isAuth: _isAuth, user: _user, currentPath: _currentPath }) %>

<a class="fab-whatsapp"
   href="https://wa.me/21600000000?text=%D8%A3%D8%B1%D9%8A%D8%AF%20%D8%A7%D9%84%D8%A7%D8%B3%D8%AA%D9%81%D8%B3%D8%A7%D8%B1%20%D8%B9%D9%86%20%D9%85%D8%B2%D8%B1%D8%B9%D8%A9%20%D9%84%D9%84%D8%A8%D9%8A%D8%B9"
   target="_blank" rel="noopener" aria-label="ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨">
  <span class="fab-whatsapp__icon" aria-hidden="true">ÙˆØ§ØªØ³Ø§Ø¨</span>
</a>
<%- include('partials/promo-swiper', { bannersDoc }) %>

<!-- Ø§Ù„ÙÙ„Ø§ØªØ± -->
<section id="filters" class="section filters" aria-labelledby="filters-title">
  <div class="container">
    <details class="filter-dropdown" open>
      <summary id="filters-title">ØªØµÙÙŠØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</summary>
      <form id="sale-filters" class="filters-form" action="#results" method="get" novalidate>
        <div class="filters-grid">
          <div class="field">
            <label class="label" for="area">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
            <input id="area" name="area" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Ù…Ø«Ø§Ù„: Ø±ÙŠÙ Ø¯Ù…Ø´Ù‚)" />
          </div>

          <div class="field">
            <label class="label" for="city">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
            <input id="city" name="city" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" />
          </div>

          <div class="field">
            <label class="label" for="price-min">Ø§Ù„Ø³Ø¹Ø± (Ù…Ù†)</label>
            <input id="price-min" name="price_min" type="number" placeholder="Ù…Ø«Ø§Ù„: 50000" />
          </div>
          <div class="field">
            <label class="label" for="price-max">Ø§Ù„Ø³Ø¹Ø± (Ø¥Ù„Ù‰)</label>
            <input id="price-max" name="price_max" type="number" placeholder="Ù…Ø«Ø§Ù„: 500000" />
          </div>

          <div class="field">
            <label class="label" for="size-min">Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ù…Ù† Ù…Â²)</label>
            <input id="size-min" name="size_min" type="number" placeholder="Ù…Ø«Ø§Ù„: 5000" />
          </div>
          <div class="field">
            <label class="label" for="size-max">Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ø¥Ù„Ù‰ Ù…Â²)</label>
            <input id="size-max" name="size_max" type="number" placeholder="Ù…Ø«Ø§Ù„: 25000" />
          </div>

          <div class="field field--actions">
            <button class="btn btn-primary" type="submit">ØªØ·Ø¨ÙŠÙ‚</button>
          </div>
        </div>
      </form>
    </details>
  </div>
</section>
<!-- VIP Sale Only -->
<section id="vip-sale" class="vip-sale-section" aria-labelledby="vip-sale-title" hidden>
  <div class="container">
    <header class="section-header">
      <h2 id="vip-sale-title">Ù…Ø²Ø§Ø±Ø¹ Ù„Ù„Ø¨ÙŠØ¹</h2>
      <p class="muted">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„ÙØªØ­ ØµÙØ­Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©.</p>
    </header>

    <div class="swiper vip-swiper" dir="rtl">
      <div class="swiper-wrapper" id="vipSaleWrapper"></div>
      <div class="swiper-button-prev" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚"></div>
      <div class="swiper-button-next" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ"></div>
      <div class="swiper-pagination"></div>
    </div>
  </div>
</section>

<!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (Ø³ÙˆÙŠØ¨Ø± Ù„Ù„ÙƒØ±ÙˆØª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©) -->
<section id="results" class="section results" aria-labelledby="results-title">
  <div class="container">
    <header class="section-header">
    </header>
    <div class="swiper sale-swiper" dir="rtl">
      <div class="swiper-wrapper" id="saleWrapper">
        <% if (_farmsSSR.length) { _farmsSSR.forEach(farm => {
             const cover = (Array.isArray(farm.photos) && farm.photos[0]) ? farm.photos[0] : '/Public/placeholder.jpg';
             const titleTxt = esc(farm.title || 'â€”');
             const hasVideo = !!(farm.videoUrl);
             const isVip    = (farm?.owner?.subscriptionTier === 'VIP') || (farm?.ownerTier === 'VIP');
        %>
          <div class="swiper-slide">
            <article class="farm-card">
              <a class="farm-link" href="/farm/<%= farm._id %>" aria-label="Ø¹Ø±Ø¶ <%= titleTxt %>">
                <figure class="farm-media" style="position:relative">
  <img src="<%= cover %>" alt="<%= titleTxt %>" loading="lazy"
       onerror="this.onerror=null;this.src='/public/assets/farm-default.jpg'"/>

  <% const tierSSR = (farm?.owner?.subscriptionTier || farm?.ownerTier || 'Basic'); %>
  <% if (tierSSR === 'VIP') { %>
    <span class="badge badge--vip">VIP</span>
  <% } else if (tierSSR === 'Premium') { %>
    <span class="badge badge--premium">Premium</span>
  <% } else { %>
    <span class="badge badge--basic">Basic</span>
  <% } %>

  <% if (farm.videoUrl) { %>
    <span class="badge badge--video">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ</span>
  <% } %>

  
</figure>

                <div class="farm-body">
                  <h3 class="farm-title"><%= titleTxt %></h3>
                  <p class="farm-location"><%= esc(farm.area||'') %> â€” <%= esc(farm.city||'') %></p>
                  <p class="farm-price"><%= num(farm.price) ? ('$' + num(farm.price).toLocaleString('en')) : 'â€”' %></p>
                  <span class="meta-views" style="color: #0f172a;">ğŸ‘ï¸ <%= Number(farm.views||0).toLocaleString('en') %></span>
                  <span class="btn btn-outline" role="button" tabindex="0">Ø§Ù„ØªÙØ§ØµÙŠÙ„</span>
                </div>
              </a>
            </article>
          </div>
        <% }) } %>
      </div>
      <div class="swiper-button-prev" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚"></div>
      <div class="swiper-button-next" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ"></div>
      <div class="swiper-pagination"></div>
    </div>

  </div>
</section>

<%- include('partials/promo', { promoContractors }) %>

<!--

   ========================
       Ø§Ù„ÙÙˆØªØ±
   ======================== -->
<footer class="farm-footer" dir="rtl" aria-labelledby="footer-title">
  <h2 id="footer-title" class="sr-only">ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>

  <div class="footer-top">
    <!-- Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ§Ù„ÙˆØµÙ Ø§Ù„Ù…Ø®ØªØµØ± -->
    <div class="footer-brand">
      <div class="logo-mark" aria-hidden="true">ğŸŒ¿</div>
      <div>
        <strong class="brand-name">Ù…Ø²Ø±Ø¹ØªÙŠ</strong>
        <p class="brand-desc">
          Ù…Ù†ØµÙ‘Ø© Ù„Ø¹Ø±Ø¶ ÙˆØ·Ù„Ø¨ Ø§Ù„Ù…Ø²Ø§Ø±Ø¹ (Ø¨ÙŠØ¹/Ø¥ÙŠØ¬Ø§Ø±) ÙˆØ±Ø¨Ø· Ø§Ù„Ù…Ø²Ø§Ø±Ø¹ÙŠÙ† Ø¨Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† ÙˆØ§Ù„Ø®Ø¨Ø±Ø§Ø¡.
        </p>
      </div>
    </div>

    <!-- Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø© -->
    <nav class="footer-links" aria-label="Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©">
      <div>
        <h3 class="footer-title">ØªØµÙØ­</h3>
        <ul>
          <li><a href="/sale">Ù…Ø²Ø§Ø±Ø¹ Ù„Ù„Ø¨ÙŠØ¹</a></li>
          <li><a href="/rent">Ù…Ø²Ø§Ø±Ø¹ Ù„Ù„Ø¥ÙŠØ¬Ø§Ø±</a></li>
          <li><a href="/contractors">Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙˆÙ†</a></li>
          <li><a href="/plans">Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</a></li>
        </ul>
      </div>
      <div>
        <h3 class="footer-title">Ø§Ù„Ø¯Ø¹Ù…</h3>
        <ul>
          <li><a href="/about">Ù…Ù† Ù†Ø­Ù†</a></li>
          <li><a href="/about#faq">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©</a></li>
          <li><a href="/about#privacy">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a></li>
          <li><a href="/about#terms">Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…</a></li>
        </ul>
      </div>
      <div>
        <h3 class="footer-title">ØªÙˆØ§ØµÙ„</h3>
        <ul class="contact">
          <li><a href="mailto:info@farmers.example">info@farmers</a></li>
          <li><a href="tel:+963900000000">+963 900 000</a></li>
          <li><a href="https://wa.me/963900000000" target="_blank" rel="noopener">ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¨Ø§Ø´Ø±</a></li>
        </ul>
      </div>
    </nav>
  </div>

  <div class="footer-bottom">
    <div class="social" aria-label="Ø´Ø¨ÙƒØ§Øª Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©">
      <a class="s-link" href="#" aria-label="ØªÙˆÙŠØªØ±" title="ØªÙˆÙŠØªØ±" rel="noopener">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path fill="currentColor" d="M22 5.8c-.7.3-1.5.6-2.3.7.8-.5 1.4-1.3 1.7-2.2-.8.5-1.7.9-2.6 1.1A3.9 3.9 0 0 0 12 8.6c0 .3 0 .5.1.8A11 11 0 0 1 3 5.4a3.9 3.9 0 0 0 1.2 5.2c-.6 0-1.2-.2-1.7-.5v.1c0 1.9 1.3 3.6 3.2 4-.3.1-.7.2-1 .2-.2 0-.5 0-.7-.1.5 1.6 2 2.8 3.8 2.8A7.8 7.8 0 0 1 2 19.5c1.7 1.1 3.8 1.8 6 1.8 7.2 0 11.2-6 11.2-11.2v-.5c.8-.6 1.4-1.3 1.8-2.1z"/></svg>
      </a>
      <a class="s-link" href="#" aria-label="ÙÙŠØ³Ø¨ÙˆÙƒ" title="ÙÙŠØ³Ø¨ÙˆÙƒ" rel="noopener">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path fill="currentColor" d="M13 22v-8h3l1-4h-4V7c0-1.2.3-2 2-2h2V1h-3c-3 0-5 2-5 5v4H6v4h3v8h4z"/></svg>
      </a>
      <a class="s-link" href="#" aria-label="ÙŠÙˆØªÙŠÙˆØ¨" title="ÙŠÙˆØªÙŠÙˆØ¨" rel="noopener">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path fill="currentColor" d="M23.5 6.2a3 3 0 0 0-2.1-2.1C19.2 3.5 12 3.5 12 3.5s-7.2 0-9.4.6A3 3 0 0 0 .5 6.2 31 31 0 0 0 0 12a31 31 0 0 0 .5 5.8 3 3 0 0 0 2.1 2.1c2.2.6 9.4.6 9.4.6s7.2 0 9.4-.6a3 3 0 0 0 2.1-2.1A31 31 0 0 0 24 12a31 31 0 0 0-.5-5.8zM9.8 15.5V8.6l6.2 3.5-6.2 3.4z"/></svg>
      </a>
    </div>

    <p class="copyright">
      Â© <span id="year-placeholder">2025</span> ÙØ§Ø±Ù…Ø±Ø² â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.
    </p>

    <div class="mini-links">
      <a href="/about">Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a>
      <span class="dot" aria-hidden="true">â€¢</span>
      <a href="/about">Ø§Ù„Ø´Ø±ÙˆØ·</a>
    </div>
  </div>
</footer>

<!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<script type="module">
/* ======= Ø£Ø¯ÙˆØ§Øª ØµØºÙŠØ±Ø© ======= */
const $  = (s,ctx=document)=>ctx.querySelector(s);
const $$ = (s,ctx=document)=>Array.from(ctx.querySelectorAll(s));
const fmtEN = n => Number(n||0).toLocaleString('en');

/* ======= Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø© ======= */
const form        = $('#sale-filters');
const vipSection  = $('#vip-sale');
const vipWrap     = $('#vipSaleWrapper');
const saleWrapper = $('#saleWrapper');

/* ======= HTML helpers ======= */
function htmlEscape(s=''){ return String(s).replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }
function assetPath(u){
  u = (u || '').toString().trim();
  if (/^data:/i.test(u) || /^https?:\/\//i.test(u)) return u;
  u = u.replace(/\\/g, '/').replace(/^\/?Public\//, '/public/').replace(/\/assests\//gi, '/assets/');
  if (u.startsWith('/uploads/') || u.startsWith('/public/')) return u;
  if (u.startsWith('/assets/')) return '/public' + u;
  if (u.startsWith('/')) return '/public' + u;
  return '/uploads/' + u;
}

/* ======= Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¦Ø­ ======= */
function saleSlide(f){
  const raw   = (Array.isArray(f.photos) && f.photos[0]) ? f.photos[0] : '/assets/farm-default.jpg';
  const cover = assetPath(raw);
  const link  = `/farm/${f._id}`;
  const loc   = f.city ? `${f.area || ''} â€” ${f.city}` : (f.area || 'â€”');
  const tier  = ((f.owner && f.owner.subscriptionTier) || f.ownerTier || 'Basic');
  const views = Number(f.views || 0);

  const tierBadge =
    tier === 'VIP'     ? '<span class="badge badge--vip">VIP</span>' :
    tier === 'Premium' ? '<span class="badge badge--premium">Premium</span>' :
                         '<span class="badge badge--basic">Basic</span>';

  return `
    <div class="swiper-slide">
      <article class="farm-card">
        <a class="farm-link" href="${link}" aria-label="${htmlEscape(f.title || 'Ù…Ø²Ø±Ø¹Ø©')}">
          <figure class="farm-media" style="position:relative">
            <img src="${cover}" alt="${htmlEscape(f.title || 'Ù…Ø²Ø±Ø¹Ø©')}" loading="lazy"
                 onerror="this.onerror=null;this.src='/public/assets/farm-default.jpg'">
            ${tierBadge}
            ${f.videoUrl ? `<span class="badge badge--video">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ</span>` : ``}
            
          </figure>
          <div class="farm-body">
            <h3 class="farm-title">${htmlEscape(f.title || 'â€”')}</h3>
            <p class="farm-location">${htmlEscape(loc)}</p>
            <p class="farm-price">${Number(f.price || 0) ? ('$' + fmtEN(f.price)) : 'â€”'}</p>
            <span class="meta-views" style="color: #0f172a;">ğŸ‘ï¸ ${fmtEN(views)}</span>
            <span class="btn btn-outline" role="button" tabindex="0">Ø§Ù„ØªÙØ§ØµÙŠÙ„</span>
          </div>
        </a>
      </article>
    </div>`;
}


function vipSlide(f){
  const raw   = (Array.isArray(f.photos) && f.photos[0]) ? f.photos[0] : '/assets/farm-default.jpg';
  const cover = assetPath(raw);
  const loc   = f.city ? `${f.area || ''} â€” ${f.city}` : (f.area || 'â€”');
  const link  = `/farm/${f._id}`;
  const vws   = Number(f.views || 0);

  return `
    <div class="swiper-slide">
      <article class="vip-hero-slide">
        <span class="vip-badge">VIP</span>
        <img class="vip-hero-img" src="${cover}" alt="${htmlEscape(f.title || 'VIP')}"
             loading="lazy" onerror="this.onerror=null;this.src='/public/assets/farm-default.jpg'">
        <div class="vip-hero-overlay"></div>
        <div class="vip-hero-body">
          <h3 class="vip-hero-title">${htmlEscape(f.title || 'â€”')}</h3>
          <div class="vip-hero-meta">
            ${htmlEscape(loc)} <br>â€¢ ${fmtEN(f.size)} Ù…Â² <br>â€¢ $${fmtEN(f.price)} <br>â€¢ ğŸ‘ï¸ ${fmtEN(vws)}
          </div>
          <a class="vip-hero-cta" href="${link}">Ø§Ù„ØªÙØ§ØµÙŠÙ„</a>
        </div>
      </article>
    </div>`;
}

/* ======= Ø¬Ù„Ø¨ API ======= */
async function fetchJSON(url){
  const r = await fetch(url, { headers: { 'Accept':'application/json' }});
  if (!r.ok) throw new Error('HTTP '+r.status);
  const j = await r.json();
  return j.data || j.rows || [];
}

/* ======= Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø³ÙˆÙŠØ¨Ø±Ø§Øª ======= */
let allSale = [];
let vipAll  = [];
let saleSwiper = null;
let vipSwiper  = null;

function destroySwiper(sw){
  if (sw) try{ sw.destroy(true,true); }catch(_){}
}

function initSaleSwiper(){
  destroySwiper(saleSwiper);
  saleSwiper = new Swiper('.sale-swiper', {
    slidesPerView: 1.05,
    spaceBetween: 12,
    watchOverflow: true,
    pagination: { el: '.sale-swiper .swiper-pagination', clickable: true },
    navigation: {
      nextEl: '.sale-swiper .swiper-button-next',
      prevEl: '.sale-swiper .swiper-button-prev'
    },
    breakpoints: {
      480:  { slidesPerView: 1.2,  spaceBetween: 14 },
      640:  { slidesPerView: 2.2,  spaceBetween: 16 },
      1024: { slidesPerView: 3.2,  spaceBetween: 18 },
      1280: { slidesPerView: 4.2,  spaceBetween: 20 }
    }
  });
}

function initVipSwiper(){
  destroySwiper(vipSwiper);
  vipSwiper = new Swiper('.vip-swiper', {
    loop: true,
    centeredSlides: true,
    slidesPerView: 1.02,
    spaceBetween: 18,
    watchOverflow: true,
    pagination: { el: '.vip-swiper .swiper-pagination', clickable: true },
    navigation: {
      nextEl: '.vip-swiper .swiper-button-next',
      prevEl: '.vip-swiper .swiper-button-prev'
    },
    breakpoints: {
      640:  { slidesPerView: 1.05, spaceBetween: 20 },
      1024: { slidesPerView: 1.08, spaceBetween: 22 }
    }
  });
}

function renderSale(list){
  if (!saleWrapper) return;
  saleWrapper.innerHTML = (list && list.length) ? list.map(saleSlide).join('') : `<div class="empty muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>`;
  initSaleSwiper();
}
function renderVip(list){
  if (!vipSection || !vipWrap) return;
  const has = Array.isArray(list) && list.length>0;
  vipSection.hidden = !has;
  vipWrap.innerHTML = has ? list.map(vipSlide).join('') : '';
  if (has) initVipSwiper(); else destroySwiper(vipSwiper);
}

/* ======= ÙÙ„Ø§ØªØ± ======= */
function applyFilters(){
  const area  = (form?.area?.value||'').trim().toLowerCase();
  const city  = (form?.city?.value||'').trim().toLowerCase();
  const minP  = parseFloat(form?.price_min?.value);
  const maxP  = parseFloat(form?.price_max?.value);
  const minS  = parseFloat(form?.size_min?.value);
  const maxS  = parseFloat(form?.size_max?.value);

  const pass = (f)=>{
    const fArea = (f.area||'').toString().toLowerCase();
    const fCity = (f.city||'').toString().toLowerCase();
    const okArea  = !area || fArea.includes(area);
    const okCity  = !city || fCity.includes(city);
    const price   = Number(f.price)||0;
    const size    = Number(f.size)||0;
    const okPrice = (isNaN(minP) || price>=minP) && (isNaN(maxP) || price<=maxP);
    const okSize  = (isNaN(minS) || size>=minS)   && (isNaN(maxS) || size<=maxS);
    return okArea && okCity && okPrice && okSize;
  };

  const filteredSale = allSale.filter(pass);
  const filteredVip  = vipAll.filter(pass);
  renderSale(filteredSale);
  renderVip(filteredVip);
}

/* ======= Ø¨Ø¯Ø¡ ======= */
async function init(){
  try {
    const apiSale = await fetchJSON('/api/farms/sale'); // ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„
    allSale = Array.isArray(apiSale) ? apiSale : [];
    renderSale(allSale);
  } catch(e){ console.warn('sale fetch error:', e); renderSale([]); }

  try {
    vipAll = await fetchJSON('/api/farms/sale?vipOnly=1');
    renderVip(vipAll);
  } catch(e){ console.warn('vip fetch error:', e); renderVip([]); }

  if (form){
    form.addEventListener('submit', e=>{ e.preventDefault(); applyFilters(); });
    $$('#sale-filters input, #sale-filters select').forEach(inp=>{
      inp.addEventListener('change', applyFilters);
      inp.addEventListener('input',  e=>{
        const n = (e.target?.name||'');
        if (/price_|size_|area|city/.test(n)) applyFilters();
      });
    });
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
