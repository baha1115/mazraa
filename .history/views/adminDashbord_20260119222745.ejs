<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="alternate icon" type="image/png" href="../public/assests/logo.png">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù â€” Farmers</title>
<meta name="description" content="Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Admin Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ ÙˆØ§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† ÙˆØ§Ù„Ø¨Ø§Ù†Ø±Ø§Øª ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ø³Ø¬Ù„.">
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<style>
  :root{
    --g700:#047857; --g600:#059669; --g500:#10b981;
    --y500:#eab308;
    --ink:#0f172a; --ink70:#334155; --ink50:#64748b;
    --bg:#f7faf7; --white:#fff;
    --r:16px; --rs:12px;
    --sh:0 10px 26px rgba(2,44,34,.08);
    --ring:0 0 0 3px rgba(5,150,105,.28);
    /* Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø¹Ù†Ø¯ Ø¸Ù‡ÙˆØ±/Ø§Ø®ØªÙØ§Ø¡ Ø³ÙƒØ±ÙˆÙ„ */
    scrollbar-gutter: stable both-edges;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--ink);
    font:15.5px/1.6 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:
      radial-gradient(900px 360px at 110% -10%, #fef9c3 0%, transparent 60%),
      radial-gradient(900px 360px at -10% 120%, #ecfccb 0%, transparent 60%),
      linear-gradient(#f7fff8,#fbfdf6);
  }

  /* Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø¯Ø¯ Ø§Ù„Ø£ÙÙ‚ÙŠ Ø§Ù„Ù…ÙØ§Ø¬Ø¦ */
  html, body { overflow-x: hidden; }
  .container, .panel, .card { max-width: 100%; overflow-x: clip; }
  img, video { max-width: 100%; height: auto; }

  a{color:inherit;text-decoration:none}
  img{max-width:100%;display:block}
  button{font:inherit;cursor:pointer}
  :focus-visible{outline:none;box-shadow:var(--ring);border-radius:10px}

  /* Topbar */
  .topbar{position:sticky;top:0;z-index:40;background:rgba(255,255,255,.9);border-bottom:1px solid #e5e7eb;backdrop-filter:blur(8px)}
  .topbar__in{display:flex;justify-content:space-between;align-items:center;gap:.8rem;padding:.8rem 0}
  .container{width:min(1200px,92%);margin-inline:auto}
  .brand{display:flex;align-items:center;gap:.6rem;font-weight:900}
  .brand__mark{width:36px;height:36px;display:grid;place-items:center;border-radius:10px;color:#fff;background:linear-gradient(135deg,var(--g600),var(--y500))}
  .topbar__act{display:flex;gap:.5rem}

  /* Buttons / Inputs */
  .btn{display:inline-flex;align-items:center;gap:.4rem;padding:.55rem .85rem;border-radius:12px;border:1px solid transparent;font-weight:800;background:linear-gradient(135deg,var(--g600),var(--g700));color:#fff;box-shadow:0 10px 24px rgba(4,120,87,.18)}
  .btn:hover{filter:brightness(.98)}
  .btn--ghost{background:#fff;border-color:#e5e7eb;color:var(--ink)}
  .btn--warn{background:linear-gradient(135deg,#f59e0b,#d97706)}
  .btn--danger{background:linear-gradient(135deg,#ef4444,#dc2626)}
  .btn--ok{background:linear-gradient(135deg,#10b981,#059669)}
  .btn--sm{padding:.4rem .6rem}
  .input{width:100%;padding:.6rem .8rem;border:1px solid #e2e8f0;border-radius:12px;background:#fff}

  /* Layout */
  .layout{display:grid;grid-template-columns:258px 1fr;gap:1rem;margin:1rem 0}
  .sidebar{border:1px solid #e2e8f0;border-radius:16px;background:#fff;box-shadow:var(--sh);display:flex;flex-direction:column}
  .menu{display:grid;padding:.5rem}
  .menu__item{border:1px solid transparent;border-radius:12px;padding:.65rem .75rem;text-align:right;font-weight:800;color:var(--ink70);background:#fff}
  .menu__item:hover{background:#f9fafb}
  .menu__item.is-active{background:linear-gradient(135deg,var(--g600),var(--g700));color:#fff}
  .sidebar__foot{margin-top:auto;padding:.8rem;border-top:1px solid #e5e7eb;color:var(--ink50);font-size:.92rem}

  .content{min-width:0}
  .panel{display:none;border:1px solid #e2e8f0;border-radius:16px;background:#fff;box-shadow:var(--sh);padding:1rem}
  .panel.is-visible{display:block}
  .head{display:flex;justify-content:space-between;align-items:center;gap:.8rem;margin-bottom:.6rem}
  .muted{color:var(--ink50)}

  /* Cards / Lists */
  .cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.8rem}
  .card{border:1px solid #e5e7eb;border-radius:16px;background:#fff;padding:.8rem}
  .title{margin:.2rem 0 .6rem;font-weight:900}
  .land{display:grid;grid-template-columns:140px 1fr;gap:.8rem;border:1px solid #e5e7eb;border-radius:14px;padding:.6rem;background:#fff}
  .land__media{width:140px;height:105px;border-radius:12px;overflow:hidden;background:#0b1a13}
  .land__media img{width:100%;height:100%;object-fit:cover}
  .meta{color:var(--ink50);font-size:.95rem}
  .pill{display:inline-block;padding:.2rem .5rem;border-radius:999px;font-weight:800;font-size:.85rem;margin-inline-start:.35rem}
  .p--pending{background:#fffbeb;color:#92400e;border:1px solid #fde68a}
  .p--approved{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
  .p--rejected{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}

  .table-wrap{border:1px solid #e2e8f0;border-radius:16px;background:#fff;overflow:hidden}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:#f9fafb;border-bottom:1px solid #e5e7eb;text-align:right;padding:.55rem .7rem}
  tbody td{padding:.55rem .7rem;border-bottom:1px solid #f1f5f9}

  .drawer{position:fixed;top:0;right:-520px;width:min(520px,92%);height:100%;background:#fff;border-left:1px solid #e5e7eb;box-shadow:-12px 0 34px rgba(0,0,0,.08);transition:right .25s ease;z-index:80;display:flex;flex-direction:column}
  .drawer[aria-hidden="false"]{right:0}
  .drawer__head{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid #e5e7eb}
  .drawer__body{padding:1rem 1rem 2rem;overflow:auto}
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.2);backdrop-filter:blur(2px);z-index:70}

  .toasts{position:fixed;left:16px;bottom:16px;display:grid;gap:.5rem;z-index:90}
  .toast{padding:.55rem .8rem;border-radius:12px;border:1px solid #e2e8f0;background:#fff;box-shadow:var(--sh);font-weight:800}
  .toast--ok{border-color:#a7f3d0;background:#ecfdf5;color:#065f46}
  .toast--warn{border-color:#fde68a;background:#fffbeb;color:#92400e}

  /* ---- Ù…Ù„Ù ØªØ­Ù…ÙŠÙ„ Ù…Ø®ØµØµ (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø§Ù†Ø²Ù„Ø§Ù‚) ---- */
  .filebox{
    position: relative;                           /* Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„Ù€ input Ø§Ù„Ù…Ø·Ù„Ù‚ Ø¯Ø§Ø®Ù„Ù‡Ø§ */
    display:flex; align-items:center; gap:.6rem; flex-wrap:wrap;
    max-width:100%; overflow:hidden;
  }
  /* Ø¥Ø®ÙØ§Ø¡ Ø¨ØµØ±ÙŠ Ù„Ù„Ù€ input Ø¨Ø¯ÙˆÙ† Ø¥Ù†Ø´Ø§Ø¡ ØªÙ…Ø±ÙŠØ± Ø£ÙÙ‚ÙŠ */
  .filebox input[type="file"]{
    position: absolute !important;                /* ÙŠØªÙ…Ø±ÙƒØ² Ø¯Ø§Ø®Ù„ .filebox ÙÙ‚Ø· */
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0 0 0 0) !important;
    clip-path: inset(50%) !important;
    white-space: nowrap !important;
    border: 0 !important;
  }
  .filebox__btn{
    display:inline-flex; align-items:center; gap:.4rem;
    padding:.55rem .9rem; border-radius:12px; border:1px solid #d1d5db;
    background:#fff; font-weight:800; cursor:pointer;
    box-shadow:0 6px 14px rgba(0,0,0,.05);
  }
  .filebox__btn:hover{ background:#f8fafc }
  .filebox__name{
    font-size:.95rem; color:#475569; min-width:180px;
    padding:.4rem .6rem; border:1px dashed #cbd5e1; border-radius:10px; background:#f8fafc;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    max-width:100%;
    direction:ltr; /* Ù„Ø£Ø³Ù…Ø§Ø¡ Ù…Ù„ÙØ§Øª Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©/Ø£Ø±Ù‚Ø§Ù… Ø·ÙˆÙŠÙ„Ø© */
  }

  @media (max-width:980px){
    .layout{grid-template-columns:1fr}
    .cards{grid-template-columns:1fr}
  }

  .site-header { background:#fff; border-bottom:1px solid #eee; }
  .nav { display:flex; align-items:center; justify-content:space-between; gap:1rem; }
  .nav .navlinks { display:flex; align-items:center; gap:1rem; }
  .nav .btn { padding:.5rem .9rem; border-radius:10px; }
  .badge { font-weight:700; }
  .mobile-menu { padding:.75rem 1rem; background:#fff; border-top:1px solid #eee; }
  .nav-toggle { background:transparent; border:0; }
  #previewMap { height: 260px; border-radius: 12px; border:1px solid #e5e7eb; overflow:hidden; }
.showcase-card{
  border:1px solid #e5e7eb; border-radius:14px; overflow:hidden; background:#fff;
  display:flex; flex-direction:column; box-shadow:0 8px 20px rgba(0,0,0,.04);
}
.showcase-thumb{height:140px; background:#0b1a13}
.showcase-thumb img{width:100%; height:100%; object-fit:cover; display:block}
.showcase-body{padding:.6rem .7rem}
.showcase-title{font-weight:800; margin:.1rem 0}
.showcase-desc{color:#64748b; font-size:.92rem; min-height:1.6em}
.showcase-actions{display:flex; gap:.5rem; padding:.6rem; border-top:1px solid #eef2f7}
/* === Showcase Lists (rentTop / saleTop / bestContractors) === */
.showcase-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
  gap:.9rem;
}

.showcase-card{
  border:1px solid #e5e7eb;
  border-radius:16px;
  background:#fff;
  box-shadow:0 10px 22px rgba(2,44,34,.06);
  overflow:hidden;
  transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease;
  display:flex;
  flex-direction:column;
}

.showcase-card:hover{
  transform:translateY(-2px);
  box-shadow:0 14px 26px rgba(2,44,34,.10);
  border-color:#cbd5e1;
}

.showcase-thumb{
  height:140px;
  background:#0b1a13;
}

.showcase-thumb img{
  width:100%; height:100%; object-fit:cover; display:block;
}

.showcase-body{
  padding:.7rem .8rem .2rem;
}

.showcase-title{
  font-weight:900;
  margin:.05rem 0 .25rem;
  color:#0f172a;
}

.showcase-desc{
  color:#64748b;
  font-size:.94rem;
  min-height:1.6em;
  line-height:1.45;
}

.showcase-meta{
  display:flex; gap:.5rem; align-items:center;
  padding:.4rem .8rem .8rem;
}

.showcase-actions{
  display:flex; justify-content:space-between; align-items:center;
  gap:.6rem; padding:.6rem .8rem; border-top:1px solid #eef2f7;
}

.showcase-actions .btn{
  padding:.4rem .65rem;
}

.showcase-link{
  color:#334155; font-size:.92rem; text-decoration:underline;
}
.showcase-link:hover{ color:#0f172a; }

@media (max-width:640px){
  .showcase-thumb{ height:120px; }
}
/* ===== Mobile upgrades ===== */
.mobile-tabs {
  position: fixed; right: 0; left: 0; bottom: 0; z-index: 60;
  display: flex; gap: .2rem; justify-content: space-around;
  padding: .4rem; background: #fff; border-top: 1px solid #e5e7eb;
  box-shadow: 0 -8px 18px rgba(0,0,0,.06);
}
.mobile-tabs__btn {
  flex: 1; padding: .55rem .4rem; border-radius: 10px; border: 1px solid #e5e7eb;
  background: #fff; font-weight: 800; font-size: .9rem;
}
.mobile-tabs__btn.is-active {
  color: #fff; border-color: transparent;
  background: linear-gradient(135deg, var(--g600), var(--g700));
  box-shadow: 0 8px 18px rgba(4,120,87,.18);
}

@media (max-width: 980px){
  body{ padding-bottom: 64px; }          /* Ø¹Ù„Ø´Ø§Ù† Ù…Ø§ ØªØºØ·ÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
  .layout{ grid-template-columns: 1fr; }
  .sidebar{ display: none; }             /* Ù†Ø®Ø¨ÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
  .panel{ padding: .8rem .8rem 1rem; }
  .head{ flex-direction: column; align-items: flex-start; gap: .4rem; }

  /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ */
  .land{ grid-template-columns: 1fr; }
  .land__media{ width: 100%; height: 160px; }

  /* Ø´Ø¨ÙƒØ© Ø§Ù„ÙƒØ±ÙˆØª */
  .cards{ grid-template-columns: 1fr; gap: .6rem; }
  .showcase-grid{ grid-template-columns: repeat(auto-fill, minmax(160px,1fr)); }

  /* Ø§Ù„Ø¯Ø±ÙˆØ§Ø± Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø© */
  .drawer{ right: -100%; width: 100%; }
  .drawer[aria-hidden="false"]{ right: 0; }

  /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª â†’ Ø¨Ø·Ø§Ù‚Ø§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© */
  .table-wrap{ border-radius: 12px; overflow: hidden; }
  table{ display: block; }
  thead{ display: none; }
  tbody, tr, td{ display: block; width: 100%; }
  tbody tr{ padding: .6rem .8rem; border-bottom: 1px solid #f1f5f9; }
  tbody td{ padding: .45rem 0; border-bottom: 0; }
  tbody td:nth-child(1)::before{ content: 'Ø§Ù„Ø§Ø³Ù…: '; color:#64748b; font-weight:700; }
  tbody td:nth-child(2)::before{ content: 'Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„: '; color:#64748b; font-weight:700; }
  tbody td:nth-child(3)::before{ content: 'Ø§Ù„Ù†ÙˆØ¹: '; color:#64748b; font-weight:700; }
  tbody td:nth-child(4)::before{ content: 'Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª/Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: '; color:#64748b; font-weight:700; }
  tbody td:nth-child(5)::before{ content: 'ØªØ­Ø±ÙŠØ±: '; color:#64748b; font-weight:700; }

  /* Ù…Ù†Ø¹ ØªÙƒØ¨ÙŠØ± iOS ÙˆÙ‚Øª Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ */
  .input{ font-size: 16px; }
}

@media (min-width: 981px){
  .mobile-tabs{ display: none; }         /* Ù†Ø®ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙŠØ³ÙƒØªÙˆØ¨ */
}
/* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
@media (max-width:980px){
  .users-table thead{ display:none; }
  .users-table, .users-table tbody, .users-table tr, .users-table td{ display:block; width:100%; }
  .users-table tbody tr{ padding:.6rem .8rem; border-bottom:1px solid #f1f5f9; }
  .users-table td{ padding:.45rem 0; }
  .users-table td:nth-child(1)::before{ content:'Ø§Ù„Ø§Ø³Ù…: '; color:#64748b; font-weight:700; }
  .users-table td:nth-child(2)::before{ content:'Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„: '; color:#64748b; font-weight:700; }
  .users-table td:nth-child(3)::before{ content:'Ø§Ù„Ø¯ÙˆØ±: '; color:#64748b; font-weight:700; }
  .users-table td:nth-child(4)::before{ content:'Ø§Ù„Ø®Ø·Ø©/Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: '; color:#64748b; font-weight:700; }
  .users-table td:nth-child(5)::before{ content:'Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…: '; color:#64748b; font-weight:700; }
}
.badge{display:inline-block;padding:.25rem .5rem;border-radius:.4rem;font-size:.85rem}
.badge--basic{background:#e5e7eb;color:#111827}
.badge--premium{background:#2563eb;color:#fff}
.badge--vip{background:#d97706;color:#111}
/* ===== Users header & controls ===== */
.panel-head{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  gap:.75rem;
  margin-bottom:.75rem;
  flex-wrap:wrap;
}

.panel-head .panel-actions{
  display:flex;
  align-items:center;
  gap:.5rem;
  flex-wrap:wrap;
}

/* Ø´ÙƒÙ„ Ø­Ø¨ÙˆØ¨ (pill) Ù„Ù„Ù€ select Ùˆ input */
.panel-head .panel-actions .input,
.panel-head .panel-actions select,
.panel-head .panel-actions input{
  border-radius:999px;
  border-color:#d1d5db;
  box-shadow:0 4px 10px rgba(15,23,42,.04);
  height:2.4rem;
}

/* Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø© */
.input-search{
  position:relative;
  display:flex;
  align-items:center;
}

.input-search__icon{
  position:absolute;
  inset-inline-start:.75rem;
  color:#94a3b8;
  font-size:.9rem;
  pointer-events:none;
}

.input-search__field{
  padding-inline-start:2rem; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
}

/* Ø­Ø¬Ù… Ù…Ù†Ø·Ù‚ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙŠØ³ÙƒØªÙˆØ¨ */
@media (min-width:981px){
  #usersRole{ min-width:170px; }
  #usersSearch{ min-width:220px; }
}
.users-table td:nth-child(6)::before{ content:'Ø­Ø°Ù: '; color:#64748b; font-weight:700; }

</style>

</head>
<body>
<%- include('partials/navbar') %>
<main class="container layout">
  <aside class="sidebar" aria-label="Ù‚Ø§Ø¦Ù…Ø©">
    <nav class="menu">
      <button class="menu__item is-active" data-view="farms">Ø£Ø±Ø§Ø¶Ù Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</button>
      <button class="menu__item" data-view="contractors">Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</button>
      <button class="menu__item" data-view="banners">Ø¨Ø§Ù†Ø±Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button class="menu__item" data-view="subs">Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</button>
      <button class="menu__item" data-view="history">Ø§Ù„Ø¨Ù†Ø± Ø§Ù„Ù…ØªØ­Ø±Ùƒ Ø§Ù„Ø¹Ù„ÙˆÙŠ</button>
      <button class="menu__item" data-view="settings">Ø§Ù„Ø¨Ù†Ø± Ø§Ù„Ø³ÙÙ„ÙŠ Ø§Ù„Ø«Ø§Ø¨Øª</button>
      <button class="menu__item" data-view="users">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</button>
    </nav>
    <div class="sidebar__foot">Â© <span data-year></span> Farmers</div>
  </aside>

  <section class="content">

    <!-- 1) Farms Pending -->
    <section id="view-farms" class="panel">
      <div class="head">
        <h2>Ø£Ø±Ø§Ø¶Ù Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</h2>
        <div style="display:flex;gap:.5rem;align-items:center">
          <label class="muted">ØªØµÙÙŠØ© Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</label>
          <select id="areaFilter" class="input" style="width:220px">
            <option value="all">Ø§Ù„ÙƒÙ„</option>
          </select>
        </div>
      </div>
      <div id="farmsWrap" class="cards"></div>
      <p id="farmsEmpty" class="muted" hidden>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.</p>
      <div id="farmsPager" class="table-pager" style="display:flex;align-items:center;gap:.5rem;margin-top:.75rem;">
  <button type="button" class="btn btn--ghost btn--sm" id="farmsPrev">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
  <span class="muted" id="farmsInfo" style="font-size:.9rem"></span>
  <button type="button" class="btn btn--ghost btn--sm" id="farmsNext">Ø§Ù„ØªØ§Ù„ÙŠ</button>
</div>

    </section>

    <!-- 2) Contractors -->
<!-- Contractors as CARDS -->
<section id="view-contractors" class="panel">
  <div class="head"><h2>Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h2></div>
  <div style="display:flex;gap:.5rem;align-items:center;margin:.4rem 0 .8rem">
    <label class="muted">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
    <select id="contractorStatus" class="input" style="width:220px">
      <option value="pending" selected>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
      <option value="approved">Ù…Ù‚Ø¨ÙˆÙ„</option>
      <option value="rejected">Ù…Ø±ÙÙˆØ¶</option>
    </select>
  </div>

  <div id="contractorsCards" class="cards"></div>
  <p id="contractorsEmpty" class="muted" hidden>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¢Ù†.</p>
    <div id="contractorsPager"
       class="table-pager"
       style="display:flex;align-items:center;gap:.5rem;margin-top:.75rem;">
    <button type="button" class="btn btn--ghost btn--sm" id="contractorsPrev">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
    <span class="muted" id="contractorsInfo" style="font-size:.9rem"></span>
    <button type="button" class="btn btn--ghost btn--sm" id="contractorsNext">Ø§Ù„ØªØ§Ù„ÙŠ</button>
  </div>
</section>


    <!-- Ø¯Ø§Ø®Ù„ .content ÙÙŠ adminDashbord.ejs -->
<section id="view-banners" class="panel">
  <div class="head"><h2>Ø³Ù„Ø§ÙŠØ¯Ø§Øª Ø§Ù„Ù‡ÙŠØ±Ùˆ (Hero Swiper)</h2></div>

  <form id="hero-add" class="card" style="display:grid;gap:.6rem;max-width:560px" enctype="multipart/form-data">
    <div>
      <label class="muted">Ø§Ù„ØµÙˆØ±Ø©</label>
      <div class="filebox" dir="rtl">
        <input id="heroImgFile" type="file" name="imgFile" accept="image/*" required>
        <label for="heroImgFile" class="filebox__btn">ğŸ“¤ Ø§Ø®ØªØ± ØµÙˆØ±Ø©</label>
        <span class="filebox__name">Ù„Ù… ØªÙØ­Ø¯Ù‘ÙØ¯ ØµÙˆØ±Ø© Ø¨Ø¹Ø¯</span>
      </div>
    </div>

    <div>
      <label class="muted">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (ÙŠØ¯Ø¹Ù… span)</label>
      <input class="input" name="title" placeholder='Ù…Ø«Ø§Ù„: Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ù…Ø²Ø±Ø¹Ø©ØŸ <span class="accent">Ø§Ù†Ø¶Ù… Ø§Ù„Ø¢Ù†</span>'>
    </div>

    <div>
      <label class="muted">Ø§Ù„ÙˆØµÙ</label>
      <textarea class="input" name="lead" rows="3"></textarea>
    </div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem">
  <div>
    <label class="muted">Ù†Øµ Ø§Ù„Ø²Ø± Ø§Ù„Ø£ÙˆÙ„</label>
    <input class="input" name="btn1Text" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù† ÙƒØ¨Ø§Ø¦Ø¹">
  </div>
  <div>
    <label class="muted">Ø±Ø§Ø¨Ø· Ø§Ù„Ø²Ø± Ø§Ù„Ø£ÙˆÙ„</label>
    <input class="input" name="btn1Link" placeholder="/signup Ø£Ùˆ https://...">
  </div>

  <div>
    <label class="muted">Ù†Øµ Ø§Ù„Ø²Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ</label>
    <input class="input" name="btn2Text" placeholder="Ù…Ø«Ø§Ù„: Ø§ÙƒØªØ´Ù Ø§Ù„Ù…Ø²Ø§Ø±Ø¹">
  </div>
  <div>
    <label class="muted">Ø±Ø§Ø¨Ø· Ø§Ù„Ø²Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ</label>
    <input class="input" name="btn2Link" placeholder="/sale Ø£Ùˆ https://...">
  </div>
</div>

    <button class="btn btn--ok" type="submit">Ø¥Ø¶Ø§ÙØ©</button>
  </form>

  <script>
    (function(){
      const fi = document.getElementById('heroImgFile');
      const nameEl = document.querySelector('#hero-add .filebox__name');
      if (fi && nameEl) {
        fi.addEventListener('change', () => {
          const f = fi.files && fi.files[0];
          nameEl.textContent = f ? f.name : 'Ù„Ù… ØªÙØ­Ø¯Ù‘ÙØ¯ ØµÙˆØ±Ø© Ø¨Ø¹Ø¯';
        });
      }
    })();
  </script>

  <div style="margin:.8rem 0 .4rem"><strong>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</strong></div>
  <div id="hero-list" style="display:grid;gap:.6rem"></div>
  <p id="hero-empty" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù„Ø§ÙŠØ¯Ø§Øª Ø¨Ø¹Ø¯.</p>





  <div class="head" style="margin-top:1rem"><h3>Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø§ØµØ± Ù„ÙƒÙ„ Ø³ÙƒØ´Ù† (Upload)</h3></div>

  <!-- rentTop -->
  <form action="/admin/home/showcase/rentTop/item" method="post" enctype="multipart/form-data" class="card" style="display:grid;gap:.6rem;max-width:860px">
    <strong>Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¥Ù„Ù‰: Ø£Ø¬Ù…Ù„ Ø£Ø±Ø§Ø¶ÙŠ Ù„Ù„Ø¥ÙŠØ¬Ø§Ø± (rentTop)</strong>

    <div>
      <label class="muted">Ø§Ù„ØµÙˆØ±Ø©</label>
      <div class="filebox" dir="rtl">
        <input id="rentTopFile" type="file" name="imgFile" accept="image/*" required>
        <label for="rentTopFile" class="filebox__btn">ğŸ“¤ Ø§Ø®ØªØ± ØµÙˆØ±Ø©</label>
        <span class="filebox__name">Ù„Ù… ØªÙØ­Ø¯Ù‘ÙØ¯ ØµÙˆØ±Ø© Ø¨Ø¹Ø¯</span>
      </div>
    </div>

    <div>
      <label class="muted">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input class="input" name="title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù…Ø®ØªØµØ±">
    </div>

    <div>
      <label class="muted">ÙˆØµÙ Ù…Ø®ØªØµØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input class="input" name="desc" placeholder="Ù†Øµ ØªØ¹Ø±ÙŠÙÙŠ Ù‚ØµÙŠØ±">
    </div>

    <div>
      <label class="muted">Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙØ§ØµÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input class="input" name="link" placeholder="/rent Ø£Ùˆ /sale Ø£Ùˆ Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ">
    </div>

    <button type="submit" class="btn btn--ok">+ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù€ rentTop</button>
  </form>

  <!-- saleTop -->
  <form action="/admin/home/showcase/saleTop/item" method="post" enctype="multipart/form-data" class="card" style="display:grid;gap:.6rem;max-width:860px">
    <strong>Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¥Ù„Ù‰: Ø£Ø¬Ù…Ù„ Ø£Ø±Ø§Ø¶ÙŠ Ù„Ù„Ø¨ÙŠØ¹ (saleTop)</strong>

    <div>
      <label class="muted">Ø§Ù„ØµÙˆØ±Ø©</label>
      <div class="filebox" dir="rtl">
        <input id="saleTopFile" type="file" name="imgFile" accept="image/*" required>
        <label for="saleTopFile" class="filebox__btn">ğŸ“¤ Ø§Ø®ØªØ± ØµÙˆØ±Ø©</label>
        <span class="filebox__name">Ù„Ù… ØªÙØ­Ø¯Ù‘ÙØ¯ ØµÙˆØ±Ø© Ø¨Ø¹Ø¯</span>
      </div>
    </div>

    <div>
      <label class="muted">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input class="input" name="title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù…Ø®ØªØµØ±">
    </div>

    <div>
      <label class="muted">ÙˆØµÙ Ù…Ø®ØªØµØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input class="input" name="desc" placeholder="Ù†Øµ ØªØ¹Ø±ÙŠÙÙŠ Ù‚ØµÙŠØ±">
    </div>

    <div>
      <label class="muted">Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙØ§ØµÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input class="input" name="link" placeholder="/sale Ø£Ùˆ /rent Ø£Ùˆ Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ">
    </div>

    <button type="submit" class="btn btn--ok">+ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù€ saleTop</button>
  </form>

  <!-- bestContractors -->
  <form action="/admin/home/showcase/bestContractors/item" method="post" enctype="multipart/form-data" class="card" style="display:grid;gap:.6rem;max-width:860px">
    <strong>Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¥Ù„Ù‰: Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† (bestContractors)</strong>

    <div>
      <label class="muted">Ø§Ù„ØµÙˆØ±Ø©</label>
      <div class="filebox" dir="rtl">
        <input id="bestContractorsFile" type="file" name="imgFile" accept="image/*" required>
        <label for="bestContractorsFile" class="filebox__btn">ğŸ“¤ Ø§Ø®ØªØ± ØµÙˆØ±Ø©</label>
        <span class="filebox__name">Ù„Ù… ØªÙØ­Ø¯Ù‘ÙØ¯ ØµÙˆØ±Ø© Ø¨Ø¹Ø¯</span>
      </div>
    </div>

    <div>
      <label class="muted">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input class="input" name="title" placeholder="Ø§Ø³Ù…/Ø¹Ù†ÙˆØ§Ù† Ù…Ø®ØªØµØ±">
    </div>

    <div>
      <label class="muted">ÙˆØµÙ Ù…Ø®ØªØµØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input class="input" name="desc" placeholder="Ù†Øµ ØªØ¹Ø±ÙŠÙÙŠ Ù‚ØµÙŠØ±">
    </div>

    <div>
      <label class="muted">Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙØ§ØµÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input class="input" name="link" placeholder="/contractors Ø£Ùˆ ØµÙØ­Ø© Ù…Ù‚Ø§ÙˆÙ„">
    </div>

    <button type="submit" class="btn btn--ok">+ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù€ bestContractors</button>
  </form>

  <script>
    (function(){
      document.querySelectorAll('.filebox').forEach(box=>{
        const input  = box.querySelector('input[type="file"]');
        const nameEl = box.querySelector('.filebox__name');
        if (!input || !nameEl) return;
        input.addEventListener('change', ()=>{
          const f = input.files && input.files[0];
          nameEl.textContent = f ? f.name : 'Ù„Ù… ØªÙØ­Ø¯Ù‘ÙØ¯ ØµÙˆØ±Ø© Ø¨Ø¹Ø¯';
        });
      });
    })();
  </script>
<!-- ====== Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„ÙƒÙ„ Ø³ÙƒØ´Ù† + Ø§Ù„Ø­Ø°Ù ====== -->
<div class="head" style="margin-top:1rem"><h3>Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨ÙƒÙ„ Ø³ÙƒØ´Ù†</h3></div>

<!-- rentTop LIST -->
<section class="card" style="display:grid;gap:.6rem;max-width:100%">
  <strong>Ø£Ø¬Ù…Ù„ Ø£Ø±Ø§Ø¶ÙŠ Ù„Ù„Ø¥ÙŠØ¬Ø§Ø± (rentTop)</strong>
 <div id="list-rentTop" class="showcase-grid">
    <!-- ÙŠÙ…ØªÙ„Ø¦ Ø¹Ø¨Ø± JS -->
  </div>
</section>

<!-- saleTop LIST -->
<section class="card" style="display:grid;gap:.6rem;max-width:100%">
  <strong>Ø£Ø¬Ù…Ù„ Ø£Ø±Ø§Ø¶ÙŠ Ù„Ù„Ø¨ÙŠØ¹ (saleTop)</strong>
 <div id="list-saleTop" class="showcase-grid">
    <!-- ÙŠÙ…ØªÙ„Ø¦ Ø¹Ø¨Ø± JS -->
  </div>
</section>

<!-- bestContractors LIST -->
<section class="card" style="display:grid;gap:.6rem;max-width:100%">
  <strong>Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† (bestContractors)</strong>
 <div id="list-bestContractors" class="showcase-grid">
    <!-- ÙŠÙ…ØªÙ„Ø¦ Ø¹Ø¨Ø± JS -->
  </div>
</section>

</section>

    <!-- 3) Banners -->
    
    <!-- 4) Subs & Permissions -->
    <section id="view-subs" class="panel">
      <div class="head"><h2>Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h2></div>
      <div class="table-wrap">
<div style="display:flex;gap:.5rem;align-items:center;margin:.4rem 0 .8rem">
  <label class="muted">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
  <select id="subsStatus" class="input" style="width:220px">
    <option value="pending" selected>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
    <option value="approved">Ù…Ù‚Ø¨ÙˆÙ„</option>
  </select>
</div>
  

        <table>
          <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</th><th style="width:180px">ØªØ­Ø±ÙŠØ±</th></tr></thead>
          <tbody id="subsBody"></tbody>
        </table>
      </div>
      <div id="subsPager"
       class="table-pager"
       style="display:flex;align-items:center;gap:.5rem;margin-top:.75rem;">
    <button type="button" class="btn btn--ghost btn--sm" id="subsPrev">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
    <span class="muted" id="subsInfo" style="font-size:.9rem"></span>
    <button type="button" class="btn btn--ghost btn--sm" id="subsNext">Ø§Ù„ØªØ§Ù„ÙŠ</button>
  </div>
    </section>

    <!-- 5) History -->
   <section id="view-history" class="panel">
  <div class="head"><h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ù†Ø±Ø§Øª Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠØ© (Swiper)</h2></div>

  <div class="card" style="display:grid;gap:.6rem;max-width:720px">
    <label class="muted" style="display:flex;align-items:center;gap:.5rem">
      <input id="bnr-enabled" type="checkbox" /> ØªÙØ¹ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ù†Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹
    </label>

    <label class="muted" style="display:flex;align-items:center;gap:.5rem">
      Ø§Ø®ØªØ± Ø§Ù„ØµÙØ­Ø©:
      <select id="bnr-key" class="input" style="width:240px">
        <option value="sale-banners">ØµÙØ­Ø© Ø§Ù„Ø¨ÙŠØ¹</option>
        <option value="home-banners" style="display:none;">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</option>
        <option value="rent-banners">ØµÙØ­Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</option>
        <option value="contractors-banners">ØµÙØ­Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</option>
      </select>
    </label>

    <form id="bnr-add-form" style="display:grid;gap:.5rem">
      <div>
        <label class="muted">ØµÙˆØ±Ø©</label>
        <div class="filebox" dir="rtl">
          <input id="imgFile" type="file" name="imgFile" accept="image/*" />
          <label for="imgFile" class="filebox__btn">ğŸ“¤ Ø§Ø®ØªØ± ØµÙˆØ±Ø©</label>
          <span class="filebox__name">Ù„Ù… ØªÙØ­Ø¯Ù‘ÙØ¯ ØµÙˆØ±Ø© Ø¨Ø¹Ø¯</span>
        </div>
      </div>

      <div><label class="muted">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input class="input" name="title"></div>
      <div><label class="muted">Ø§Ù„Ù†Øµ</label><textarea class="input" name="text" rows="3"></textarea></div>
      <div><label class="muted">Ø§Ù„Ø±Ø§Ø¨Ø·</label><input class="input" name="link"></div>
      <div><label class="muted">Ù†Øµ Ø§Ù„Ø²Ø±</label><input class="input" name="btn" value="Ø§Ù„ØªÙØ§ØµÙŠÙ„"></div>
      <button class="btn btn--ok" type="submit">Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù†Ø±</button>
    </form>

    <hr>

    <div>
      <h3 class="title">Ø§Ù„Ø¨Ù†Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
      <div id="bnr-list" style="display:grid;gap:.6rem"></div>
      <p id="bnr-empty" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†Ø±Ø§Øª Ø¨Ø¹Ø¯.</p>
    </div>
  </div>

  <!-- Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ (placeholder Ù„ØªÙØ§Ø¯ÙŠ null) -->
  <div class="card" style="margin-top:.8rem">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</strong>
      <button id="clearHistory" class="btn btn--ghost btn--sm" type="button">ØªÙØ±ÙŠØº Ø§Ù„Ø³Ø¬Ù„</button>
    </div>
    <div id="historyList" style="margin-top:.6rem"></div>
  </div>
</section>
<% var _promo = (typeof promo !== 'undefined' && promo) ? promo : {}; %>

    <!-- 6) Admin settings -->
  <!-- 5) Users -->
<section id="view-users" class="panel" hidden>
   <header class="panel-head">
    <div>
      <h2>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</h2>
      <p class="muted">Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ù…Ù†ØµÙ‘Ø© Ø¨Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ± ÙˆØ§Ù„Ø®Ø·Ø©.</p>
    </div>

    <div class="panel-actions">
      <!-- Ø§Ù„Ø¯ÙˆØ± Ù…Ø¹ Ø´ÙƒÙ„ input Ù…ÙˆØ­Ù‘Ø¯ -->
      <select id="usersRole" class="input">
        <option value="all">ÙƒÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</option>
        <option value="owner">Ù…Ù„Ø§Ùƒ Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ</option>
        <option value="contractor">Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙˆÙ†</option>
        
      </select>

      <!-- Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¹Ø¯Ø³Ø© -->
      <div class="input-search">
        <span class="input-search__icon">ğŸ”</span>
        <input
          id="usersSearch"
          type="search"
          class="input input-search__field"
          placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙâ€¦"
        >
      </div>
    </div>
  </header>
  <div class="table-wrapper">
    <table class="data-table users-table">
      <thead>
        <tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
          <th>Ø§Ù„Ø¯ÙˆØ±</th>
          <th>Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th>
          <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</th>
          <th>Ø­Ø°Ù</th>
        </tr>
      </thead>
      <tbody id="usersBody"></tbody>
    </table>

    <p id="usersEmpty" class="empty" hidden>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±.</p>

    <!-- Ø§Ù„Ø¨Ø§Ø¬ÙŠÙ†Øº Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙ‚Ø· -->
    <div id="usersPager" class="table-pager" style="visibility:hidden">
      <button type="button" id="usersPrev" class="btn btn-sm" disabled>Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
      <span id="usersInfo" class="pager-info"></span>
      <button type="button" id="usersNext" class="btn btn-sm" disabled>Ø§Ù„ØªØ§Ù„ÙŠ</button>
    </div>
  </div>
</section>


    <!-- 6) Admin settings -->
<section id="view-settings" class="panel">
  <div class="head"><h2>Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù†Ø±Ø§Øª</h2></div>

  <form id="bottom-form" class="card" action="/admin/promo/bottom" method="post" enctype="multipart/form-data" style="display:grid;gap:.6rem;max-width:720px">
    <label class="muted" style="display:flex;align-items:center;gap:.5rem">
      Ø§Ø®ØªØ± Ø§Ù„ØµÙØ­Ø©:
      <select id="btm-key" name="__key__" class="input" style="width:240px">
        <option value="sale">ØµÙØ­Ø© Ø§Ù„Ø¨ÙŠØ¹</option>
        <option value="rent">ØµÙØ­Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</option>
        <option value="contractors">ØµÙØ­Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</option>
      </select>
    </label>

    <label class="muted" style="display:flex;align-items:center;gap:.5rem">
      <input type="checkbox" name="enabled"> ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø§Ù†Ø±
    </label>

    <div>
      <label class="muted">Ø§Ù„ØµÙˆØ±Ø©</label>
      <div class="filebox" dir="rtl">
        <input id="bottomImgFile" type="file" name="imgFile" accept="image/*">
        <label for="bottomImgFile" class="filebox__btn">ğŸ“¤ Ø§Ø®ØªØ± ØµÙˆØ±Ø©</label>
        <span class="filebox__name">Ù„Ù… ØªÙØ­Ø¯Ù‘ÙØ¯ ØµÙˆØ±Ø© Ø¨Ø¹Ø¯</span>
      </div>
    </div>

    <div><label class="muted">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input class="input" name="title"></div>
    <div><label class="muted">Ø§Ù„Ù†Øµ</label><textarea class="input" name="text" rows="3"></textarea></div>
    <div><label class="muted">Ø§Ù„Ø±Ø§Ø¨Ø·</label><input class="input" name="link"></div>
    <div><label class="muted">Ù†Øµ Ø§Ù„Ø²Ø±</label><input class="input" name="btn" value="Ø§Ù„ØªÙØ§ØµÙŠÙ„"></div>

    <div style="display:flex;gap:.5rem">
      <button class="btn btn--ok" type="submit">Ø­ÙØ¸</button>
      <button class="btn btn--ghost" type="reset">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </form>

  <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨Ù†Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ + Ø²Ø± Ø­Ø°Ù -->
  <section class="card" style="display:grid;gap:.6rem;max-width:720px;margin-top:.8rem">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</strong>
      <button id="btm-delete" class="btn btn--danger btn--sm" type="button">Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø± Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©</button>
    </div>

    <div id="btm-current">
      <p class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</p>
    </div>
    <section class="card" style="margin-top:1rem">
  <h3 style="margin-bottom:.5rem">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙÙˆØªØ±</h3>
  <form id="footerForm" class="grid" style="grid-template-columns:1fr 1fr; gap:.7rem">
    <input class="input" name="email"    placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ (Ù…Ø«Ø§Ù„: support@example.com)">
    <input class="input" name="phone"    placeholder="Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: +963 900 000 000)">
    <input class="input" name="whatsapp" placeholder="ÙˆØ§ØªØ³Ø§Ø¨ (Ø±Ù‚Ù… Ø¯ÙˆÙ„ÙŠ Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª)">
    <input class="input" name="address"  placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">

    <input class="input" name="facebook"  placeholder="Ø±Ø§Ø¨Ø· ÙÙŠØ³Ø¨ÙˆÙƒ">
    <input class="input" name="twitter"   placeholder="Ø±Ø§Ø¨Ø· ØªÙˆÙŠØªØ±/X">
    <input class="input" name="youtube"   placeholder="Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨">
    <input class="input" name="instagram" placeholder="Ø±Ø§Ø¨Ø· Ø¥Ù†Ø³ØªØºØ±Ø§Ù…">
    <input class="input" name="tiktok"    placeholder="Ø±Ø§Ø¨Ø· ØªÙŠÙƒØªÙˆÙƒ">

    <div style="grid-column:1/-1; display:flex; gap:.6rem; justify-content:flex-end">
      <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
    </div>
  </form>
</section>

  </section>

  <script>
    (function(){
      const form   = document.getElementById('bottom-form');
      const keySel = document.getElementById('btm-key');
      const nameEl = document.querySelector('#bottom-form .filebox__name');
      const file   = document.getElementById('bottomImgFile');
      const view   = document.getElementById('btm-current');
      const delBtn = document.getElementById('btm-delete');

      // Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø±
      if (file && nameEl) {
        file.addEventListener('change', () => {
          const f = file.files && file.files[0];
          nameEl.textContent = f ? f.name : 'Ù„Ù… ØªÙØ­Ø¯Ù‘ÙØ¯ ØµÙˆØ±Ø© Ø¨Ø¹Ø¯';
        });
      }

      // Ø£Ø¶Ù ?key=... Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ)
      form.addEventListener('submit', function(){
        if (!keySel) return;
        form.action = '/admin/promo/bottom?key=' + encodeURIComponent(keySel.value);
      });

      // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ù†Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
      async function fetchBottom(){
        const k = keySel.value || 'sale';
        const res = await fetch('/admin/promo/bottom?key=' + encodeURIComponent(k), {
          headers:{ 'accept':'application/json' }
        });
        if(!res.ok) throw new Error('load failed');
        const j = await res.json();
        return j && j.data ? j.data : { enabled:false };
      }

      // Ø±Ø³Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
      function renderBottomCard(doc){
        const d = doc || {};
        if (!d.enabled && !d.img && !d.title && !d.text){
          view.innerHTML = '<p class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</p>';
          return;
        }
        const img = d.img ? `<div style="width:160px;height:100px;border-radius:12px;overflow:hidden;border:1px solid #e5e7eb;background:#0b1a13"><img src="${d.img}" alt="" style="width:100%;height:100%;object-fit:cover"></div>` : '';
        view.innerHTML = `
          <div style="display:grid;grid-template-columns:160px 1fr;gap:.8rem;align-items:center">
            ${img || '<div class="muted">Ù„Ø§ ØµÙˆØ±Ø©</div>'}
            <div>
              <div style="display:flex;gap:.5rem;align-items:center;margin-bottom:.25rem">
                <span class="pill ${d.enabled ? 'p--approved':'p--pending'}">${d.enabled?'Ù…ÙØ¹Ù„':'ØºÙŠØ± Ù…ÙØ¹Ù„'}</span>
              </div>
              <div style="font-weight:900">${(d.title||'â€”')}</div>
              <div class="muted" style="white-space:pre-wrap">${(d.text||'')}</div>
              ${d.link ? `<div style="margin-top:.4rem"><a class="btn btn--ghost btn--sm" href="${d.link}" target="_blank" rel="noopener">${d.btn||'Ø§Ù„ØªÙØ§ØµÙŠÙ„'}</a></div>` : ''}
            </div>
          </div>
        `;
      }

      // Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (ÙŠØ¹ÙŠØ¯ ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ù„ØªÙƒÙˆÙ† ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„Ø© ÙˆÙØ§Ø±ØºØ©)
      async function deleteBottom(){
        const k = keySel.value || 'sale';
        const ok = confirm('Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø± Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©ØŸ');
        if(!ok) return;
        const res = await fetch('/admin/promo/bottom?key=' + encodeURIComponent(k), { method:'DELETE' });
        if (!res.ok) { alert('ØªØ¹Ø°Ø± Ø§Ù„Ø­Ø°Ù'); return; }
        await loadBottom();
      }

      async function loadBottom(){
        try{
          const doc = await fetchBottom();
          renderBottomCard(doc);
        }catch(e){
          console.error(e);
          view.innerHTML = '<p class="muted">ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>';
        }
      }

      keySel.addEventListener('change', loadBottom);
      delBtn.addEventListener('click', deleteBottom);

      // Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„
      loadBottom();
    })();
  </script>
</section>


</main>
<!-- Mobile bottom nav -->
<nav class="mobile-tabs" aria-label="Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹">
  <button class="mobile-tabs__btn is-active" data-view="farms">Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ</button>
  <button class="mobile-tabs__btn" data-view="contractors">Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙˆÙ†</button>
  <button class="mobile-tabs__btn" data-view="banners">Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª</button>
  <button class="mobile-tabs__btn" data-view="subs">Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</button>
  <button class="mobile-tabs__btn" data-view="history">Ø§Ù„Ø¹Ù„ÙˆÙŠ</button>
  <button class="mobile-tabs__btn" data-view="settings">Ø§Ù„Ø³ÙÙ„ÙŠ</button>
  <button class="mobile-tabs__btn" data-view="users">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</button>
</nav>

<!-- Drawer -->
<aside id="drawer" class="drawer" aria-hidden="true" role="dialog" aria-labelledby="drawerTitle">
  <div class="drawer__head"><h3 id="drawerTitle">Ù…Ø¹Ø§ÙŠÙ†Ø©</h3><button class="btn btn--ghost btn--sm" data-close>âœ•</button></div>
  <div id="drawerBody" class="drawer__body"></div>
</aside>
<div id="backdrop" class="backdrop" hidden></div>

<!-- Toasts -->
<div id="toasts" class="toasts" aria-live="polite" aria-atomic="true"></div>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
(() => {
  'use strict';

  /* ---------- Helpers ---------- */
  const qs  = (s, r=document)=>r.querySelector(s);
  const qsa = (s, r=document)=>Array.from(r.querySelectorAll(s));
  function esc(s){return (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
    function debounce(fn, ms){
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), ms);
    };
  }
  const toastBox = qs('#toasts');
  const fmt = new Intl.NumberFormat('en');
  function moneySym(c){ return c === 'SYP' ? 'Ù„.Ø³' : '$'; }
  function toast(msg, kind='ok', ms=2200){
    const t = document.createElement('div');
    t.className = 'toast ' + (kind==='ok' ? 'toast--ok' : 'toast--warn');
    t.textContent = msg;
    toastBox.appendChild(t);
    setTimeout(()=>t.remove(), ms);
  }
  qsa('[data-year]').forEach(el => el.textContent = String(new Date().getFullYear()));

  /* ---------- LocalStorage (Ù„Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙ‚Ø·) ---------- */
  const ADMIN_KEY = 'farmers_admin_actions';
  function load(k){ try{const raw=localStorage.getItem(k); return raw?JSON.parse(raw):null;}catch{return null} }
  function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  const adminState = load(ADMIN_KEY) || [];

  /* ---------- Navigation ---------- */
const views = {
  farms: qs('#view-farms'),
  contractors: qs('#view-contractors'),
  banners: qs('#view-banners'),
  subs: qs('#view-subs'),
  history: qs('#view-history'),
  settings: qs('#view-settings'),
  users: qs('#view-users'),            // â† Ø¬Ø¯ÙŠØ¯
};

  qsa('.menu__item').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      qsa('.menu__item').forEach(b=>b.classList.remove('is-active'));
      btn.classList.add('is-active');
      const t = btn.dataset.view;
      Object.entries(views).forEach(([k,sec])=>sec.classList.toggle('is-visible', k===t));
    });
  });

  /* =========================
     1) FARMS (Pending)
     ========================= */
    const farmsWrap  = qs('#farmsWrap');
  const farmsEmpty = qs('#farmsEmpty');
  const areaFilter = qs('#areaFilter');

  // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù€ pagination
  const farmsPager = qs('#farmsPager');
  const farmsPrev  = qs('#farmsPrev');
  const farmsNext  = qs('#farmsNext');
  const farmsInfo  = qs('#farmsInfo');

  let farmsPage  = 1;
  const FARMS_LIMIT = 20;
  let farmsPages = 1;

  async function uniqueAreas(){
    try{
      // Ù†Ø£Ø®Ø° ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© ÙƒØ¨ÙŠØ±Ø© ÙÙ‚Ø· Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ (ÙŠÙƒÙÙŠ)
      const res = await fetch('/admin/farms?status=pending&limit=500', { headers:{'Accept':'application/json'} });
      const json = await res.json();
      const lands = json.ok ? (json.data||[]) : [];
      const a = Array.from(new Set(lands.map(l=>l.area).filter(Boolean)));
      areaFilter.innerHTML = '<option value="all">Ø§Ù„ÙƒÙ„</option>' + a.map(x=>`<option>${esc(x)}</option>`).join('');
    }catch{
      areaFilter.innerHTML = '<option value="all">Ø§Ù„ÙƒÙ„</option>';
    }
  }

  async function apiGetPendingFarms(area, page = 1){
    const params = new URLSearchParams({
      status: 'pending',
      page: String(page),
      limit: String(FARMS_LIMIT)
    });

    if (area && area !== 'all') {
      params.set('area', area);
    }

    const res = await fetch('/admin/farms?' + params.toString(), {
      headers:{'Accept':'application/json'}
    });
    const json = await res.json();
    if (!json.ok) throw new Error('Failed to load');
    return json; // { ok, data, total, page, pages, limit }
  }

  async function apiApproveFarm(id){
    const res = await fetch('/admin/farms/'+id+'/approve', { method:'PATCH' });
    return res.json();
  }
  async function apiRejectFarm(id, note){
    const res = await fetch('/admin/farms/'+id+'/reject', {
      method:'PATCH',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ note: note||'' })
    });
    return res.json();
  }
  async function apiGetFarmById(id){
    const res = await fetch(`/admin/farms/${id}`, { headers:{'Accept':'application/json'} });
    const json = await res.json();
    if (!json.ok) throw new Error(json.msg || 'failed');
    return json.data;
  }

  function farmDetailsHTML(f){
   const kindText  = f.kind === 'rent' ? 'Ø¥ÙŠØ¬Ø§Ø±' : 'Ø¨ÙŠØ¹';

  const isRent  = String(f.kind || '').toLowerCase() === 'rent';
  const isDaily = String(f.rentPeriod || '').toLowerCase() === 'daily';
const owner = (f.owner && typeof f.owner === 'object') ? f.owner : null;
const ownerName  = owner?.name  || 'â€”';
const ownerEmail = owner?.email || 'â€”';
const ownerPhone = owner?.phone || 'â€”';

const ownerBlock = `
  <div style="border:1px solid #e5e7eb;border-radius:12px;padding:.6rem;margin-top:.35rem">
    <h4 style="margin:.1rem 0 .35rem">Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¶</h4>
    <div class="muted" style="display:grid;gap:.2rem">
      <div><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${esc(ownerName)}</div>
      <div><strong>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</strong> ${esc(ownerEmail)}</div>
      <div><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${esc(ownerPhone)}</div>
    </div>
  </div>
`;

  const priceText = isRent
    ? (moneySym(f.currency) + fmt.format(f.price) + (isDaily ? '/ÙŠÙˆÙ…' : '/Ø´Ù‡Ø±'))
    : (moneySym(f.currency) + fmt.format(f.price));
    const locLine   = f.location ? `${(f.location.address||'')} ${(f.location.lat!=null&&f.location.lng!=null)?`(${f.location.lat}, ${f.location.lng})`:''}` : 'â€”';

    const imgs = Array.isArray(f.photos) && f.photos.length
      ? f.photos.slice(0, 8).map(src => `
          <div style="border:1px solid #e5e7eb;border-radius:10px;overflow:hidden">
            <img src="${src}" alt="" style="width:100%;height:120px;object-fit:cover">
          </div>`).join('')
      : '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…Ø±ÙÙˆØ¹Ø©.</div>';

    const rejectNote = (f.status === 'rejected' && f.reviewNote)
      ? `<p class="muted" style="margin:.4rem 0 0"><strong>Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶:</strong> ${esc(f.reviewNote)}</p>`
      : '';
const video = f.videoUrl ? videoBlock(f.videoUrl) : '';
    return `
      <div style="display:grid;gap:.55rem">
        <h3 style="margin:.2rem 0">${esc(f.title || 'â€”')}</h3>
        ${ownerBlock}

        <div class="muted">
          ${kindText} â€¢ ${esc(f.area || 'â€”')} â€” ${esc(f.city || 'â€”')} â€¢ ${fmt.format(f.size||0)} Ù…Â² â€¢ ${priceText}
        </div>

        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:.4rem;margin:.35rem 0">
          ${imgs}
        </div>
${(f.poolDesc||'').trim() ? `
  <div><h4>ÙˆØµÙ Ø§Ù„Ù…Ø³Ø¨Ø­</h4><p style="white-space:pre-wrap">${esc(f.poolDesc)}</p></div>` : ''}

${(f.amenitiesDesc||'').trim() ? `
  <div><h4>ÙˆØµÙ Ø§Ù„Ù…Ø±Ø§ÙÙ‚</h4><p style="white-space:pre-wrap">${esc(f.amenitiesDesc)}</p></div>` : ''}

 ${(f.buildingDesc||'').trim() ? `
   <div><h4>ÙˆØµÙ Ø§Ù„Ø¨Ù†Ø§Ø¡</h4><p style="white-space:pre-wrap">${esc(f.buildingDesc)}</p></div>` : ''}

        <div>
          <p style="white-space:pre-wrap">${esc(f.description || f.desc || 'â€”')}</p>
        </div>
 ${video}
        <div>
          <p class="muted" style="margin:.1rem 0"><strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong> ${esc(locLine)}</p>
          <div id="previewMap" style="height:280px;border-radius:12px;overflow:hidden;border:1px solid #e5e7eb"></div>
        </div>

        <div style="margin-top:.3rem">
          <span class="pill ${
            f.status==='approved' ? 'p--approved' :
            f.status==='rejected' ? 'p--rejected' : 'p--pending'
          }">
            ${
              f.status==='approved' ? 'Ù…Ù‚Ø¨ÙˆÙ„' :
              f.status==='rejected' ? 'Ù…Ø±ÙÙˆØ¶' : 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'
            }
          </span>
          ${rejectNote}
        </div>
      </div>
    `;
  }

  function initPreviewMap(f){
    const box = document.getElementById('previewMap');
    if (!box) return;
    const lat = Number(f?.location?.lat);
    const lng = Number(f?.location?.lng);
    if (!isFinite(lat) || !isFinite(lng)) {
      box.innerHTML = '<div class="muted" style="padding:.5rem">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.</div>';
      return;
    }
    const map = L.map('previewMap', { scrollWheelZoom:false }).setView([lat, lng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    L.marker([lat, lng]).addTo(map);
  }

  async function renderFarms(page = 1){
    if (!farmsWrap) return;

    farmsWrap.innerHTML = '';
    farmsEmpty && (farmsEmpty.style.display = 'none');
    farmsPager && (farmsPager.style.visibility = 'hidden');

    const area = areaFilter ? areaFilter.value : 'all';

    let json;
    try{
      json = await apiGetPendingFarms(area, page);
    }catch(err){
      console.error(err);
      if (farmsEmpty){
        farmsEmpty.textContent = 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.';
        farmsEmpty.style.display = 'block';
      }
      return;
    }

    const items = json.data || [];
    farmsPage  = json.page || 1;
    farmsPages = json.pages || 1;
    const total = json.total || items.length;

    if (!items.length){
      if (farmsEmpty){
        farmsEmpty.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø±Ø§Ø¶Ù Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©.';
        farmsEmpty.style.display = 'block';
      }
      farmsWrap.innerHTML = '';
    } else {
      items.forEach(l=>{
        const cover = (l.photos && l.photos[0]) || 'assets/rent/featured-03.jpg';
        const loc = l.location ? ` â€¢ ğŸ“ ${esc(l.location.address || (l.location.lat+', '+l.location.lng))}` : '';
        const el = document.createElement('article');
        el.className='land';

        const isRent   = String(l.kind || '').toLowerCase() === 'rent';
        const isDaily  = String(l.rentPeriod || '').toLowerCase() === 'daily';
        const priceStr = isRent
          ? (moneySym(l.currency) + fmt.format(l.price) + (isDaily ? '/ÙŠÙˆÙ…' : '/Ø´Ù‡Ø±'))
          : (moneySym(l.currency) + fmt.format(l.price));

        el.innerHTML = `
          <div class="land__media"><img src="${cover}" alt=""></div>
          <div>
            <h3 class="title" style="margin:.1rem 0">${esc(l.title)}</h3>
            <div class="meta">
              ${l.kind==='sale'?'Ø¨ÙŠØ¹':'Ø¥ÙŠØ¬Ø§Ø±'} â€¢ ${esc(l.area)} â€” ${esc(l.city||'')}${loc}
              â€¢ ${priceStr} â€¢ ${fmt.format(l.size)} Ù…Â²
              <span class="pill p--pending">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
            </div>

            <div style="display:flex;gap:.4rem;flex-wrap:wrap;margin-top:.45rem">
              <button class="btn btn--ghost btn--sm" data-act="preview" data-id="${l._id}">Ù…Ø¹Ø§ÙŠÙ†Ø©</button>

              <form action="/admin/farms/${l._id}/approve?_method=PATCH" method="post" style="display:inline">
                <button class="btn btn--ok btn--sm" type="submit">Ù…ÙˆØ§ÙÙ‚Ø©</button>
              </form>

              <form action="/admin/farms/${l._id}/reject?_method=PATCH" method="post" style="display:inline-flex;gap:.35rem;align-items:center">
                <input type="text" name="note" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="min-width:140px" />
                <button class="btn btn--warn btn--sm" type="submit">Ø±ÙØ¶</button>
              </form>
            </div>
          </div>
        `;
        farmsWrap.appendChild(el);
      });
    }

    // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù€ pagination + Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    if (farmsInfo){
      const start = total ? ((farmsPage - 1) * FARMS_LIMIT) + 1 : 0;
      const end   = total ? (start + items.length - 1) : 0;
      farmsInfo.textContent = total
        ? `Ø¹Ø±Ø¶ ${start}â€“${end} Ù…Ù† ${total}`
        : '';
    }

    if (farmsPrev) farmsPrev.disabled = (farmsPage <= 1);
    if (farmsNext) farmsNext.disabled = (farmsPage >= farmsPages);

    if (farmsPager){
      farmsPager.style.visibility = (farmsPages > 1 ? 'visible' : 'hidden');
    }
  }
  // ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙŠØ¹ÙŠØ¯Ù†Ø§ Ù„Ø£ÙˆÙ„ ØµÙØ­Ø©
  areaFilter?.addEventListener('change', ()=>{
    farmsPage = 1;
    renderFarms(1);
  });

  // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ / Ø§Ù„ØªØ§Ù„ÙŠ
  farmsPrev?.addEventListener('click', ()=>{
    if (farmsPage > 1){
      renderFarms(farmsPage - 1);
    }
  });

  farmsNext?.addEventListener('click', ()=>{
    if (farmsPage < farmsPages){
      renderFarms(farmsPage + 1);
    }
  });

 

  farmsWrap.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act]'); if(!btn) return;
    const id = btn.dataset.id, act = btn.dataset.act;

    if (act==='preview'){
      try {
        const farm = await apiGetFarmById(id);
        const html = farmDetailsHTML(farm);
        openDrawer(html, 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø±Ø¶');
        setTimeout(()=> initPreviewMap(farm), 0);
      } catch(err) {
        console.error(err);
        toast('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„','warn');
      }
      return;
    }
  });

  /* =========================
     2) CONTRACTORS (API)
     ========================= */
  async function apiGetContractors(status, page = 1){
    const params = new URLSearchParams({
      status: status || 'pending',
      page:   String(page),
      limit:  String(CONTRACTORS_LIMIT),
    });
    const res  = await fetch('/admin/contractors?' + params.toString(), {
      headers:{ 'Accept':'application/json' }
    });
    const json = await res.json();
    if (!json.ok) throw new Error(json.msg || 'failed');
    return json; // { ok, data, total, page, pages, limit }
  }

  async function apiApproveContractor(id){
    const res = await fetch('/admin/contractors/'+id+'/approve', { method:'PATCH' });
    return res.json();
  }
  async function apiRejectContractor(id, note){
    const res = await fetch('/admin/contractors/'+id+'/reject', {
      method:'PATCH',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({note: note||''})
    });
    return res.json();
  }
  function parseYoutubeId(url){
  if (!url) return null;
  try {
    const u = new URL(url);
    // ØµÙŠØº Ù…Ø¯Ø¹ÙˆÙ…Ø©: https://youtu.be/ID  |  https://www.youtube.com/watch?v=ID  |  /embed/ID
    if (u.hostname.includes('youtu.be')) return u.pathname.slice(1);
    if (u.hostname.includes('youtube.com')) {
      if (u.searchParams.get('v')) return u.searchParams.get('v');
      const m = u.pathname.match(/\/embed\/([^/]+)/);
      if (m) return m[1];
    }
    return null;
  } catch { return null; }
}

function videoBlock(url){
  if (!url) return '';
  const id = parseYoutubeId(url);
  if (id){
    return `
      <div style="margin-top:.5rem">
        <div style="position:relative;padding-bottom:56.25%;height:0;border-radius:10px;overflow:hidden;border:1px solid #e5e7eb">
          <iframe src="https://www.youtube.com/embed/${id}"
                  title="Video" frameborder="0" allow="accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture;web-share"
                  allowfullscreen
                  style="position:absolute;inset:0;width:100%;height:100%"></iframe>
        </div>
      </div>`;
  }
  // Ù„Ùˆ ÙƒØ§Ù† Ø±Ø§Ø¨Ø· Ù…Ù„Ù ÙÙŠØ¯ÙŠÙˆ Ù…Ø¨Ø§Ø´Ø± mp4/webm/ogg:
  if (/\.(mp4|webm|ogg)$/i.test(url)) {
    return `
      <div style="margin-top:.5rem">
        <video controls style="width:100%;border-radius:10px;border:1px solid #e5e7eb" src="${url}"></video>
      </div>`;
  }
  // ØºÙŠØ± Ø°Ù„Ùƒ: Ø§Ø¹Ø±Ø¶Ù‡ ÙƒØ²Ø± ÙØªØ­
  return `
    <div style="margin-top:.5rem">
      <a class="btn btn--ghost btn--sm" href="${url}" target="_blank" rel="noopener">ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</a>
    </div>`;
}

// API: Ø§Ø­Ø¶Ø± Ù…Ù‚Ø§ÙˆÙ„ ÙˆØ§Ø­Ø¯ Ø¨Ø§Ù„ØªÙØ§ØµÙŠÙ„
  async function apiGetContractorById(id){
    const res  = await fetch('/admin/contractors/'+id, { headers:{'Accept':'application/json'} });
    const json = await res.json();
    if(!json.ok) throw new Error(json.msg||'failed');
    return json.data;
  }
  function renderVideoBlock(url){
    if(!url) return '<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆ.</div>';
    const u = url.trim();
    // YouTube
    const yt = u.match(/(?:youtu\.be\/|youtube\.com\/watch\?v=)([A-Za-z0-9_-]{11})/);
    if (yt) {
      return `
        <div class="video-wrap">
          <iframe width="100%" height="315"
            src="https://www.youtube.com/embed/${yt[1]}"
            title="YouTube video" frameborder="0"
            allowfullscreen></iframe>
        </div>`;
    }
    // Vimeo (Ù…Ø¨Ø³Ø·)
    const vm = u.match(/vimeo\.com\/(\d+)/);
    if (vm) {
      return `
        <div class="video-wrap">
          <iframe width="100%" height="315"
            src="https://player.vimeo.com/video/${vm[1]}"
            title="Vimeo video" frameborder="0"
            allowfullscreen></iframe>
        </div>`;
    }
    // Ù…Ù„Ù ÙÙŠØ¯ÙŠÙˆ Ù…Ø¨Ø§Ø´Ø±
    if (/\.(mp4|webm|ogg)(\?|$)/i.test(u)) {
      return `<video controls style="width:100%;max-height:360px"><source src="${u}"></video>`;
    }
    // ØºÙŠØ± Ø°Ù„Ùƒ: Ø±Ø§Ø¨Ø· ÙÙ‚Ø·
    return `<a href="${u}" target="_blank" rel="noopener">ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</a>`;
  }

 
// ÙŠØ¨Ù†ÙŠ Ù…Ø¹Ø§ÙŠÙ†Ø© ÙƒØ§Ù…Ù„Ø© (ØµÙˆØ±ØŒ Ù†Ø¨Ø°Ø©ØŒ Ø®Ø¯Ù…Ø§ØªØŒ Ø¨ÙŠØ§Ù†Ø§Øª ØªÙˆØ§ØµÙ„ØŒ Ù…Ø¹Ø±Ø¶ Ø£Ø¹Ù…Ø§Ù„)
function contractorDetailsHTML(c){
    const esc = s => (s??'').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const services = Array.isArray(c.services) ? c.services.join('ØŒ ') : (c.services||'');
    const gallery  = Array.isArray(c.photos) && c.photos.length
      ? c.photos.map(src => `
          <div style="border:1px solid #e5e7eb;border-radius:12px;overflow:hidden">
            <img src="${src}" alt="" style="width:100%;height:140px;object-fit:cover">
          </div>`).join('')
      : '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ø£Ø¹Ù…Ø§Ù„.</div>';

    const avatar = c.avatar || '/assets/contractor-1.jpg';
    const badge =
      c.status==='approved' ? '<span class="pill p--approved">Ù…Ù‚Ø¨ÙˆÙ„</span>' :
      c.status==='rejected' ? '<span class="pill p--rejected">Ù…Ø±ÙÙˆØ¶</span>'  :
                              '<span class="pill p--pending">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>';

    const rejectNote = (c.status==='rejected' && c.reviewNote)
      ? `<div class="muted" style="margin-top:.35rem"><strong>Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶:</strong> ${esc(c.reviewNote)}</div>`
      : '';

    // â† Ø¥Ø¶Ø§ÙØ© Ø¨Ù„ÙˆÙƒ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¥Ù† ÙˆÙØ¬Ø¯
     const videoBlock = renderVideoBlock(c.videoUrl);

    return `
      <div style="display:grid;gap:.8rem">
        <div style="display:grid;grid-template-columns:96px 1fr;gap:.8rem;align-items:center">
          <div style="width:96px;height:96px;border-radius:12px;overflow:hidden;border:1px solid #e5e7eb;background:#0b1a13">
            <img src="${avatar}" alt="" style="width:100%;height:100%;object-fit:cover">
          </div>
          <div>
            <h3 class="title" style="margin:.1rem 0">${esc(c.name || c.companyName || 'â€”')} ${badge}</h3>
            <div class="muted">
              ${esc(c.companyName || 'â€”')} â€¢ ${esc(c.city||'â€”')} â€” ${esc(c.region||'â€”')}
              <br>Ø§Ù„Ø®Ø¯Ù…Ø§Øª: ${esc(services || 'â€”')}
              <br>Ø§Ù„Ù‡Ø§ØªÙ: ${esc(c.phone || 'â€”')} â€¢ Ø§Ù„Ø¨Ø±ÙŠØ¯: ${esc(c.email || 'â€”')}
            </div>
          </div>
        </div>

        <div>
          <h4 style="margin:.2rem 0">Ù†Ø¨Ø°Ø©</h4>
          <p style="white-space:pre-wrap">${esc(c.bio || c.description || 'â€”')}</p>
        </div>

        ${videoBlock}

        <div>
          <h4 style="margin:.2rem 0">Ù…Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</h4>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem">${gallery}</div>
        </div>

        ${rejectNote}
      </div>
    `;
  }
  const contractorStatus  = qs('#contractorStatus');
  const contractorsCards  = qs('#contractorsCards');
  const contractorsEmpty  = qs('#contractorsEmpty');
    const contractorsPager = qs('#contractorsPager');
  const contractorsPrev  = qs('#contractorsPrev');
  const contractorsNext  = qs('#contractorsNext');
  const contractorsInfo  = qs('#contractorsInfo');

  let contractorsPage  = 1;
  const CONTRACTORS_LIMIT = 20;
  let contractorsPages = 1;

  function pill(status){
    if (status==='approved') return '<span class="pill p--approved">Ù…Ù‚Ø¨ÙˆÙ„</span>';
    if (status==='rejected') return '<span class="pill p--rejected">Ù…Ø±ÙÙˆØ¶</span>';
    return '<span class="pill p--pending">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>';
  }

  async function renderContractorCards(page = 1){
    contractorsCards.innerHTML = '';
    contractorsEmpty.hidden = true;
    if (contractorsPager) contractorsPager.style.visibility = 'hidden';

    let json;
    try {
      json = await apiGetContractors(contractorStatus.value, page);
    } catch (e) {
      console.error(e);
      contractorsEmpty.textContent = 'ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†.';
      contractorsEmpty.hidden = false;
      return;
    }

    const rows   = json.data || [];
    const total  = json.total || 0;
    contractorsPage  = json.page  || 1;
    contractorsPages = json.pages || 1;

    if (!rows.length){
      contractorsEmpty.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¢Ù†.';
      contractorsEmpty.hidden = false;
    }

    rows.forEach(c => {
      const avatar   = c.avatar || '/assets/contractor-1.jpg';
      const services = Array.isArray(c.services) ? c.services.join('ØŒ ') : (c.services||'');

      const card = document.createElement('article');
      card.className = 'card';
      card.innerHTML = `
        <div style="display:grid;grid-template-columns:96px 1fr;gap:.8rem;align-items:flex-start">
          <div style="width:96px;height:96px;border-radius:12px;overflow:hidden;border:1px solid #e5e7eb;background:#0b1a13">
            <img src="${avatar}" alt="" style="width:100%;height:100%;object-fit:cover">
          </div>
          <div>
            <h3 class="title" style="margin:.15rem 0">${esc(c.name || c.companyName || 'â€”')}</h3>
            <div class="meta">
              ${esc(c.companyName || 'â€”')} â€¢ ${esc(c.city||'â€”')} â€” ${esc(c.region||'â€”')}
              <br>Ø§Ù„Ø®Ø¯Ù…Ø§Øª: ${esc(services || 'â€”')}
              <br>Ø§Ù„Ù‡Ø§ØªÙ: ${esc(c.phone || 'â€”')} â€¢ Ø§Ù„Ø¨Ø±ÙŠØ¯: ${esc(c.email || 'â€”')}
            </div>
            <div style="margin-top:.35rem">${pill(c.status)}</div>

            <div style="display:flex;gap:.4rem;flex-wrap:wrap;margin-top:.6rem">
              <button class="btn btn--ghost btn--sm" data-act="view" data-id="${c._id}">Ù…Ø¹Ø§ÙŠÙ†Ø©</button>

              <form action="/admin/contractors/${c._id}/approve?_method=PATCH" method="post" style="display:inline">
                <button class="btn btn--ok btn--sm" type="submit">Ù…ÙˆØ§ÙÙ‚Ø©</button>
              </form>

              <form action="/admin/contractors/${c._id}/reject?_method=PATCH" method="post" style="display:inline-flex;gap:.35rem;align-items:center">
                <input type="text" name="note" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" class="input" style="width:200px;padding:.3rem .5rem"/>
                <button class="btn btn--danger btn--sm" type="submit">Ø±ÙØ¶</button>
              </form>
            </div>
          </div>
        </div>
      `;
      contractorsCards.appendChild(card);
    });

    // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù€ Pagination
    if (contractorsInfo){
      const start = total ? ((contractorsPage - 1) * CONTRACTORS_LIMIT) + 1 : 0;
      const end   = total ? (start + rows.length - 1) : 0;
      contractorsInfo.textContent = total
        ? `Ø¹Ø±Ø¶ ${start}â€“${end} Ù…Ù† ${total}`
        : '';
    }

    if (contractorsPrev) contractorsPrev.disabled = (contractorsPage <= 1);
    if (contractorsNext) contractorsNext.disabled = (contractorsPage >= contractorsPages);

    if (contractorsPager){
      contractorsPager.style.visibility = (contractorsPages > 1 ? 'visible' : 'hidden');
    }
  }

document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act="view-contractor"][data-id]');
    if(!btn) return;
    try{
      const doc = await apiGetContractorById(btn.dataset.id);
      const html = contractorDetailsHTML(doc);
      openDrawer(html, 'Ù…Ù„Ù Ù…Ù‚Ø§ÙˆÙ„');
    }catch(err){
      console.error(err);
      toast('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„','warn');
    }
  });
document.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-act="view"][data-id]');
  if (!btn) return;
  const id = btn.dataset.id;

  try {
    const contractor = await apiGetContractorById(id);
    const html = contractorDetailsHTML(contractor);
    openDrawer(html, 'Ù…Ù„Ù Ù…Ù‚Ø§ÙˆÙ„');
  } catch (err) {
    console.error(err);
    toast('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„','warn');
  }
});
  contractorStatus?.addEventListener('change', () => {
    contractorsPage = 1;
    renderContractorCards(1);
  });

  contractorsPrev?.addEventListener('click', () => {
    if (contractorsPage > 1) renderContractorCards(contractorsPage - 1);
  });

  contractorsNext?.addEventListener('click', () => {
    if (contractorsPage < contractorsPages) renderContractorCards(contractorsPage + 1);
  });


  /* =========================
     3) Banners (Demo)
     ========================= */
 
  /* =========================
     4) Subscriptions (Demo)
     ========================= */
     const subsStatus = qs('#subsStatus');

  const subsBody = qs('#subsBody');
    const subsPager = qs('#subsPager');
  const subsPrev  = qs('#subsPrev');
  const subsNext  = qs('#subsNext');
  const subsInfo  = qs('#subsInfo');

  let subsPage  = 1;
  const SUBS_LIMIT = 20;
  let subsPages = 1;

  let users = [
    {id:'U-OWN', name:'Ù…Ø§Ù„Ùƒ',      email:'owner@example.com',      plan: 'Basic',  perms:['Ø¨ÙŠØ¹','Ø¥ÙŠØ¬Ø§Ø±','Ø¨Ø§Ù†Ø±']},
    {id:'U-CON', name:'Ù…Ù‚Ø§ÙˆÙ„ (API)', email:'contractor@example.com', plan: 'Basic', perms:['Ù…Ù‚Ø§ÙˆÙ„','Ø¨Ø§Ù†Ø±']},
  ];
async function apiGetSubs(status, page = 1){
  const params = new URLSearchParams({
    status: status || 'pending',
    page:   String(page),
    limit:  String(SUBS_LIMIT),
  });
  const res  = await fetch('/admin/subscriptions?' + params.toString(), {
    headers:{ 'Accept':'application/json' }
  });
  const json = await res.json();
  if (!json.ok) throw new Error(json.msg || 'failed');
  return json; // { ok, data, total, page, pages, limit }
}

async function apiApproveSub(id){
  const res = await fetch('/admin/subscriptions/'+id+'/approve', { method:'PATCH' });
  return res.json();
}
async function apiRejectSub(id, note){
  const res = await fetch('/admin/subscriptions/'+id+'/reject', {
    method:'PATCH',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ note: note || '' })
  });
  return res.json();
}

function fmtDateISO(d){
  try{ const dt = new Date(d); 
       if (isNaN(dt)) return 'â€”';
       return dt.toLocaleDateString('ar-SY', { year:'numeric', month:'2-digit', day:'2-digit' });
  }catch(_){ return 'â€”'; }
}

function dedupeLatestApproved(rows){
    // Ø±ØªØ¨ Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹: approvedAt Ø«Ù… createdAt Ø§Ø­ØªÙŠØ§Ø·ÙŠÙ‹Ø§
    const sorted = rows.slice().sort((a,b)=>{
      const da = new Date(a.approvedAt || a.createdAt || 0).getTime();
      const db = new Date(b.approvedAt || b.createdAt || 0).getTime();
      return db - da; // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
    });
    const pick = new Map(); // userId -> row
    for (const r of sorted){
      const uid = (r.user && (r.user._id || r.user)) || null;
      if (!uid) continue;
      if (!pick.has(uid)) pick.set(uid, r); // Ø¨Ù…Ø§ Ø¥Ù†Ù†Ø§ Ù…Ø±ØªØ¨ÙŠÙ†ØŒ Ø£ÙˆÙ„ Ù…Ø±Ø© = Ø£Ø­Ø¯Ø«
    }
    return Array.from(pick.values());
  }

   async function renderSubs(page = 1){
    subsBody.innerHTML = '';
    if (subsPager) subsPager.style.visibility = 'hidden';

    const state = (subsStatus?.value || 'pending');

    let json;
    try {
      json = await apiGetSubs(state, page);
    } catch (e) {
      console.error(e);
      subsBody.innerHTML = `<tr><td colspan="5" class="muted">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª.</td></tr>`;
      return;
    }

    const rows  = json.data || [];
    const total = json.total || 0;
    subsPage  = json.page  || 1;
    subsPages = json.pages || 1;

    if (!rows.length){
      subsBody.innerHTML = `<tr><td colspan="5" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø©.</td></tr>`;
    } else {
      const fmt = d => {
        try{
          const x = new Date(d);
          if (isNaN(x)) return 'â€”';
          return x.toLocaleDateString('ar-EG', { year:'numeric', month:'2-digit', day:'2-digit' });
        }catch{ return 'â€”'; }
      };

      rows.forEach(r => {
        const tr = document.createElement('tr');
        const uname  = r.user?.name  || r.name  || 'â€”';
        const email  = r.user?.email || 'â€”';
        const plan   = r.plan || r.user?.subscriptionTier || 'â€”';
        const expAt  = r.user?.subscriptionExpiresAt ? fmt(r.user.subscriptionExpiresAt) : 'â€”';

        if (state === 'approved') {
          tr.innerHTML = `
            <td>${esc(uname)}</td>
            <td>${esc(email)}</td>
            <td><span class="pill ${plan==='VIP'?'p--approved':'p--pending'}">${esc(plan)}</span></td>
            <td class="muted">ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ: <strong>${esc(expAt)}</strong></td>
            <td class="muted">â€”</td>
          `;
        } else {
          tr.innerHTML = `
            <td>${esc(uname)}</td>
            <td>${esc(email)}</td>
            <td><span class="pill ${plan==='VIP'?'p--approved':'p--pending'}">${esc(plan)}</span></td>
            <td>${esc(r.notes || '')}</td>
            <td style="display:flex;gap:.4rem;align-items:center">
              <select class="input" data-dur="${r._id}" style="width:120px">
                <option value="month" selected>Ø´Ù‡Ø±</option>
                <option value="year">Ø³Ù†Ø©</option>
              </select>
              <button class="btn btn--ok btn--sm" data-sub="${r._id}" data-act="sub-approve">Ù…ÙˆØ§ÙÙ‚Ø©</button>
              <form class="inline-reject" data-sub="${r._id}" style="display:inline-flex;gap:.35rem;align-items:center">
                <input type="text" name="note" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" class="input" style="width:180px;padding:.3rem .5rem"/>
                <button class="btn btn--danger btn--sm" type="submit">Ø±ÙØ¶</button>
              </form>
            </td>
          `;
        }

        subsBody.appendChild(tr);
      });
    }

    // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù€ Pagination
    if (subsInfo){
      const start = total ? ((subsPage - 1) * SUBS_LIMIT) + 1 : 0;
      const end   = total ? (start + (json.data || []).length - 1) : 0;
      subsInfo.textContent = total
        ? `Ø¹Ø±Ø¶ ${start}â€“${end} Ù…Ù† ${total}`
        : '';
    }

    if (subsPrev) subsPrev.disabled = (subsPage <= 1);
    if (subsNext) subsNext.disabled = (subsPage >= subsPages);

    if (subsPager){
      subsPager.style.visibility = (subsPages > 1 ? 'visible' : 'hidden');
    }
  }

subsStatus?.addEventListener('change', () => {
  subsPage = 1;
  renderSubs(1);
});

subsPrev?.addEventListener('click', () => {
  if (subsPage > 1) renderSubs(subsPage - 1);
});

subsNext?.addEventListener('click', () => {
  if (subsPage < subsPages) renderSubs(subsPage + 1);
});

subsBody?.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-act="sub-approve"][data-sub]');
  if (!btn) return;
  const id = btn.dataset.sub;

  const durSel = subsBody.querySelector(`select[data-dur="${id}"]`);
  const duration = durSel ? durSel.value : 'month';

  try {
    const res = await fetch('/admin/subscriptions/'+id+'/approve', {
      method:'PATCH',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ duration })
    });
    const json = await res.json();
    if (!json.ok) throw new Error(json.msg||'failed');
    toast('ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ','ok');
    renderSubs();
  } catch(err) {
    console.error(err); toast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©','warn');
  }
});

subsBody?.addEventListener('submit', async (e)=>{
  const form = e.target.closest('form.inline-reject[data-sub]');
  if (!form) return;
  e.preventDefault();
  const id = form.dataset.sub;
  const note = new FormData(form).get('note') || '';
  try{
    const r = await fetch('/admin/subscriptions/'+id+'/reject', {
      method:'PATCH',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ note })
    });
    const j = await r.json();
    if(!j.ok) throw 0;
    toast('ØªÙ… Ø§Ù„Ø±ÙØ¶','ok');
    renderSubs(1);
  }catch(_){ toast('ØªØ¹Ø°Ø± Ø§Ù„Ø±ÙØ¶','warn'); }
});
// ===== Users (API + Render) =====
async function apiGetUsers({ q = '', role = 'all', page = 1 } = {}) {
  const params = new URLSearchParams();
  if (q)    params.set('q', q);
  if (role) params.set('role', role);
  params.set('page',  String(page));
  params.set('limit', String(USERS_LIMIT));

  const r = await fetch('/admin/users?' + params.toString(), {
    headers: { 'Accept': 'application/json' }
  });
  const j = await r.json();
  if (!j.ok) throw new Error(j.msg || 'failed');
  return j; // { ok, data, total, page, pages, limit }
}

const usersBody   = qs('#usersBody');
const usersEmpty  = qs('#usersEmpty');
const usersSearch = qs('#usersSearch');
const usersRole   = qs('#usersRole');
const usersPager = qs('#usersPager');
const usersPrev  = qs('#usersPrev');
const usersNext  = qs('#usersNext');
const usersInfo  = qs('#usersInfo');

let usersPage  = 1;
const USERS_LIMIT = 20;
let usersPages = 1;

  function dateFmt(d){
    const dt = new Date(d);
    if (Number.isNaN(dt.getTime())) return 'â€”';
    return dt.toLocaleDateString('ar-SY', { year:'numeric', month:'2-digit', day:'2-digit' });
  }

  // Ø´Ø§Ø±Ø© Ø§Ù„Ø®Ø·Ø©
  function planBadge(plan){
    const p = String(plan || '').trim().toLowerCase();
    const text = (p === 'vip') ? 'VIP' : (p === 'premium' ? 'Premium' : 'Basic');
    const cls  = (p === 'vip') ? 'badge--vip' : (p === 'premium' ? 'badge--premium' : 'badge--basic');
    return `<span class="badge ${cls}">${text}</span>`;
  }
function roleAr(role){
  const v = String(role||'').trim().toLowerCase();
  if (v === 'owner' || v === 'landowner') return 'Ù…Ø§Ù„Ùƒ';
  if (v === 'contractor') return 'Ù…Ù‚Ø§ÙˆÙ„';
  if (v === 'admin') return 'Ù…Ø´Ø±Ù';
  if (v === 'user') return 'Ù…Ø³ØªØ®Ø¯Ù…';
  return 'Ù…Ø³ØªØ®Ø¯Ù…';
}
async function renderUsers(page = 1){
  if (!usersBody) return;
  usersBody.innerHTML = '';
  if (usersPager) usersPager.style.visibility = 'hidden';

  let json;
  try {
    json = await apiGetUsers({
      role: usersRole?.value || 'all',
      q:    usersSearch?.value?.trim() || '',
      page
    });
  } catch (_) {
    json = { data: [], total: 0, page: 1, pages: 1 };
  }

  const rows  = json.data  || [];
  const total = json.total || 0;
  usersPage   = json.page  || 1;
  usersPages  = json.pages || 1;

  usersEmpty.hidden = rows.length > 0;

  rows.forEach(u=>{
    const tr = document.createElement('tr');
    const name   = u.name || 'â€”';
    const email  = u.email || 'â€”';
    const role   = u.role || u.type || 'user';
    const plan   = u.subscriptionTier || u.plan || 'Basic';
    const expRaw = u.subscriptionExpiresAt || u.subscriptionUntil;
    const exp    = expRaw ? dateFmt(expRaw) : 'â€”';
    const joined = u.createdAt ? dateFmt(u.createdAt) : 'â€”';
    const roleLabel = roleAr(role);
const badgeClass = (String(role).toLowerCase() === 'admin') ? 'badge--vip' : 'badge--basic';
const tierLabel = `${planBadge(plan)}${exp !== 'â€”' ? `<div class="muted" style="font-size:.85rem">ÙŠÙ†ØªÙ‡ÙŠ: ${exp}</div>` : ''}`;
const createdAt = joined;

   const isAdmin = String(role).toLowerCase() === 'admin';

tr.innerHTML = `
  <td>${name}</td>
  <td>${email}</td>
  <td><span class="badge ${badgeClass}">${roleLabel}</span></td>
  <td>${tierLabel}</td>
  <td>${createdAt}</td>

 <td class="actions">
  <button class="btn btn--outline btn--sm"
          data-act="user-details"
          data-id="${esc(u._id)}"
          data-label="${esc(u.name || u.email || 'Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…')}">
    ØªÙØ§ØµÙŠÙ„
  </button>

  ${isAdmin ? '' : `<button class="btn btn--danger btn--sm" data-act="user-delete"
    data-id="${esc(u._id)}" data-label="${esc(u.name || u.email || 'Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…')}">Ø­Ø°Ù</button>`}
</td>

`;

    usersBody.appendChild(tr);
  });

  // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø§Ø¬ÙŠÙ†Øº
  if (usersInfo){
    const start = total ? ((usersPage - 1) * USERS_LIMIT) + 1 : 0;
    const end   = total ? (start + rows.length - 1) : 0;
    usersInfo.textContent = total
      ? `Ø¹Ø±Ø¶ ${start}â€“${end} Ù…Ù† ${total}`
      : '';
  }

  if (usersPrev) usersPrev.disabled = (usersPage <= 1);
  if (usersNext) usersNext.disabled = (usersPage >= usersPages);

  if (usersPager){
    usersPager.style.visibility = (usersPages > 1 ? 'visible' : 'hidden');
  }
}
usersSearch?.addEventListener('input', debounce(() => {
  usersPage = 1;
  renderUsers(1);
}, 300));

usersRole?.addEventListener('change', () => {
  usersPage = 1;
  renderUsers(1);
});

usersPrev?.addEventListener('click', () => {
  if (usersPage > 1) renderUsers(usersPage - 1);
});

usersNext?.addEventListener('click', () => {
  if (usersPage < usersPages) renderUsers(usersPage + 1);
});
// âœ… 1) Ø¶Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø¹Ø¯ renderUsers Ù…Ø¨Ø§Ø´Ø±Ø©
async function openUserDetails(userId, label = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…') {
  // openDrawer(html, title) âœ…
  openDrawer(`<div style="padding:10px;color:#64748b;font-weight:800">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`, label);

  try {
    const r = await fetch(`/admin/users/${userId}/details`, {
      headers: { 'Accept': 'application/json' }
    });

    const j = await r.json().catch(() => ({}));
    if (!r.ok || j.ok === false) throw new Error(j.msg || 'details_failed');

    const u = j.user || {};
    const farms = Array.isArray(j.farms) ? j.farms : [];
    const c = j.contractor;

    const fmtDate = (d) => d ? new Date(d).toLocaleDateString('ar') : 'â€”';
    const esc2 = (x) => String(x ?? '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));

    const farmsHtml = farms.length
      ? `<ul style="margin:8px 0 0; padding:0 18px; line-height:1.9">
          ${farms.map(f => `<li><b>${esc2(f.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†')}</b> â€” ${esc2(f.kind || '')} â€” ${esc2(f.status || '')}</li>`).join('')}
        </ul>`
      : `<div style="color:#64748b;font-weight:800;margin-top:6px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø±Ø§Ø¶ÙŠ/Ù…Ø²Ø§Ø±Ø¹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….</div>`;

    const contractorHtml = c
      ? `<div style="margin-top:8px; line-height:1.9">
          <div><b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> ${esc2(c.status || 'â€”')}</div>
          <div><b>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©:</b> ${esc2(c.companyName || 'â€”')}</div>
          <div><b>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</b> ${esc2(c.region || c.city || 'â€”')}</div>
          <div><b>Ø§Ù„Ø®Ø¯Ù…Ø§Øª:</b> ${(Array.isArray(c.services) && c.services.length) ? c.services.map(esc2).join('ØŒ ') : 'â€”'}</div>
          <div style="color:#64748b"><b>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:</b> ${fmtDate(c.createdAt)}</div>
          <div><b>Ù†Ù‚Ø±Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨:</b> ${Number(c.whatsappClicks || 0)}</div>

        </div>`
      : `<div style="color:#64748b;font-weight:800;margin-top:6px">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ Ù…Ù„Ù Ù…Ù‚Ø§ÙˆÙ„.</div>`;

    const html = `
      <div style="display:grid;gap:10px">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div class="stat"><div class="k">Ø§Ù„Ø§Ø³Ù…</div><div class="v">${esc2(u.name || 'â€”')}</div></div>
          <div class="stat"><div class="k">Ø§Ù„Ø¯ÙˆØ±</div><div class="v">${esc2(u.role || 'â€”')}</div></div>
          <div class="stat"><div class="k">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</div><div class="v">${esc2(u.email || 'â€”')}</div></div>
          <div class="stat"><div class="k">Ø§Ù„Ù‡Ø§ØªÙ</div><div class="v">${esc2(u.phone || 'â€”')}</div></div>
          <div class="stat"><div class="k">Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</div><div class="v">${esc2(u.subscriptionTier || 'â€”')}</div></div>
          <div class="stat"><div class="k">Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</div><div class="v">${fmtDate(u.subscriptionExpiresAt)}</div></div>
        </div>

        <div style="height:1px;background:rgba(0,0,0,.08);border-radius:999px;margin:6px 0"></div>

        <div>
          <div style="font-weight:900;color:#0b4e45">Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ/Ø§Ù„Ù…Ø²Ø§Ø±Ø¹ (${farms.length})</div>
          ${farmsHtml}
        </div>

        <div style="height:1px;background:rgba(0,0,0,.08);border-radius:999px;margin:6px 0"></div>

        <div>
          <div style="font-weight:900;color:#0b4e45">Ù…Ù„Ù Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</div>
          ${contractorHtml}
        </div>
      </div>
    `;

    openDrawer(html, `Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${esc2(u.name || u.email || '')}`);
  } catch (err) {
    console.error(err);
    openDrawer(`<div style="padding:10px;color:#b42318;font-weight:900">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ âŒ</div>`, label);
  }
}


// âœ… 2) ÙˆÙ‡Ø°Ø§ Ù‡Ùˆ event listener Ø§Ù„Ù…ÙˆØ­Ø¯ (ØªÙØ§ØµÙŠÙ„ + Ø­Ø°Ù)
usersBody?.addEventListener('click', async (e) => {
  // ØªÙØ§ØµÙŠÙ„
  const detailsBtn = e.target.closest('[data-act="user-details"]');
  if (detailsBtn) {
    const userId = detailsBtn.dataset.id;
    const label = detailsBtn.dataset.label || 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
    return openUserDetails(userId, label);
  }

  // Ø­Ø°Ù
  const delBtn = e.target.closest('[data-act="user-delete"]');
  if (!delBtn) return;

  const userId = delBtn.dataset.id;
  const label = delBtn.dataset.label || 'Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';

  const ok = confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ${label} Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ\nØ³ÙŠØªÙ… Ø£ÙŠØ¶Ø§Ù‹ Ø¥Ø®ÙØ§Ø¡ Ù…Ø­ØªÙˆØ§Ù‡ Ø§Ù„Ù…Ø±ØªØ¨Ø· (Ù…Ø²Ø§Ø±Ø¹/Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†).`);
  if (!ok) return;

  delBtn.disabled = true;

  try {
    const r = await fetch(`/admin/users/${userId}`, {
      method: 'DELETE',
      headers: { 'Accept': 'application/json' }
    });

    const j = await r.json().catch(() => ({}));
    if (!r.ok || j.ok === false) throw new Error(j.msg || 'delete_failed');

    await renderUsers(usersPage);
    toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
  } catch (err) {
    console.error(err);
    delBtn.disabled = false;
    toast('ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… âŒ', 'error');
  }
});


// Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø£ÙˆÙ„
document.addEventListener('DOMContentLoaded', () => renderUsers(1));

  /* =========================
     5) History
     ========================= */
  const historyList = qs('#historyList');
  function logAction(type, text, payload={}){
    const item = {id: 'A-'+Date.now(), ts: new Date().toISOString(), type, text, payload};
    adminState.push(item);
    save(ADMIN_KEY, adminState);
    renderHistory();
  }
  function renderHistory(){
    if (!historyList) return;
    if (!adminState.length){ historyList.innerHTML='<p class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø¨Ø¹Ø¯.</p>'; return; }
    
    historyList.innerHTML = adminState.slice().reverse().map(a=>{
      const d = new Date(a.ts).toLocaleString('ar-EG');
      return `<div style="display:grid;grid-template-columns:140px 1fr;gap:.6rem;padding:.45rem .2rem;border-bottom:1px dashed #e5e7eb">
        <div class="muted">${d}</div>
        <div><strong>${esc(a.text)}</strong><div class="muted" style="font-size:.92rem">#${esc(a.type)}</div></div>
      </div>`;
    }).join('');
  }
  qs('#clearHistory')?.addEventListener('click', ()=>{ if(!confirm('ØªÙØ±ÙŠØº Ø§Ù„Ø³Ø¬Ù„ØŸ')) return; save(ADMIN_KEY, []); adminState.length=0; renderHistory(); });

  /* ---------- Drawer ---------- */
  const drawer   = qs('#drawer');
  const backdrop = qs('#backdrop');
  qs('[data-close]')?.addEventListener('click', closeDrawer);
  backdrop?.addEventListener('click', closeDrawer);
  function openDrawer(html, title='Ù…Ø¹Ø§ÙŠÙ†Ø©'){
    qs('#drawerTitle').textContent = title;
    qs('#drawerBody').innerHTML = html;
    drawer.setAttribute('aria-hidden','false'); backdrop.hidden=false;
  }
  function closeDrawer(){ drawer.setAttribute('aria-hidden','true'); backdrop.hidden=true; }

  /* ---------- Admin Settings ---------- */
  const adminSettings = qs('#adminSettings');
  const ADMIN_PREFS_KEY='farmers_admin_prefs';
  const prefs = load(ADMIN_PREFS_KEY) || {name:'Admin',noti:'all'};
  function fillPrefs(){ if(!adminSettings) return; adminSettings.name.value=prefs.name; adminSettings.noti.value=prefs.noti; }
  adminSettings?.addEventListener('submit',(e)=>{
    e.preventDefault();
    const fd = new FormData(adminSettings);
    prefs.name = (fd.get('name')||'Admin').toString();
    prefs.noti = fd.get('noti')||'all';
    save(ADMIN_PREFS_KEY, prefs); toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª','ok');
  });

  /* ---------- Init ---------- */
  function init(){
    uniqueAreas();
    renderFarms(1);


    // Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙˆÙ† (Ø¨Ø§Ù„Ù€API)
    renderContractorCards(1);

    // Ø§Ù„Ø¯ÙŠÙ…Ùˆ
    renderSubs(1);
    renderHistory();
    fillPrefs();
    renderUsers();

  }
  init();

  /* ---------- Misc ---------- */
  qs('#refreshBtn')?.addEventListener('click', ()=>{ location.reload(); });
  qs('#logoutBtn')?.addEventListener('click', ()=> toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ (ØªØ¬Ø±ÙŠØ¨ÙŠ)','warn'));
})();
</script>
<script>
(async function bannerAdmin(){
  const $  = (s, r=document)=>r.querySelector(s);

  // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  const listBox = $('#bnr-list');
  const empty   = $('#bnr-empty');
  const form    = $('#bnr-add-form');
  const enabled = $('#bnr-enabled');
  const keySel  = $('#bnr-key');

  if (!listBox || !empty || !form || !enabled) return;

  // Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø§ÙØªØ±Ø§Ø¶ÙŠ home-banners Ø¥Ù† Ù„Ù… ÙŠÙˆØ¬Ø¯ select)
  function currentKey(){ return keySel && keySel.value ? keySel.value : 'home-banners'; }

  // Ù…Ø³Ø§Ø±Ø§Øª REST ØªØ³ØªØ®Ø¯Ù… param :key
  const paths = {
    get:      key => `/admin/promo/banners/${encodeURIComponent(key)}`,
    add:      key => `/admin/promo/banners/${encodeURIComponent(key)}`,
    enabled:  key => `/admin/promo/banners/${encodeURIComponent(key)}/enabled`,
    del: (key,id) => `/admin/promo/banners/${encodeURIComponent(key)}/${encodeURIComponent(id)}`
  };

  // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„Ø±ÙØ¹
  const fileInput = form.querySelector('#imgFile');
  const fileName  = form.querySelector('.filebox__name');
  fileInput?.addEventListener('change', () => {
    const f = fileInput.files && fileInput.files[0];
    if (fileName) fileName.textContent = f ? f.name : 'Ù„Ù… ØªÙØ­Ø¯Ù‘ÙØ¯ ØµÙˆØ±Ø© Ø¨Ø¹Ø¯';
  });

  async function load(){
    try{
      const r = await fetch(paths.get(currentKey()), { headers:{'Accept':'application/json'} });
      const j = await r.json();
      if(!j.ok) throw 0;
      const d = j.data || {enabled:false, items:[]};
      enabled.checked = !!d.enabled;
      render(d.items||[]);
    }catch(_){
      enabled.checked = false;
      render([]);
    }
  }

  function render(items){
    listBox.innerHTML = '';
    if(!items || !items.length){
      empty.hidden = false;
      return;
    }
    empty.hidden = true;

    items
      .slice()
      .sort((a,b)=>(a.order||0)-(b.order||0))
      .forEach(it=>{
        const el = document.createElement('div');
        el.style.cssText='border:1px solid #e5e7f0;border-radius:12px;padding:.6rem;display:grid;grid-template-columns:140px 1fr;gap:.6rem;align-items:center';
        el.innerHTML = `
          <div style="width:140px;height:90px;border-radius:10px;overflow:hidden;background:#0b1a13">
            <img src="${it.img}" alt="" style="width:100%;height:100%;object-fit:cover">
          </div>
          <div>
            <div style="font-weight:800">${it.title||'â€”'}</div>
            <div class="muted" style="font-size:.95rem;white-space:pre-wrap">${it.text||''}</div>
            <div style="display:flex;gap:.4rem;margin-top:.4rem">
              ${it.link ? `<a class="btn btn--ghost btn--sm" href="${it.link}" target="_blank" rel="noopener">ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·</a>` : ''}
              <button class="btn btn--danger btn--sm" data-del="${it._id}">Ø­Ø°Ù</button>
            </div>
          </div>`;
        listBox.appendChild(el);
      });
  }

  // Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù†Ø± (Ø±ÙØ¹ Ù…Ù„Ù)
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    try{
      const r = await fetch(paths.add(currentKey()), { method:'POST', body: fd });
      const j = await r.json(); if(!j.ok) throw 0;
      form.reset();
      if (fileName) fileName.textContent = 'Ù„Ù… ØªÙØ­Ø¯Ù‘ÙØ¯ ØµÙˆØ±Ø© Ø¨Ø¹Ø¯';
      await load();
    }catch(_){
      alert('ØªØ¹Ø°Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø§Ù†Ø±');
    }
  });

  // ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø¨Ù†Ø±Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø­Ø§Ù„ÙŠ
  enabled.addEventListener('change', async ()=>{
    try{
      const r = await fetch(paths.enabled(currentKey()), {
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ enabled: enabled.checked })
      });
      const j = await r.json(); if(!j.ok) throw 0;
    }catch(_){
      alert('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙØ¹ÙŠÙ„');
      enabled.checked = !enabled.checked;
    }
  });

  // Ø­Ø°Ù Ø¹Ù†ØµØ±
  listBox.addEventListener('click', async (e)=>{
    const btn = e.target.closest('[data-del]');
    if(!btn) return;
    if(!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ù†Ø±ØŸ')) return;
    try{
      const r = await fetch(paths.del(currentKey(), btn.dataset.del), { method:'DELETE' });
      const j = await r.json(); if(!j.ok) throw 0;
      await load();
    }catch(_){
      alert('ØªØ¹Ø°Ø± Ø§Ù„Ø­Ø°Ù');
    }
  });

  // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  keySel?.addEventListener('change', load);

  // Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„
  load();
})();
</script>

<script>
(async function heroAdmin(){
  const $  = (s,r=document)=>r.querySelector(s);
  const list  = $('#hero-list');
  const empty = $('#hero-empty');
  const form  = $('#hero-add');

  async function load(){
    try{
      const r = await fetch('/admin/hero/slides', { headers:{'Accept':'application/json'} });
      const j = await r.json(); if(!j.ok) throw 0;
      render(j.data||[]);
    }catch{ render([]); }
  }
  function render(items){
    list.innerHTML = '';
    if(!items.length){ empty.hidden=false; return; }
    empty.hidden = true;
    items.forEach(it=>{
      const el = document.createElement('div');
      el.style.cssText = 'border:1px solid #e5e7f0;border-radius:12px;padding:.6rem;display:grid;grid-template-columns:140px 1fr;gap:.6rem;align-items:center';
      el.innerHTML = `
        <div style="width:140px;height:90px;border-radius:10px;overflow:hidden;background:#0b1a13">
          <img src="${it.img}" alt="" style="width:100%;height:100%;object-fit:cover">
        </div>
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem">
            <div style="font-weight:800">${it.title||'â€”'}</div>
            <label class="muted" style="display:flex;gap:.35rem;align-items:center">
              <input type="checkbox" data-on="${it._id}" ${it.enabled?'checked':''}> Ù…ÙØ¹Ù‘Ù„
            </label>
          </div>
          <div class="muted" style="font-size:.95rem;white-space:pre-wrap">${it.lead||''}</div>
          <div style="display:flex;gap:.4rem;margin-top:.4rem;align-items:center">
            <label class="muted">Ø§Ù„ØªØ±ØªÙŠØ¨:</label>
            <input type="number" value="${it.order||0}" data-order="${it._id}" class="input" style="width:110px">
            <button class="btn btn--danger btn--sm" data-del="${it._id}">Ø­Ø°Ù</button>
          </div>
        </div>`;
      list.appendChild(el);
    });
  }

  // âœ… Ù‡Ù†Ø§ Ø§Ù„ØªØºÙŠÙŠØ±: Ù†Ø±Ø³Ù„ FormData Ø¨Ø¯ÙˆÙ† Content-Type ÙŠØ¯ÙˆÙŠ
  form?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    try{
      const r = await fetch('/admin/hero/slides', {
        method:'POST',
        body: fd
      });
      const j = await r.json(); if(!j.ok) throw 0;
      form.reset(); load();
    }catch{ alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©'); }
  });

  list?.addEventListener('change', async (e)=>{
    const idOn = e.target.closest('input[type="checkbox"][data-on]')?.dataset.on;
    const idOrd= e.target.closest('input[type="number"][data-order]')?.dataset.order;
    try{
      if (idOn){
        await fetch('/admin/hero/slides/'+idOn, {
          method:'PATCH', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ enabled: e.target.checked })
        });
      }
      if (idOrd){
        const val = Number(e.target.value)||0;
        await fetch('/admin/hero/slides/'+idOrd, {
          method:'PATCH', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ order: val })
        });
      }
    }catch{}
  });

  list?.addEventListener('click', async (e)=>{
    const id = e.target.closest('[data-del]')?.dataset.del;
    if(!id) return;
    if(!confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙŠØ­Ø©ØŸ')) return;
    try{
      const r = await fetch('/admin/hero/slides/'+id, { method:'DELETE' });
      const j = await r.json(); if(!j.ok) throw 0;
      load();
    }catch{ alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­Ø°Ù'); }
  });

  load();
})();
</script>

<script>
(function homeShowcaseAdmin(){
  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));

  const form   = $('#hs-form');
  const itemsB = $('#hs-items');
  const addBtn = $('#hs-add-item');
  const viewB  = $('#hs-view');
if (!form || !itemsB || !addBtn || !viewB) return;
  const itemTpl = (data={}, idx=0)=>`
    <div class="card" data-idx="${idx}" style="display:grid;gap:.5rem">
      <div style="display:grid;grid-template-columns:160px 1fr;gap:.6rem;align-items:center">
        <div style="width:160px;height:96px;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;background:#0b1a13">
          <img src="${data.img||''}" alt="" style="width:100%;height:100%;object-fit:cover" onerror="this.src='/public/assets/farm-default.jpg'">
        </div>
        <div style="display:grid;gap:.5rem">
          <input class="input" name="img"   placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©" value="${data.img||''}">
          <input class="input" name="title" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"     value="${data.title||''}">
          <input class="input" name="desc"  placeholder="Ø§Ù„ÙˆØµÙ"       value="${data.desc||''}">
          <input class="input" name="link"  placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø²Ø±"   value="${data.link||''}">
          <input class="input" name="order" type="number" placeholder="Ø§Ù„ØªØ±ØªÙŠØ¨" value="${Number(data.order||0)}">
          <button type="button" class="btn btn--danger btn--sm" data-del>Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±</button>
        </div>
      </div>
    </div>`;

  function readItemsFromUI(){
    return $$('#hs-items .card').map(card=>{
      const get = n=>card.querySelector(`[name="${n}"]`)?.value || '';
      return {
        img: get('img'), title:get('title'), desc:get('desc'), link:get('link'),
        order: Number(get('order')||0)
      };
    });
  }

  function fillUIItems(items){
    itemsB.innerHTML = '';
    items.slice(0,3).forEach((it,i)=> itemsB.insertAdjacentHTML('beforeend', itemTpl(it,i)));
  }

  addBtn?.addEventListener('click', ()=>{
    const cur = readItemsFromUI();
    if (cur.length >= 3) return alert('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 3 Ø¹Ù†Ø§ØµØ±');
    itemsB.insertAdjacentHTML('beforeend', itemTpl({}, cur.length));
  });

  itemsB?.addEventListener('click', (e)=>{
    const del = e.target.closest('[data-del]');
    if(!del) return;
    del.closest('.card')?.remove();
  });

  async function loadAll(){
    try{
      const r = await fetch('/admin/home/showcase', { headers:{'Accept':'application/json'} });
      const j = await r.json(); if(!j.ok) throw 0;
      renderView(j.data || []);
    }catch{ renderView([]); }
  }

  function renderView(rows){
    if (!viewB) return;
    viewB.innerHTML = rows.map(row=>{
      const items = (row.items||[]).slice().sort((a,b)=>(a.order||0)-(b.order||0));
      return `
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>${row.key}</strong>
            <span class="pill ${row.enabled?'p--approved':'p--pending'}">${row.enabled?'Ù…ÙØ¹Ù„':'ØºÙŠØ± Ù…ÙØ¹Ù„'}</span>
          </div>
          <div class="muted">${row.title||''}</div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:.6rem;margin-top:.5rem">
            ${items.map(it=>`
              <div style="border:1px solid #e5e7eb;border-radius:12px;overflow:hidden">
                <img src="${it.img}" alt="" style="width:100%;height:120px;object-fit:cover">
                <div style="padding:.5rem">
                  <div style="font-weight:800">${it.title||'â€”'}</div>
                  <div class="muted" style="font-size:.92rem">${it.desc||''}</div>
                </div>
              </div>`).join('')}
          </div>
        </div>`;
    }).join('');
  }

  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙØªØ§Ø­ (ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§)
  form?.key?.addEventListener('change', async ()=>{
    const key = form.key.value;
    try{
      const r = await fetch('/admin/home/showcase', { headers:{'Accept':'application/json'} });
      const j = await r.json(); if(!j.ok) throw 0;
      const row = (j.data||[]).find(x=>x.key===key);
      form.enabled.checked = !!row?.enabled;
      form.title.value = row?.title || '';
      fillUIItems(row?.items || []);
    }catch{
      form.enabled.checked = true;
      form.title.value = '';
      fillUIItems([]);
    }
  });

  form?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const key = form.key.value;
    const payload = {
      title: form.title.value || '',
      enabled: form.enabled.checked,
      items: readItemsFromUI()
    };
    try{
      const r = await fetch('/admin/home/showcase/'+encodeURIComponent(key), {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const j = await r.json(); if(!j.ok) throw 0;
      alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
      loadAll();
    }catch{ alert('ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸'); }
  });

  // Ø¥Ù‚Ù„Ø§Ø¹
  (async function init(){
    // Ø­Ù…Ù‘Ù„ Ø£ÙˆÙ„ Ø³ÙƒØ´Ù† Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
    await loadAll();
    form.key.dispatchEvent(new Event('change'));
  })();
})();
</script>
<script>
  // ====== Showcase viewer & delete ======
  async function fetchShowcases(){
    const res = await fetch('/admin/home/showcase', { headers:{'accept':'application/json'} });
    if(!res.ok) throw new Error('Failed to load showcases');
    const json = await res.json();
    return (json && json.data) ? json.data : [];
  }

  function byKey(rows){
    const map = { rentTop:{items:[]}, saleTop:{items:[]}, bestContractors:{items:[]} };
    rows.forEach(r => { if(r && r.key && map[r.key] !== undefined) map[r.key] = r; });
    return map;
  }

  function escapeHtml(s){
    return (s||'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

  function renderShowcaseList(containerId, items, key){
    const wrap = document.getElementById(containerId);
    if(!wrap) return;
    wrap.innerHTML = '';

    if(!Array.isArray(items) || !items.length){
      wrap.innerHTML = '<p class="muted" style="grid-column:1/-1">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø¨Ø¹Ø¯.</p>';
      return;
    }

    items.forEach((it, idx) => {
      const card = document.createElement('div');
      card.className = 'showcase-card';

      card.innerHTML = `
        <div class="showcase-thumb">
          ${it.img ? `<img src="${it.img}" alt="">` : ''}
        </div>

        <div class="showcase-body">
          <div class="showcase-title">${escapeHtml(it.title || '')}</div>
          <div class="showcase-desc">${escapeHtml(it.desc || '')}</div>
        </div>

        <div class="showcase-actions">
          <div>
            ${it.link ? `<a class="showcase-link" href="${it.link}" target="_blank" rel="noopener">Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙØ§ØµÙŠÙ„</a>` : '<span class="muted">â€”</span>'}
          </div>
          <div>
            <button class="btn btn--danger btn--sm" data-key="${key}" data-idx="${idx}">Ø­Ø°Ù</button>
          </div>
        </div>
      `;
      wrap.appendChild(card);
    });

    // ØªÙÙˆÙŠØ¶ Ø§Ù„Ø­Ø°Ù (Ù…Ø±Ù‘Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„ØªÙƒØ±Ø§Ø±)
    wrap.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-key]');
      if(!btn) return;
      const k = btn.getAttribute('data-key');
      const i = btn.getAttribute('data-idx');
      if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±ØŸ')) return;
      try{
        const res = await fetch(`/admin/home/showcase/${encodeURIComponent(k)}/item/${encodeURIComponent(i)}`, {
          method:'DELETE',
          headers:{ 'accept':'application/json' }
        });
        if(!res.ok) throw new Error('Delete failed');
        await loadShowcaseLists();
        (window.showToast ? showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù','ok') : null);
      }catch(err){
        console.error(err);
        (window.showToast ? showToast('ØªØ¹Ø°Ø± Ø§Ù„Ø­Ø°Ù','warn') : null);
      }
    }, { once:true });
  }

  async function loadShowcaseLists(){
    const rows = await fetchShowcases();
    const map  = byKey(rows);
    renderShowcaseList('list-rentTop',         map.rentTop.items || [],         'rentTop');
    renderShowcaseList('list-saleTop',         map.saleTop.items || [],         'saleTop');
    renderShowcaseList('list-bestContractors', map.bestContractors.items || [], 'bestContractors');
  }

  // Ø´ØºÙ‘Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ Ù…Ø§ ØªÙØªØ­ Ø§Ù„ØµÙØ­Ø©
  (async function initShowcaseLists(){
    try { await loadShowcaseLists(); } catch(e){ console.error(e); }
  })();
</script>
<script>
  // â€¦ Ø¨Ø¹Ø¯ ØªØ¹Ø±ÙŠÙ views = { farms, contractors, banners, subs, history, settings }
  (function navUnify(){
    const sideBtns   = Array.from(document.querySelectorAll('.menu__item'));
    const mobileBtns = Array.from(document.querySelectorAll('.mobile-tabs__btn'));
    const views = {
      farms:        document.querySelector('#view-farms'),
      contractors:  document.querySelector('#view-contractors'),
      banners:      document.querySelector('#view-banners'),
      subs:         document.querySelector('#view-subs'),
      history:      document.querySelector('#view-history'),
      settings:     document.querySelector('#view-settings'),
        users:        document.querySelector('#view-users'),

    };

    function activateView(name){
      Object.entries(views).forEach(([k,sec])=>{
        if (sec) sec.classList.toggle('is-visible', k===name);
      });
      sideBtns.forEach(b=> b.classList.toggle('is-active', b.dataset.view===name));
      mobileBtns.forEach(b=> b.classList.toggle('is-active', b.dataset.view===name));
    }

    // Ø§Ø±Ø¨Ø· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
    sideBtns.forEach(btn=>{
      btn.addEventListener('click', ()=> activateView(btn.dataset.view));
    });
    // Ø§Ø±Ø¨Ø· Ø§Ù„Ø³ÙÙ„ÙŠ
    mobileBtns.forEach(btn=>{
      btn.addEventListener('click', ()=> activateView(btn.dataset.view));
    });

    // ØªÙØ¹ÙŠÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ
    activateView('farms');
  })();
</script>
<script>
(() => {
  const fForm = document.getElementById('footerForm');
  if (!fForm) return;

  // Ø­Ù…Ù‘Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  (async function loadFooter(){
    try{
      const res  = await fetch('/admin/site/footer', { headers: { 'accept':'application/json' }});
      const json = await res.json();
      const d = json?.data || {};
      for (const [k,v] of Object.entries(d)) {
        const el = fForm.querySelector(`[name="${k}"]`);
        if (el) el.value = v || '';
      }
    }catch(e){ console.error(e); }
  })();

  // Ø§Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…
   fForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(fForm);
    const payload = Object.fromEntries(fd.entries());

    const res = await fetch('/admin/site/footer', {
      method: 'POST',
      headers: {
        'content-type': 'application/json',
        'accept': 'application/json'
      },
      body: JSON.stringify(payload)
    });
    const j = await res.json().catch(()=>({}));
    if (j?.ok) (window.showToast? showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸','ok') : alert('ØªÙ… Ø§Ù„Ø­ÙØ¸'));
    else       (window.showToast? showToast('ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸','warn') : alert('ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸'));
  });
})();
</script>

</body>
</html>
