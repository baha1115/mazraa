<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title><%= farm ? (farm.title + ' â€” ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±') : 'Ø§Ù„Ù…Ø²Ø±Ø¹Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©' %></title>
  <meta name="description" content="ØªÙØ§ØµÙŠÙ„ Ù…Ø²Ø±Ø¹Ø© Ù„Ù„Ø¥ÙŠØ¬Ø§Ø±: Ø§Ù„ØµÙˆØ±ØŒ Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŒ Ø§Ù„ÙˆØµÙØŒ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø­Ø§Ù„Ø©."/>

  <!-- Ù…Ù„ÙØ§ØªÙƒ Ø§Ù„Ø¹Ø§Ù…Ø© -->
  <link rel="stylesheet" href="/public/styles/rentandfarmdetail.css"/>

  <% 
    // Ù…ØªÙ‰ Ù†Ø­ØªØ§Ø¬ SwiperØŸ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø²Ø§Ø±Ø¹ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø§Ù„Ùƒ Ø£Ùˆ Ù‚Ø§Ø¦Ù…Ø© top-rent
    const _hasOwner    = Array.isArray(sameOwnerFarms) && sameOwnerFarms.length > 0;
    const _hasTopRent  = Array.isArray(topRent) && topRent.length > 0;
    const _needsSwiper = _hasOwner || _hasTopRent;
  %>
  <% if (_needsSwiper) { %>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
  <% } %>

  <style>
    /* ===== Gallery Grid (compact & with +more) ===== */
.gallery-grid{
  display:grid;
  gap: var(--gg,8px);
  grid-template-columns: repeat(12, 1fr);
}

.gallery-grid .g-item{
  position:relative;
  border-radius:12px;
  overflow:hidden;
  background:#f1f5f9;
}

.gallery-grid .g-item img{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  object-position:center;
  display:block;
}

/* Ø£ÙˆÙ„ ØµÙˆØ±Ø© ÙˆØ§Ø³Ø¹Ø© 16:9ØŒ Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØµÙˆØ± Ù…Ø±Ø¨Ù‘Ø¹Ø© ØµØºÙŠØ±Ø© */
.gallery-grid .g-item.is-hero{
  grid-column:span 8;
  aspect-ratio:16/9;
}
.gallery-grid .g-item.is-rect{
  grid-column:span 4;
  aspect-ratio:1/1;
}

/* Ø´Ø§Ø±Ø© +Ø¹Ø¯Ø¯ */
.g-item .g-more{
  position:absolute;
  inset:0;
  display:grid;
  place-items:center;
  background:rgba(15,23,42,.45);
  color:#fff;
  font-weight:900;
  font-size:clamp(18px, 4vw, 28px);
  letter-spacing:.5px;
  backdrop-filter: blur(2px);
}

/* ØªÙƒÙŠÙ‘Ù ÙˆØ³Ø· (ØªØ§Ø¨Ù„Øª / Ù„Ø§Ø¨ØªÙˆØ¨ ØµØºÙŠØ±) */
@media (max-width:1024px){
  .gallery-grid{
    grid-template-columns: repeat(6,1fr);
    --gg:10px;
  }
  .gallery-grid .g-item.is-hero{
    grid-column: span 6;
    aspect-ratio: 16/9;
  }
  .gallery-grid .g-item.is-rect{
    grid-column: span 3;
    aspect-ratio: 1/1;
  }
}

/* ===== Gallery Â· ultra-mini on phones ===== */
@media (max-width:640px){
  /* Ø³ÙƒØ´Ù† Ø£Ø®Ù */
  #gallery.card{
    padding:.45rem !important;
  }
  #gallery h2{
    margin:0 0 .35rem !important;
    font-size:.92rem !important;
  }

  /* Ø´Ø¨ÙƒØ© Ù…ØµØºÙ‘Ø±Ø© Ø¬Ø¯Ù‹Ø§: 6 Ø£Ø¹Ù…Ø¯Ø© + ÙØ¬ÙˆØ© 2px */
  .gallery-grid{
    grid-template-columns: repeat(6, 1fr) !important;
    gap: 2px !important;
  }

  /* Ø£ÙˆÙ„ ØµÙˆØ±Ø© ØªØºØ·ÙŠ Ø§Ù„ØµÙ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ù†Ø³Ø¨Ø© 3:2 */
  .gallery-grid .g-item.is-hero{
    grid-column: span 6 !important;
    aspect-ratio: 3 / 2 !important;
  }

  /* Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØµÙˆØ± Ù…Ø±Ø¨Ø¹Ø§Øª ØµØºÙŠØ±Ø© */
  .gallery-grid .g-item{
    aspect-ratio: 1 / 1 !important;
  }

  .gallery-grid .g-item img{
    width:100% !important;
    height:100% !important;
    object-fit:cover !important;
    object-position:center !important;
  }

  /* Ø´Ø§Ø±Ø© +Ø¹Ø¯Ø¯ Ø£ØµØºØ± */
  .g-item .g-more{
    font-size: clamp(11px, 4vw, 15px) !important;
  }
}

  </style>
</head>
<body>
<%
/* ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© (ØªØ­Ø³ÙŠÙ† Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØµÙˆØ± + Cloudinary) ===== */
function tweakCloudinary(url){
  try{
    var u = new URL(url);
    if (u.hostname.includes('res.cloudinary.com') && u.pathname.includes('/upload/')){
      u.pathname = u.pathname.replace('/upload/', '/upload/f_auto,q_auto,w_1600/');
      return u.toString();
    }
  }catch(_){}
  return url;
}
function assetPath(u){
  u = (u||'').toString().trim();
  if (!u) return '/public/assets/farm-default.jpg';
  if (/^data:/i.test(u)) return '/public/assets/farm-default.jpg';
  if (/^https?:\/\//i.test(u)) return tweakCloudinary(u);

  var CLOUD = (process && process.env && process.env.CLOUDINARY_CLOUD_NAME) ? process.env.CLOUDINARY_CLOUD_NAME : '';
  if (CLOUD && /^(?:[\w-]+\/)+[\w.-]+$/.test(u)) {
    return 'https://res.cloudinary.com/'+CLOUD+'/image/upload/f_auto,q_auto,w_1600/'+u;
  }

  u = u.replace(/\\/g,'/').replace(/^\/?Public\//,'/public/').replace(/\/assests\//gi,'/assets/');
  if (u.startsWith('/uploads/') || u.startsWith('/public/')) return u;
  if (u.startsWith('/assets/')) return '/public'+u;
  if (u.startsWith('/')) return '/public'+u;
  return '/uploads/'+u;
}

function cldSize(url, w){
  try{
    var u = new URL(assetPath(url)); // ÙŠÙ…Ø± Ø¹Ø¨Ø± assetPath Ù„Ø¶Ù…Ø§Ù† Cloudinary/Ù…Ø­Ù„ÙŠ
    if (u.hostname.includes('res.cloudinary.com') && u.pathname.includes('/upload/')){
      u.pathname = u.pathname.replace(/\/upload\/[^/]*\//, '/upload/f_auto,q_auto,w_'+w+'/');
      if (!/\/upload\/[^/]*\//.test(u.pathname)) {
        u.pathname = u.pathname.replace('/upload/', '/upload/f_auto,q_auto,w_'+w+'/');
      }
      return u.toString();
    }
  }catch(_){}
  return assetPath(url);
}

/* Ù…ØªØºÙŠÙ‘Ø±Ø§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø¬Ø²Ø¦ÙŠØ© */
const _isAuth      = (typeof isAuth !== 'undefined') ? isAuth : false;
const _user        = (typeof user   !== 'undefined') ? user   : null;
const _currentPath = (typeof currentPath !== 'undefined') ? currentPath : '';
const _banners     = (typeof bannersDoc !== 'undefined') ? bannersDoc : null;

const photos = (Array.isArray(farm?.photos) && farm.photos.length) ? farm.photos : ['/assets/farm-default.jpg'];
const cover  = assetPath(photos[0]);

const ownerList     = Array.isArray(sameOwnerFarms) ? sameOwnerFarms : [];
const hasOwnerFarms = ownerList.length > 0;

const sym       = (farm?.currency === 'SYP') ? 'Ù„.Ø³' : '$';
const priceNum  = Number(farm?.price || 0);
const isRent    = String(farm?.kind || '').toLowerCase() === 'rent';
const isDaily   = String(farm?.rentPeriod || '').toLowerCase() === 'daily';
const periodStr = isRent ? (isDaily ? '/ÙŠÙˆÙ…' : '/Ø´Ù‡Ø±') : '';

const pStr = priceNum
  ? (sym + ' ' + priceNum.toLocaleString('en') + periodStr)
  : 'â€”';
%>

<!-- Ø§Ù„Ø±Ø£Ø³ ÙˆØ§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… -->
<%- include('partials/navbar', { isAuth:_isAuth, user:_user, currentPath:_currentPath }) %>
<%- include('partials/whatsapp') %>
<% if (_banners) { %><%- include('partials/promo-swiper', { bannersDoc:_banners }) %><% } %>

<!-- Breadcrumb -->
<nav class="breadcrumb" aria-label="Breadcrumb">
  <div class="container">
    <ol>
      <li><a href="/">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
      <li><a href="/rent">Ù„Ù„Ø¥ÙŠØ¬Ø§Ø±</a></li>
      <li aria-current="page"><%= farm?.title || 'â€”' %></li>
    </ol>
  </div>
</nav>

<% if (!farm) { %>
  <section class="section"><div class="container"><h1>Ø§Ù„Ù…Ø²Ø±Ø¹Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</h1><p class="muted">Ø¹Ø°Ø±Ù‹Ø§ØŒ Ù„Ù… Ù†Ø¹Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.</p><a class="btn btn-outline" href="/rent">Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</a></div></section>
<% } else { %>

<!-- ====== HERO ====== -->
<section class="section">
  <div class="container">
    <header class="hero card">
      <img class="hero__bg"
           src="<%= cover %>"
           alt="<%= farm.title %>"
           fetchpriority="high" decoding="async" loading="eager"
           onerror="this.onerror=null;this.src='/public/assets/farm-default.jpg'">
      <div class="hero__veil"></div>
      <div class="hero__body">
        <h1 class="hero__title"><%= farm.title %></h1>
        <p class="hero__meta"><%= farm.city ? (farm.area||'') + ' â€” ' + farm.city : (farm.area||'â€”') %></p>
        <div class="hero__actions">
          <a class="btn btn-primary" href="#gallery">ØªØµÙÙ‘Ø­ Ø§Ù„ØµÙˆØ±</a>
          <a class="btn hero__cta" href="https://wa.me/<%= ((farm?.ownerInfo?.whatsapp)||'').replace(/\D/g,'') %>?text=<%= encodeURIComponent('Ø£Ù†Ø§ Ù…Ù‡ØªÙ… Ø¨Ù…Ø²Ø±Ø¹Ø©: ' + farm.title) %>" target="_blank" rel="noopener">ÙˆØ§ØªØ³Ø§Ø¨</a>
        </div>
      </div>
    </header>
  </div>
</section>

<!-- ====== Main ====== -->
<section class="section">
  <div class="container grid main-grid">
    <!-- ÙŠØ³Ø§Ø±: Ø§Ù„Ù…Ø¹Ø±Ø¶ + ØªÙØ§ØµÙŠÙ„ + ÙˆØµÙ + Ø®Ø±ÙŠØ·Ø© -->
    <div class="grid" style="gap:18px">

      <!-- Ù…Ø¹Ø±Ø¶ (Grid Ø¨Ø¯ÙˆÙ† Ø³ÙˆÙŠØ¨Ø±) -->
      <!-- ===== Gallery (Grid, no Swiper) ===== -->


      <!-- ØªÙØ§ØµÙŠÙ„ Ø³Ø±ÙŠØ¹Ø© -->
      <section class="card" aria-labelledby="quick-title" style="padding:1rem">
        <h2 id="quick-title" style="margin:0 0 .75rem">ØªÙØ§ØµÙŠÙ„ Ø³Ø±ÙŠØ¹Ø©</h2>
        <div class="infogrid">
          <article class="info-item">
            <span class="info-ico" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none"><path d="M4 4h16v16H4zM4 9h16M9 4v16" stroke="currentColor" stroke-width="1.4"/></svg></span>
            <div class="info-t"><h3>Ø§Ù„Ù…Ø³Ø§Ø­Ø©</h3><p><strong><%= Number(farm.size||0).toLocaleString('en') %></strong> Ù…Â²</p></div>
          </article>
          <article class="info-item">
  <span class="info-ico" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.5"/><path d="M8 12h8M12 8v8" stroke="currentColor" stroke-width="1.5"/></svg></span>
  <div class="info-t">
    <h3>Ø§Ù„Ø³Ø¹Ø±</h3>
    <%
      const __sym     = (farm?.currency === 'SYP') ? 'Ù„.Ø³' : '$';
      const __p       = Number(farm?.price || 0);
      const __isRent  = String(farm?.kind || '').toLowerCase() === 'rent';
      const __isDaily = String(farm?.rentPeriod || '').toLowerCase() === 'daily';
      const __per     = __isRent ? (__isDaily ? '/ÙŠÙˆÙ…' : '/Ø´Ù‡Ø±') : '';
      const __txt     = __p ? (__sym + ' ' + __p.toLocaleString('en')) : 'â€”';
    %>
    <p><strong><%= __txt %></strong><%= __per %></p>
  </div>
</article>

          <article class="info-item">
            <span class="info-ico" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none"><path d="M12 21s7-7 7-11a7 7 0 10-14 0c0 4 7 11 7 11z" stroke="currentColor" stroke-width="1.3"/><circle cx="12" cy="10" r="2.7" fill="currentColor"/></svg></span>
            <div class="info-t"><h3>Ø§Ù„Ù…ÙˆÙ‚Ø¹</h3><p><%= farm.city ? (farm.area||'') + ' â€” ' + farm.city : (farm.area||'â€”') %></p></div>
          </article>
          <article class="info-item">
            <span class="info-ico" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none"><path d="M1.5 12S5.5 5 12 5s10.5 7 10.5 7-4 7-10.5 7S1.5 12 1.5 12z" stroke="currentColor" stroke-width="1.2"/><circle cx="12" cy="12" r="3" fill="currentColor"/></svg></span>
            <div class="info-t"><h3>Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª</h3><p>ğŸ‘ï¸ <%= Number((typeof viewsCount!=='undefined'?viewsCount:farm.views)||0).toLocaleString('en') %></p></div>
          </article>
        </div>
      </section>

      <%
        // ØªØ¬Ù‡ÙŠØ² Ù†ØµÙˆØµ Ø§Ù„Ù…Ø±Ø§ÙÙ‚/Ø§Ù„Ù…Ø³Ø¨Ø­/Ø§Ù„Ø¨Ù†Ø§Ø¡
        const __amenRaw  = (farm?.amenitiesDesc || '').trim();
        const __poolRaw  = (farm?.poolDesc      || '').trim();
        const __buildRaw = (farm?.buildingDesc  || '').trim();

        function splitList(s){
          return String(s||'').split(/[\n,ØŒ;Ø›â€¢\-]+/g).map(t=>t.trim()).filter(Boolean).slice(0,50);
        }
        const __amenList = __amenRaw ? Array.from(new Set(splitList(__amenRaw))) : [];
        const __poolList = __poolRaw ? Array.from(new Set(splitList(__poolRaw))) : [];
      %>
      <% if (__amenRaw || __poolRaw || __buildRaw) { %>
      <section id="features" class="card features" aria-labelledby="features-title" style="padding:1rem">
        <h2 id="features-title" style="margin:0 0 .6rem">Ø§Ù„Ù…Ø±Ø§ÙÙ‚ ÙˆØ§Ù„Ù…Ø²Ø§ÙŠØ§</h2>
        <% if (__amenRaw) { %>
          <div class="features__block">
            <h3 class="features__h">Ø§Ù„Ù…Ø±Ø§ÙÙ‚</h3>
            <% if (__amenList.length) { %>
              <div class="chips">
                <% __amenList.forEach(function(it){ %>
                  <span class="chip">
                    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M20 7l-9 9-4-4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <%= it %>
                  </span>
                <% }) %>
              </div>
            <% } else { %><div class="prose"><%= __amenRaw %></div><% } %>
          </div>
        <% } %>
        <% if (__poolRaw) { %>
          <div class="features__block">
            <h3 class="features__h">Ø§Ù„Ù…Ø³Ø¨Ø­</h3>
            <% if (__poolList.length) { %>
              <div class="chips">
                <% __poolList.forEach(function(it){ %>
                  <span class="chip">
                    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 15c3 0 3-2 6-2s3 2 6 2 3-2 6-2" stroke="currentColor" stroke-width="1.4" fill="none" stroke-linecap="round"/></svg>
                    <%= it %>
                  </span>
                <% }) %>
              </div>
            <% } else { %><div class="prose"><%= __poolRaw %></div><% } %>
          </div>
        <% } %>
        <% if (__buildRaw) { %>
          <div class="features__block">
            <h3 class="features__h">Ø§Ù„Ø¨Ù†Ø§Ø¡</h3>
            <div class="prose"><%= __buildRaw %></div>
          </div>
        <% } %>
      </section>
      <% } %>
<section id="gallery" class="card" aria-labelledby="gallery-title" style="padding:1rem">
  <h2 id="gallery-title" style="margin:0 0 .75rem">Ø§Ù„Ù…Ø¹Ø±Ø¶</h2>

  <%
    // ØµÙˆØ± Ø§Ù„Ù…Ø¹Ø±Ø¶ + Ù…Ù†Ø·Ù‚ Ø¥Ø¸Ù‡Ø§Ø± "+Ø¹Ø¯Ø¯"
    const __photosAll = (Array.isArray(farm?.photos) && farm.photos.length) ? farm.photos : ['/assets/farm-default.jpg'];
    const __total     = __photosAll.length;
    const __limit     = 4;                  // Ù†Ø¹Ø±Ø¶ 4 ÙÙ‚Ø·
    const __photos    = __photosAll.slice(0, __limit);
    const __more      = Math.max(0, __total - __limit);
  %>

  <div class="gallery-grid" id="galleryMain" style="--gg:8px">
    <% __photos.forEach(function(src, i){ 
         const full   = assetPath(src);
         const isHero = (i===0);
    %>
      <a class="g-item <%= isHero ? 'is-hero' : 'is-rect' %>" 
         href="<%= full %>" 
         data-index="<%= i %>" 
         aria-label="Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© <%= i+1 %> Ù…Ù† <%= __total %>">
        <img
       src="<%= cldSize(src, isHero ? 600 : 360) %>"
srcset="<%= cldSize(src, 320) %> 320w, <%= cldSize(src, 540) %> 540w, <%= cldSize(src, 800) %> 800w"
sizes="(max-width:640px) <%= isHero ? '92vw' : '14vw' %>, (max-width:1024px) <%= isHero ? '60vw' : '18vw' %>, 640px"

          alt="ØµÙˆØ±Ø© Ù…Ø²Ø±Ø¹Ø©"
          loading="lazy" decoding="async" fetchpriority="low"
          onerror="this.onerror=null;this.src='/public/assets/farm-default.jpg'">

        <% /* Ù„Ùˆ Ù‡Ø°Ù‡ Ø¢Ø®Ø± Ø¨Ù„Ø§Ø·Ø© Ù…Ø¹Ø±ÙˆØ¶Ø© ÙˆÙŠÙˆØ¬Ø¯ Ù…Ø²ÙŠØ¯ */ %>
        <% if (i === __limit - 1 && __more > 0) { %>
          <span class="g-more" aria-hidden="true">+<%= __more %></span>
          <span class="sr-only">Ù‡Ù†Ø§Ùƒ <%= __more %> ØµÙˆØ± Ø¥Ø¶Ø§ÙÙŠØ©</span>
        <% } %>
      </a>
    <% }) %>
  </div>
</section>
      <!-- ÙÙŠØ¯ÙŠÙˆ (Click-to-Load) -->
      <% const __videoUrl = (farm.videoUrl||'').trim(); if (__videoUrl) { %>
      <section class="card" aria-labelledby="video-title" style="padding:1rem">
        <h2 id="video-title" style="margin:0 0 .6rem">ÙÙŠØ¯ÙŠÙˆ ØªÙØµÙŠÙ„ÙŠ</h2>
        <div class="video-frame" id="videoFrame"></div>
      </section>
      <% } %>

      <!-- ÙˆØµÙ -->
      <section id="description" class="card" aria-labelledby="desc-title" style="padding:1rem">
        <h2 id="desc-title" style="margin:0 0 .6rem">Ø§Ù„ÙˆØµÙ Ø§Ù„ÙƒØ§Ù…Ù„</h2>
        <article class="prose"><p><%= (farm.description||'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ÙØµÙ‘Ù„.') %></p></article>
      </section>

      <!-- Ø®Ø±ÙŠØ·Ø© (Lazy) -->
      <% const hasCoords = Number.isFinite(parseFloat(farm?.location?.lat)) && Number.isFinite(parseFloat(farm?.location?.lng)); %>
      <% if (hasCoords) { %>
      <section id="map" class="card" aria-labelledby="map-title" style="padding:1rem">
        <h2 id="map-title" style="margin:0 0 .6rem">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</h2>
        <div class="map-placeholder" id="mapPlaceholder"
             data-lat="<%= farm.location.lat %>"
             data-lng="<%= farm.location.lng %>"
             data-address="<%= (farm?.location?.address || '').replace(/\"/g,'&quot;') %>">
          <img class="static-map" src="/public/assets/location.jpg" alt="Ø®Ø±ÙŠØ·Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ©" loading="lazy">
        </div>
        <div id="leafletMap" aria-label="Ø®Ø±ÙŠØ·Ø© OpenStreetMap"></div>
      </section>
      <% } %>

    </div>

    <!-- ÙŠÙ…ÙŠÙ†: ÙƒØ±Øª ØªÙˆØ§ØµÙ„ Sticky (ÙŠÙØ®ÙÙ‰ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„) -->
    <aside class="aside-sticky">
      <section class="card" style="padding:1rem">
        <h3 style="margin:.2rem 0 .6rem">Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</h3>
        <div class="grid" style="grid-template-columns:1fr; gap:.6rem">
          <div class="info-item">
            <span class="info-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M4 5h16M4 12h16M4 19h16" stroke="currentColor" stroke-width="1.6"/></svg></span>
            <div class="info-t"><h3>Ø§Ù„Ø³Ø¹Ø±</h3><p style="font-weight:900"><%= pStr %></p></div>
          </div>
          <% const _wa=((farm?.ownerInfo?.whatsapp)||'').replace(/\D/g,''); const _ph=(farm?.ownerInfo?.phone||'').replace(/\s+/g,''); const _em=farm?.ownerInfo?.email||''; %>
          <% if (_wa) { %><a class="btn btn-primary" href="<%= 'https://wa.me/'+_wa+'?text='+encodeURIComponent('Ø£Ù†Ø§ Ù…Ù‡ØªÙ… Ø¨Ù…Ø²Ø±Ø¹Ø©: '+farm.title) %>" target="_blank" rel="noopener">ÙˆØ§ØªØ³Ø§Ø¨</a><% } %>
          <% if (_ph) { %><a class="btn btn-outline" href="tel:<%= _ph %>">Ø§ØªØµØ§Ù„ Ù‡Ø§ØªÙÙŠ</a><% } %>
          <% if (_em) { %><a class="btn btn-ghost" href="mailto:<%= _em %>">Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯</a><% } %>
        </div>
      </section>
    </aside>

  </div>
</section>

<!-- Ù…Ø²Ø§Ø±Ø¹ Ø£Ø®Ø±Ù‰ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø§Ù„Ùƒ (Ø³ÙˆÙŠØ¨Ø±) -->

<% if (hasOwnerFarms) { %>
<section class="section" aria-labelledby="owner-farms-title">
  <div class="container">
    <header class="section-header" style="margin-bottom:.75rem">
      <h2 id="owner-farms-title">Ù…Ø²Ø§Ø±Ø¹ Ø£Ø®Ø±Ù‰ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø§Ù„Ùƒ</h2>
      <p class="muted">Ù‚Ø¯ ØªÙ‡Ù…Ù‘Ùƒ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø²Ø§Ø±Ø¹ Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù…Ø§Ù„Ùƒ.</p>
    </header>

    <div class="swiper owner-sale-swiper" dir="rtl">
      <div class="swiper-wrapper">
        <% ownerList.forEach(function(f){
             const raw  = (Array.isArray(f.photos) && f.photos[0]) ? f.photos[0] : '/assets/farm-default.jpg';
             const link = (String(f.kind||'').toLowerCase()==='rent') ? ('/rent/farm/'+f._id) : ('/farm/'+f._id);
             const loc  = f.city ? ((f.area||'') + ' â€” ' + f.city) : (f.area||'â€”');
             const tier = (f?.owner?.subscriptionTier) || f.ownerTier || 'Basic';
             const tierKey = String(tier).trim().toLowerCase();
        %>
        <div class="swiper-slide">
          <article class="farm-card">
            <a class="farm-link" href="<%= link %>">
              <figure class="farm-media" style="position:relative">
                <img src="<%= assetPath(raw) %>" alt="<%= f.title||'Ù…Ø²Ø±Ø¹Ø©' %>" loading="lazy"
                     onerror="this.onerror=null;this.src='/public/assets/farm-default.jpg'">
                <% if (tierKey==='vip') { %><span class="badge badge--vip">VIP</span><% } %>
                <% if (tierKey==='premium') { %><span class="badge badge--premium">Premium</span><% } %>
                <% if (f.videoUrl) { %><span class="badge badge--video">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ</span><% } %>
              </figure>

              <div class="farm-body">
                <h3 class="farm-title" title="<%= f.title||'â€”' %>"><%= (f.title||'â€”') %></h3>
                <p class="farm-location"><%= loc %></p>
                <p class="farm-price">
                  <% const sym2=(f.currency==='SYP'?'Ù„.Ø³':'$'); %>
                  <%= Number(f.price||0) ? (sym2+' '+Number(f.price).toLocaleString('en')) : 'â€”' %>
                  <%= (String(f.kind).toLowerCase()==='rent' ? '/Ø´Ù‡Ø±' : '') %>
                </p>
                <span class="meta-views" style="color:#0f172a">ğŸ‘ï¸ <%= Number(f.views||0).toLocaleString('en') %></span>
                <span class="btn btn-outline" role="button" tabindex="0">Ø§Ù„ØªÙØ§ØµÙŠÙ„</span>
              </div>
            </a>
          </article>
        </div>
        <% }) %>
      </div>

      <div class="swiper-button-prev" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚"></div>
      <div class="swiper-button-next" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ"></div>
      <div class="swiper-pagination"></div>
    </div>
  </div>
</section>
<% } %>

<!-- Top Rent (Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø¨Ø§Ø±ØªØ´ÙŠØ§Ù„ top-rent) -->
<%- include('partials/top-rent', { items: (Array.isArray(topRent) ? topRent : []) }) %>

<% } /* end if farm */ %>
<!-- ===== Lightbox / Fullscreen Gallery ===== -->
<div id="lb" class="lb" hidden aria-hidden="true">
  <button class="lb-close" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
  <div class="swiper lb-swiper">
    <div class="swiper-wrapper" id="lbWrapper"></div>
    <div class="swiper-button-prev" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚"></div>
    <div class="swiper-button-next" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ"></div>
    <div class="swiper-pagination"></div>
  </div>
</div>

<%- include('partials/footer') %>

<!-- Scripts -->
<% if (_needsSwiper) { %>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js" defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      if (document.querySelector('.vip-swiper')) {
        new Swiper('.vip-swiper', {
          loop:true, centeredSlides:true, slidesPerView:1.02, spaceBetween:18, watchOverflow:true,
          pagination:{ el:'.vip-swiper .swiper-pagination', clickable:true },
          navigation:{ nextEl:'.vip-swiper .swiper-button-next', prevEl:'.vip-swiper .swiper-button-prev' },
          breakpoints:{ 640:{slidesPerView:1.05,spaceBetween:20}, 1024:{slidesPerView:1.08,spaceBetween:22} }
        });
      }
      
    });
  </script>
<% } %>

<script>
/* ÙÙŠØ¯ÙŠÙˆ: ÙŠÙˆØªÙŠÙˆØ¨/Ù…Ù„Ù â€” Click-to-Load */
(function(){
  const el = document.getElementById('videoFrame'); if (!el) return;
  const url = <%- JSON.stringify((farm && farm.videoUrl) ? farm.videoUrl : '') %>; if (!url) return;
  function ytId(u){ try{ const x=new URL(u);
    if (x.hostname.includes('youtu.be')) return x.pathname.slice(1);
    if (x.hostname.includes('youtube.com')) return x.searchParams.get('v');
  }catch(_){ } return null; }
  const id = ytId(url);
  if (id){
    const thumb = 'https://i.ytimg.com/vi/'+id+'/hqdefault.jpg';
    el.innerHTML = `
      <div class="video-thumb" style="position:relative;border-radius:12px;overflow:hidden">
        <img src="${thumb}" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ" loading="lazy" style="width:100%;height:auto;display:block;filter:brightness(.9)">
        <button id="playYt" aria-label="ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ"
          style="position:absolute;inset:0;margin:auto;width:72px;height:72px;border:none;border-radius:999px;cursor:pointer;background:#fff;box-shadow:0 10px 30px rgba(0,0,0,.3);display:grid;place-items:center">â–¶</button>
      </div>`;
    document.getElementById('playYt').addEventListener('click', function(){
      const iframe = document.createElement('iframe');
      iframe.src = 'https://www.youtube-nocookie.com/embed/'+id+'?autoplay=1';
      iframe.title = 'YouTube';
      iframe.loading = 'lazy';
      iframe.referrerPolicy = 'strict-origin-when-cross-origin';
      iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
      iframe.style.cssText = 'width:100%;height:56.25vw;max-height:62vh;border:0;border-radius:12px;aspect-ratio:16/9';
      el.innerHTML = ''; el.appendChild(iframe);
    });
    return;
  }
  if (/\.(mp4|webm|ogg)(\?|#|$)/i.test(url)){
    el.innerHTML = '<video controls preload="none" style="width:100%;border-radius:12px"><source src="'+url+'"></video>';
  }else{
    el.innerHTML = '<a class="btn btn-outline" href="'+url+'" target="_blank" rel="noopener">ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</a>';
  }
})();

/* Ø§Ù„Ø®Ø±ÙŠØ·Ø©: Lazy Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ‚ØªØ±Ø¨ Ø§Ù„Ù‚Ø³Ù… Ù…Ù† Ø§Ù„Ø¸Ù‡ÙˆØ± */
(function(){
  var holder = document.getElementById('mapPlaceholder');
  var mapSection = document.getElementById('map');
  if (!holder || !mapSection) return;

  var lat = parseFloat(holder.dataset.lat), lng = parseFloat(holder.dataset.lng);
  if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

  var loaded = false;
  var io = new IntersectionObserver(function(entries){
    if (loaded) return;
    if (entries.some(e => e.isIntersecting)) {
      loaded = true; io.disconnect();
      var lcss = document.createElement('link'); lcss.rel='stylesheet';
      lcss.href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'; document.head.appendChild(lcss);
      var s = document.createElement('script'); s.src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      s.onload = function(){
        try{
          var mapEl = document.getElementById('leafletMap'); if (!mapEl || typeof L === 'undefined') return;
          var addr = holder.dataset.address || '';
          var map = L.map(mapEl, { center:[lat,lng], zoom:14 });
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);
          var mrk = L.marker([lat,lng]).addTo(map);
          if (addr) mrk.bindPopup(addr);
          setTimeout(function(){ map.invalidateSize(); }, 200);
        }catch(_){}
      };
      document.head.appendChild(s);
    }
  }, {rootMargin:'800px 0px'});
  io.observe(mapSection);
})();
</script>

<!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³ÙÙ„ÙŠ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
<% const wa = ((farm?.ownerInfo?.whatsapp)||'').replace(/\D/g,''); const ph=(farm?.ownerInfo?.phone||'').replace(/\s+/g,''); const em=farm?.ownerInfo?.email||''; %>
<div class="mobile-cta" role="group" aria-label="Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„">
  <a class="btn btn-wa"   href="<%= wa ? ('https://wa.me/'+wa+'?text='+encodeURIComponent('Ø£Ù†Ø§ Ù…Ù‡ØªÙ… Ø¨Ù…Ø²Ø±Ø¹Ø©: '+farm.title)) : 'javascript:void(0)' %>" target="_blank" rel="noopener" <%= wa ? '' : 'aria-disabled="true"' %>>ÙˆØ§ØªØ³Ø§Ø¨</a>
  <a class="btn btn-call" href="<%= ph ? ('tel:'+ph) : 'javascript:void(0)' %>" <%= ph ? '' : 'aria-disabled="true"' %>>Ø§ØªØµØ§Ù„</a>
  <a class="btn btn-mail" href="<%= em ? ('mailto:'+em) : 'javascript:void(0)' %>" <%= em ? '' : 'aria-disabled="true"' %>>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</a>
</div>
<%- include('partials/mobile-nav', { 
  activeTab: 'rent',   // ØºÙŠÙ‘Ø±Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„ØµÙØ­Ø©: 'home' | 'sale' | 'rent' | 'contractors' | 'dash'
  isAuth, isAdmin, isContractor, isOwner,
}) %>
<script>
document.addEventListener('DOMContentLoaded', function(){
  if (document.querySelector('.owner-sale-swiper')) {
    new Swiper('.owner-sale-swiper', {
      watchOverflow:true,
      pagination:{ el:'.owner-sale-swiper .swiper-pagination', clickable:true },
      navigation:{ nextEl:'.owner-sale-swiper .swiper-button-next', prevEl:'.owner-sale-swiper .swiper-button-prev' },
      breakpoints:{
        0:    { slidesPerView: 2.02, spaceBetween: 10 },   /* Ù‡Ø§ØªÙ: ÙƒØ±ØªØ§Ù† */
        480:  { slidesPerView: 2.10, spaceBetween: 12 },
        640:  { slidesPerView: 2.4,  spaceBetween: 14 },
        1024: { slidesPerView: 3.2,  spaceBetween: 18 },
        1280: { slidesPerView: 4.2,  spaceBetween: 20 }
      }
    });
  }
});
</script>
<script>
(function(){
  const grid = document.getElementById('galleryMain');          // Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø¹Ø±Ø¶ Ù„Ø¯ÙŠÙƒ
  if(!grid) return;

  const anchors = Array.from(grid.querySelectorAll('a.g-item')); // ÙƒÙ„ ØµÙˆØ±Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù†Ù‚Ø±
  if(!anchors.length) return;

  // Ù…ØµØ§Ø¯Ø± Ø§Ù„ØµÙˆØ± Ø¨Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ù† href
  const sources = anchors.map(a => a.getAttribute('href'));

  // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù„Ø§ÙŠØª Ø¨ÙˆÙƒØ³
  const lb = document.getElementById('lb');
  const lbWrap = document.getElementById('lbWrapper');
  const closeBtn = lb.querySelector('.lb-close');
  let lbSwiper = null, slidesBuilt = false;

  // Ø­Ù…Ù‘Ù„ Swiper Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
  function ensureSwiper(cb){
    if (window.Swiper) return cb();
    const link = document.createElement('link');
    link.rel='stylesheet';
    link.href='https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css';
    document.head.appendChild(link);
    const s = document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js';
    s.onload=cb;
    document.head.appendChild(s);
  }

  // Ø£Ù†Ø´Ø¦ Ø§Ù„Ø´Ø±Ø§Ø¦Ø­ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
  function buildSlides(){
    if (slidesBuilt) return;
    lbWrap.innerHTML = sources.map(src => `<div class="swiper-slide"><img src="${src}" alt=""></div>`).join('');
    slidesBuilt = true;
  }

  function openLB(index){
    ensureSwiper(function(){
      buildSlides();
      lb.hidden = false;
      lb.setAttribute('aria-hidden','false');

      if (lbSwiper){ try{ lbSwiper.destroy(true,true); }catch(_){ } }
      lbSwiper = new Swiper('.lb-swiper', {
        initialSlide: index||0,
        loop: (sources.length>1),
        centeredSlides: true,
        slidesPerView: 1,
        spaceBetween: 10,
        pagination: { el: '.lb-swiper .swiper-pagination', clickable: true },
        navigation: { nextEl: '.lb-swiper .swiper-button-next', prevEl: '.lb-swiper .swiper-button-prev' },
        keyboard: { enabled: true }
      });

      document.addEventListener('keydown', onKey);
      lb.addEventListener('click', backdropClose, { once:true });
    });
  }

  function closeLB(){
    if (lbSwiper){ try{ lbSwiper.destroy(true,true); }catch(_){ } lbSwiper = null; }
    lb.hidden = true;
    lb.setAttribute('aria-hidden','true');
    document.removeEventListener('keydown', onKey);
  }
  function onKey(e){ if(e.key==='Escape') closeLB(); }
  function backdropClose(e){
    const inside = e.target.closest('.lb-swiper');
    const isClose = e.target.closest('.lb-close');
    if (!inside || isClose) closeLB();
  }

  // Ø§Ø±Ø¨Ø· ÙƒÙ„ ØµÙˆØ±Ø©
  anchors.forEach((a,i)=>{
    const img=a.querySelector('img'); if(img) img.style.cursor='zoom-in';
    a.addEventListener('click', (ev)=>{ ev.preventDefault(); openLB(i); });
  });

  closeBtn.addEventListener('click', closeLB);
})();
</script>
<script>
/* Reveal on view for quick details + features */
(function(){
  // Ø¹Ù†Ø§ØµØ± Ù†Ù†ÙÙ‘Ø° Ø¹Ù„ÙŠÙ‡Ø§ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù†
  var targets = [
    ...document.querySelectorAll('.infogrid .info-item'),
    ...document.querySelectorAll('#features .features__block'),
    ...document.querySelectorAll('#features .chip')
  ];
  if (!targets.length) return;

  // Ø£Ø¶Ù ÙƒÙ„Ø§Ø³ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ
  targets.forEach(function(el){ el.classList.add('reveal'); });

  // Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø¸Ù‡ÙˆØ±
  var io = new IntersectionObserver(function(entries){
    entries.forEach(function(e){
      if (e.isIntersecting) {
        e.target.classList.add('in');
        io.unobserve(e.target);
      }
    });
  }, { rootMargin: '80px 0px' });

  targets.forEach(function(el){ io.observe(el); });
})();
</script>

</body>
</html>
