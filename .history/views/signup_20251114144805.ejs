<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>المزارعون — إنشاء حساب / تسجيل الدخول</title>
  <link rel="stylesheet" href="/styles/logincss.css" />
  <style>
    /* تنسيقات خفيفة — بإمكانك دمجها ضمن ملف CSS الخاص بك */
    :root { --brand:#1d6c3b; --text:#111; --muted:#6b7280; --ring:rgba(29,108,59,.12); }
    body { font-family: system-ui, -apple-system, Segoe UI, Tahoma, sans-serif; color:var(--text); background:#f8faf9; }
    .container { max-width: 920px; margin: 0 auto; padding: 1.25rem; }
    .auth { padding: 2rem 0; }

    .auth-tabs { display:flex; gap:.5rem; margin-bottom:1rem; }
    .auth-tab {
      padding:.6rem 1rem; border:1px solid #e5e7eb; background:#fff; border-radius:999px;
      cursor:pointer; font-weight:700; color:#111;
    }
    .auth-tab.is-active { background:var(--brand); color:#fff; border-color:var(--brand); }

    .auth-panels { display:grid; gap:1rem; }
    .auth-card {
      background:#fff; border-radius:16px; box-shadow:0 10px 24px rgba(0,0,0,.06); padding:2rem;
    }
    .auth-card__head { margin-bottom:.75rem; }
    .auth-card__title { margin:0 0 .25rem; font-size:1.25rem; font-weight:800; }
    .muted { color:var(--muted); }

    .field { margin:.9rem 0; }
    .label { display:block; margin-bottom:.35rem; font-weight:700; }
    .input, select, textarea {
      width:100%; padding:.75rem .9rem; border:1px solid #e5e7eb; border-radius:10px; background:#fff;
    }
    .input:focus, select:focus, textarea:focus {
      outline:none; border-color:var(--brand); box-shadow:0 0 0 3px var(--ring);
    }

    .actions { margin-top:1rem; display:grid; gap:.6rem; }
    .btn { display:inline-block; text-align:center; border-radius:10px; padding:.8rem 1rem; font-weight:800; }
    .btn-primary { background:var(--brand); color:#fff; border:1px solid var(--brand); }
    .btn-outline { background:#fff; color:var(--brand); border:1px solid var(--brand); }
    .btn[disabled] { opacity:.5; pointer-events:none; }

    .divider { margin:1rem 0; height:1px; background:linear-gradient(90deg, transparent, #e5e7eb, transparent); }
    .hidden { display:none !important; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    .auth-wrapper { display:grid; gap:1rem; grid-template-columns: 1fr; }
    @media (min-width: 900px) {
      .auth-wrapper { grid-template-columns: 360px 1fr; align-items:start; }
    }

    .auth-aside {
      background:#fff; border-radius:16px; padding:1.25rem; box-shadow:0 10px 24px rgba(0,0,0,.06);
    }
    .auth-title { margin:0 0 .35rem; font-size:1.35rem; font-weight:900; }
    .accent { color:var(--brand); }
    .auth-benefits { margin:1rem 0 0; padding:0 1rem; line-height:1.9; }

    .alert {
      margin: 0 auto 1rem; max-width: 920px;
      padding:.9rem 1rem; border-radius:12px; border:1px solid;
    }
    .alert.success { background:#ecfdf5; color:#065f46; border-color:#a7f3d0; }
    .alert.error   { background:#fef2f2; color:#991b1b; border-color:#fecaca; }
    .alert.info    { background:#eff6ff; color:#1e3a8a; border-color:#bfdbfe; }

    .error { color:#b91c1c; font-size:.9rem; margin-top:.35rem; }
    .form-note { font-size:.9rem; color:var(--muted); }
    a { color:var(--brand); text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>

<%
  /* تهيئة المتغيرات القادمة من الراوتر حتى لا تكون undefined */
  const _msg  = (typeof msg  !== 'undefined' && msg)  ? msg  : '';
  const _type = (typeof type !== 'undefined' && type) ? type : 'info';
  const _tab  = (typeof tab  !== 'undefined' && tab)  ? tab  : 'signup';

  const oldData = (typeof old !== 'undefined' && old) ? old : {};
  const err  = (typeof errors !== 'undefined' && errors) ? errors : {};
%>

<body>

  <% if (_msg) { %>
    <div class="alert <%= _type %>"><%= _msg %></div>
  <% } %>

  <main class="auth" aria-labelledby="auth-title">
    <div class="container">
      <h1 id="auth-title" class="sr-only">التسجيل أو تسجيل الدخول</h1>

      <div class="auth-wrapper">
        <!-- Aside -->
        <aside class="auth-aside">
          <header class="auth-header">
            <h1 class="auth-title">مرحبًا بك في <span class="accent">Farmers</span></h1>
            <p class="auth-subtitle muted">أنشئ حسابك لإدارة المزارع أو الخدمات والوصول لشرائح أكبر من العملاء.</p>
          </header>

          <ul class="auth-benefits" role="list">
            <li role="listitem">✓ إضافة وتحرير إعلانات البيع أو الإيجار</li>
            <li role="listitem">✓ استقبال استفسارات موثّقة مباشرة</li>
            <li role="listitem">✓ تحليلات للمشاهدات والعملاء المحتملين</li>
            <li role="listitem">✓ دعم أولوية لباقات Premium و VIP</li>
          </ul>
        </aside>

        <!-- Panels -->
        <section>
          <!-- Tabs -->
          <div class="auth-tabs" role="tablist" aria-label="اختيار النموذج">
            <button class="auth-tab" id="tab-signup" role="tab" aria-selected="false" aria-controls="panel-signup">إنشاء حساب</button>
            <button class="auth-tab" id="tab-login"  role="tab" aria-selected="false" aria-controls="panel-login" >تسجيل الدخول</button>
          </div>

          <div class="auth-panels">
            <!-- Sign Up -->
            <section id="panel-signup" class="auth-card hidden" role="tabpanel" aria-labelledby="tab-signup" tabindex="-1">
              <header class="auth-card__head">
                <h2 class="auth-card__title">إنشاء حساب</h2>
                <p class="muted">سجّل كمقاول أو كصاحب أرض — يجب اختيار أحدهما للمتابعة.</p>
              </header>

              <form id="signup-form" action="/signup" method="post" novalidate>
                <!-- الاسم -->
                <div class="field">
                  <label class="label" for="name">الاسم</label>
                  <input class="input" id="name" name="name" value="<%= oldData.name || '' %>" required />
                  <% if (err.name) { %><p class="error"><%= err.name %></p><% } %>
                </div>

                <!-- البريد -->
                <div class="field">
                  <label class="label" for="email">البريد الإلكتروني</label>
                  <input class="input" id="email" type="email" name="email" value="<%= oldData.email || '' %>" required />
                  <% if (err.email) { %><p class="error"><%= err.email %></p><% } %>
                </div>

                <!-- الهاتف (مطلوب) -->
              <div class="field">
                <label class="label" for="phone">رقم الهاتف</label>
                <input class="input" id="phone" type="tel" name="phone"
       dir="ltr" inputmode="numeric" pattern="^\+963\d{9}$"
       placeholder="+9639xxxxxxx"
       value="<%= oldData.phone || '' %>" required
       oninput="
         // تحويل الأرقام العربية إلى إنجليزية وإزالة غير الأرقام و+
         this.value = this.value
           .replace(/[٠-٩]/g, d => '٠١٢٣٤٥٦٧٨٩'.indexOf(d))
           .replace(/[^\d+]/g,'');
         // تحويـل الصيغ الشائعة إلى +9639XXXXXXXX
         if (/^0\d{9}$/.test(this.value)) { this.value = '+963' + this.value.slice(1); }
         else if (/^00963\d{9}$/.test(this.value)) { this.value = '+' + this.value.slice(2); }
         else if (/^963\d{9}$/.test(this.value)) { this.value = '+' + this.value; }
       "
/>
<p class="form-note">الصيغة الصحيحة: <b>+963</b> ثم 9 أرقام (مثال: <b>+9639XXXXXXXX</b>).</p>

                <% if (err.phone) { %><p class="error"><%= err.phone %></p><% } %>
              </div>


                <!-- كلمة المرور -->
                <div class="field">
                  <label class="label" for="password">كلمة المرور</label>
                  <input class="input" id="password" type="password" name="password" required />
                  <% if (err.password) { %><p class="error"><%= err.password %></p><% } %>
                </div>

                <!-- تأكيد كلمة المرور -->
                <div class="field">
                  <label class="label" for="confirm">تأكيد كلمة المرور</label>
                  <input class="input" id="confirm" type="password" name="confirm" required />
                  <% if (err.confirm) { %><p class="error"><%= err.confirm %></p><% } %>
                </div>

                <!-- الدور -->
                <div class="field">
                  <label class="label" for="role">الدور</label>
                  <select class="input" name="role" id="role" required>
                    <option value="">اختر</option>
                    <option value="contractor" <%= oldData.role==='contractor' ? 'selected' : '' %>>مقاول</option>
                    <option value="landowner"  <%= oldData.role==='landowner'  ? 'selected' : '' %>>صاحب أرض</option>
                  </select>
                  <% if (err.role) { %><p class="error"><%= err.role %></p><% } %>
                </div>

                <div class="actions">
                  <button id="signup-submit" class="btn btn-primary" type="submit" disabled>إنشاء الحساب</button>
                  <p class="form-note">بالنقر على "إنشاء الحساب" فأنت توافق على <a href="/terms">الشروط</a> و <a href="/privacy">سياسة الخصوصية</a>.</p>
                </div>
              </form>

              <div class="divider" role="separator" aria-label="أو"></div>
              <p class="muted">لديك حساب؟ <a href="#" id="go-login">سجّل الدخول</a></p>
            </section>

            <!-- Login -->
            <section id="panel-login" class="auth-card hidden" role="tabpanel" aria-labelledby="tab-login" tabindex="-1">
              <header class="auth-card__head">
                <h2 class="auth-card__title">تسجيل الدخول</h2>
                <p class="muted">استخدم بريدك الإلكتروني لتسجيل الدخول.</p>
              </header>

              <form id="login-form" action="/login" method="post" novalidate>
                            <div class="field">
                <label class="label" for="identifier">البريد الإلكتروني أو رقم الهاتف</label>
                <input class="input" id="identifier" type="text" name="identifier"
                      dir="ltr" placeholder="phone or email"
                      value="<%= oldData.identifier || '' %>" />
                <% if (err.identifier) { %><p class="error"><%= err.identifier %></p><% } %>
              </div>


                <div class="field">
                  <label class="label" for="login-password">كلمة المرور</label>
                  <input class="input" id="login-password" type="password" name="password" />
                  <% if (err.password && _tab === 'login') { %><p class="error"><%= err.password %></p><% } %>
                </div>

                <div class="actions">
                  <button class="btn btn-primary" type="submit">تسجيل الدخول</button>
                  <p class="muted" style="margin-top:.5rem"><a href="/auth/forgot">نسيت كلمة المرور؟</a></p>
                </div>
              </form>

              <div class="divider" role="separator" aria-label="أو"></div>
              <p class="muted">مستخدم جديد؟ <a href="#" id="go-signup">أنشئ حسابًا</a></p>
            </section>
          </div>
        </section>
      </div>
    </div>
  </main>

  <script>
    // عناصر التبويب
    const tabSignup   = document.getElementById('tab-signup');
    const tabLogin    = document.getElementById('tab-login');
    const panelSignup = document.getElementById('panel-signup');
    const panelLogin  = document.getElementById('panel-login');
    const goLogin     = document.getElementById('go-login');
    const goSignup    = document.getElementById('go-signup');

    function showPanel(which) {
      const isSignup = which === 'signup';

      tabSignup.classList.toggle('is-active', isSignup);
      tabLogin .classList.toggle('is-active', !isSignup);

      tabSignup.setAttribute('aria-selected', String(isSignup));
      tabLogin .setAttribute('aria-selected', String(!isSignup));

      panelSignup.classList.toggle('hidden', !isSignup);
      panelLogin .classList.toggle('hidden', isSignup);

      (isSignup ? panelSignup : panelLogin).focus();
    }

    // تبديل يدوي عبر الأزرار/الروابط
    tabSignup.addEventListener('click', () => showPanel('signup'));
    tabLogin .addEventListener('click', () => showPanel('login'));
    if (goLogin)  goLogin .addEventListener('click', (e)=>{ e.preventDefault(); showPanel('login');  });
    if (goSignup) goSignup.addEventListener('click', (e)=>{ e.preventDefault(); showPanel('signup'); });

    // اختيار التبويب الابتدائي بناءً على قيمة tab القادمة من السيرفر
    const initialTab = "<%= _tab %>";
    showPanel(initialTab === 'login' ? 'login' : 'signup');

    // عناصر التسجيل
    const signupForm   = document.getElementById('signup-form');
    const signupSubmit = document.getElementById('signup-submit');
    const roleSelect   = document.getElementById('role');

    function updateRoleState() {
      const hasRole = roleSelect && roleSelect.value && roleSelect.value.trim() !== '';
      signupSubmit.disabled = !hasRole;
    }

    // تفعيل/تعطيل زر الإرسال حسب الدور
    if (roleSelect) roleSelect.addEventListener('change', updateRoleState);
    updateRoleState();

    // منع الإرسال دون اختيار الدور (تأكيد أخير)
    if (signupForm) {
      signupForm.addEventListener('submit', (e) => {
        const hasRole = roleSelect && roleSelect.value && roleSelect.value.trim() !== '';
        if (!hasRole) {
          e.preventDefault();
          alert('يرجى اختيار نوع الحساب: مقاول أو صاحب أرض.');
        }
      });
    }
  </script>
</body>
</html>
