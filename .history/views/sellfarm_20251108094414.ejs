<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Farmers â€” Ù…Ø²Ø§Ø±Ø¹ Ù„Ù„Ø¨ÙŠØ¹</title>
  <meta name="description" content="ØªØµÙÙ‘Ø­ Ø§Ù„Ù…Ø²Ø§Ø±Ø¹ Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¨ÙŠØ¹ â€” ØµÙÙ‘ Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙˆØ§Ù„Ù…Ø¯ÙŠÙ†Ø© ÙˆØ§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ù…Ø³Ø§Ø­Ø©." />
  <!-- ÙˆØ±Ù‚Ø© Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¹Ø§Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù„Ø§ Ù†Ù„Ù…Ø³Ù‡Ø§) -->
  <link rel="stylesheet" href="/Public/styles/rentandfarmdetail.css">
  <!-- Swiper -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

  <style>
    /* =============== Design Tokens =============== */
    :root{
      --bg: #f8fafc;
      --card: #ffffff;
      --ink: #0f172a;
      --muted:#64748b;
      --brand:#0f172a;
      --accent:#10b981;       /* Ø²Ø± ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± */
      --warn:#ef4444;         /* Ø´Ø§Ø±Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
      --ring:#0f172a22;
      --r:14px;
      --shadow:0 10px 24px rgba(2,6,23,.08);
      --container: 1160px;
      --gap: 16px;
    }
    body{ background: var(--bg); color: var(--ink); }

    /* =============== Helpers =============== */
    .container{ width:min(100%, var(--container)); margin-inline:auto; padding-inline:16px; }
    .section{ padding: 1.25rem 0; }
    .muted{ color: var(--muted); }
    .link{ color: inherit; text-decoration: underline; text-underline-offset: 2px; }
    .btn{ display:inline-block; padding:.6rem 1rem; border-radius:10px; font-weight:600; text-decoration:none; cursor:pointer; }
    .btn-primary{ background: var(--accent); color:#fff; border: none; }
    .btn-outline{ background:#fff; color: var(--brand); border:1px solid var(--brand); }

    /* =============== ÙÙ„Ø§ØªØ± Ø§Ù„Ø¨Ø­Ø« =============== */
    #filters .filter-card{
      background: var(--card); border:1px solid #e2e8f0; border-radius:16px; padding: .9rem;
      box-shadow: var(--shadow);
    }
    .filter-dropdown summary{
      cursor:pointer; display:flex; align-items:center; justify-content:space-between;
      gap:.5rem; font-weight:700; padding:.2rem .1rem;
    }
    .filter-dropdown summary::after{ content:"â–¾"; font-size:.9rem; opacity:.85; transition:.2s; }
    .filter-dropdown[open] summary::after{ transform: rotate(180deg); }
    .filters-form{ padding:.75rem 0 0; }
    .filters-grid{
      display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap: 14px;
    }
    .field .label{ display:block; margin:.2rem 0 .35rem; font-weight:600; }
    .field input,.field select{
      height: 2.85rem; width: 100%; padding: .75rem .9rem; border:1px solid #e2e8f0;
      border-radius:12px; background:#fff; outline: none;
    }
    .field input:focus,.field select:focus{ border-color: var(--brand); box-shadow: 0 0 0 3px var(--ring); }
    .field--actions{ display:flex; align-items:flex-end; gap:.5rem; }

    /* =============== Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø²Ø§Ø±Ø¹ =============== */
    .sale-swiper .swiper-slide,
    .vip-swiper  .swiper-slide{ height:auto; }

    .farm-card{
      display:block; background: var(--card); border:1px solid #e2e8f0; border-radius: var(--r); overflow:hidden;
      transition: transform .18s ease, box-shadow .18s ease; box-shadow: var(--shadow);
    }
    .farm-card:hover{ transform: translateY(-3px); box-shadow: 0 14px 32px rgba(2,6,23,.12); }

    .farm-media{ position:relative; aspect-ratio: 16/9; background:#eef2f7; overflow:hidden; }
    .farm-media img{ width:100%; height:100%; object-fit:cover; display:block; filter: brightness(.98); }
    .farm-media::after{ content:""; position:absolute; inset:0; background: linear-gradient(180deg, transparent, rgba(0,0,0,.06)); }

    /* Ø§Ù„Ø¨Ø§Ø¯Ø¬Ø§Øª */
    .badge{
      position:absolute; top:10px; inset-inline-start:10px; z-index:4;
      display:inline-block; padding:.2rem .6rem; border-radius:999px; font-size:.75rem;
      color:#fff; background:#0f172a; box-shadow:0 6px 14px rgba(0,0,0,.18);
    }
    .badge--vip{ background:#0f172a; }
    .badge--premium{ background:#8b5cf6; }  /* Ø¨Ù†ÙØ³Ø¬ÙŠ */
    .badge--video{ inset-inline-start:auto; inset-inline-end:10px; background: var(--warn); }

    .farm-body{ padding:.85rem; display:grid; gap:.25rem; }
    .farm-title{
      margin:0; font-size:1.06rem; font-weight:800; letter-spacing:-.2px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .farm-location{ margin:0; color: var(--muted); }
    .farm-pricebar{
      margin-top:.35rem; display:flex; align-items:center; justify-content:space-between; gap:.5rem;
    }
    .farm-price{ margin:0; font-weight:800; }
    .meta-views{ color: var(--muted); font-size:.9rem; white-space:nowrap; }
    .farm-cta{ margin-top:.4rem; display:flex; justify-content:flex-start; }

    /* =============== Ø¹Ù†ÙˆØ§Ù† Ù‚Ø³Ù… Ø§Ù„VIP =============== */
    .section-header h2{ margin: .2rem 0; font-size: clamp(18px, 2.2vw, 24px); }
    .section-header p{ margin: 0; }

    /* =============== Ø²Ø± Ø§Ù„Ù…Ø²ÙŠØ¯/Ø£Ù‚Ù„ =============== */
    .advanced-fields[hidden]{ display:none !important; }
    .advanced-fields.fade-in{ animation: fadeIn .18s ease-in; }
    @keyframes fadeIn { from{opacity:0; transform: translateY(-4px)} to{opacity:1; transform: translateY(0)} }
  </style>
</head>
<body>
<%
  /* ===== Helpers ===== */
  const _isAuth      = (typeof isAuth !== 'undefined') ? isAuth : false;
  const _user        = (typeof user   !== 'undefined') ? user   : null;
  const _currentPath = (typeof currentPath !== 'undefined') ? currentPath : '/sale';
  const _farmsSSR    = (typeof farms !== 'undefined' && Array.isArray(farms)) ? farms : [];

  function esc(x){ return String(x ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
  function truncateWords(str, n){
    const w = String(str||'').trim().split(/\s+/);
    return (w.length <= n) ? w.join(' ') : (w.slice(0,n).join(' ') + 'â€¦');
  }
%>

<%- include('partials/navbar', { isAuth: _isAuth, user: _user, currentPath: _currentPath }) %>
<%- include('partials/whatsapp') %>
<%- include('partials/promo-swiper', { bannersDoc }) %>

<!-- ===================== Ø§Ù„ÙÙ„Ø§ØªØ± ===================== -->
<section id="filters" class="section" aria-labelledby="filters-title">
  <div class="container">
    <div class="filter-card">
      <details class="filter-dropdown" open>
        <summary id="filters-title">ØªØµÙÙŠØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</summary>

        <form id="sale-filters" class="filters-form" action="#results" method="get" novalidate>
          <div class="filters-grid">
            <div class="field">
              <label class="label" for="city">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
              <select id="city" name="city" class="input">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©â€¦</option>
                <option>Ø¯Ù…Ø´Ù‚</option><option>Ø±ÙŠÙ Ø¯Ù…Ø´Ù‚</option><option>Ø­Ù„Ø¨</option><option>Ø­Ù…Øµ</option>
                <option>Ø­Ù…Ø§Ø©</option><option>Ø§Ù„Ù„Ø§Ø°Ù‚ÙŠØ©</option><option>Ø·Ø±Ø·ÙˆØ³</option><option>Ø¥Ø¯Ù„Ø¨</option>
                <option>Ø¯ÙŠØ± Ø§Ù„Ø²ÙˆØ±</option><option>Ø§Ù„Ø­Ø³ÙƒØ©</option><option>Ø§Ù„Ø±Ù‚Ø©</option>
                <option>Ø¯Ø±Ø¹Ø§</option><option>Ø§Ù„Ù‚Ù†ÙŠØ·Ø±Ø©</option><option>Ø§Ù„Ø³ÙˆÙŠØ¯Ø§Ø¡</option>
              </select>
            </div>
            <div class="field">
              <label class="label" for="area">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
              <input id="area" name="area" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Ù…Ø«Ø§Ù„: Ø±ÙŠÙ Ø¯Ù…Ø´Ù‚)" />
            </div>
            <div class="field field--actions">
              <button id="toggle-advanced" class="btn btn-outline" type="button" aria-expanded="false" aria-controls="advanced-fields">Ø§Ù„Ù…Ø²ÙŠØ¯</button>
              <button class="btn btn-primary" type="submit">ØªØ·Ø¨ÙŠÙ‚</button>
            </div>
          </div>

          <div id="advanced-fields" class="filters-grid advanced-fields" hidden>
            <div class="field">
              <label class="label" for="price-min">Ø§Ù„Ø³Ø¹Ø± (Ù…Ù†)</label>
              <input id="price-min" name="price_min" type="number" placeholder="Ù…Ø«Ø§Ù„: 50000" />
            </div>
            <div class="field">
              <label class="label" for="price-max">Ø§Ù„Ø³Ø¹Ø± (Ø¥Ù„Ù‰)</label>
              <input id="price-max" name="price_max" type="number" placeholder="Ù…Ø«Ø§Ù„: 500000" />
            </div>
            <div class="field">
              <label class="label" for="size-min">Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ù…Ù† Ù…Â²)</label>
              <input id="size-min" name="size_min" type="number" placeholder="Ù…Ø«Ø§Ù„: 5000" />
            </div>
            <div class="field">
              <label class="label" for="size-max">Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ø¥Ù„Ù‰ Ù…Â²)</label>
              <input id="size-max" name="size_max" type="number" placeholder="Ù…Ø«Ø§Ù„: 25000" />
            </div>
          </div>
        </form>
      </details>
    </div>
  </div>
</section>

<!-- ===================== VIP ===================== -->
<section id="vip-sale" class="section" aria-labelledby="vip-sale-title" hidden>
  <div class="container">
    <header class="section-header">
      <h2 id="vip-sale-title">Ù…Ø²Ø§Ø±Ø¹ VIP Ù„Ù„Ø¨ÙŠØ¹</h2>
      <p class="muted">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„ÙØªØ­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©.</p>
    </header>

    <div class="swiper vip-swiper" dir="rtl">
      <div class="swiper-wrapper" id="vipSaleWrapper"></div>
      <div class="swiper-button-prev" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚"></div>
      <div class="swiper-button-next" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ"></div>
      <div class="swiper-pagination"></div>
    </div>
  </div>
</section>

<!-- ===================== Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ===================== -->
<section id="results" class="section" aria-labelledby="results-title">
  <div class="container">
    <header class="section-header">
      <h2 id="results-title">Ù…Ø²Ø§Ø±Ø¹ Ù„Ù„Ø¨ÙŠØ¹</h2>
      <p class="muted">ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©.</p>
    </header>

    <div class="swiper sale-swiper" dir="rtl">
      <div class="swiper-wrapper" id="saleWrapper">
        <% if (_farmsSSR.length) {
             _farmsSSR.forEach(farm => {
               const cover = (Array.isArray(farm.photos) && farm.photos[0]) ? farm.photos[0] : '/public/assets/farm-default.jpg';
               const titleTxt = esc(farm.title || 'â€”');
               const tierSSR = String((farm?.owner?.subscriptionTier || farm?.ownerTier || 'Basic')).trim(); // â¬…ï¸ ØªØ¹Ø±ÙŠÙ Ù‚Ø¨Ù„ Ø§Ù„ÙØ­Øµ
               const hasVideo = !!farm.videoUrl;
               if (tierSSR === 'VIP') { return; } // Ù„Ø§ Ù†Ø±Ø³Ù… VIP ÙÙŠ Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± Ø§Ù„Ø¹Ø§Ù…
        %>
        <div class="swiper-slide">
          <article class="farm-card">
            <a class="farm-link" href="/farm/<%= farm._id %>" aria-label="Ø¹Ø±Ø¶ <%= titleTxt %>">
              <figure class="farm-media">
                <img src="<%= cover %>" alt="<%= titleTxt %>" loading="lazy"
                     onerror="this.onerror=null;this.src='/public/assets/farm-default.jpg'">
                <% if (tierSSR === 'VIP') { %>
                  <span class="badge badge--vip">VIP</span>
                <% } else if (tierSSR === 'Premium') { %>
                  <span class="badge badge--premium">Premium</span>
                <% } %>
                <% if (hasVideo) { %>
                  <span class="badge badge--video">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ</span>
                <% } %>
              </figure>

              <div class="farm-body">
                <h3 class="farm-title" title="<%= titleTxt %>"><%= truncateWords(titleTxt, 3) %></h3>
                <p class="farm-location"><%= esc(farm.area||'') %> â€” <%= esc(farm.city||'') %></p>

                <div class="farm-pricebar">
                  <p class="farm-price">
                    <%
                      const c = (farm.currency || 'USD');
                      const sym = (c === 'SYP') ? 'Ù„.Ø³' : '$';
                      const p = Number(farm.price||0);
                    %>
                    <%= p ? (sym + ' ' + p.toLocaleString('en')) : 'â€”' %>
                  </p>
                  <span class="meta-views">ğŸ‘ï¸ <%= Number(farm.views||0).toLocaleString('en') %></span>
                </div>

                <div class="farm-cta">
                  <span class="btn btn-outline" role="button" tabindex="0">Ø§Ù„ØªÙØ§ØµÙŠÙ„</span>
                </div>
              </div>
            </a>
          </article>
        </div>
        <% }); } %>
      </div>

      <div class="swiper-button-prev" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚"></div>
      <div class="swiper-button-next" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ"></div>
      <div class="swiper-pagination"></div>
    </div>
  </div>
</section>

<%- include('partials/promo', { promoBottom }) %>
<%- include('partials/footer') %>

<!-- Swiper -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<!-- Ø²Ø± Ø§Ù„Ù…Ø²ÙŠØ¯/Ø£Ù‚Ù„ -->
<script>
(function(){
  const btn = document.getElementById('toggle-advanced');
  const box = document.getElementById('advanced-fields');
  if (!btn || !box) return;
  btn.addEventListener('click', ()=>{
    const willShow = box.hasAttribute('hidden');
    if (willShow){
      box.hidden = false;
      box.classList.remove('fade-in'); void box.offsetWidth; box.classList.add('fade-in');
      btn.textContent = 'Ø£Ù‚Ù„'; btn.setAttribute('aria-expanded','true');
    } else {
      box.hidden = true; btn.textContent = 'Ø§Ù„Ù…Ø²ÙŠØ¯'; btn.setAttribute('aria-expanded','false');
    }
  });
})();
</script>

<!-- Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£ØµÙ„ÙŠ (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±) -->
<script type="module">
function truncateWordsJS(str, n){
  const w = String(str || '').trim().split(/\s+/);
  return (w.length <= n) ? w.join(' ') : (w.slice(0, n).join(' ') + 'â€¦');
}

/* Ø£Ø¯ÙˆØ§Øª ØµØºÙŠØ±Ø© */
const $  = (s,ctx=document)=>ctx.querySelector(s);
const $$ = (s,ctx=document)=>Array.from(ctx.querySelectorAll(s));
const fmtEN = n => Number(n||0).toLocaleString('en');

/* Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø© */
const form        = $('#sale-filters');
const vipSection  = $('#vip-sale');
const vipWrap     = $('#vipSaleWrapper');
const saleWrapper = $('#saleWrapper');

/* HTML helpers */
function htmlEscape(s=''){ return String(s).replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }
function assetPath(u){
  u = (u || '').toString().trim();
  if (/^data:/i.test(u) || /^https?:\/\//i.test(u)) return u;
  u = u.replace(/\\/g, '/').replace(/^\/?Public\//, '/public/').replace(/\/assests\//gi, '/assets/');
  if (u.startsWith('/uploads/') || u.startsWith('/public/')) return u;
  if (u.startsWith('/assets/')) return '/public' + u;
  if (u.startsWith('/')) return '/public' + u;
  return '/uploads/' + u;
}

/* Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¦Ø­ */
function saleSlide(f){
  const raw   = (Array.isArray(f.photos) && f.photos[0]) ? f.photos[0] : '/assets/farm-default.jpg';
  const cover = assetPath(raw);
  const link  = `/farm/${f._id}`;
  const loc   = f.city ? `${f.area || ''} â€” ${f.city}` : (f.area || 'â€”');

  const tierRaw = ((f.owner && f.owner.subscriptionTier) || f.ownerTier || 'Basic');
  const tierKey = String(tierRaw).trim().toLowerCase();
  const tierBadge =
    tierKey === 'vip'     ? '<span class="badge badge--vip">VIP</span>' :
    tierKey === 'premium' ? '<span class="badge badge--premium">Premium</span>' : '';

  const views = Number(f.views || 0);

  return `
    <div class="swiper-slide">
      <article class="farm-card">
        <a class="farm-link" href="${link}" aria-label="${htmlEscape(f.title || 'Ù…Ø²Ø±Ø¹Ø©')}">
          <figure class="farm-media">
            <img src="${cover}" alt="${htmlEscape(f.title || 'Ù…Ø²Ø±Ø¹Ø©')}" loading="lazy"
                 onerror="this.onerror=null;this.src='/public/assets/farm-default.jpg'">
            ${tierBadge}
            ${f.videoUrl ? `<span class="badge badge--video">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ</span>` : ``}
          </figure>
          <div class="farm-body">
            <h3 class="farm-title" title="${htmlEscape(f.title || 'â€”')}">${htmlEscape(truncateWordsJS(f.title || 'â€”', 3))}</h3>
            <p class="farm-location">${htmlEscape(loc)}</p>
            <div class="farm-pricebar">
              <p class="farm-price">${
                Number(f.price || 0)
                  ? ((f.currency==='SYP' ? 'Ù„.Ø³' : '$') + ' ' + fmtEN(f.price))
                  : 'â€”'
              }</p>
              <span class="meta-views">ğŸ‘ï¸ ${fmtEN(views)}</span>
            </div>
            <div class="farm-cta">
              <span class="btn btn-outline" role="button" tabindex="0">Ø§Ù„ØªÙØ§ØµÙŠÙ„</span>
            </div>
          </div>
        </a>
      </article>
    </div>`;
}
function vipSlide(f){ return saleSlide(f); }

/* API */
async function fetchJSON(url){
  const r = await fetch(url, { headers: { 'Accept':'application/json' }});
  if (!r.ok) throw new Error('HTTP '+r.status);
  const j = await r.json(); return j.data || j.rows || [];
}

/* Swipers */
let allSale = [], vipAll = [], saleSwiper = null, vipSwiper = null;
function destroySwiper(sw){ if (sw) try{ sw.destroy(true,true);}catch(_){} }

function initSaleSwiper(){
  destroySwiper(saleSwiper);
  saleSwiper = new Swiper('.sale-swiper', {
    slidesPerView: 1.05, spaceBetween: 14, watchOverflow: true,
    pagination: { el: '.sale-swiper .swiper-pagination', clickable: true },
    navigation: { nextEl: '.sale-swiper .swiper-button-next', prevEl: '.sale-swiper .swiper-button-prev' },
    breakpoints: { 480:{slidesPerView:1.2}, 640:{slidesPerView:2.2}, 1024:{slidesPerView:3.2}, 1280:{slidesPerView:4.2} }
  });
}
function initVipSwiper(){
  destroySwiper(vipSwiper);
  vipSwiper = new Swiper('.vip-swiper', {
    slidesPerView: 1.05, spaceBetween: 14, watchOverflow: true,
    pagination: { el: '.vip-swiper .swiper-pagination', clickable: true },
    navigation: { nextEl: '.vip-swiper .swiper-button-next', prevEl: '.vip-swiper .swiper-button-prev' },
    breakpoints: { 480:{slidesPerView:1.2}, 640:{slidesPerView:2.2}, 1024:{slidesPerView:3.2}, 1280:{slidesPerView:4.2} }
  });
}

/* Ø±Ø³Ù… */
function renderSale(list){
  if (!saleWrapper) return;
  saleWrapper.innerHTML = (list && list.length) ? list.map(saleSlide).join('') : `<div class="muted" style="padding:2rem; text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>`;
  initSaleSwiper();
}
function renderVip(list){
  if (!vipSection || !vipWrap) return;
  const has = Array.isArray(list) && list.length>0;
  vipSection.hidden = !has;
  vipWrap.innerHTML = has ? list.map(vipSlide).join('') : '';
  if (has) initVipSwiper(); else destroySwiper(vipSwiper);
}

/* ÙÙ„Ø§ØªØ± */
function applyFilters(){
  const area  = (form?.area?.value||'').trim().toLowerCase();
  const city  = (form?.city?.value||'').trim().toLowerCase();
  const minP  = parseFloat(form?.price_min?.value);
  const maxP  = parseFloat(form?.price_max?.value);
  const minS  = parseFloat(form?.size_min?.value);
  const maxS  = parseFloat(form?.size_max?.value);

  const pass = (f)=>{
    const fArea = (f.area||'').toString().toLowerCase();
    const fCity = (f.city||'').toString().toLowerCase();
    const okArea  = !area || fArea.includes(area);
    const okCity  = !city || fCity.includes(city);
    const price   = Number(f.price)||0;
    const size    = Number(f.size)||0;
    const okPrice = (isNaN(minP) || price>=minP) && (isNaN(maxP) || price<=maxP);
    const okSize  = (isNaN(minS) || size>=minS)   && (isNaN(maxS) || size<=maxS);
    return okArea && okCity && okPrice && okSize;
  };

  const filteredSale = allSale.filter(pass).filter(f => ((f?.owner?.subscriptionTier)||f.ownerTier||'Basic') !== 'VIP');
  const filteredVip  = vipAll.filter(pass);
  renderSale(filteredSale);
  renderVip(filteredVip);
}

/* Ø¨Ø¯Ø¡ */
async function init(){
  try {
    const apiSale = await fetchJSON('/api/farms/sale');
    allSale = Array.isArray(apiSale) ? apiSale : [];
    const nonVipSale = allSale.filter(f => ((f?.owner?.subscriptionTier)||f.ownerTier||'Basic') !== 'VIP');
    renderSale(nonVipSale);
  } catch(e){ console.warn('sale fetch error:', e); renderSale([]); }

  try {
    vipAll = await fetchJSON('/api/farms/sale?vipOnly=1');
    renderVip(vipAll);
  } catch(e){ console.warn('vip fetch error:', e); renderVip([]); }

  if (form){
    form.addEventListener('submit', e=>{ e.preventDefault(); applyFilters(); });
    $$('#sale-filters input, #sale-filters select').forEach(inp=>{
      inp.addEventListener('change', applyFilters);
      inp.addEventListener('input',  e=>{
        const n = (e.target?.name||''); if (/price_|size_|area|city/.test(n)) applyFilters();
      });
    });
  }
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
