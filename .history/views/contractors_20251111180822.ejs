<!-- views/contractors.ejs -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>فارمرز — المقاولون</title>
  <meta name="description" content="ابحث عن مقاولين موثوقين: كهرباء، مضخات، طاقة شمسية، بناء ريفي، تشخيص فني، وأنظمة الري.">

  <link rel="stylesheet" href="/Public/styles/contractorsstyle.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>

  <style>
    /* ==== VIP hero ==== */
    .vip-hero-slide{position:relative;min-height:360px;border-radius:16px;overflow:hidden;background:#f6faf6;}
    @media (min-width:1024px){.vip-hero-slide{min-height:520px;}}
    .vip-hero-img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(.85);}
    .vip-hero-overlay{position:absolute;inset:0;background:linear-gradient(90deg,rgba(0,0,0,.35),rgba(0,0,0,.15) 40%,rgba(0,0,0,0) 70%);}
    .vip-hero-body{position:absolute;inset-inline:1.2rem;inset-block-end:1.1rem;color:#fff;display:grid;gap:.35rem;}
    .vip-hero-title{font-size:clamp(20px,3vw,34px);margin:.25rem 0 0;}
    .vip-hero-meta{opacity:.95;font-size:clamp(14px,1.5vw,16px);}
    .vip-hero-cta{margin-top:.6rem;display:inline-block;padding:.5rem .9rem;border-radius:10px;background:#fff;color:#0f172a;text-decoration:none;font-weight:600;width:150px;text-align:center;}
    .vip-badge{position:absolute;top:12px;inset-inline-start:12px;background:#0f172a;color:#fff;border-radius:999px;font-size:.8rem;padding:.18rem .6rem;z-index:2}

    /* ==== بطاقات المقاولين (مطابقة لشكل الصورة) ==== */
    .contractor-swiper .swiper-slide{height:auto;}
    .contractor-card{
      position:relative;border:1px solid #e2e8f0;background:#fff;border-radius:16px;overflow:hidden;
      display:flex;flex-direction:column;gap:20px;padding:16px 14px;height: 300px;padding-top: 40px;
    }
    /* شارة الباقة في أقصى اليسار أعلى البطاقة */
    .tier-badge{
      position:absolute;top:10px;inset-inline-end:10px;
      background:#0f172a;color:#fff;border-radius:999px;font-size:13px;padding:.2rem .6rem;line-height:1
    }

    /* السطر العلوي: الصورة الدائرية يمين + الاسم/الخانات يسارها عمودياً */
    .card-row{display:grid;grid-template-columns:auto 1fr;align-items:center;gap:12px;}
    .avatar{width:82px;height:82px;border-radius:999px;overflow:hidden;border:3px solid #eef2f7;justify-self:end}
    .avatar img{width:100%;height:100%;object-fit:cover}

    .info-stack{display:flex;flex-direction:column;gap:4px}
    .name{font-weight:800;font-size:22px;margin:0}
    .specialization,.region{margin:0;color:#475569}

    /* سطر التقييم تحتهم بمحاذاة اليمين */
    .rating{display:flex;align-items:center;gap:.35rem;color:#111827;font-weight:700;justify-content:flex-start}
    .rating small{color:#6b7280;font-weight:600}

    /* زر أسفل الكرت */
    .card-cta{margin-top:50px;width:100%;text-align:center;border:1px solid #0f172a;border-radius:12px;padding:.6rem .9rem;text-decoration:none;color:#0f172a;font-weight:600;display:inline-block}

    /* أزرار السويبر */
    .contractor-swiper .swiper-button-prev,
    .contractor-swiper .swiper-button-next{color:#2563eb}

    /* وقاية من قواعد عامة قد تؤثر على الصور */
.contractor-card img{margin-top:0!important;border-radius:0}
/* ليأخذ ارتفاع البطاقة تلقائيًا مثل السويبر العام */
.vip-swiper .swiper-slide{ height:auto; }

/* نفس لون الأسهم كالسويبر العام */
.vip-swiper .swiper-button-prev,
.vip-swiper .swiper-button-next{ color:#2563eb; }
/* ===== Contractors cards · compact on phones ===== */
@media (max-width: 640px){
  .contractor-swiper .swiper-slide{ height:auto; }

  .contractor-card{
    padding: 12px 10px !important;
    gap: 12px !important;
    height: auto !important;          /* لا نجبر الارتفاع */
    border-radius: 12px !important;
  }

  .card-row{ gap: 10px !important; }
  .avatar{ width: 56px !important; height: 56px !important; border-width: 2px !important; }
  .name{ font-size: 1rem !important; }
  .specialization, .region{ font-size: .85rem !important; }

  .rating{ font-size: .9rem !important; gap: .3rem !important; }
  .rating small{ font-size: .82rem !important; }

  .card-cta{
    padding: .42rem .7rem !important;
    font-size: .88rem !important;
    border-radius: 10px !important;
    margin-top: 6px !important;       /* أقل فراغ سفلي */
  }

  .tier-badge{
    font-size: .72rem !important;
    padding: .16rem .5rem !important;
    top: 8px !important; inset-inline-end: 8px !important;
  }
}

  </style>
</head>
<body>

  <%- include('partials/navbar', { isAuth: (typeof isAuth!=='undefined'?isAuth:false), user: (typeof user!=='undefined'?user:null), active: 'contractors' }) %>

 <%- include('partials/whatsapp') %>
<%- include('partials/promo-swiper', { bannersDoc }) %>
  
  <!-- فلاتر بسيطة -->
  <section id="filters" class="section filters" aria-labelledby="filters-title">
    <div class="container">
      <details class="filter-dropdown" open>
        <summary id="filters-title">فلترة المقاولين</summary>
   <form id="contractor-filters" class="filters-form" action="#results" method="get" novalidate>
  <div class="filters-grid" style="display:grid;gap:.8rem;grid-template-columns:repeat(12,1fr)">
    <!-- التخصص: قائمة منسدلة -->
    <div class="field" style="grid-column:span 6">
      <label class="label" for="specialization">التخصص</label>
      <select id="specialization" name="specialization" class="input">
        <option value="">اختر التخصص…</option>
        <option>كهرباء زراعية</option>
        <option>مضخات</option>
        <option>طاقة شمسية</option>
        <option>ري (تنقيط/رش)</option>
        <option>بناء ريفي</option>
        <option>تشخيص فني</option>
        <option>صيانة وتركيبات</option>
        <option>حدادة/لحام</option>
        <option>ألمنيوم</option>
        <option>تبريد/تكييف زراعي</option>
      </select>
    </div>

    <!-- المحافظة: قائمة منسدلة -->
    <div class="field" style="grid-column:span 6">
      <label class="label" for="city">المحافظة</label>
      <select id="city" name="city" class="input">
        <option value="">اختر المحافظة…</option>
        <option>دمشق</option>
        <option>ريف دمشق</option>
        <option>حلب</option>
        <option>حمص</option>
        <option>حماة</option>
        <option>اللاذقية</option>
        <option>طرطوس</option>
        <option>إدلب</option>
        <option>دير الزور</option>
        <option>الحسكة</option>
        <option>الرقة</option>
        <option>درعا</option>
        <option>القنيطرة</option>
        <option>السويداء</option>
      </select>
    </div>

    <div class="field" style="grid-column:span 12;display:flex;justify-content:flex-end">
      <button class="btn btn-primary" type="submit" style="background:#0f172a;color:#fff;border:none;border-radius:10px;padding:.55rem 1rem">تطبيق</button>
    </div>
  </div>
</form>

      </details>
    </div>
  </section>
<!-- VIP -->
  <section id="vip-contractors" class="section gallery" aria-labelledby="vip-title" hidden>
    <div class="container">
      <header class="section-header">
        <h2 id="vip-title">المقاولون المتاحون</h2>
        
      </header>

      <div class="swiper vip-swiper" dir="rtl" aria-label="مقاولون VIP">
        <div class="swiper-wrapper" id="vipContractorsWrapper"></div>
        <div class="swiper-button-prev" aria-label="السابق"></div>
        <div class="swiper-button-next" aria-label="التالي"></div>
        <div class="swiper-pagination"></div>
      </div>
    </div>
  </section>

  <!-- النتائج (سويبر البطاقات بالشكل المطلوب) -->
  <section id="results" class="section list" aria-labelledby="list-title">
    <div class="container">
      <header class="section-header">
        
      </header>

      <div class="swiper contractor-swiper" dir="rtl">
        <div class="swiper-wrapper" id="contractorsWrapper">
          <% if (Array.isArray(contractors) && contractors.length) { contractors.forEach(function(c){ 
               const img = (Array.isArray(c.photos) && c.photos[0]) || c.avatar || '/Public/assets/contractors/default.jpg';
               const services = Array.isArray(c.services) ? c.services.join('، ') : (c.services || '');
               const region = c.region || '';
               const tier = c.userTier || c.subscriptionTier || 'Basic';
               if (tier === 'VIP') { return; } // ← لا نرسم VIP في السلايدر العام

            %>
              <div class="swiper-slide">
                <article class="contractor-card">
                  <% if (String(tier||'Basic').toLowerCase() !== 'basic') { %>
  <span class="tier-badge"><%= tier %></span>
<% } %>

                  <div class="card-row">
                    <div class="avatar"><img src="<%= img %>" alt="صورة <%= c.name || 'مقاول' %>" loading="lazy" onerror="this.onerror=null;this.src='/Public/assets/contractors/default.jpg'"></div>
                    <div class="info-stack">
                      <h3 class="name"><%= c.name || '—' %></h3>
                      <p class="specialization"><%= services || '—' %></p>
                      <p class="region"><%= region || '—' %></p>
                    </div>
                  </div>
                  <div class="rating"><small>(<%= c.ratingCount || 0 %>)</small><span><%= Number(c.ratingAvg||0).toFixed(2) %></span><span>⭐</span></div>
                  <a class="card-cta" href="/contractor/<%= c._id %>">صفحة المقاول</a>
                </article>
              </div>
          <% }) } %>
        </div>
        <div class="swiper-button-prev" aria-label="السابق"></div>
        <div class="swiper-button-next" aria-label="التالي"></div>
        <div class="swiper-pagination"></div>
      </div>
    </div>
  </section>

    <%- include('partials/promo', { promoBottom }) %>
 <%- include('partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script>
    const $  = (s,ctx=document)=>ctx.querySelector(s);
    const $$ = (s,ctx=document)=>Array.from(ctx.querySelectorAll(s));
    const htmlEscape = (s='') => String(s).replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
    function assetPath(u){
      u = (u||'').toString().trim();
      if (/^data:/i.test(u) || /^https?:\/\//i.test(u)) return u;
      u = u.replace(/\\/g,'/').replace(/^\/?Public\//,'/public/').replace(/\/assests\//gi,'/assets/');
      if (u.startsWith('/uploads/') || u.startsWith('/public/')) return u;
      if (u.startsWith('/assets/')) return '/public'+u;
      if (u.startsWith('/')) return '/public'+u;
      return '/uploads/'+u;
    }

    const form       = $('#contractor-filters');
    const listWrap   = $('#contractorsWrapper');
    const vipSection = $('#vip-contractors');
    const vipWrap    = $('#vipContractorsWrapper');

 function contractorSlide(c){
  const img   = assetPath((Array.isArray(c.photos)&&c.photos[0]) || c.avatar || '/Public/assets/contractors/default.jpg');
  const name  = htmlEscape(c.name || '—');
  const spec  = htmlEscape(Array.isArray(c.services) ? c.services.join('، ') : (c.services||'—'));
  const reg   = htmlEscape(c.region || '—');

  // ← طبّع الخطة ثم قرّر إظهار الشارة
  const tierRaw = (c.userTier || c.subscriptionTier || 'Basic');
  const tier    = String(tierRaw);
  const showBadge = tier.toLowerCase() !== 'basic';
  const badgeHTML = showBadge ? `<span class="tier-badge">${tier}</span>` : '';

  const rating= Number(c.ratingAvg||0).toFixed(2);
  const rcnt  = Number(c.ratingCount||0);

  return `
    <div class="swiper-slide">
      <article class="contractor-card">
        ${badgeHTML}
        <div class="card-row">
          <div class="avatar"><img src="${img}" alt="صورة ${name}" loading="lazy" onerror="this.onerror=null;this.src='/Public/assets/contractors/default.jpg'"></div>
          <div class="info-stack">
            <h3 class="name">${name}</h3>
            <p class="specialization">${spec}</p>
            <p class="region">${reg}</p>
          </div>
        </div>
        <div class="rating"><small>(${rcnt})</small><span>${rating}</span><span>⭐</span></div>
        <a class="card-cta" href="/contractor/${c._id}">صفحة المقاول</a>
      </article>
    </div>`;
}


    function vipSlide(c){
    return contractorSlide(c);

    }

    async function fetchJSON(url){
      const r = await fetch(url, { headers: { 'Accept':'application/json' }});
      if (!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      return j.data || j.rows || [];
    }

    let allContractors = [];
    let vipOnlyList    = [];
    let nonVipList     = []; 
    let listSwiper = null, vipSwiper = null;

    function destroySwiper(sw){ if (sw) try{ sw.destroy(true,true); }catch(_){ } }

function initListSwiper(){
  destroySwiper(listSwiper);
  listSwiper = new Swiper('.contractor-swiper', {
    watchOverflow: true,
    pagination: { el: '.contractor-swiper .swiper-pagination', clickable: true },
    navigation: { nextEl: '.contractor-swiper .swiper-button-next', prevEl: '.contractor-swiper .swiper-button-prev' },
    breakpoints: {
      /* هاتف: كرتان */
      0:    { slidesPerView: 2.02, spaceBetween: 10 },
      480:  { slidesPerView: 2.10, spaceBetween: 12 },
      /* تابلت صغير */
      640:  { slidesPerView: 2.4,  spaceBetween: 14 },
      /* أكبر */
      1024: { slidesPerView: 3.2,  spaceBetween: 18 },
      1280: { slidesPerView: 4.0,  spaceBetween: 20 }
    }
  });
}
   function initVipSwiper(){
  destroySwiper(vipSwiper);
  vipSwiper = new Swiper('.vip-swiper', {
    watchOverflow: true,
    pagination: { el: '.vip-swiper .swiper-pagination', clickable: true },
    navigation: { nextEl: '.vip-swiper .swiper-button-next', prevEl: '.vip-swiper .swiper-button-prev' },
    breakpoints: {
      0:    { slidesPerView: 2.02, spaceBetween: 10 },  /* هاتف: كرتان */
      480:  { slidesPerView: 2.10, spaceBetween: 12 },
      640:  { slidesPerView: 2.4,  spaceBetween: 14 },
      1024: { slidesPerView: 3.2,  spaceBetween: 18 },
      1280: { slidesPerView: 4.0,  spaceBetween: 20 }
    }
  });
}


    function renderList(list){
      listWrap.innerHTML = (list&&list.length) ? list.map(contractorSlide).join('') : `<div class="empty muted">لا توجد نتائج مطابقة.</div>`;
      initListSwiper();
    }
    function renderVip(list){
      const has = Array.isArray(list) && list.length>0;
      vipSection.hidden = !has;
      vipWrap.innerHTML = has ? list.map(vipSlide).join('') : '';
      if (has) initVipSwiper(); else destroySwiper(vipSwiper);
    }

   function applyFilters(){
  const qSpec = (form?.specialization?.value || '').trim().toLowerCase();
  const qCity = (form?.city?.value || '').trim().toLowerCase();

  const pass = (c) => {
    // الخدمات قد تكون Array أو نص
    const spec = (Array.isArray(c.services) ? c.services.join('، ') : (c.services || '')).toString().toLowerCase();
    // نعتمد المحافظة من حقل city (وليس region)
    const city = (c.city || '').toString().toLowerCase();

    const okSpec = !qSpec || spec.includes(qSpec);
    const okCity = !qCity || city.includes(qCity);
    return okSpec && okCity;
  };

  renderList(nonVipList.filter(pass));
  renderVip(vipOnlyList.filter(pass));
}


    (async function init(){
      try {
        const apiAll = await fetchJSON('/api/contractors');
        allContractors = Array.isArray(apiAll) ? apiAll : [];
      } catch(e) {
        /* SSR fallback (خارج backticks لتفادي خطأ EJS) */
        const ssr = <%- JSON.stringify((typeof contractors!=='undefined' && Array.isArray(contractors)) ? contractors : []) %>;
        allContractors = ssr;
      }
      try {
        const apiVip = await fetchJSON('/api/contractors?vipOnly=1');
        vipOnlyList = Array.isArray(apiVip) ? apiVip : [];
      } catch(_) {
        vipOnlyList = allContractors.filter(c => (c.subscriptionTier||'') === 'VIP');
      }

      // ترتيب العرض: VIP ثم Premium ثم Basic
      const rank = { VIP:0, Premium:1, Basic:2 };
      allContractors.sort((a,b)=>(rank[a.subscriptionTier||'Basic']??9)-(rank[b.subscriptionTier||'Basic']??9));

      // بعد الترتيب:
nonVipList = allContractors.filter(c => ((c.userTier || c.subscriptionTier || 'Basic') !== 'VIP'));

// السلايدر العام يعرض غير الـ VIP فقط
renderList(nonVipList);

// سلايدر الـ VIP كما هو
renderVip(vipOnlyList);


    if (form){
  form.addEventListener('submit', e=>{ e.preventDefault(); applyFilters(); });
  // استمع لتغيّر القوائم المنسدلة أيضًا
  $$('#contractor-filters select').forEach(sel => sel.addEventListener('change', applyFilters));
}

    })();
  </script>
</body>
</html>
