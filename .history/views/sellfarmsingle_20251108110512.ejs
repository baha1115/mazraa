<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title><%= farm ? (farm.title + ' â€” Ø§Ù„ØªÙØ§ØµÙŠÙ„') : 'Ø§Ù„Ù…Ø²Ø±Ø¹Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©' %></title>
  <meta name="description" content="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©: Ø§Ù„ØµÙˆØ±ØŒ Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŒ Ø§Ù„ÙˆØµÙØŒ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø­Ø§Ù„Ø©."/>

  <!-- Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>

  <style>
    /* ====== Design Tokens ====== */
    :root{
      --bg:#f7fafc; --card:#fff; --ink:#0f172a; --muted:#64748b;
      --accent:#10b981; --danger:#ef4444; --ring:#0f172a22;
      --r:16px; --shadow:0 14px 36px rgba(2,6,23,.10); --container:1160px;
    }
    html,body{ background:var(--bg); color:var(--ink); }
    .container{ width:min(100%,var(--container)); margin-inline:auto; padding-inline:16px; }
    .section{ padding:1.25rem 0; }
    .card{ background:var(--card); border:1px solid #e2e8f0; border-radius:var(--r); box-shadow:var(--shadow); }
    .grid{ display:grid; gap:16px; }
    .muted{ color:var(--muted); }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.65rem 1rem; border-radius:12px; font-weight:700; text-decoration:none; cursor:pointer; }
    .btn-primary{ background:var(--accent); color:#fff; border:none; }
    .btn-outline{ background:#fff; color:#0f172a; border:1px solid #0f172a; }
    .btn-ghost{ background:#fff; color:var(--ink); border:1px solid #e2e8f0; }

    /* ====== HERO Ø¬Ø¯ÙŠØ¯ Ø®ÙÙŠÙ ====== */
    .hero{ position:relative; border-radius:20px; overflow:hidden; min-height:300px; margin-block:10px; background:#e2e8f0; }
    .hero__bg{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; filter:brightness(.9); }
    .hero__veil{ position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.50) 80%); }
    .hero__body{ position:absolute; inset-inline:1rem; inset-block-end:1rem; color:#fff; display:grid; gap:.45rem; }
    .hero__title{ margin:0; font-size:clamp(20px,3vw,32px); font-weight:900; letter-spacing:-.2px; }
    .hero__meta{ margin:0; opacity:.95; }
    .price-chip{ position:absolute; top:12px; inset-inline-end:12px; z-index:2; background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; border-radius:999px; padding:.25rem .65rem; font-weight:800; }
    .badge{ display:inline-block; padding:.22rem .6rem; border-radius:999px; font-size:.8rem; color:#fff; background:#0f172a; box-shadow:0 2px 8px rgba(0,0,0,.25); }
    .badge--vip{ background:#0f172a; } .badge--premium{ background:#8b5cf6; } .badge--ok{ background:#065f46; } .badge--no{ background:#991b1b; } .badge--video{ background:var(--danger); }
    .hero__badges{ display:flex; gap:.4rem; flex-wrap:wrap; }
    .hero__actions{ margin-top:.7rem; display:flex; gap:.5rem; flex-wrap:wrap; }
    .hero__cta{ background:#fff; color:#111; }

    /* ====== ØªØ®Ø·ÙŠØ· Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ====== */
    .main-grid{ grid-template-columns:1fr; }
    @media (min-width:1024px){ .main-grid{ grid-template-columns:2fr 1fr; align-items:start; } .aside-sticky{ position:sticky; top:16px; } }

    /* ====== Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± (Ø±Ø¦ÙŠØ³ÙŠ + Ù…ØµØºÙ‘Ø±Ø§Øª) ====== */
    .gallery .swiper-slide img{ width:100%; height:420px; object-fit:cover; border-radius:12px; }
    .gallery-thumbs .swiper-slide{ opacity:.7; cursor:pointer; }
    .gallery-thumbs .swiper-slide-thumb-active{ opacity:1; }
    .gallery-thumbs img{ width:100%; height:84px; object-fit:cover; border-radius:10px; }
    @media (max-width:480px){ .gallery .swiper-slide img{ height:260px; } .gallery-thumbs img{ height:70px; } }

    /* ====== Ø¨Ø·Ø§Ù‚Ø§Øª Ù…ÙˆØ§ØµÙØ§Øª Ø¨Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ====== */
    .infogrid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; }
    .info-item{ display:flex; gap:.6rem; align-items:flex-start; border:1px solid #e2e8f0; border-radius:12px; padding:.8rem; background:#fff; }
    .info-ico{ width:28px; height:28px; display:inline-grid; place-items:center; border:1px solid #e2e8f0; border-radius:8px; }
    .info-ico svg{ width:18px; height:18px; }
    .info-t h3{ margin:.05rem 0 .25rem; font-size:1rem; }
    .info-t p{ margin:0; color:var(--muted); }

    /* ====== Ø£Ù‚Ø³Ø§Ù… Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø·ÙŠ ====== */
    .fold{ border:1px solid #e2e8f0; border-radius:12px; background:#fff; }
    .fold > summary{ list-style:none; cursor:pointer; padding:1rem; font-weight:800; display:flex; align-items:center; justify-content:space-between; }
    .fold > summary::marker{ content:''; }
    .fold > summary span{ color:var(--muted); font-weight:600; }
    .fold[open] > summary span{ transform:rotate(180deg); }
    .fold__body{ padding:0 1rem 1rem; }

    /* ====== Ø§Ù„Ø®Ø±ÙŠØ·Ø© ====== */
    #leafletMap{ width:100%; height:380px; border-radius:12px; }
    .map-placeholder img{ max-width:100%; height:auto; border-radius:12px; }
    .map-placeholder img.static-map{ display:none; }

    /* ====== Ø³ÙˆÙŠØ¨Ø± Ù…Ø²Ø§Ø±Ø¹ Ø§Ù„Ù…Ø§Ù„Ùƒ ====== */
    .vip-hero-slide{ position:relative; min-height:360px; border-radius:16px; overflow:hidden; background:#eef2f7; }
    .vip-hero-img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; filter:brightness(.85); }
    .vip-hero-overlay{ position:absolute; inset:0; background:linear-gradient(90deg, rgba(0,0,0,.45), rgba(0,0,0,.15) 40%, rgba(0,0,0,0) 70%); }
    .vip-hero-body{ position:absolute; inset-inline:1.2rem; inset-block-end:1.1rem; color:#fff; display:grid; gap:.35rem; }
    .vip-hero-title{ margin:.1rem 0; font-size:clamp(18px,3vw,28px); }
    .vip-hero-cta{ display:inline-block; padding:.5rem .9rem; border-radius:10px; background:#fff; color:#0f172a; text-decoration:none; width:150px; text-align:center; }

    /* ====== Ø´Ø±ÙŠØ· Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³ÙÙ„ÙŠ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ====== */
    .mobile-cta{ position:fixed; inset-inline:0; bottom:0; z-index:70; background:#fff; padding:.5rem env(safe-area-inset-right) calc(.5rem + env(safe-area-inset-bottom)) env(safe-area-inset-left); box-shadow:0 -10px 26px rgba(2,6,23,.10); border-top:1px solid #e2e8f0; display:grid; grid-template-columns:1fr 1fr 1fr; gap:.5rem; }
    .mobile-cta .btn{ height:44px; border-radius:12px; }
    .btn-wa{ background:#10b981; color:#fff; border:none; }
    .btn-call{ background:#0f172a; color:#fff; border:none; }
    .btn-mail{ background:#fff; color:#0f172a; border:1px solid #0f172a; }
    @media (min-width:1024px){ .mobile-cta{ display:none; } }
    @media (max-width:1023.98px){ body{ padding-bottom:84px; } } /* Ù…Ø³Ø§Ø­Ø© Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø³ÙÙ„ */
    .prose{ line-height:1.85; }
    /* ===== Fix: Ù†Ø³Ø¨Ø© Ø£Ø¨Ø¹Ø§Ø¯ Ø«Ø§Ø¨ØªØ© Ù„Ù„ØµÙˆØ± ÙÙŠ Ø§Ù„Ø³ÙˆÙŠØ¨Ø± ===== */

/* Ø§Ø¬Ø¹Ù„ ÙƒÙ„ Ø³Ù„Ø§ÙŠØ¯ Ø­Ø§ÙˆÙŠØ© Ø¨Ù†Ø³Ø¨Ø© Ø£Ø¨Ø¹Ø§Ø¯ */
.gallery .swiper-slide{
  position: relative;
  aspect-ratio: 16 / 9;      /* Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙŠØ³ÙƒØªÙˆØ¨ */
  overflow: hidden;
  border-radius: 12px;
}

/* Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù†Ø¬Ø¹Ù„ Ø§Ù„Ù†Ø³Ø¨Ø© Ø£ÙƒØ«Ø± Ø·ÙˆÙ„Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) */
@media (max-width:640px){
  .gallery .swiper-slide{ aspect-ratio: 4 / 3; }  /* ÙŠÙ…ÙƒÙ†Ùƒ 1/1 Ø­Ø³Ø¨ ØµÙˆØ±Ùƒ */
}

/* Ø§Ù„ØµÙˆØ±Ø© ØªÙ…Ù„Ø£ Ø§Ù„Ø³Ù„Ø§ÙŠØ¯ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªÙ…Ø¯Ø¯ */
.gallery .swiper-slide img{
  position: absolute; inset: 0;
  width: 100%; height: 100%;
  object-fit: cover;            /* ØªÙ…Ù†Ø¹ Ø§Ù„ØªÙ…Ø¯Ø¯ ÙˆØªÙ‚ØµÙ‘ Ù…Ù† Ø§Ù„Ø£Ø·Ø±Ø§Ù */
  object-position: center;      /* Ù‚ØµÙ‘ Ù…Ù† Ø§Ù„Ù…Ù†ØªØµÙ */
}

/* Ù…ØµØºÙ‘Ø±Ø§Øª Ø§Ù„Ø³ÙˆÙŠØ¨Ø± */
.gallery-thumbs .swiper-slide{
  aspect-ratio: 16 / 10;
  overflow: hidden; border-radius: 10px;
}
.gallery-thumbs .swiper-slide img{
  width: 100%; height: 100%; object-fit: cover;
}
/* ============ GALLERY HARD-FIX ============ */
/* 1) Ø«Ø¨Ù‘Øª Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø¨Ù†ÙØ³Ø¨Ø© Ø£Ø¨Ø¹Ø§Ø¯ + Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ø§Ø±ØªÙØ§Ø¹ */
.gallery .gallery-main,
.gallery .gallery-swiper{
  position: relative;
  width: 100%;
  aspect-ratio: 16 / 9;     /* ØºÙŠÙ‘Ø±Ù‡Ø§ 4/3 Ø£Ùˆ 1/1 Ù„Ùˆ Ø£Ø±Ø¯Øª */
  max-height: 72vh;         /* ÙŠÙ…Ù†Ø¹ â€œØ§Ù„ØªÙ…Ø¯Ø¯ Ø¥Ù„Ù‰ Ù…Ø§Ù„Ø§Ù†Ù‡Ø§ÙŠØ©â€ */
  border-radius: 12px;
  overflow: hidden;
}

/* 2) Ø§Ø¬Ø¹Ù„ ÙƒÙ„ Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø§Øª ØªÙ…ØªÙ„Ø¦ Ø§Ù„Ø­Ø§ÙˆÙŠØ© */
.gallery .gallery-main .swiper-wrapper,
.gallery .gallery-main .swiper-slide,
.gallery .gallery-swiper .swiper-wrapper,
.gallery .gallery-swiper .swiper-slide{
  height: 100% !important;
}

/* 3) Ø§Ù„ØµÙˆØ±Ø© ØªÙ…Ù„Ø£ Ø§Ù„Ø³Ù„Ø§ÙŠØ¯ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªÙ…Ø¯Ø¯ */
.gallery .gallery-main .swiper-slide img,
.gallery .gallery-swiper .swiper-slide img{
  width: 100% !important;
  height: 100% !important;
  object-fit: cover !important;   /* Ù‚ØµÙ‘ Ø£Ù†ÙŠÙ‚ Ù…Ù† Ø§Ù„Ø£Ø·Ø±Ø§Ù */
  object-position: center !important;
  display: block;
}

/* 4) Ù…ØµØºÙ‘Ø±Ø§Øª Ù…Ø±ØªÙ‘Ø¨Ø© */
.gallery .gallery-thumbs .swiper-slide{
  aspect-ratio: 16 / 10;
  overflow: hidden;
  border-radius: 10px;
}
.gallery .gallery-thumbs .swiper-slide img{
  width: 100%; height: 100%; object-fit: cover;
}

/* 5) Ø¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ¯Ø¹Ù… aspect-ratio */
@supports not (aspect-ratio: 1 / 1){
  .gallery .gallery-main,
  .gallery .gallery-swiper{ height: auto; }
  .gallery .gallery-main::before,
  .gallery .gallery-swiper::before{
    content:""; display:block; padding-top:56.25%; /* 16:9 */
  }
}

  </style>
</head>
<body>
<%
  /* ====== Helpers + Safe Locals ====== */
  function assetPath(u){
    u = (u||'').toString().trim();
    if (/^data:/i.test(u) || /^https?:\/\//i.test(u)) return u;
    u = u.replace(/\\/g,'/').replace(/^\/?Public\//,'/public/').replace(/\/assests\//gi,'/assets/');
    if (u.startsWith('/uploads/') || u.startsWith('/public/')) return u;
    if (u.startsWith('/assets/')) return '/public'+u;
    if (u.startsWith('/')) return '/public'+u;
    return '/uploads/'+u;
  }
  const _isAuth      = (typeof isAuth !== 'undefined') ? isAuth : false;
  const _user        = (typeof user   !== 'undefined') ? user   : null;
  const _currentPath = (typeof currentPath !== 'undefined') ? currentPath : '';
  const _banners     = (typeof bannersDoc !== 'undefined') ? bannersDoc : null;

  const photos = (Array.isArray(farm?.photos) && farm.photos.length) ? farm.photos : ['/assets/farm-default.jpg'];
  const cover  = assetPath(photos[0]);
  const ownerList = Array.isArray(sameOwnerFarms) ? sameOwnerFarms : [];
  const hasOwnerFarms = ownerList.length > 0;

  const sym  = (farm?.currency === 'SYP') ? 'Ù„.Ø³' : '$';
  const pStr = Number(farm?.price||0) ? (sym + ' ' + Number(farm.price).toLocaleString('en')) : 'â€”';
%>

<!-- Ø¬Ø²Ø¡ Ø§Ù„Ø±Ø£Ø³ ÙˆØ§Ù„Ø²Ø± Ø§Ù„Ø«Ø§Ø¨Øª (ØªÙ…Ø±ÙŠØ± Ø¢Ù…Ù†) -->
<%- include('partials/navbar', { isAuth:_isAuth, user:_user, currentPath:_currentPath }) %>
<%- include('partials/whatsapp') %>
<% if (_banners) { %><%- include('partials/promo-swiper', { bannersDoc:_banners }) %><% } %>

<!-- Breadcrumb -->
<nav class="breadcrumb" aria-label="Breadcrumb">
  <div class="container">
    <ol>
      <li><a href="/">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
      <li><a href="/sale">Ù„Ù„Ø¨ÙŠØ¹</a></li>
      <li aria-current="page"><%= farm?.title || 'â€”' %></li>
    </ol>
  </div>
</nav>

<% if (!farm) { %>
  <section class="section"><div class="container"><h1>Ø§Ù„Ù…Ø²Ø±Ø¹Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</h1><p class="muted">Ø¹Ø°Ø±Ù‹Ø§ØŒ Ù„Ù… Ù†Ø¹Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.</p><a class="btn btn-outline" href="/sale">Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</a></div></section>
<% } else { %>

<!-- ====== HERO ====== -->
<section class="section">
  <div class="container">
    <header class="hero card">
      <img class="hero__bg" src="<%= cover %>" alt="<%= farm.title %>" loading="eager" onerror="this.onerror=null;this.src='/public/assets/farm-default.jpg'">
      <div class="hero__veil"></div>
      <div class="price-chip"><%= pStr %><%= (String(farm.kind).toLowerCase()==='rent' ? '/Ø´Ù‡Ø±' : '') %></div>
      <div class="hero__body">
        <div class="hero__badges">
          <% const tier = (farm?.owner?.subscriptionTier || farm?.ownerTier || 'Basic'); %>
          <% if (tier==='VIP') { %><span class="badge badge--vip">VIP</span><% } %>
          <% if (tier==='Premium') { %><span class="badge badge--premium">Premium</span><% } %>
          <% const rented = (farm.status||'available').toLowerCase()==='rented'; %>
          <span class="badge <%= rented?'badge--no':'badge--ok' %>"><%= rented?'Ù…Ø¤Ø¬Ù‘Ø±Ø©':'Ù…ØªØ§Ø­Ø©' %></span>
          <% if (farm.videoUrl) { %><span class="badge badge--video">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ</span><% } %>
        </div>
        <h1 class="hero__title"><%= farm.title %></h1>
        <p class="hero__meta"><%= farm.city ? (farm.area||'') + ' â€” ' + farm.city : (farm.area||'â€”') %></p>
        <div class="hero__actions">
          <a class="btn btn-primary" href="#gallery">ØªØµÙÙ‘Ø­ Ø§Ù„ØµÙˆØ±</a>
          <a class="btn hero__cta" href="https://wa.me/<%= ((farm?.ownerInfo?.whatsapp)||'').replace(/\D/g,'') %>?text=<%= encodeURIComponent('Ø£Ù†Ø§ Ù…Ù‡ØªÙ… Ø¨Ù…Ø²Ø±Ø¹Ø©: ' + farm.title) %>" target="_blank" rel="noopener">ÙˆØ§ØªØ³Ø§Ø¨</a>
        </div>
      </div>
    </header>
  </div>
</section>

<!-- ====== Main ====== -->
<section class="section">
  <div class="container grid main-grid">
    <!-- ÙŠØ³Ø§Ø±: Ø§Ù„Ù…Ø¹Ø±Ø¶ + ØªÙØ§ØµÙŠÙ„ + ÙˆØµÙ + Ø®Ø±ÙŠØ·Ø© -->
    <div class="grid" style="gap:18px">

      <!-- Gallery with thumbs -->
      <section id="gallery" class="card" aria-labelledby="gallery-title" style="padding:1rem">
        <h2 id="gallery-title" style="margin:0 0 .75rem">Ø§Ù„Ù…Ø¹Ø±Ø¶</h2>

        <div class="swiper gallery-main">
          <div class="swiper-wrapper" id="galleryMain">
            <% photos.forEach(function(src){ %>
              <div class="swiper-slide"><img src="<%= assetPath(src) %>" alt="<%= farm.title %>" loading="lazy"></div>
            <% }) %>
          </div>
          <div class="swiper-button-prev" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚"></div>
          <div class="swiper-button-next" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ"></div>
          <div class="swiper-pagination"></div>
        </div>

        <div class="swiper gallery-thumbs" style="margin-top:.6rem">
          <div class="swiper-wrapper">
            <% photos.forEach(function(src){ %>
              <div class="swiper-slide"><img src="<%= assetPath(src) %>" alt="Ù…ØµØºÙ‘Ø±" loading="lazy"></div>
            <% }) %>
          </div>
        </div>
      </section>

      <!-- Quick info (icons) -->
      <section class="card" aria-labelledby="quick-title" style="padding:1rem">
        <h2 id="quick-title" style="margin:0 0 .75rem">ØªÙØ§ØµÙŠÙ„ Ø³Ø±ÙŠØ¹Ø©</h2>

        <div class="infogrid">
          <article class="info-item">
            <span class="info-ico" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none"><path d="M4 4h16v16H4zM4 9h16M9 4v16" stroke="currentColor" stroke-width="1.4"/></svg></span>
            <div class="info-t"><h3>Ø§Ù„Ù…Ø³Ø§Ø­Ø©</h3><p><strong><%= Number(farm.size||0).toLocaleString('en') %></strong> Ù…Â²</p></div>
          </article>

          <article class="info-item">
            <span class="info-ico" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none"><path d="M5 12l5 5L20 7" stroke="currentColor" stroke-width="1.8"/></svg></span>
            <div class="info-t"><h3>Ø§Ù„Ø­Ø§Ù„Ø©</h3><% const rented2=(farm.status||'available').toLowerCase()==='rented'; %><p><span class="badge <%= rented2?'badge--no':'badge--ok' %>"><%= rented2?'Ù…Ø¤Ø¬Ù‘Ø±Ø©':'Ù…ØªØ§Ø­Ø©' %></span></p></div>
          </article>

          <article class="info-item">
            <span class="info-ico" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none"><path d="M12 21s7-7 7-11a7 7 0 10-14 0c0 4 7 11 7 11z" stroke="currentColor" stroke-width="1.3"/><circle cx="12" cy="10" r="2.7" fill="currentColor"/></svg></span>
            <div class="info-t"><h3>Ø§Ù„Ù…ÙˆÙ‚Ø¹</h3><p><%= farm.city ? (farm.area||'') + ' â€” ' + farm.city : (farm.area||'â€”') %></p></div>
          </article>

          <article class="info-item">
            <span class="info-ico" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none"><path d="M1.5 12S5.5 5 12 5s10.5 7 10.5 7-4 7-10.5 7S1.5 12 1.5 12z" stroke="currentColor" stroke-width="1.2"/><circle cx="12" cy="12" r="3" fill="currentColor"/></svg></span>
            <div class="info-t"><h3>Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª</h3><p>ğŸ‘ï¸ <%= Number((typeof viewsCount!=='undefined'?viewsCount:farm.views)||0).toLocaleString('en') %></p></div>
          </article>
        </div>
      </section>

      <!-- ÙÙŠØ¯ÙŠÙˆ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
      <% const __videoUrl = (farm.videoUrl||'').trim(); if (__videoUrl) { %>
      <section class="card" aria-labelledby="video-title" style="padding:1rem">
        <h2 id="video-title" style="margin:0 0 .6rem">ÙÙŠØ¯ÙŠÙˆ ØªÙØµÙŠÙ„ÙŠ</h2>
        <div class="video-frame" id="videoFrame"></div>
      </section>
      <% } %>

      <!-- ÙˆØµÙ -->
      <section id="description" class="card" aria-labelledby="desc-title" style="padding:1rem">
        <h2 id="desc-title" style="margin:0 0 .6rem">Ø§Ù„ÙˆØµÙ Ø§Ù„ÙƒØ§Ù…Ù„</h2>
        <article class="prose"><p><%= (farm.description||'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ÙØµÙ‘Ù„.') %></p></article>
      </section>

      <!-- Ø®Ø±ÙŠØ·Ø© -->
      <section id="map" class="card" aria-labelledby="map-title" style="padding:1rem">
        <h2 id="map-title" style="margin:0 0 .6rem">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</h2>
        <div class="map-placeholder" id="mapPlaceholder"
             data-lat="<%= farm?.location?.lat || '' %>"
             data-lng="<%= farm?.location?.lng || '' %>"
             data-address="<%= (farm?.location?.address || '').replace(/"/g,'&quot;') %>">
          <img class="static-map" src="/public/assets/location.jpg" alt="Ø®Ø±ÙŠØ·Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ©" loading="lazy">
        </div>
        <div id="leafletMap" aria-label="Ø®Ø±ÙŠØ·Ø© OpenStreetMap"></div>
      </section>

    </div>

    <!-- ÙŠÙ…ÙŠÙ†: ÙƒØ±Øª ØªÙˆØ§ØµÙ„ Sticky -->
    <aside class="aside-sticky">
      <section class="card" style="padding:1rem">
        <h3 style="margin:.2rem 0 .6rem">Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</h3>
        <div class="grid" style="grid-template-columns:1fr; gap:.6rem">
          <div class="info-item">
            <span class="info-ico"><svg viewBox="0 0 24 24" fill="none"><path d="M4 5h16M4 12h16M4 19h16" stroke="currentColor" stroke-width="1.6"/></svg></span>
            <div class="info-t"><h3>Ø§Ù„Ø³Ø¹Ø±</h3><p style="font-weight:900"><%= pStr %></p></div>
          </div>
          <% const _wa=((farm?.ownerInfo?.whatsapp)||'').replace(/\D/g,''); const _ph=(farm?.ownerInfo?.phone||'').replace(/\s+/g,''); const _em=farm?.ownerInfo?.email||''; %>
          <% if (_wa) { %><a class="btn btn-primary" href="<%= 'https://wa.me/'+_wa+'?text='+encodeURIComponent('Ø£Ù†Ø§ Ù…Ù‡ØªÙ… Ø¨Ù…Ø²Ø±Ø¹Ø©: '+farm.title) %>" target="_blank" rel="noopener">ÙˆØ§ØªØ³Ø§Ø¨</a><% } %>
          <% if (_ph) { %><a class="btn btn-outline" href="tel:<%= _ph %>">Ø§ØªØµØ§Ù„ Ù‡Ø§ØªÙÙŠ</a><% } %>
          <% if (_em) { %><a class="btn btn-ghost" href="mailto:<%= _em %>">Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯</a><% } %>
        </div>
      </section>
    </aside>

  </div>
</section>

<!-- Ù…Ø²Ø§Ø±Ø¹ Ø£Ø®Ø±Ù‰ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø§Ù„Ùƒ -->
<% if (hasOwnerFarms) { %>
<section class="section" aria-labelledby="owner-farms-title">
  <div class="container">
    <header class="section-header" style="margin-bottom:.75rem">
      <h2 id="owner-farms-title">Ù…Ø²Ø§Ø±Ø¹ Ø£Ø®Ø±Ù‰ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø§Ù„Ùƒ</h2>
      <p class="muted">Ù‚Ø¯ ØªÙ‡Ù…Ù‘Ùƒ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø²Ø§Ø±Ø¹ Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù…Ø§Ù„Ùƒ.</p>
    </header>

    <div class="swiper vip-swiper" dir="rtl">
      <div class="swiper-wrapper">
        <% ownerList.forEach(function(f){
             const raw = (Array.isArray(f.photos) && f.photos[0]) ? f.photos[0] : '/assets/farm-default.jpg';
             const link = (String(f.kind||'').toLowerCase()==='rent') ? ('/rent/farm/'+f._id) : ('/farm/'+f._id);
             const loc  = f.city ? ((f.area||'') + ' â€” ' + f.city) : (f.area||'â€”');
        %>
        <div class="swiper-slide">
          <article class="vip-hero-slide card" style="border:none">
            <img class="vip-hero-img" src="<%= assetPath(raw) %>" alt="<%= f.title||'Ù…Ø²Ø±Ø¹Ø©' %>" loading="lazy" onerror="this.onerror=null;this.src='/public/assets/farm-default.jpg'">
            <div class="vip-hero-overlay"></div>
            <div class="vip-hero-body">
              <h3 class="vip-hero-title"><%= f.title || 'â€”' %></h3>
              <div class="muted">
                <% const sym2=(f.currency==='SYP'?'Ù„.Ø³':'$'); %>
                <%= loc %> â€¢ <%= Number(f.size||0).toLocaleString('en') %> Ù…Â² â€¢
                <%= sym2 %><%= Number(f.price||0).toLocaleString('en') %><%= (String(f.kind).toLowerCase()==='rent' ? '/Ø´Ù‡Ø±' : '') %>
              </div>
              <a class="vip-hero-cta" href="<%= link %>">Ø§Ù„ØªÙØ§ØµÙŠÙ„</a>
            </div>
          </article>
        </div>
        <% }) %>
      </div>
      <div class="swiper-button-prev" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚"></div>
      <div class="swiper-button-next" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ"></div>
      <div class="swiper-pagination"></div>
    </div>
  </div>
</section>
<% } %>

<% if (typeof topSale !== 'undefined') { %>
  <%- include('partials/top-sale', { items: topSale }) %>
<% } %>
<% } /* end if farm */ %>

<%- include('partials/footer') %>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* Ø³ÙˆÙŠØ¨Ø±: Ù…Ø²Ø§Ø±Ø¹ Ø§Ù„Ù…Ø§Ù„Ùƒ */
if (document.querySelector('.vip-swiper')) {
  new Swiper('.vip-swiper', {
    loop:true, centeredSlides:true, slidesPerView:1.02, spaceBetween:18, watchOverflow:true,
    pagination:{ el:'.vip-swiper .swiper-pagination', clickable:true },
    navigation:{ nextEl:'.vip-swiper .swiper-button-next', prevEl:'.vip-swiper .swiper-button-prev' },
    breakpoints:{ 640:{slidesPerView:1.05,spaceBetween:20}, 1024:{slidesPerView:1.08,spaceBetween:22} }
  });
}

/* Ø³ÙˆÙŠØ¨Ø±: Ø§Ù„Ù…Ø¹Ø±Ø¶ + Ø§Ù„Ù…ØµØºÙ‘Ø±Ø§Øª */
(function(){
  const thumbsEl = document.querySelector('.gallery-thumbs');
  const mainEl   = document.querySelector('.gallery-main');
  if (!thumbsEl || !mainEl) return;
  const thumbs = new Swiper('.gallery-thumbs', {
    slidesPerView:4.2, spaceBetween:8, watchOverflow:true,
    breakpoints:{ 480:{slidesPerView:5.2}, 768:{slidesPerView:6.2} }
  });
  new Swiper('.gallery-main', {
    loop:true, spaceBetween:12, watchOverflow:true,
    pagination:{ el:'.gallery-main .swiper-pagination', clickable:true },
    navigation:{ nextEl:'.gallery-main .swiper-button-next', prevEl:'.gallery-main .swiper-button-prev' },
    thumbs:{ swiper:thumbs }
  });
})();

/* Ø­Ù‚Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (ÙŠÙˆØªÙŠÙˆØ¨/Ù…Ù„Ù) */
(function(){
  const el = document.getElementById('videoFrame'); if (!el) return;
  const url = <%- JSON.stringify((farm && farm.videoUrl) ? farm.videoUrl : '') %>; if (!url) return;
  function esc(s){return (s||'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
  try{
    const u = new URL(url);
    if (u.hostname.includes('youtu.be')){ const id=u.pathname.slice(1); el.innerHTML='<iframe src="https://www.youtube.com/embed/'+id+'" title="YouTube" frameborder="0" allowfullscreen></iframe>'; return; }
    if (u.hostname.includes('youtube.com')){ const id=u.searchParams.get('v'); if (id){ el.innerHTML='<iframe src="https://www.youtube.com/embed/'+id+'" title="YouTube" frameborder="0" allowfullscreen></iframe>'; return; } }
  }catch(_){}
  if (/\.(mp4|webm|ogg)(\?|#|$)/i.test(url)){ el.innerHTML='<video controls style="width:100%;border-radius:12px"><source src="'+esc(url)+'"></video>'; }
  else { el.innerHTML='<a class="btn btn-outline" href="'+esc(url)+'" target="_blank" rel="noopener">ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</a>'; }
})();

/* Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
(function () {
  function ready(fn){ document.readyState!=='loading' ? fn() : document.addEventListener('DOMContentLoaded', fn); }
  ready(function(){
    var holder = document.getElementById('mapPlaceholder');
    var mapEl = document.getElementById('leafletMap');
    if (!holder || !mapEl || typeof L === 'undefined') return;
    var lat = parseFloat(holder.dataset.lat), lng = parseFloat(holder.dataset.lng), addr = holder.dataset.address || '';
    if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;
    var map = L.map(mapEl, { center:[lat,lng], zoom:14 });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap' }).addTo(map);
    var marker = L.marker([lat,lng]).addTo(map); if (addr) marker.bindPopup(addr);
    setTimeout(function(){ map.invalidateSize(); }, 200);
  });
})();
</script>

<!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³ÙÙ„ÙŠ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
<% const wa = ((farm?.ownerInfo?.whatsapp)||'').replace(/\D/g,''); const ph=(farm?.ownerInfo?.phone||'').replace(/\s+/g,''); const em=farm?.ownerInfo?.email||''; %>
<div class="mobile-cta" role="group" aria-label="Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„">
  <a class="btn btn-wa"   href="<%= wa ? ('https://wa.me/'+wa+'?text='+encodeURIComponent('Ø£Ù†Ø§ Ù…Ù‡ØªÙ… Ø¨Ù…Ø²Ø±Ø¹Ø©: '+farm.title)) : 'javascript:void(0)' %>" target="_blank" rel="noopener" <%= wa ? '' : 'aria-disabled="true"' %>>ÙˆØ§ØªØ³Ø§Ø¨</a>
  <a class="btn btn-call" href="<%= ph ? ('tel:'+ph) : 'javascript:void(0)' %>" <%= ph ? '' : 'aria-disabled="true"' %>>Ø§ØªØµØ§Ù„</a>
  <a class="btn btn-mail" href="<%= em ? ('mailto:'+em) : 'javascript:void(0)' %>" <%= em ? '' : 'aria-disabled="true"' %>>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</a>
</div>
</body>
</html>
