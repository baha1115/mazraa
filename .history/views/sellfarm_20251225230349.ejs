<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="alternate icon" type="image/png" href="../public/assests/logo.png">
 <title>Ù…Ø²Ø§Ø±Ø¹ Ù„Ù„Ø¨ÙŠØ¹ ÙÙŠ Ø³ÙˆØ±ÙŠØ§ â€” Ù…Ø²Ø±Ø¹ØªÙŠ</title>
<meta name="description" content="Ø§ÙƒØªØ´Ù Ù…Ø²Ø§Ø±Ø¹ Ù„Ù„Ø¨ÙŠØ¹ ÙÙŠ Ø³ÙˆØ±ÙŠØ§ Ø¨Ù…Ø³Ø§Ø­Ø§Øª ÙˆØ£Ø³Ø¹Ø§Ø± Ù…Ø®ØªÙ„ÙØ©. ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©ØŒ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©ØŒ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ù…Ø³Ø§Ø­Ø© Ø¹Ø¨Ø± Ù…Ù†ØµØ© Ù…Ø²Ø±Ø¹ØªÙŠ.">
<link rel="stylesheet" href="/public/styles/rentandfarmdetail.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <link rel="preconnect" href="https://res.cloudinary.com" crossorigin>
<link rel="dns-prefetch" href="https://res.cloudinary.com">

  <style>
  /* ===== VIP Hero ===== */
  .vip-hero-slide{
    position:relative;
    min-height:360px;
    border-radius:16px;
    overflow:hidden;
    background:#f6faf6;
  }
  @media (min-width:1024px){
    .vip-hero-slide{ min-height:520px; }
  }
  .vip-hero-img{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
    object-position:center;
    filter:brightness(.85);
  }
  .vip-hero-overlay{
    position:absolute;
    inset:0;
    background:linear-gradient(90deg,
      rgba(0,0,0,.35),
      rgba(0,0,0,.15) 40%,
      rgba(0,0,0,0) 70%
    );
  }
  .vip-hero-body{
    position:absolute;
    inset-inline:1.2rem;
    inset-block-end:1.1rem;
    color:#fff;
    display:grid;
    gap:.35rem;
  }
  .vip-hero-title{
    font-size:clamp(20px,3vw,34px);
    margin:.25rem 0 0;
  }
  .vip-hero-meta{
    opacity:.95;
    font-size:clamp(14px,1.5vw,16px);
  }
  .vip-hero-cta{
    margin-top:.6rem;
    display:inline-block;
    padding:.5rem .9rem;
    border-radius:10px;
    background:#fff;
    color:#0f172a;
    text-decoration:none;
    font-weight:600;
    width:150px;
    text-align:center;
  }
  .vip-badge{
    position:absolute;
    top:12px;
    inset-inline-start:12px;
    background:#0f172a;
    color:#fff;
    border-radius:999px;
    font-size:.8rem;
    padding:.2rem .6rem;
    z-index:4;
    box-shadow:0 2px 8px rgba(0,0,0,.25);
  }
  .vip-swiper .swiper-slide{ height:auto; }

  /* ===== Sale swiper & farm cards ===== */
  .sale-swiper .swiper-slide{ height:auto; }
/* Ù†Ø¬Ø¹Ù„ Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø§Øª ØªØ´Ø¯ Ø§Ù„ÙƒØ±ÙˆØª Ù„Ù†ÙØ³ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ */
.sale-swiper .swiper-wrapper{
  align-items: stretch;
}

 .farm-card{
  display:flex;              /* Ø¨Ø¯Ù„ block */
  flex-direction:column;     /* Ø§Ù„ØµÙˆØ±Ø© ÙÙˆÙ‚ØŒ Ø§Ù„Ù†Øµ ÙˆØ§Ù„Ø²Ø± ØªØ­Øª */
  border:1px solid #e5e7eb;
  border-radius:14px;
  overflow:hidden;
  background:#fff;
  box-shadow:0 2px 10px rgba(2,6,23,.05);
  transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
  height:100%;               /* ÙŠÙ…Ù„Ù‰ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø³Ù„Ø§ÙŠØ¯ */
}

  .farm-card:hover{
    transform:translateY(-2px);
    box-shadow:0 10px 24px rgba(2,6,23,.08);
    border-color:#e2e8f0;
  }

  .farm-media{
    position:relative;
    aspect-ratio:4/3;
    background:#f5f7f8;
  }
  .farm-card img{
    width:100% !important;
    height:100% !important;
    object-fit:cover !important;
    display:block;
  }

  .farm-body{
  padding:.7rem .75rem;
  display:grid;
  row-gap:.45rem;
  flex:1;                     /* ÙŠÙ…Ù„Ø£ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© ØªØ­Øª Ø§Ù„ØµÙˆØ±Ø© */
}


  .farm-title{
    margin:0;
    font-size:1rem;
    font-weight:900;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
    min-height:2.6em;
  }

  .farm-location{
    margin:0;
    color:#64748b;
    font-size:.9rem;
  }
  .farm-price{
    margin:0;
    color:#64748b;
    font-weight:900;
    letter-spacing:.2px;
  }

  .meta-views{
    color:#fff;
    padding:.15rem .5rem;
    font-size:.75rem;
    z-index:4;
  }
  .farm-body .meta-views{
    margin-inline-start:auto;
    font-size:.85rem;
    color:#475569 !important;
  }

  .btn.btn-outline{
    width:80%;
    display:inline-block;
    border:1px solid #0f172a;
    text-align:center;
    border-radius:10px;
    padding:.55rem 1rem;
    text-decoration:none;
    background:#fff;
    color:#0f172a;
  }
 .farm-body .btn.btn-outline{
  width:100%;
  padding:.48rem .85rem;
  font-weight:700;
  margin-top:auto;            /* ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø²Ø± Ø¯Ø§Ø¦Ù…Ù‹Ø§ ÙÙŠ Ø£Ø³ÙÙ„ Ø§Ù„ÙƒØ±Øª */
}

  .empty{
    padding:2rem;
    text-align:center;
  }

  /* ===== Badges ===== */
  .badge,
  .badge--video{
    z-index:4;
  }

  .badge{
    text-align:center;
    max-width:50px;
    position:absolute;
    inset-inline-start:10px;
    top:10px;
    background:#0f172a;
    color:#fff;
    border-radius:999px;
    font-size:.72rem;
    padding:.18rem .55rem;
    display:inline-flex;
    align-items:center;
    gap:6px;
    font-weight:800;
    letter-spacing:.2px;
    box-shadow:0 4px 14px rgba(0,0,0,.12);
  }
  .badge--vip{ background:#0f172a; }
  .badge--premium{
    background:#8b5cf6;
    color:#fff;
    max-width:80px;
  }
  .badge--basic{ background:#64748b; }
  .badge--video{
    text-align:center;
    inset-inline-start:auto;
    inset-inline-end:10px;
    background:#ef4444;
    max-width:100px;
    color:#fff;
  }

  /* ===== Filters (desktop base) ===== */
  .filter-dropdown summary{
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:.5rem;
    font-weight:600;
    user-select:none;
  }
  .filter-dropdown summary::after{
    content:"â–¾";
    transition:.2s;
    font-size:.9rem;
    opacity:.9;
  }
  .filter-dropdown[open] summary::after{
    transform:rotate(180deg);
  }
  .filters-form{ padding:.75rem 0 0; }
  .filters-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:14px;
  }
  .field .label{
    display:block;
    margin:.2rem 0 .35rem;
  }
  .field input,
  .field select{
    height:2.6rem;
    width:100%;
    padding:.75rem .9rem;
    border:1px solid #e2e8f0;
    border-radius:12px;
  }
  .field--actions{
    display:flex;
    align-items:flex-end;
  }
  .btn.btn-primary{
    background:#0f172a;
    color:#fff;
    border:none;
    border-radius:10px;
    padding:.55rem 1rem;
  }

  .advanced-fields[hidden]{ display:none !important; }
  .advanced-fields.fade-in{ animation:fadeIn .18s ease-in; }
  @keyframes fadeIn{
    from{opacity:0;transform:translateY(-4px);}
    to{opacity:1;transform:translateY(0);}
  }

  /* ===== Sale cards Â· two-up on phones ===== */
  @media (max-width:640px){
    .sale-swiper .farm-card{
      border-radius:12px !important;
    }
    .sale-swiper .farm-card img{
      height:140px !important;
      object-fit:cover !important;
    }
    .sale-swiper .farm-body{ padding:.55rem !important; }
    .sale-swiper .farm-title{
      font-size:.95rem !important;
      margin:.15rem 0 .3rem !important;
    }
    .sale-swiper .farm-location,
    .sale-swiper .farm-price{
      font-size:.82rem !important;
      margin:0 0 .2rem !important;
    }
    .sale-swiper .btn.btn-outline{
      padding:.4rem .7rem !important;
      font-size:.85rem !important;
    }
  }

  /* ===== Mobile fine-tuning + filters (Ù†ÙØ³ Ø§Ù„Ù€ breakpoint) ===== */
  @media (max-width:640px){
    .sale-swiper .swiper-slide{ height:auto; }
    .farm-body{
      padding:.6rem .6rem;
      row-gap:.4rem;
    }
    .farm-title{
      font-size:.95rem;
      min-height:2.4em;
    }
    .farm-location{ font-size:.84rem; }
    .farm-price{ font-size:.9rem; }
    .farm-body .btn.btn-outline{
      padding:.42rem .75rem;
      font-size:.86rem;
    }
    .badge{
      font-size:.68rem;
      padding:.15rem .5rem;
    }

    /* ÙÙ„Ø§ØªØ± Ù…Ø¶ØºÙˆØ·Ø© + Ø¥Ø®ÙØ§Ø¡ Ø¨Ø¹Ø¶ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    #filters .filter-dropdown summary{
      font-size:.95rem !important;
      padding:.45rem 0 !important;
      display:none !important;          /* Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†ÙˆØ§Ù† "ØªØµÙÙŠØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬" */
    }
    #filters .filters-form{
      padding:.5rem 0 0 !important;
    }
    #filters .filters-grid{
      grid-template-columns:repeat(2,minmax(130px,1fr)) !important;
      gap:8px !important;
      margin-top:0 !important;
    }
    #filters .field .label{
      margin:.1rem 0 .25rem !important;
      font-size:.85rem !important;
    }
    #filters .field input,
    #filters .field select{
      height:2.1rem !important;
      padding:.35rem .55rem !important;
      font-size:.88rem !important;
      border-radius:10px !important;
    }
    #filters .field--actions{
      gap:6px !important;
      display:none !important;          /* Ø¥Ø®ÙØ§Ø¡ "Ø§Ù„Ù…Ø²ÙŠØ¯" Ùˆ"ØªØ·Ø¨ÙŠÙ‚" */
    }
    #filters .field--actions .btn.btn-outline{
      padding:.35rem .6rem !important;
      font-size:.86rem !important;
      border-radius:10px !important;
    }
    #filters .field--actions .btn.btn-primary{
      padding:.42rem .8rem !important;
      font-size:.9rem !important;
      border-radius:10px !important;
    }
    #filters #advanced-fields.filters-grid{
      grid-template-columns:repeat(2,minmax(130px,1fr)) !important;
      gap:8px !important;
      margin-top:.35rem !important;
    }
  }

  /* ===== Tablet/Desktop touch-ups ===== */
  @media (min-width:641px){
    .farm-card{ border-radius:16px; }
    .farm-body{ padding:.8rem .85rem; }
    .farm-title{ font-size:1.05rem; }
  }

  /* ===== Location Gate (Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹) ===== */
  #location-gate{
    position:fixed;
    inset:0;
    display:none;
    z-index:1100;
  }
  #location-gate[aria-hidden="false"]{ display:block; }
  #location-gate .gate-backdrop{
    position:absolute;
    inset:0;
    background:rgba(0,0,0,.45);
    backdrop-filter:saturate(120%) blur(2px);
  }
  #location-gate .gate-card{
    position:relative;
    margin:6vh auto 0;
    max-width:560px;
    background:#fff;
    color:#0f172a;
    border-radius:16px;
    padding:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.22);
    animation:gatePop .18s ease-out;
  }
  #location-gate .gate-close{
    position:absolute;
    inset-inline-end:8px;
    top:6px;
    width:36px;
    height:36px;
    border:none;
    border-radius:10px;
    background:#f1f5f9;
    cursor:pointer;
    font-size:20px;
    line-height:1;
  }
  #location-gate h3{
    margin:.25rem 0 .35rem;
    font-size:1.25rem;
    font-weight:900;
  }
  #location-gate .gate-note{
    margin:0 0 .6rem;
    color:#64748b;
    font-size:.95rem;
  }
  #location-gate .gate-fields{
    display:grid;
    gap:10px;
    margin:.5rem 0 .8rem;
  }
  #location-gate .gate-label{
    font-weight:700;
    font-size:.9rem;
  }
  #location-gate .gate-input{
    width:100%;
    height:2.6rem;
    border:1px solid #e2e8f0;
    border-radius:12px;
    padding:.55rem .75rem;
    font-size:1rem;
  }
  #location-gate .gate-actions{
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:flex-start;
  }
  #location-gate .gate-btn{
    border:1px solid #e2e8f0;
    background:#fff;
    color:#0f172a;
    border-radius:12px;
    padding:.6rem .9rem;
    font-weight:800;
    cursor:pointer;
  }
  #location-gate .gate-primary{
    background:#0f172a;
    color:#fff;
    border-color:#0f172a;
  }
  @keyframes gatePop{
    from{opacity:0;transform:translateY(6px);}
    to{opacity:1;transform:translateY(0);}
  }
  @media (max-width:640px){
    #location-gate .gate-card{
      margin:10vh 12px 0;
      padding:14px;
    }
    #location-gate h3{ font-size:1.1rem; }
    #location-gate .gate-note{ font-size:.9rem; }
    #location-gate .gate-input{
      height:2.4rem;
      font-size:.95rem;
    }
    #location-gate .gate-btn{
      padding:.5rem .8rem;
      font-size:.95rem;
    }
  }
  /* Ø¥Ø®ÙØ§Ø¡ Ù†Ù‚Ø§Ø· Ø§Ù„Ø³ÙˆÙŠØ¨Ø± ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© */
.contractor-swiper .swiper-pagination,
.rent-swiper .swiper-pagination,
.sale-swiper .swiper-pagination,
.vip-swiper .swiper-pagination{
  display: none !important;
}
/* ===== Normal cards look like VIP (style only) ===== */
.sale-swiper .swiper-wrapper{ align-items: stretch; }
.sale-swiper .swiper-slide{ height:auto; }

.sale-swiper .farm-card,
.sale-swiper .farm-link{
  display:flex;
  flex-direction:column;
  height:100%;
}

.sale-swiper .farm-media{
  aspect-ratio:16/10;          /* Ù†ÙØ³ Ø¥Ø­Ø³Ø§Ø³ VIP */
  overflow:hidden;
}

.sale-swiper .farm-media img{
  width:100%;
  height:100%;
  object-fit:cover;
}

.sale-swiper .farm-body{
  display:grid;
  row-gap:.45rem;
  flex:1;
}

.sale-swiper .farm-body .btn.btn-outline{
  margin-top:auto;             /* Ø§Ù„Ø²Ø± Ø«Ø§Ø¨Øª ØªØ­Øª */
  width:100%;
}

/* Ù…ÙˆØ¨Ø§ÙŠÙ„ */
@media (max-width:640px){
  .sale-swiper .farm-media{ aspect-ratio:16/10; }
  .sale-swiper .farm-body{ padding:.6rem; }
}

</style>

</head>
<body>
<%
  const _isAuth      = (typeof isAuth !== 'undefined') ? isAuth : false;
  const _user        = (typeof user   !== 'undefined') ? user   : null;
  const _currentPath = (typeof currentPath !== 'undefined') ? currentPath : '/sale';
  const _farmsSSR    = (typeof farms !== 'undefined' && Array.isArray(farms)) ? farms : [];
  function esc(x){ return String(x ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
  function num(n){ const v = Number(n); return Number.isFinite(v) ? v : 0; }
%>
<%
  function priceHtml(f){
    const c = (f.currency || 'USD');
    const sym = (c === 'SYP') ? 'Ù„.Ø³' : '$';
    const p = Number(f.price||0);
    return p ? (sym + p.toLocaleString('en')) : 'â€”';
  }
%>
<%
  function truncateWords(str, n){
    const w = String(str||'').trim().split(/\s+/);
    return (w.length <= n) ? w.join(' ') : (w.slice(0,n).join(' ') + 'â€¦');
  }
%>
<%
function tweakCloudinary(url){
  try{
    var u = new URL(url);
    if (u.hostname.includes('res.cloudinary.com') && u.pathname.includes('/upload/')){
      u.pathname = u.pathname.replace('/upload/','/upload/f_auto,q_auto,w_800/');
      return u.toString();
    }
  }catch(_){}
  return url;
}
function assetPath(u){
  u = (u||'').toString().trim();
  if (!u) return '/public/assets/farm-default.jpg';
  // Ø§Ù…Ù†Ø¹ data: Ù„Ø£Ù†Ù‡Ø§ ØªÙ†ÙØ® Ø§Ù„Ù€HTML
  if (/^data:/i.test(u)) return '/public/assets/farm-default.jpg';
  if (/^https?:\/\//i.test(u)) return tweakCloudinary(u); // Cloudinary Ø³Ø±ÙŠØ¹
  // ØªØ·Ø¨ÙŠØ¹ Ù‚Ø¯ÙŠÙ…
  u = u.replace(/\\/g,'/').replace(/^\/?Public\//,'/public/').replace(/\/assests\//gi,'/assets/');
  if (u.startsWith('/uploads/') || u.startsWith('/public/')) return u;
  if (u.startsWith('/assets/')) return '/public'+u;
  if (u.startsWith('/')) return '/public'+u;
  return '/uploads/'+u;
}
%>

<%- include('partials/navbar', { isAuth: _isAuth, user: _user, currentPath: _currentPath }) %>

<%- include('partials/whatsapp') %>
<%- include('partials/promo-swiper', { bannersDoc }) %>
<!-- ===== Ø¨ÙˆØ§Ø¨Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ (ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„) ===== -->
<div id="location-gate" aria-hidden="true">
  <div class="gate-backdrop" data-close="1"></div>
  <div class="gate-card" role="dialog" aria-modal="true" aria-labelledby="gate-title">
    <button class="gate-close" type="button" aria-label="Ø¥ØºÙ„Ø§Ù‚" data-close="1">Ã—</button>
    <h3 id="gate-title">Ø£ÙŠÙ† ØªØ±ÙŠØ¯ Ø§Ù„Ø¨Ø­Ø«ØŸ</h3>
    <p class="gate-note">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© ÙˆØ£Ø¯Ø®Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠÙ‹Ø§) Ù„Ù†Ø¸Ù‡Ø± Ù„Ùƒ Ù†ØªØ§Ø¦Ø¬ Ø£Ø¯Ù‚Ù‘.</p>

    <div class="gate-fields">
      <label class="gate-label" for="gate-city">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
      <select id="gate-city" class="gate-input">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©â€¦</option>
        <option>Ø¯Ù…Ø´Ù‚</option>
        <option>Ø±ÙŠÙ Ø¯Ù…Ø´Ù‚</option>
        <option>Ø­Ù„Ø¨</option>
        <option>Ø­Ù…Øµ</option>
        <option>Ø­Ù…Ø§Ø©</option>
        <option>Ø§Ù„Ù„Ø§Ø°Ù‚ÙŠØ©</option>
        <option>Ø·Ø±Ø·ÙˆØ³</option>
        <option>Ø¥Ø¯Ù„Ø¨</option>
        <option>Ø¯ÙŠØ± Ø§Ù„Ø²ÙˆØ±</option>
        <option>Ø§Ù„Ø­Ø³ÙƒØ©</option>
        <option>Ø§Ù„Ø±Ù‚Ø©</option>
        <option>Ø¯Ø±Ø¹Ø§</option>
        <option>Ø§Ù„Ù‚Ù†ÙŠØ·Ø±Ø©</option>
        <option>Ø§Ù„Ø³ÙˆÙŠØ¯Ø§Ø¡</option>
      </select>

      <label class="gate-label" for="gate-area">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input id="gate-area" class="gate-input" type="text" placeholder="Ù…Ø«Ø§Ù„: Ù‚Ø¯Ø³ÙŠØ§ØŒ Ø§Ù„Ù…Ø²Ø©ØŒ...">
    </div>

    <div class="gate-actions">
      <button id="gate-apply" class="gate-btn gate-primary" type="button">Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
      <button class="gate-btn" type="button" data-close="1">ØªØ®Ø·Ù‘ÙŠ Ø§Ù„Ø¢Ù†</button>
    </div>
  </div>
</div>

<!-- Ø§Ù„ÙÙ„Ø§ØªØ± -->
<section id="filters" class="section filters" aria-labelledby="filters-title">
  <div class="container">
    <details class="filter-dropdown" open>
      <summary id="filters-title">ØªØµÙÙŠØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</summary>

      <form id="sale-filters" class="filters-form" action="#results" method="get" novalidate>
        <div class="filters-grid">
          <!-- Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (ÙŠØ¸Ù‡Ø± Ø¯Ø§Ø¦Ù…Ù‹Ø§) -->
         <div class="field">
  <label class="label" for="city">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
  <select id="city" name="city" class="input">
    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©â€¦</option>
    <option>Ø¯Ù…Ø´Ù‚</option>
    <option>Ø±ÙŠÙ Ø¯Ù…Ø´Ù‚</option>
    <option>Ø­Ù„Ø¨</option>
    <option>Ø­Ù…Øµ</option>
    <option>Ø­Ù…Ø§Ø©</option>
    <option>Ø§Ù„Ù„Ø§Ø°Ù‚ÙŠØ©</option>
    <option>Ø·Ø±Ø·ÙˆØ³</option>
    <option>Ø¥Ø¯Ù„Ø¨</option>
    <option>Ø¯ÙŠØ± Ø§Ù„Ø²ÙˆØ±</option>
    <option>Ø§Ù„Ø­Ø³ÙƒØ©</option>
    <option>Ø§Ù„Ø±Ù‚Ø©</option>
    <option>Ø¯Ø±Ø¹Ø§</option>
    <option>Ø§Ù„Ù‚Ù†ÙŠØ·Ø±Ø©</option>
    <option>Ø§Ù„Ø³ÙˆÙŠØ¯Ø§Ø¡</option>
  </select>
</div>

          <div class="field">
            <label class="label" for="area">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
            <input id="area" name="area" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Ù…Ø«Ø§Ù„: Ø±ÙŠÙ Ø¯Ù…Ø´Ù‚)" />
          </div>

          <!-- Ø²Ø± Ø§Ù„Ù…Ø²ÙŠØ¯/Ø£Ù‚Ù„ -->
          <div class="field field--actions">
            <button id="toggle-advanced" class="btn btn-outline" type="button" aria-expanded="false" aria-controls="advanced-fields">
              Ø§Ù„Ù…Ø²ÙŠØ¯
            </button>
            <button class="btn btn-primary" type="submit" style="margin-inline-start:.5rem">ØªØ·Ø¨ÙŠÙ‚</button>
          </div>
        </div>

        <!-- Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§) -->
        <div id="advanced-fields" class="filters-grid advanced-fields" hidden>
          <div class="field">
            <label class="label" for="price-min">Ø§Ù„Ø³Ø¹Ø± (Ù…Ù†)</label>
            <input id="price-min" name="price_min" type="number" placeholder="Ù…Ø«Ø§Ù„: 50000" />
          </div>

          <div class="field">
            <label class="label" for="price-max">Ø§Ù„Ø³Ø¹Ø± (Ø¥Ù„Ù‰)</label>
            <input id="price-max" name="price_max" type="number" placeholder="Ù…Ø«Ø§Ù„: 500000" />
          </div>

          <div class="field">
            <label class="label" for="size-min">Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ù…Ù† Ù…Â²)</label>
            <input id="size-min" name="size_min" type="number" placeholder="Ù…Ø«Ø§Ù„: 5000" />
          </div>

          <div class="field">
            <label class="label" for="size-max">Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ø¥Ù„Ù‰ Ù…Â²)</label>
            <input id="size-max" name="size_max" type="number" placeholder="Ù…Ø«Ø§Ù„: 25000" />
          </div>
        </div>
      </form>
    </details>
  </div>
</section>
<!-- VIP Sale Only -->
<section id="vip-sale" class="vip-sale-section" aria-labelledby="vip-sale-title" hidden>
  <div class="container">
    <header class="section-header">
      <h2 id="vip-sale-title">Ù…Ø²Ø§Ø±Ø¹ Ù„Ù„Ø¨ÙŠØ¹</h2>
      <p class="muted">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„ÙØªØ­ ØµÙØ­Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©.</p>
    </header>

    <div class="swiper vip-swiper" dir="rtl">
      <div class="swiper-wrapper" id="vipSaleWrapper"></div>
      <div class="swiper-button-prev" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚"></div>
      <div class="swiper-button-next" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ"></div>
      <div class="swiper-pagination"></div>
    </div>
  </div>
</section>

<!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (Ø³ÙˆÙŠØ¨Ø± Ù„Ù„ÙƒØ±ÙˆØª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©) -->
<section id="results" class="section results" aria-labelledby="results-title">
  <div class="container">
    <header class="section-header">
    </header>
    <div class="swiper sale-swiper" dir="rtl">
      <div class="swiper-wrapper" id="saleWrapper">
        <% if (_farmsSSR.length) { _farmsSSR.forEach(farm => {
             const cover = (Array.isArray(farm.photos) && farm.photos[0]) ? farm.photos[0] : '/Public/placeholder.jpg';
             const titleTxt = esc(farm.title || 'â€”');
             const hasVideo = !!(farm.videoUrl);
             const isVip    = (farm?.owner?.subscriptionTier === 'VIP') || (farm?.ownerTier === 'VIP');
             if (tierSSR === 'VIP') { return; } // â¬…ï¸ Ù„Ø§ Ù†Ø±Ø³Ù… VIP ÙÙŠ Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± Ø§Ù„Ø¹Ø§Ù…
        %>
          <div class="swiper-slide">
            <article class="farm-card">
              <a class="farm-link" href="/farm/<%= farm._id %>" aria-label="Ø¹Ø±Ø¶ <%= titleTxt %>">
                <figure class="farm-media" style="position:relative">
  <img src="<%= assetPath(cover) %>" alt="<%= titleTxt %>"
     loading="lazy" decoding="async" fetchpriority="low"
     onerror="this.onerror=null;this.src='/public/assets/farm-default.jpg'"/>


  <% const tierSSR = (farm?.owner?.subscriptionTier || farm?.ownerTier || 'Basic'); %>
<% if (tierSSR === 'VIP') { %>
  <span class="badge badge--vip">VIP</span>
<% } else if (tierSSR === 'Premium') { %>
  <span class="badge badge--premium">Premium</span>
<% } %>

  <% if (farm.videoUrl) { %>
    <span class="badge badge--video">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ</span>
  <% } %>

  
</figure>

                <div class="farm-body">
                  <h3 class="farm-title" title="<%= titleTxt %>"><%= truncateWords(titleTxt, 3) %></h3>

                  <p class="farm-location"><%= esc(farm.area||'') %> â€” <%= esc(farm.city||'') %></p>
                  <p class="farm-price">${
  Number(f.price || 0)
    ? ((f.currency==='SYP' ? 'Ù„.Ø³' : '$') + ' ' + fmtEN(f.price))
    : 'â€”'
}</p>
                  <span class="meta-views" style="color: #0f172a;">ğŸ‘ï¸ <%= Number(farm.views||0).toLocaleString('en') %></span>
                  <span class="btn btn-outline" role="button" tabindex="0">Ø§Ù„ØªÙØ§ØµÙŠÙ„</span>
                </div>
              </a>
            </article>
          </div>
        <% }) } %>
      </div>
      <div class="swiper-button-prev" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚"></div>
      <div class="swiper-button-next" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ"></div>
      <div class="swiper-pagination"></div>
    </div>

  </div>
</section>

  <%- include('partials/promo', { promoBottom }) %>


<%- include('partials/footer') %>


<!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script type="module">
function tweakCloudinary(url){
  try{
    const u = new URL(url);
    if (u.hostname.includes('res.cloudinary.com') && u.pathname.includes('/upload/')){
      u.pathname = u.pathname.replace('/upload/','/upload/f_auto,q_auto,w_800/');
      return u.toString();
    }
  }catch(e){}
  return url;
}
function assetPath(u){
  u = (u || '').toString().trim();
  if (/^data:/i.test(u)) return '/public/assets/farm-default.jpg'; // Ù…Ù†Ø¹ data:
  if (/^https?:\/\//i.test(u)) return tweakCloudinary(u);         // Cloudinary Ø³Ø±ÙŠØ¹
  u = u.replace(/\\/g,'/').replace(/^\/?Public\//,'/public/').replace(/\/assests\//gi,'/assets/');
  if (u.startsWith('/uploads/') || u.startsWith('/public/')) return u;
  if (u.startsWith('/assets/')) return '/public'+u;
  if (u.startsWith('/')) return '/public'+u;
  return '/uploads/'+u;
}

</script>

<script>
  // ØªØ¨Ø¯ÙŠÙ„ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
  (function(){
    const btn  = document.getElementById('toggle-advanced');
    const box  = document.getElementById('advanced-fields');
    if (!btn || !box) return;

    btn.addEventListener('click', ()=>{
      const willShow = box.hasAttribute('hidden');
      if (willShow){
        box.hidden = false;
        box.classList.remove('fade-in'); // Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù†
        // force reflow Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† ÙƒÙ„ Ù…Ø±Ø©
        void box.offsetWidth;
        box.classList.add('fade-in');
        btn.textContent = 'Ø£Ù‚Ù„';
        btn.setAttribute('aria-expanded','true');
      } else {
        box.hidden = true;
        btn.textContent = 'Ø§Ù„Ù…Ø²ÙŠØ¯';
        btn.setAttribute('aria-expanded','false');
      }
    });
  })();
</script>
<script type="module">
  function truncateWordsJS(str, n){
  const w = String(str || '').trim().split(/\s+/);
  return (w.length <= n) ? w.join(' ') : (w.slice(0, n).join(' ') + 'â€¦');
}

/* ======= Ø£Ø¯ÙˆØ§Øª ØµØºÙŠØ±Ø© ======= */
const $  = (s,ctx=document)=>ctx.querySelector(s);
const $$ = (s,ctx=document)=>Array.from(ctx.querySelectorAll(s));
const fmtEN = n => Number(n||0).toLocaleString('en');

/* ======= Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø© ======= */
const form        = $('#sale-filters');
const vipSection  = $('#vip-sale');
const vipWrap     = $('#vipSaleWrapper');
const saleWrapper = $('#saleWrapper');

/* ======= HTML helpers ======= */
function htmlEscape(s=''){ return String(s).replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }
function tweakCloudinary(url){
  try{
    const u = new URL(url);
    if (u.hostname.includes('res.cloudinary.com') && u.pathname.includes('/upload/')){
      u.pathname = u.pathname.replace('/upload/', '/upload/f_auto,q_auto,w_480/');
      return u.toString();
    }
  }catch(_){}
  return url;
}
function assetPath(u){
  u = (u || '').toString().trim();
  if (!u) return '/public/assets/farm-default.jpg';
  if (/^data:/i.test(u)) return '/public/assets/farm-default.jpg';
  if (/^https?:\/\//i.test(u)) return tweakCloudinary(u);
  u = u.replace(/\\/g,'/').replace(/^\/?Public\//,'/public/').replace(/\/assests\//gi,'/assets/');
  if (u.startsWith('/uploads/') || u.startsWith('/public/')) return u;
  if (u.startsWith('/assets/')) return '/public'+u;
  if (u.startsWith('/')) return '/public'+u;
  return '/uploads/'+u;
}


/* ======= Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¦Ø­ ======= */
function saleSlide(f){
  const raw   = (Array.isArray(f.photos) && f.photos[0]) ? f.photos[0] : '/assets/farm-default.jpg';
  const cover = assetPath(raw);
  const link  = `/farm/${f._id}`;
  const loc   = f.city ? `${f.area || ''} â€” ${f.city}` : (f.area || 'â€”');

  // Ø·Ø¨Ù‘Ø¹ Ø§Ù„Ø®Ø·Ø© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø³Ø§Ø³ÙŠØ© Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø­Ø±Ù
  const tierRaw = ((f.owner && f.owner.subscriptionTier) || f.ownerTier || 'Basic');
  const tierKey = String(tierRaw).trim().toLowerCase();

  // Ø£Ø¸Ù‡Ø± Ø§Ù„Ø¨Ø§Ø¯Ø¬ ÙÙ‚Ø· Ø¥Ù† ÙƒØ§Ù†Øª Premium Ø£Ùˆ VIP
  const tierBadge =
    tierKey === 'vip'     ? '<span class="badge badge--vip">VIP</span>' :
    tierKey === 'premium' ? '<span class="badge badge--premium">Premium</span>' :
                            '';

  const views = Number(f.views || 0);

  return `
    <div class="swiper-slide">
      <article class="farm-card">
        <a class="farm-link" href="${link}" aria-label="${htmlEscape(f.title || 'Ù…Ø²Ø±Ø¹Ø©')}">
          <figure class="farm-media" style="position:relative">
           <img src="${cover}"
     alt="${htmlEscape(f.title || 'Ù…Ø²Ø±Ø¹Ø©')}"
     loading="lazy" decoding="async" fetchpriority="low"
     sizes="(max-width:640px) 45vw, (max-width:1024px) 30vw, 280px"
     onerror="this.onerror=null;this.src='/public/assets/farm-default.jpg'">

            ${tierBadge}
            ${f.videoUrl ? `<span class="badge badge--video">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ</span>` : ``}
          </figure>
          <div class="farm-body">
            <h3 class="farm-title" title="${htmlEscape(f.title || 'â€”')}">
  ${htmlEscape(truncateWordsJS(f.title || 'â€”', 3))}
</h3>

            <p class="farm-location">${htmlEscape(loc)}</p>
            <p class="farm-price">${
              Number(f.price || 0)
                ? ((f.currency==='SYP' ? 'Ù„.Ø³' : '$') + ' ' + fmtEN(f.price))
                : 'â€”'
            }</p>
            <span class="meta-views" style="color: #0f172a;">ğŸ‘ï¸ ${fmtEN(views)}</span>
            <span class="btn btn-outline" role="button" tabindex="0">Ø§Ù„ØªÙØ§ØµÙŠÙ„</span>
          </div>
        </a>
      </article>
    </div>`;
}


// VIP ÙŠØ³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø¹Ø§Ù…Ø© (ØªØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ 'Ù„.Ø³' Ø¹Ù†Ø¯ SYP)
function vipSlide(f){
  return saleSlide(f);
}


/* ======= Ø¬Ù„Ø¨ API ======= */
async function fetchJSON(url){
  const r = await fetch(url, { headers: { 'Accept':'application/json' }});
  if (!r.ok) throw new Error('HTTP '+r.status);
  const j = await r.json();
  return j.data || j.rows || [];
}

/* ======= Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø³ÙˆÙŠØ¨Ø±Ø§Øª ======= */
let allSale = [];
let vipAll  = [];
let saleSwiper = null;
let vipSwiper  = null;
function destroySwiper(sw){
  if (sw) try{ sw.destroy(true,true); }catch(_){}
}

function initSaleSwiper(){
  destroySwiper(saleSwiper);
  saleSwiper = new Swiper('.sale-swiper', {
    watchOverflow: true,
    pagination: { el: '.sale-swiper .swiper-pagination', clickable: true },
    navigation: {
      nextEl: '.sale-swiper .swiper-button-next',
      prevEl: '.sale-swiper .swiper-button-prev'
    },preloadImages: false,
lazy: { loadPrevNext: true, loadPrevNextAmount: 2 },
watchSlidesProgress: true,

    breakpoints: {
      /* Ù‡Ø§ØªÙ: ÙƒØ±ØªÙŠÙ† */
      0:    { slidesPerView: 2.02, spaceBetween: 10 },
      480:  { slidesPerView: 2.10, spaceBetween: 12 },
      /* ØªØ§Ø¨Ù„Øª ØµØºÙŠØ± */
      640:  { slidesPerView: 2.4,  spaceBetween: 14 },
      /* ØªØ§Ø¨Ù„Øª/Ø¯ÙŠØ³ÙƒØªÙˆØ¨ ÙƒÙ…Ø§ ÙƒØ§Ù† */
      1024: { slidesPerView: 3.2,  spaceBetween: 18 },
      1280: { slidesPerView: 4.2,  spaceBetween: 20 }
    }
  });
}

function initVipSwiper(){
  destroySwiper(vipSwiper);
  vipSwiper = new Swiper('.vip-swiper', {
    watchOverflow: true,
    pagination: { el: '.vip-swiper .swiper-pagination', clickable: true },
    navigation: {
      nextEl: '.vip-swiper .swiper-button-next',
      prevEl: '.vip-swiper .swiper-button-prev'
    },preloadImages: false,
lazy: { loadPrevNext: true, loadPrevNextAmount: 2 },
watchSlidesProgress: true,

    breakpoints: {
      0:    { slidesPerView: 2.02, spaceBetween: 10 },  /* Ù†ÙØ³ ÙÙƒØ±Ø© Ø§Ù„Ù‡Ø§ØªÙ */
      480:  { slidesPerView: 2.10, spaceBetween: 12 },
      640:  { slidesPerView: 2.4,  spaceBetween: 14 },
      1024: { slidesPerView: 3.2,  spaceBetween: 18 },
      1280: { slidesPerView: 4.2,  spaceBetween: 20 }
    }
  });
}

function renderSale(list){
  if (!saleWrapper) return;
  saleWrapper.innerHTML = (list && list.length) ? list.map(saleSlide).join('') : `<div class="empty muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>`;
  initSaleSwiper();
}
function renderVip(list){
  if (!vipSection || !vipWrap) return;
  const has = Array.isArray(list) && list.length>0;
  vipSection.hidden = !has;
  vipWrap.innerHTML = has ? list.map(vipSlide).join('') : '';
  if (has) initVipSwiper(); else destroySwiper(vipSwiper);
}

/* ======= ÙÙ„Ø§ØªØ± ======= */
function applyFilters(){
  const area  = (form?.area?.value||'').trim().toLowerCase();
  const city  = (form?.city?.value||'').trim().toLowerCase();
  const minP  = parseFloat(form?.price_min?.value);
  const maxP  = parseFloat(form?.price_max?.value);
  const minS  = parseFloat(form?.size_min?.value);
  const maxS  = parseFloat(form?.size_max?.value);

  const pass = (f)=>{
    const fArea = (f.area||'').toString().toLowerCase();
    const fCity = (f.city||'').toString().toLowerCase();
    const okArea  = !area || fArea.includes(area);
    const okCity  = !city || fCity.includes(city);
    const price   = Number(f.price)||0;
    const size    = Number(f.size)||0;
    const okPrice = (isNaN(minP) || price>=minP) && (isNaN(maxP) || price<=maxP);
    const okSize  = (isNaN(minS) || size>=minS)   && (isNaN(maxS) || size<=maxS);
    return okArea && okCity && okPrice && okSize;
  };

 const filteredSale = allSale
  .filter(pass)
  .filter(f => ((f?.owner?.subscriptionTier) || f.ownerTier || 'Basic') !== 'VIP');
const filteredVip  = vipAll.filter(pass);
renderSale(filteredSale);
renderVip(filteredVip);

}

/* ======= Ø¨Ø¯Ø¡ ======= */
async function init(){
  try {
    // Ø¯ÙØ¹Ø© Ø£ÙˆÙ„Ù‰ ØµØºÙŠØ±Ø©
    const first = await fetchJSON('/api/farms/sale?limit=24');
    allSale = Array.isArray(first) ? first : [];
    const nonVipFirst = allSale.filter(f => ((f?.owner?.subscriptionTier) || f.ownerTier || 'Basic') !== 'VIP');
    renderSale(nonVipFirst);
  } catch(e){ console.warn('sale fetch error (first):', e); renderSale([]); }

  // Ø£ÙƒÙ…Ù„ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨Ù‡Ø¯ÙˆØ¡
  requestIdleCallback(async () => {
    try{
      const rest = await fetchJSON('/api/farms/sale?limit=60');
      allSale = Array.isArray(rest) ? rest : [];
      const nonVip = allSale.filter(f => ((f?.owner?.subscriptionTier) || f.ownerTier || 'Basic') !== 'VIP');
      renderSale(nonVip);
    }catch(_){}
  });

  // VIP Ù…Ù†ÙØµÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙˆÙ„
  try {
    vipAll = await fetchJSON('/api/farms/sale?vipOnly=1&limit=24');
    renderVip(vipAll);
  } catch(e){ console.warn('vip fetch error:', e); renderVip([]); }

  if (form){
    form.addEventListener('submit', e=>{ e.preventDefault(); applyFilters(); });
    $$('#sale-filters input, #sale-filters select').forEach(inp=>{
      inp.addEventListener('change', applyFilters);
      inp.addEventListener('input',  e=>{
        const n = (e.target?.name||'');
        if (/price_|size_|area|city/.test(n)) applyFilters();
      });
    });
  }
}


document.addEventListener('DOMContentLoaded', init);
 window.applyFilters = applyFilters;

  // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø¯Ø§Ù„Ø© ØµØºÙŠØ±Ø© Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ù…Ù† Ø§Ù„Ø­Ø§Ø±Ø³
  window.setSaleFilters = (city, area) => {
    const form = document.getElementById('sale-filters');
    if (form) {
      if (form.city) form.city.value = city || '';
      if (form.area) form.area.value = area || '';
    }
    applyFilters();
  };
</script>
<script>
/* ======== Ø­Ø§Ø±Ø³ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ â€” ÙŠØ¸Ù‡Ø± ÙÙŠ ÙƒÙ„ Ø²ÙŠØ§Ø±Ø© ======== */
(function(){
  const gate     = document.getElementById('location-gate');
  const gateCity = document.getElementById('gate-city');
  const gateArea = document.getElementById('gate-area');
  const btnApply = document.getElementById('gate-apply');

  const filterCity = document.getElementById('city');
  const filterArea = document.getElementById('area');

  function openGate(){ if (gate) gate.setAttribute('aria-hidden','false'); }
  function closeGate(){ if (gate) gate.setAttribute('aria-hidden','true'); }

  // Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ©/Ø²Ø± Ã—/ØªØ®Ø·Ù‘ÙŠ
  document.addEventListener('click', (e)=>{
    const t = e.target;
    if (t && (t.dataset?.close || t.classList?.contains('gate-backdrop'))){
      closeGate();
    }
  });

  // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±: Ø§Ù…Ù„Ø£ Ø§Ù„ÙÙ„Ø§ØªØ± ÙˆÙ†ÙÙ‘Ø° Ø§Ù„ØªØ±Ø´ÙŠØ­
  btnApply?.addEventListener('click', ()=>{
    const c = (gateCity?.value || '').trim();
    const a = (gateArea?.value || '').trim();

    if (filterCity) filterCity.value = c;
    if (filterArea) filterArea.value = a;

    // Ù†Ø§Ø¯Ù Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø¹Ø±Ù‘Ø¶Ø© Ù…Ù† Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„
    if (window.setSaleFilters)      window.setSaleFilters(c, a);
    else if (window.applyFilters)   window.applyFilters();

    closeGate();

    // Ù…Ø±Ù‘Ø± Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    document.getElementById('results')?.scrollIntoView({ behavior:'smooth', block:'start' });
  });

  // Ø§ÙØªØ­ Ø§Ù„Ø­Ø§Ø±Ø³ Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ø¹Ù†Ø¯ ÙƒÙ„ Ø²ÙŠØ§Ø±Ø©/ØªØ­Ù…ÙŠÙ„
  window.addEventListener('DOMContentLoaded', openGate);

  // Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØªØµÙØ­ (BFCache) â€” Ø£Ø¹Ø¯ Ø§Ù„ÙØªØ­ Ø£ÙŠØ¶Ù‹Ø§
  window.addEventListener('pageshow', (e)=>{
    if (e.persisted) openGate();
  });
})();
</script>

<%- include('partials/mobile-nav', { 
  activeTab: 'sale',   // ØºÙŠÙ‘Ø±Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„ØµÙØ­Ø©: 'home' | 'sale' | 'rent' | 'contractors' | 'dash'
  isAuth, isAdmin, isContractor, isOwner,
}) %>
</body>
</html>
