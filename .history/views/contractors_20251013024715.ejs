<!-- views/contractors.ejs -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>فارمرز — المقاولون</title>
  <meta name="description" content="ابحث عن مقاولين موثوقين: كهرباء، مضخات، طاقة شمسية، بناء ريفي، تشخيص فني، وأنظمة الري.">

  <link rel="stylesheet" href="/Public/styles/contractorsstyle.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>

  <style>
    /* ==== VIP hero ==== */
    .vip-hero-slide{position:relative;min-height:360px;border-radius:16px;overflow:hidden;background:#f6faf6;}
    @media (min-width:1024px){.vip-hero-slide{min-height:520px;}}
    .vip-hero-img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(.85);}
    .vip-hero-overlay{position:absolute;inset:0;background:linear-gradient(90deg,rgba(0,0,0,.35),rgba(0,0,0,.15) 40%,rgba(0,0,0,0) 70%);}
    .vip-hero-body{position:absolute;inset-inline:1.2rem;inset-block-end:1.1rem;color:#fff;display:grid;gap:.35rem;}
    .vip-hero-title{font-size:clamp(20px,3vw,34px);margin:.25rem 0 0;}
    .vip-hero-meta{opacity:.95;font-size:clamp(14px,1.5vw,16px);}
    .vip-hero-cta{margin-top:.6rem;display:inline-block;padding:.5rem .9rem;border-radius:10px;background:#fff;color:#0f172a;text-decoration:none;font-weight:600;width:150px;text-align:center;}
    .vip-badge{position:absolute;top:12px;inset-inline-start:12px;background:#0f172a;color:#fff;border-radius:999px;font-size:.8rem;padding:.18rem .6rem;z-index:2}

    /* ==== بطاقات المقاولين (مطابقة لشكل الصورة) ==== */
    .contractor-swiper .swiper-slide{height:auto;}
    .contractor-card{
      position:relative;border:1px solid #e2e8f0;background:#fff;border-radius:16px;overflow:hidden;
      display:flex;flex-direction:column;gap:10px;padding:16px 14px;
    }
    /* شارة الباقة في أقصى اليسار أعلى البطاقة */
    .tier-badge{
      position:absolute;top:10px;inset-inline-start:10px;
      background:#0f172a;color:#fff;border-radius:999px;font-size:13px;padding:.2rem .6rem;line-height:1
    }

    /* السطر العلوي: الصورة الدائرية يمين + الاسم/الخانات يسارها عمودياً */
    .card-row{display:grid;grid-template-columns:auto 1fr;align-items:center;gap:12px;}
    .avatar{width:82px;height:82px;border-radius:999px;overflow:hidden;border:3px solid #eef2f7;justify-self:end}
    .avatar img{width:100%;height:100%;object-fit:cover}

    .info-stack{display:flex;flex-direction:column;gap:4px}
    .name{font-weight:800;font-size:22px;margin:0}
    .specialization,.region{margin:0;color:#475569}

    /* سطر التقييم تحتهم بمحاذاة اليمين */
    .rating{display:flex;align-items:center;gap:.35rem;color:#111827;font-weight:700;justify-content:flex-start}
    .rating small{color:#6b7280;font-weight:600}

    /* زر أسفل الكرت */
    .card-cta{margin-top:6px;width:100%;text-align:center;border:1px solid #0f172a;border-radius:12px;padding:.6rem .9rem;text-decoration:none;color:#0f172a;font-weight:600;display:inline-block}

    /* أزرار السويبر */
    .contractor-swiper .swiper-button-prev,
    .contractor-swiper .swiper-button-next{color:#2563eb}

    /* وقاية من قواعد عامة قد تؤثر على الصور */
    .contractor-card img{margin-top:0!important;border-radius:0}
  </style>
</head>
<body>

  <%- include('partials/navbar', { isAuth: (typeof isAuth!=='undefined'?isAuth:false), user: (typeof user!=='undefined'?user:null), active: 'contractors' }) %>

  <a class="fab-whatsapp" href="https://wa.me/21600000000?text=%D8%A3%D8%AD%D8%AA%D8%A7%D8%AC%20%D9%85%D9%82%D8%A7%D9%88%D9%84" target="_blank" rel="noopener" aria-label="الدردشة عبر واتساب">
    <span class="fab-whatsapp__icon" aria-hidden="true">واتساب</span>
  </a>
<%- include('partials/promo-swiper', { bannersDoc }) %>
  
  <!-- فلاتر بسيطة -->
  <section id="filters" class="section filters" aria-labelledby="filters-title">
    <div class="container">
      <details class="filter-dropdown" open>
        <summary id="filters-title">فلترة المقاولين</summary>
        <form id="contractor-filters" class="filters-form" action="#results" method="get" novalidate>
          <div class="filters-grid" style="display:grid;gap:.8rem;grid-template-columns:repeat(12,1fr)">
            <div class="field" style="grid-column:span 6">
              <label class="label" for="specialization">التخصص</label>
              <input id="specialization" name="specialization" type="text" placeholder="مثال: كهرباء، مضخات، طاقة شمسية…">
            </div>
            <div class="field" style="grid-column:span 6">
              <label class="label" for="region">المنطقة</label>
              <input id="region" name="region" type="text" placeholder="مثال: ريف دمشق، حمص، درعا…">
            </div>
            <div class="field" style="grid-column:span 12;display:flex;justify-content:flex-end">
              <button class="btn btn-primary" type="submit" style="background:#0f172a;color:#fff;border:none;border-radius:10px;padding:.55rem 1rem">تطبيق</button>
            </div>
          </div>
        </form>
      </details>
    </div>
  </section>
<!-- VIP -->
  <section id="vip-contractors" class="section gallery" aria-labelledby="vip-title" hidden>
    <div class="container">
      <header class="section-header">
        <h2 id="vip-title">المقاولون المتاحون</h2>
        <p class="muted">يظهر مشتركو VIP و Premium أولاً.</p>
      </header>

      <div class="swiper vip-swiper" dir="rtl" aria-label="مقاولون VIP">
        <div class="swiper-wrapper" id="vipContractorsWrapper"></div>
        <div class="swiper-button-prev" aria-label="السابق"></div>
        <div class="swiper-button-next" aria-label="التالي"></div>
        <div class="swiper-pagination"></div>
      </div>
    </div>
  </section>

  <!-- النتائج (سويبر البطاقات بالشكل المطلوب) -->
  <section id="results" class="section list" aria-labelledby="list-title">
    <div class="container">
      <header class="section-header">
        
      </header>

      <div class="swiper contractor-swiper" dir="rtl">
        <div class="swiper-wrapper" id="contractorsWrapper">
          <% if (Array.isArray(contractors) && contractors.length) { contractors.forEach(function(c){ 
               const img = (Array.isArray(c.photos) && c.photos[0]) || c.avatar || '/Public/assets/contractors/default.jpg';
               const services = Array.isArray(c.services) ? c.services.join('، ') : (c.services || '');
               const region = c.region || '';
               const tier = c.subscriptionTier || 'Basic';
            %>
              <div class="swiper-slide">
                <article class="contractor-card">
                  <span class="tier-badge"><%= tier %></span>
                  <div class="card-row">
                    <div class="avatar"><img src="<%= img %>" alt="صورة <%= c.name || 'مقاول' %>" loading="lazy" onerror="this.onerror=null;this.src='/Public/assets/contractors/default.jpg'"></div>
                    <div class="info-stack">
                      <h3 class="name"><%= c.name || '—' %></h3>
                      <p class="specialization"><%= services || '—' %></p>
                      <p class="region"><%= region || '—' %></p>
                    </div>
                  </div>
                  <div class="rating"><small>(<%= c.ratingCount || 0 %>)</small><span><%= Number(c.ratingAvg||0).toFixed(2) %></span><span>⭐</span></div>
                  <a class="card-cta" href="/contractor/<%= c._id %>">صفحة المقاول</a>
                </article>
              </div>
          <% }) } %>
        </div>
        <div class="swiper-button-prev" aria-label="السابق"></div>
        <div class="swiper-button-next" aria-label="التالي"></div>
        <div class="swiper-pagination"></div>
      </div>
    </div>
  </section>

  <%- include('partials/promo', { promoContractors: (typeof promoContractors!=='undefined'?promoContractors:null) }) %>

  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script>
    const $  = (s,ctx=document)=>ctx.querySelector(s);
    const $$ = (s,ctx=document)=>Array.from(ctx.querySelectorAll(s));
    const htmlEscape = (s='') => String(s).replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
    function assetPath(u){
      u = (u||'').toString().trim();
      if (/^data:/i.test(u) || /^https?:\/\//i.test(u)) return u;
      u = u.replace(/\\/g,'/').replace(/^\/?Public\//,'/public/').replace(/\/assests\//gi,'/assets/');
      if (u.startsWith('/uploads/') || u.startsWith('/public/')) return u;
      if (u.startsWith('/assets/')) return '/public'+u;
      if (u.startsWith('/')) return '/public'+u;
      return '/uploads/'+u;
    }

    const form       = $('#contractor-filters');
    const listWrap   = $('#contractorsWrapper');
    const vipSection = $('#vip-contractors');
    const vipWrap    = $('#vipContractorsWrapper');

    function contractorSlide(c){
      const img   = assetPath((Array.isArray(c.photos)&&c.photos[0]) || c.avatar || '/Public/assets/contractors/default.jpg');
      const name  = htmlEscape(c.name || '—');
      const spec  = htmlEscape(Array.isArray(c.services) ? c.services.join('، ') : (c.services||'—'));
      const reg   = htmlEscape(c.region || '—');
      const tier  = (c.subscriptionTier || 'Basic');
      const rating= Number(c.ratingAvg||0).toFixed(2);
      const rcnt  = Number(c.ratingCount||0);
      return `
        <div class="swiper-slide">
          <article class="contractor-card">
            <span class="tier-badge">${tier}</span>
            <div class="card-row">
              <div class="avatar"><img src="${img}" alt="صورة ${name}" loading="lazy" onerror="this.onerror=null;this.src='/Public/assets/contractors/default.jpg'"></div>
              <div class="info-stack">
                <h3 class="name">${name}</h3>
                <p class="specialization">${spec}</p>
                <p class="region">${reg}</p>
              </div>
            </div>
            <div class="rating"><small>(${rcnt})</small><span>${rating}</span><span>⭐</span></div>
            <a class="card-cta" href="/contractor/${c._id}">صفحة المقاول</a>
          </article>
        </div>`;
    }

    function vipSlide(c){
      const img  = assetPath((Array.isArray(c.photos)&&c.photos[0]) || c.avatar || '/Public/assets/contractors/default.jpg');
      const name = htmlEscape(c.name || 'VIP');
      const spec = htmlEscape(Array.isArray(c.services) ? c.services.join('، ') : (c.services||'')); 
      const reg  = htmlEscape(c.region || '');
      const rating= Number(c.ratingAvg||0).toFixed(2);
      const rcnt  = Number(c.ratingCount||0);
      return `
        <div class="swiper-slide">
          <article class="vip-hero-slide">
            <span class="vip-badge">VIP</span>
            <img class="vip-hero-img" src="${img}" alt="${name}" loading="lazy" onerror="this.onerror=null;this.src='/Public/assets/contractors/default.jpg'">
            <div class="vip-hero-overlay"></div>
            <div class="vip-hero-body">
              <h3 class="vip-hero-title">${name}</h3>
              <div class="vip-hero-meta">${spec}${(spec&&reg)?' — ':''}${reg} • ⭐ ${rating} (${rcnt})</div>
              <a class="vip-hero-cta" href="/contractor/${c._id}">عرض المقاول</a>
            </div>
          </article>
        </div>`;
    }

    async function fetchJSON(url){
      const r = await fetch(url, { headers: { 'Accept':'application/json' }});
      if (!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      return j.data || j.rows || [];
    }

    let allContractors = [];
    let vipOnlyList    = [];
    let listSwiper = null, vipSwiper = null;

    function destroySwiper(sw){ if (sw) try{ sw.destroy(true,true); }catch(_){ } }
    function initListSwiper(){
      destroySwiper(listSwiper);
      listSwiper = new Swiper('.contractor-swiper', {
        slidesPerView: 1.05, spaceBetween: 12, watchOverflow: true,
        pagination:{ el:'.contractor-swiper .swiper-pagination', clickable:true },
        navigation:{ nextEl:'.contractor-swiper .swiper-button-next', prevEl:'.contractor-swiper .swiper-button-prev' },
        breakpoints:{ 480:{slidesPerView:1.1}, 640:{slidesPerView:1.8}, 1024:{slidesPerView:2.6}, 1280:{slidesPerView:3.2} }
      });
    }
    function initVipSwiper(){
      destroySwiper(vipSwiper);
      vipSwiper = new Swiper('.vip-swiper', {
        loop:true, centeredSlides:true, slidesPerView:1.02, spaceBetween:18, watchOverflow:true,
        pagination:{ el:'.vip-swiper .swiper-pagination', clickable:true },
        navigation:{ nextEl:'.vip-swiper .swiper-button-next', prevEl:'.vip-swiper .swiper-button-prev' }
      });
    }

    function renderList(list){
      listWrap.innerHTML = (list&&list.length) ? list.map(contractorSlide).join('') : `<div class="empty muted">لا توجد نتائج مطابقة.</div>`;
      initListSwiper();
    }
    function renderVip(list){
      const has = Array.isArray(list) && list.length>0;
      vipSection.hidden = !has;
      vipWrap.innerHTML = has ? list.map(vipSlide).join('') : '';
      if (has) initVipSwiper(); else destroySwiper(vipSwiper);
    }

    function applyFilters(){
      const qSpec = (form?.specialization?.value||'').trim().toLowerCase();
      const qReg  = (form?.region?.value||'').trim().toLowerCase();
      const pass = (c)=>{
        const spec = (Array.isArray(c.services)? c.services.join('، ') : (c.services||'')).toString().toLowerCase();
        const reg  = (c.region||'').toString().toLowerCase();
        return (!qSpec || spec.includes(qSpec)) && (!qReg || reg.includes(qReg));
      };
      renderList(allContractors.filter(pass));
      renderVip(vipOnlyList.filter(pass));
    }

    (async function init(){
      try {
        const apiAll = await fetchJSON('/api/contractors');
        allContractors = Array.isArray(apiAll) ? apiAll : [];
      } catch(e) {
        /* SSR fallback (خارج backticks لتفادي خطأ EJS) */
        const ssr = <%- JSON.stringify((typeof contractors!=='undefined' && Array.isArray(contractors)) ? contractors : []) %>;
        allContractors = ssr;
      }
      try {
        const apiVip = await fetchJSON('/api/contractors?vipOnly=1');
        vipOnlyList = Array.isArray(apiVip) ? apiVip : [];
      } catch(_) {
        vipOnlyList = allContractors.filter(c => (c.subscriptionTier||'') === 'VIP');
      }

      // ترتيب العرض: VIP ثم Premium ثم Basic
      const rank = { VIP:0, Premium:1, Basic:2 };
      allContractors.sort((a,b)=>(rank[a.subscriptionTier||'Basic']??9)-(rank[b.subscriptionTier||'Basic']??9));

      renderList(allContractors);
      renderVip(vipOnlyList);

      if (form){
        form.addEventListener('submit', e=>{ e.preventDefault(); applyFilters(); });
        $$('#contractor-filters input').forEach(inp=> inp.addEventListener('input', applyFilters));
      }
    })();
  </script>
</body>
</html>
