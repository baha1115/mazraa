<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title><%= farm ? (farm.title + ' â€” Ø§Ù„ØªÙØ§ØµÙŠÙ„') : 'Ø§Ù„Ù…Ø²Ø±Ø¹Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©' %></title>
  <meta name="description" content="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©: Ø§Ù„ØµÙˆØ±ØŒ Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŒ Ø§Ù„ÙˆØµÙØŒ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø­Ø§Ù„Ø©."/>

  <!-- ÙˆØ±Ù‚Ø© Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ø¯ÙŠÙƒ (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ) -->
  <link rel="stylesheet" href="/Public/styles/rentandfarmdetail.css"/>

  <!-- Leaflet + Swiper (CDN bundle = ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„Ø§Øª Ù…ØªØ§Ø­Ø©ØŒ ÙˆÙ…Ù†Ù‡Ø§ thumbs) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>

  <style>
    /* ===== Design Tokens ===== */
    :root{
      --bg: #f7fafc; --card:#fff; --ink:#0f172a; --muted:#64748b;
      --brand:#0f172a; --accent:#10b981; --warn:#ef4444;
      --ring:#0f172a22; --r:16px; --shadow:0 14px 36px rgba(2,6,23,.10);
      --container:1160px;
    }
    body{ background:var(--bg); color:var(--ink); }
    .container{ width:min(100%,var(--container)); margin-inline:auto; padding-inline:16px; }
    .section{ padding: 1.25rem 0; }
    .card{ background:var(--card); border:1px solid #e2e8f0; border-radius:var(--r); box-shadow:var(--shadow); }
    .grid{ display:grid; gap:16px; }
    .muted{ color: var(--muted); }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
      padding:.65rem 1rem; border-radius:12px; font-weight:700; text-decoration:none; cursor:pointer; }
    .btn-primary{ background:var(--accent); color:#fff; border:none; }
    .btn-outline{ background:#fff; color:var(--brand); border:1px solid var(--brand); }

    /* ===== Hero ===== */
    .hero{ position:relative; border-radius:20px; overflow:hidden; min-height:320px; margin-block:10px; background:#e2e8f0; }
    .hero__bg{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; filter:brightness(.9); }
    .hero__overlay{ position:absolute; inset:0; background:
      radial-gradient(80% 60% at 80% 0%, rgba(0,0,0,.35), transparent 60%),
      linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.55) 70%);
    }
    .hero__body{ position:absolute; inset-inline:1rem; inset-block-end:1rem; color:#fff; display:grid; gap:.4rem; }
    .hero__title{ margin:0; font-size:clamp(20px,3vw,32px); line-height:1.25; font-weight:900; letter-spacing:-.2px; }
    .hero__meta{ margin:0; opacity:.95; }
    .hero__badges{ display:flex; gap:.4rem; flex-wrap:wrap; margin-top:.25rem; }
    .badge{ display:inline-block; padding:.22rem .6rem; border-radius:999px; font-size:.8rem; color:#fff; background:#0f172a; box-shadow:0 2px 8px rgba(0,0,0,.25); }
    .badge--premium{ background:#8b5cf6; } .badge--vip{ background:#111; }
    .badge--ok{ background:#065f46; } .badge--no{ background:#991b1b; }
    .badge--video{ background:var(--warn); }
    .hero__actions{ margin-top:.7rem; display:flex; gap:.5rem; flex-wrap:wrap; }
    .hero__cta{ background:#fff; color:#111; }

    /* ===== Layout Main ===== */
    .main-grid{ grid-template-columns: 1fr; }
    @media (min-width: 1024px){
      .main-grid{ grid-template-columns: 2fr 1fr; align-items:start; }
      .aside-sticky{ position:sticky; top:16px; }
    }

    /* ===== Gallery (main + thumbs) ===== */
    .gallery .swiper-slide img{ width:100%; height:440px; object-fit:cover; border-radius:12px; }
    .gallery-thumbs .swiper-slide{ opacity:.7; cursor:pointer; }
    .gallery-thumbs .swiper-slide-thumb-active{ opacity:1; }
    .gallery-thumbs img{ width:100%; height:84px; object-fit:cover; border-radius:10px; }
    @media (max-width: 480px){
      .gallery .swiper-slide img{ height:260px; }
      .gallery-thumbs img{ height:70px; }
    }

    /* ===== Info Card ===== */
    .infocard{ padding:1rem; }
    .infocard h3{ margin:.2rem 0 .6rem; font-size:1.1rem; }
    .infocard ul{ list-style:none; margin:0; padding:0; display:grid; gap:.4rem; }
    .infocard li{ display:flex; align-items:center; justify-content:space-between; gap:.5rem; }
    .price{ font-weight:900; font-size:1.1rem; }
    .views{ color:var(--muted); }

    /* ===== Quick blocks / Description ===== */
    .chips{ display:flex; flex-wrap:wrap; gap:.4rem; }
    .chip{ background:#eef2f7; border-radius:999px; padding:.2rem .6rem; font-size:.85rem; }
    .prose{ line-height:1.85; }
    .prose p{ margin:.4rem 0; }

    /* ===== Map ===== */
    #leafletMap{ width:100%; height:380px; border-radius:12px; }
    .map-placeholder img{ max-width:100%; height:auto; border-radius:12px; }
    .map-placeholder img.static-map{ display:none; }

    /* ===== Owner slider ===== */
    .vip-hero-slide{ position:relative; min-height:360px; border-radius:16px; overflow:hidden; background:#eef2f7; }
    .vip-hero-img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; filter:brightness(.85); }
    .vip-hero-overlay{ position:absolute; inset:0; background:linear-gradient(90deg, rgba(0,0,0,.45), rgba(0,0,0,.15) 40%, rgba(0,0,0,0) 70%); }
    .vip-hero-body{ position:absolute; inset-inline:1.2rem; inset-block-end:1.1rem; color:#fff; display:grid; gap:.35rem; }
    .vip-hero-title{ margin:.1rem 0; font-size:clamp(18px,3vw,28px); }
    .vip-hero-cta{ display:inline-block; padding:.5rem .9rem; border-radius:10px; background:#fff; color:#0f172a; text-decoration:none; width:150px; text-align:center; }
  </style>
</head>
<body>
<%
  /* ==== Helpers ==== */
  function assetPath(u){
    u = (u||'').toString().trim();
    if (/^data:/i.test(u) || /^https?:\/\//i.test(u)) return u;
    u = u.replace(/\\/g,'/').replace(/^\/?Public\//,'/public/').replace(/\/assests\//gi,'/assets/');
    if (u.startsWith('/uploads/') || u.startsWith('/public/')) return u;
    if (u.startsWith('/assets/')) return '/public'+u;
    if (u.startsWith('/')) return '/public'+u;
    return '/uploads/'+u;
  }
  const photos = (Array.isArray(farm?.photos) && farm.photos.length) ? farm.photos : ['/assets/farm-default.jpg'];
  const cover  = assetPath(photos[0]);
  const ownerList = Array.isArray(sameOwnerFarms) ? sameOwnerFarms : [];
  const hasOwnerFarms = ownerList.length > 0;
%>

<!-- Navbar + Ø£Ø¯ÙˆØ§Øª Ø«Ø§Ø¨ØªØ© (ØªÙ…Ø±ÙŠØ± Ø¢Ù…Ù†) -->
<%- include('partials/navbar', {
  isAuth: (typeof isAuth !== 'undefined' ? isAuth : false),
  user:   (typeof user   !== 'undefined' ? user   : null),
  currentPath: (typeof currentPath !== 'undefined' ? currentPath : '')
}) %>
<%- include('partials/whatsapp') %>
<%- include('partials/promo-swiper', { bannersDoc: (typeof bannersDoc !== 'undefined' ? bannersDoc : null) }) %>

<!-- ===== Breadcrumb ===== -->
<nav class="breadcrumb" aria-label="Breadcrumb">
  <div class="container">
    <ol>
      <li><a href="/">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
      <li><a href="/sale">Ù„Ù„Ø¨ÙŠØ¹</a></li>
      <li aria-current="page"><%= farm?.title || 'â€”' %></li>
    </ol>
  </div>
</nav>

<% if (!farm) { %>
  <section class="section">
    <div class="container">
      <h1>Ø§Ù„Ù…Ø²Ø±Ø¹Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</h1>
      <p class="muted">Ø¹Ø°Ø±Ù‹Ø§ØŒ Ù„Ù… Ù†Ø¹Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.</p>
      <a class="btn btn-outline" href="/sale">Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</a>
    </div>
  </section>
<% } else { %>

<!-- ===== HERO ===== -->
<section class="section">
  <div class="container">
    <header class="hero card">
      <img class="hero__bg" src="<%= cover %>" alt="<%= farm.title %>" loading="eager"
           onerror="this.onerror=null;this.src='/public/assets/farm-default.jpg'">
      <div class="hero__overlay"></div>
      <div class="hero__body">
        <div class="hero__badges">
          <% const tier = (farm?.owner?.subscriptionTier || farm?.ownerTier || 'Basic'); %>
          <% if (tier==='VIP') { %><span class="badge badge--vip">VIP</span><% } %>
          <% if (tier==='Premium') { %><span class="badge badge--premium">Premium</span><% } %>
          <% const isRented = (farm.status||'available').toLowerCase()==='rented'; %>
          <span class="badge <%= isRented?'badge--no':'badge--ok' %>"><%= isRented?'Ù…Ø¤Ø¬Ù‘Ø±Ø©':'Ù…ØªØ§Ø­Ø©' %></span>
          <% if (farm.videoUrl) { %><span class="badge badge--video">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ</span><% } %>
        </div>

        <h1 class="hero__title"><%= farm.title %></h1>
        <p class="hero__meta"><%= farm.city ? (farm.area||'') + ' â€” ' + farm.city : (farm.area||'â€”') %></p>

        <div class="hero__actions">
          <a class="btn btn-primary" href="#gallery" aria-label="Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„ØµÙˆØ±">ØªØµÙÙ‘Ø­ Ø§Ù„ØµÙˆØ±</a>
          <a class="btn hero__cta"
             href="https://wa.me/<%= ((farm?.ownerInfo?.whatsapp)||'21600000000').replace(/\D/g,'') %>?text=<%= encodeURIComponent('Ø£Ù†Ø§ Ù…Ù‡ØªÙ… Ø¨Ù…Ø²Ø±Ø¹Ø©: ' + farm.title) %>"
             target="_blank" rel="noopener">ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨</a>
        </div>
      </div>
    </header>
  </div>
</section>

<!-- ===== Main Content ===== -->
<section class="section">
  <div class="container grid main-grid">
    <!-- Left: Gallery + Quick + Description + Map -->
    <div class="grid" style="gap:18px">
      <!-- Gallery: main + thumbs -->
      <section id="gallery" class="gallery card" aria-labelledby="gallery-title" style="padding:1rem">
        <h2 id="gallery-title" style="margin:0 0 .75rem">Ø§Ù„Ù…Ø¹Ø±Ø¶</h2>

        <!-- Main -->
        <div class="swiper gallery-main" aria-label="ØµÙˆØ± Ø§Ù„Ù…Ø²Ø±Ø¹Ø©">
          <div class="swiper-wrapper" id="galleryMain">
            <% photos.forEach(function(src){ %>
              <div class="swiper-slide"><img src="<%= assetPath(src) %>" alt="<%= farm.title %>" loading="lazy"/></div>
            <% }) %>
          </div>
          <div class="swiper-button-prev" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚"></div>
          <div class="swiper-button-next" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ"></div>
          <div class="swiper-pagination"></div>
        </div>

        <!-- Thumbs -->
        <div class="swiper gallery-thumbs" style="margin-top:.6rem">
          <div class="swiper-wrapper">
            <% photos.forEach(function(src){ %>
              <div class="swiper-slide"><img src="<%= assetPath(src) %>" alt="Ù…ØµØºÙ‘Ø±" loading="lazy"/></div>
            <% }) %>
          </div>
        </div>
      </section>

      <!-- Quick Details -->
      <section class="card" aria-labelledby="quick-title" style="padding:1rem">
        <h2 id="quick-title" style="margin:0 0 .75rem">ØªÙØ§ØµÙŠÙ„ Ø³Ø±ÙŠØ¹Ø©</h2>
        <div class="chips" style="margin-bottom:.6rem">
          <span class="chip"><strong>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</strong> <%= farm.city || 'â€”' %></span>
          <span class="chip"><strong>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</strong> <%= farm.area || 'â€”' %></span>
          <span class="chip"><strong>Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</strong> <%= Number(farm.size||0).toLocaleString('en') %> Ù…Â²</span>
          <span class="chip"><strong>Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª:</strong> <%= Number((typeof viewsCount!=='undefined'?viewsCount:farm.views)||0).toLocaleString('en') %></span>
        </div>
        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px">
          <article class="card" style="padding:.9rem">
            <h3 style="margin:.1rem 0 .35rem;font-size:1rem">Ø§Ù„Ø³Ø¹Ø±</h3>
            <p class="price">
              <% const c = (farm.currency||'USD'); const sym = (c==='SYP'?'Ù„.Ø³':'$'); %>
              <%= Number(farm.price||0) ? (sym + ' ' + Number(farm.price).toLocaleString('en')) : 'â€”' %>
              <%= (String(farm.kind).toLowerCase()==='rent' ? '/Ø´Ù‡Ø±' : '') %>
            </p>
          </article>

          <% if ((farm.poolDesc||'').trim()) { %>
          <article class="card" style="padding:.9rem">
            <h3 style="margin:.1rem 0 .35rem;font-size:1rem">Ø§Ù„Ù…Ø³Ø¨Ø­</h3>
            <p class="prose"><%= farm.poolDesc %></p>
          </article><% } %>

          <% if ((farm.amenitiesDesc||'').trim()) { %>
          <article class="card" style="padding:.9rem">
            <h3 style="margin:.1rem 0 .35rem;font-size:1rem">Ø§Ù„Ù…Ø±Ø§ÙÙ‚</h3>
            <p class="prose"><%= farm.amenitiesDesc %></p>
          </article><% } %>

          <% if ((farm.buildingDesc||'').trim()) { %>
          <article class="card" style="padding:.9rem">
            <h3 style="margin:.1rem 0 .35rem;font-size:1rem">Ø§Ù„Ø¨Ù†Ø§Ø¡</h3>
            <p class="prose"><%= farm.buildingDesc %></p>
          </article><% } %>
        </div>
      </section>

      <!-- Video (optional) -->
      <% const __videoUrl = (farm.videoUrl||'').trim(); if (__videoUrl) { %>
      <section id="videoSection" class="card" aria-labelledby="video-title" style="padding:1rem">
        <h2 id="video-title" style="margin:0 0 .6rem">ÙÙŠØ¯ÙŠÙˆ ØªÙØµÙŠÙ„ÙŠ</h2>
        <div class="video-frame" id="videoFrame"></div>
      </section>
      <% } %>

      <!-- Description -->
      <section id="description" class="card" aria-labelledby="desc-title" style="padding:1rem">
        <h2 id="desc-title" style="margin:0 0 .6rem">Ø§Ù„ÙˆØµÙ Ø§Ù„ÙƒØ§Ù…Ù„</h2>
        <article class="prose"><p><%= (farm.description||'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ÙØµÙ‘Ù„.') %></p></article>
      </section>

      <!-- Map -->
      <section id="map" class="card" aria-labelledby="map-title" style="padding:1rem">
        <h2 id="map-title" style="margin:0 0 .6rem">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</h2>
        <div class="map-placeholder" id="mapPlaceholder"
             data-lat="<%= farm?.location?.lat || '' %>"
             data-lng="<%= farm?.location?.lng || '' %>"
             data-address="<%= (farm?.location?.address || '').replace(/"/g,'&quot;') %>">
          <img class="static-map" src="/public/assets/location.jpg" alt="Ø®Ø±ÙŠØ·Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ©" loading="lazy"/>
        </div>
        <div id="leafletMap" aria-label="Ø®Ø±ÙŠØ·Ø© OpenStreetMap"></div>
      </section>
    </div>

    <!-- Right: Sticky Info / CTAs -->
    <aside class="aside-sticky">
      <section class="infocard card">
        <h3>Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</h3>
        <ul>
          <li>
            <span>Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ØªØ§Ø­Ø©</span>
            <% const isRented2 = (farm.status||'available').toLowerCase()==='rented'; %>
            <span class="badge <%= isRented2?'badge--no':'badge--ok' %>"><%= isRented2?'Ù…Ø¤Ø¬Ù‘Ø±Ø©':'Ù…ØªØ§Ø­Ø©' %></span>
          </li>
          <li>
            <span>Ø§Ù„Ø³Ø¹Ø±</span>
            <span class="price">
              <% const cc = (farm.currency||'USD'); const sy = (cc==='SYP'?'Ù„.Ø³':'$'); %>
              <%= Number(farm.price||0) ? (sy + ' ' + Number(farm.price).toLocaleString('en')) : 'â€”' %>
            </span>
          </li>
          <li><span>Ø§Ù„Ù…Ø³Ø§Ø­Ø©</span><span><%= Number(farm.size||0).toLocaleString('en') %> Ù…Â²</span></li>
          <li><span>Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª</span><span class="views">ğŸ‘ï¸ <%= Number(farm.views||0).toLocaleString('en') %></span></li>
        </ul>
        <div style="display:grid; gap:.5rem; margin-top:.75rem">
          <a class="btn btn-primary"
             href="https://wa.me/<%= ((farm?.ownerInfo?.whatsapp)||'21600000000').replace(/\D/g,'') %>?text=<%= encodeURIComponent('Ø£Ù†Ø§ Ù…Ù‡ØªÙ… Ø¨Ù…Ø²Ø±Ø¹Ø©: ' + farm.title) %>"
             target="_blank" rel="noopener">ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</a>
          <% if (farm?.ownerInfo?.phone) { %>
            <a class="btn btn-outline" href="tel:<%= farm.ownerInfo.phone.replace(/\s+/g,'') %>">Ø§ØªØµØ§Ù„ Ù‡Ø§ØªÙÙŠ</a>
          <% } %>
        </div>
      </section>
    </aside>
  </div>
</section>

<!-- Other farms by same owner -->
<% if (hasOwnerFarms) { %>
<section class="section" aria-labelledby="owner-farms-title">
  <div class="container">
    <header class="section-header" style="margin-bottom:.75rem">
      <h2 id="owner-farms-title">Ù…Ø²Ø§Ø±Ø¹ Ø£Ø®Ø±Ù‰ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø§Ù„Ùƒ</h2>
      <p class="muted">Ù‚Ø¯ ØªÙ‡Ù…Ù‘Ùƒ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø²Ø§Ø±Ø¹ Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù…Ø§Ù„Ùƒ.</p>
    </header>

    <div class="swiper vip-swiper" dir="rtl">
      <div class="swiper-wrapper">
        <% ownerList.forEach(function(f){
             const raw = (Array.isArray(f.photos) && f.photos[0]) ? f.photos[0] : '/assets/farm-default.jpg';
             const link = (String(f.kind||'').toLowerCase()==='rent') ? ('/rent/farm/'+f._id) : ('/farm/'+f._id);
             const loc  = f.city ? ((f.area||'') + ' â€” ' + f.city) : (f.area||'â€”');
        %>
        <div class="swiper-slide">
          <article class="vip-hero-slide card" style="border:none">
            <img class="vip-hero-img" src="<%= assetPath(raw) %>" alt="<%= f.title||'Ù…Ø²Ø±Ø¹Ø©' %>"
                 loading="lazy" onerror="this.onerror=null;this.src='/public/assets/farm-default.jpg'">
            <div class="vip-hero-overlay"></div>
            <div class="vip-hero-body">
              <h3 class="vip-hero-title"><%= f.title || 'â€”' %></h3>
              <div class="muted">
                <% const sym2=(f.currency==='SYP'?'Ù„.Ø³':'$'); %>
                <%= loc %> â€¢ <%= Number(f.size||0).toLocaleString('en') %> Ù…Â² â€¢
                <%= sym2 %><%= Number(f.price||0).toLocaleString('en') %><%= (String(f.kind).toLowerCase()==='rent' ? '/Ø´Ù‡Ø±' : '') %>
              </div>
              <a class="vip-hero-cta" href="<%= link %>">Ø§Ù„ØªÙØ§ØµÙŠÙ„</a>
            </div>
          </article>
        </div>
        <% }) %>
      </div>
      <div class="swiper-button-prev" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚"></div>
      <div class="swiper-button-next" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ"></div>
      <div class="swiper-pagination"></div>
    </div>
  </div>
</section>
<% } %>

<%- include('partials/top-sale', { items: (typeof topSale !== 'undefined' ? topSale : []) }) %>
<% } /* end if farm */ %>

<%- include('partials/footer') %>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Swiper init (main + thumbs + owner slider) -->
<script>
(function(){
  // Owner farms slider
  if (document.querySelector('.vip-swiper')) {
    new Swiper('.vip-swiper', {
      loop:true, centeredSlides:true, slidesPerView:1.02, spaceBetween:18, watchOverflow:true,
      pagination:{ el:'.vip-swiper .swiper-pagination', clickable:true },
      navigation:{ nextEl:'.vip-swiper .swiper-button-next', prevEl:'.vip-swiper .swiper-button-prev' },
      breakpoints:{ 640:{slidesPerView:1.05,spaceBetween:20}, 1024:{slidesPerView:1.08,spaceBetween:22} }
    });
  }

  // Gallery with thumbs
  const thumbsEl = document.querySelector('.gallery-thumbs');
  const mainEl   = document.querySelector('.gallery-main');
  if (thumbsEl && mainEl) {
    const thumbs = new Swiper('.gallery-thumbs', {
      slidesPerView: 4.2, spaceBetween: 8, watchOverflow:true,
      breakpoints: { 480:{slidesPerView:5.2}, 768:{slidesPerView:6.2} }
    });
    new Swiper('.gallery-main', {
      loop:true, spaceBetween:12, watchOverflow:true,
      pagination:{ el:'.gallery-main .swiper-pagination', clickable:true },
      navigation:{ nextEl:'.gallery-main .swiper-button-next', prevEl:'.gallery-main .swiper-button-prev' },
      thumbs: { swiper: thumbs }
    });
  }
})();
</script>

<!-- Video injection -->
<script>
(function(){
  const frame = document.getElementById('videoFrame');
  if (!frame) return;
  const url = <%- JSON.stringify((farm && farm.videoUrl) ? farm.videoUrl : '') %>;
  if (!url) return;
  function esc(s){return (s||'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
  try{
    const u = new URL(url);
    if (u.hostname.includes('youtu.be')) { const id=u.pathname.slice(1); frame.innerHTML='<iframe src="https://www.youtube.com/embed/'+id+'" title="YouTube" frameborder="0" allowfullscreen></iframe>'; return; }
    if (u.hostname.includes('youtube.com')) { const id=u.searchParams.get('v'); if (id){ frame.innerHTML='<iframe src="https://www.youtube.com/embed/'+id+'" title="YouTube" frameborder="0" allowfullscreen></iframe>'; return; } }
  }catch(_){}
  if (/\.(mp4|webm|ogg)(\?|#|$)/i.test(url)) frame.innerHTML='<video controls style="width:100%;border-radius:12px"><source src="'+esc(url)+'"></video>';
  else frame.innerHTML='<a class="btn btn-outline" href="'+esc(url)+'" target="_blank" rel="noopener">ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</a>';
})();
</script>

<!-- Leaflet init -->
<script>
(function () {
  function ready(fn){ document.readyState!=='loading' ? fn() : document.addEventListener('DOMContentLoaded', fn); }
  ready(function(){
    var box = document.getElementById('mapPlaceholder');
    var mapEl = document.getElementById('leafletMap');
    if (!box || !mapEl || typeof L === 'undefined') return;

    var lat = parseFloat(box.dataset.lat), lng = parseFloat(box.dataset.lng), addr = box.dataset.address || '';
    var hasCoords = Number.isFinite(lat) && Number.isFinite(lng);
    if (!hasCoords) return;

    var map = L.map(mapEl, { center:[lat,lng], zoom:14 });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
    var marker = L.marker([lat,lng]).addTo(map); if (addr) marker.bindPopup(addr);
    setTimeout(function(){ map.invalidateSize(); }, 200);
  });
})();
</script>
</body>
</html>
