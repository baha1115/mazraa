<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="alternate icon" type="image/png" href="../public/assests/logo.png">
  <title><%= contractor ? (contractor.name + ' — تفاصيل المقاول') : 'المقاول غير موجود' %></title>
  <meta name="description" content="تفاصيل مقاول: معرض الأعمال، الخدمات، المناطق المغطّاة، ووسائل التواصل." />
  <link rel="stylesheet" href="/Public/styles/contractorsstyle.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
</head>
<body>
<style>
  /* لتحسين مظهر الشرائح داخل سويبر أفضل التقييم */
  .toprated-swiper .swiper-slide { height: auto; }
  .toprated-swiper .contractor-card { height: 100%; display: block; }
  :root{
  --r:16px;
  --shadow: 0 10px 24px rgba(0,0,0,.06);
  --muted:#64748b;
}

/* ===== Hero (الجزء العلوي) ===== */
.contractor-hero{
  background: linear-gradient(180deg,#f8fafc,transparent 60%);
  padding: 1.25rem 0 .5rem;
}
.contractor-hero__inner{
  display:grid; grid-template-columns: auto 1fr; gap: 1rem; align-items:center;
}
.avatar--lg img{
  width:112px; height:112px; object-fit:cover; border-radius: 50%;
  box-shadow: var(--shadow);
}
.hero-copy .name{ font-size:1.6rem; margin:.2rem 0; }
.hero-copy .specialization, .hero-copy .region{ color:var(--muted); margin:.15rem 0; }

/* أزرار الهيرو – منسّقة بدل الـposition:absolute */
.hero-actions{ display:flex; gap:.5rem; position: static; margin-top:.6rem; }

/* موبايل: عمود واحد ومحاذاة وسط */
@media (max-width:640px){
  .contractor-hero__inner{ grid-template-columns: 1fr; text-align:center; }
  .hero-actions{ justify-content:center; }
  .stats{ align-items:center !important; }
}

/* ===== عناوين الأقسام ===== */
.section-title{ font-size:1.25rem; margin-bottom:.75rem; }

/* ===== كروت عامة ===== */
.card{
  background:#fff; border:1px solid #e5e7eb; border-radius: var(--r); box-shadow: var(--shadow);
}

/* ===== إطار وسائط (فيديو/صور) ===== */
.media-frame{
  aspect-ratio: 16/9; background:#000;
  border:1px solid #e5e7eb; border-radius:var(--r); overflow:hidden;
}

/* ===== المعرض (Swiper) ===== */
.gallery-swiper{ border-radius: var(--r); overflow:hidden; box-shadow: var(--shadow); }
.gallery-swiper img{ width:100%; height:280px; object-fit:cover; }
@media (max-width:640px){ .gallery-swiper img{ height:220px; } }

/* ===== نص النبذة والوصف داخل كروت أنيقة ===== */
#about .prose, #description .prose{
  background:#fff; border:1px solid #e5e7eb; border-radius: var(--r);
  padding:1rem 1.2rem; box-shadow: var(--shadow);
}
/* ديسكتوب: توزيع العنوان/المحتوى */
@media (min-width:1024px){
  #about .container, #description .container{
    display:grid; grid-template-columns: 1fr 2fr; gap: 1rem; align-items:start;
  }
}

/* ===== شارة الاشتراك ===== */
.tier{
  display:inline-flex; gap:.35rem; align-items:center;
  padding:.15rem .6rem; border-radius:999px; font-weight:700; font-size:.9rem;
  background:#fef3c7; color:#92400e; border:1px solid #fde68a;
}
.tier::before{ content:'★'; font-size:1rem; line-height:1; }

/* ===== كارت "أفضل المقاولين" ===== */
.toprated-swiper .contractor-card{
  border:1px solid #e5e7eb; border-radius: var(--r); box-shadow: var(--shadow);
}
/* ===== تحسين تخطيط النبذة والوصف على الديسكتوب ===== */
@media (min-width: 1024px){
  /* عمود ثابت للعناوين + عمود مرن للمحتوى */
  #about .container,
  #description .container{
    display: grid;
    grid-template-columns: 220px minmax(0, 1fr);
    gap: 1.25rem;
    align-items: start;
  }

  /* عنوان أنيق بمحاذاة أعلى */
  #about .section-title,
  #description .section-title{
    margin: .35rem 0 0;
    white-space: nowrap;
  }

  /* خلي النص بدون كارد ثقيل على الديسكتوب، مع خط جانبي لطيف */
  #about .prose,
  #description .prose{
    background: transparent;
    border: 0;
    box-shadow: none;
    padding: 0;
    max-width: 72ch;          /* عرض قراءة مريح */
    border-inline-start: 4px solid #e2e8f0;  /* خط جانبي رقيق */
    padding-inline-start: 1rem;
  }

  /* تحسين الطباعة */
  #about .prose p,
  #description .prose p{
    line-height: 1.9;
    font-size: 1.05rem;
    color: #0f172a;            /* Slate-900 */
  }
}

/* على الشاشات الصغيرة نحافظ على “الكارد” لأنّه أجمل هناك */
@media (max-width: 1023.98px){
  #about .prose, #description .prose{
    background:#fff; border:1px solid #e5e7eb; border-radius:16px;
    padding:1rem 1.2rem; box-shadow: 0 10px 24px rgba(0,0,0,.06);
  }
}
.hero-rating{
  display:flex; align-items:center; gap:.4rem;
  margin:.5rem 0 .25rem;
}
.hero-rating .stars-inline{ color:#f59e0b; font-size:1.1rem; }
.hero-rating .muted{ color:var(--muted); }
@media (max-width:640px){
  .hero-rating{ justify-content:center; }
}
/* ===== شبكة معرض الأعمال (بديل السويبر) ===== */
.work-grid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap:12px;
}
.work-item{
  border:1px solid #e5e7eb;
  border-radius: var(--r);
  overflow:hidden;
  box-shadow: var(--shadow);
  background:#fff;
  aspect-ratio: 4 / 3;        /* حجم متوسط ثابت النسبة */
}
.work-item img{
  width:100%; height:100%; object-fit:cover; display:block;
  transition: transform .25s ease;
}
.work-item:hover img{ transform: scale(1.03); }

@media (max-width:640px){
  .work-grid{ grid-template-columns: repeat(2, 1fr); } /* صفّين على الموبايل */
}
/* ===== تخطيط الهيرو على الموبايل: عمود معلومات + عمود أزرار ===== */
@media (max-width:640px){
  .hero-top{
    display: grid;
    grid-template-columns: 1fr 140px;       /* عدّل 140px حسب عرض الأزرار اللي تفضّله */
    grid-template-areas:
      "avatar actions"
      "name   actions"
      "spec   actions"
      "region actions"
      "rating actions"
      "stats  stats";
    align-items: center;
    column-gap: .75rem;
    row-gap: .3rem;
    text-align: start;                       /* ألغِ محاذاة الوسط القديمة */
  }

  /* ربط العناصر بمناطق الشبكة */
  .avatar--lg{ grid-area: avatar; justify-self: start; }
  .hero-copy{ display: contents; }           /* مرِّر الأبناء مباشرة للشبكة */
  .hero-copy .name{ grid-area: name; }
  .hero-copy .specialization{ grid-area: spec; }
  .hero-copy .region{ grid-area: region; }
  .hero-rating{ grid-area: rating; justify-content: flex-start; }
  .stats{ grid-area: stats; align-items: flex-start !important; }

  /* عمود الأزرار */
  .hero-actions{
    grid-area: actions;
    display: flex;
    flex-direction: column;
    gap: .5rem;
    align-self: start;
  }
  .hero-actions .btn{ width: 100%; }
}

/* ألغِ التوسيط السابق الذي كان على .contractor-hero__inner و .hero-actions بالموبايل */
@media (max-width:640px){
  .contractor-hero__inner{ grid-template-columns: 1fr; }
  .hero-actions{ justify-content: initial; }
}
/* ===== موبايل: صورة | معلومات | أزرار ===== */
@media (max-width:640px){
  .hero-top{
    display: grid;
    grid-template-columns: 84px 1fr 120px;   /* صورة | معلومات | أزرار */
    grid-template-areas:
      "avatar name   actions"
      "avatar spec   actions"
      "avatar region actions"
      "avatar rating actions"
      "avatar stats  actions";
    align-items: center;
    column-gap: .75rem;
    row-gap: .25rem;
    text-align: start;
  }

  /* الصورة يمين وبحجم ثابت */
  .avatar--lg{ grid-area: avatar; width:84px; height:84px; justify-self: start; }
  .avatar--lg img{ width:100%; height:100%; object-fit:cover; border-radius:50%; }

  /* وزّع عناصر المعلومات كلٌّ في منطقته */
  .hero-copy{ display: contents; }
  .hero-copy .name{ grid-area: name; }
  .hero-copy .specialization{ grid-area: spec; }
  .hero-copy .region{ grid-area: region; }
  .hero-rating{ grid-area: rating; justify-content: flex-start; }  /* يبقى تحت المنطقة */
  .stats{ grid-area: stats; align-items: flex-start !important; }

  /* الأزرار يسار عمود مستقل */
  .hero-actions{
    grid-area: actions;
    display: flex;
    flex-direction: column;
    gap: .5rem;
    align-self: start;
  }
  .hero-actions .btn{ width: 100%; }
}
@media (max-width:640px){
  .hero-rating{
    display:flex;
    align-items:center;
    gap:.4rem;
    flex-wrap: wrap;           /* اسمح بالنزول لسطر جديد */
  }
  .hero-rating .rate-link{
    flex: 0 0 100%;            /* خُذ صف كامل تحت الرقم والعدّاد */
    margin-top: .15rem;
  }
}

/* ===== Contractor Hero (تصميم جديد) ===== */
:root{
  --r:16px;
  --shadow: 0 10px 24px rgba(0,0,0,.06);
  --muted:#64748b;
}

.contractor-hero{
  background: linear-gradient(180deg,#f8fafc,transparent 60%);
  padding: 1rem 0 .75rem;
}

.hero-grid{
  display: grid;
  grid-template-columns: 84px 1fr 130px; /* صورة | معلومات | أزرار */
  gap: .75rem;
  align-items: center;
}

.hero-avatar{
  width:84px; height:84px; border-radius:50%;
  overflow: hidden; margin:0; box-shadow: var(--shadow);
}
.hero-avatar img{
  width:100%; height:100%; object-fit:cover; display:block;
}

.hero-info{ min-width: 0; } /* للسماح بالقطع */
.hero-name{ font-size: 1.35rem; margin: .1rem 0; line-height:1.25; }
.hero-meta{ margin:.1rem 0; }
.muted{ color: var(--muted); }

.hero-rating{
  display:flex; align-items:center; gap:.4rem; flex-wrap:wrap;
  margin-top:.25rem;
}
.hero-rating .stars-inline{ color:#f59e0b; font-size:1.05rem; }
.hero-rating .rate-link{ flex:0 0 100%; margin-top:.1rem; }

.hero-actions{
  display:flex; flex-direction:column; gap:.5rem; align-self:start;
}
.hero-actions .btn{ width:100%; }

/* شاشات أصغر جدًا: اجعل الأزرار تحت المعلومات */
@media (max-width: 400px){
  .hero-grid{
    grid-template-columns: 72px 1fr;
    grid-template-areas:
      "avatar info"
      "actions actions";
  }
  .hero-avatar{ grid-area: avatar; width:72px; height:72px; }
  .hero-info{ grid-area: info; }
  .hero-actions{ grid-area: actions; margin-top:.5rem; }
}

/* ديسكتوب: وسّع الصورة قليلاً واجعل الأزرار بجانبها */
@media (min-width: 1024px){
  .hero-grid{
    grid-template-columns: 112px 1fr 220px;
    gap: 1rem;
  }
  .hero-avatar{ width:112px; height:112px; }
  .hero-name{ font-size: 1.6rem; }
}
/* ===== Top-rated contractors · compact cards on phones ===== */
@media (max-width:640px){
  .toprated-swiper .swiper-slide{ height:auto; }

  .toprated-swiper .contractor-card{
    border-radius: 12px !important;
    padding: 10px !important;
    box-shadow: 0 2px 10px rgba(2,6,23,.05) !important;
  }

  .toprated-swiper .contractor-head{ display: grid; grid-template-columns: 52px 1fr; gap: 10px; align-items: center; }
  .toprated-swiper .avatar{ width: 52px !important; height: 52px !important; border-width: 2px !important; }
  .toprated-swiper .avatar img{ width: 100%; height: 100%; object-fit: cover; border-radius: 50%; display: block; }

  .toprated-swiper .head-info .name{ font-size: .98rem !important; margin: 0 0 2px !important; }
  .toprated-swiper .specialization,
  .toprated-swiper .region{ font-size: .82rem !important; line-height: 1.25; margin: 0 !important; }

  .toprated-swiper .muted{ font-size: .8rem !important; }
  .toprated-swiper .badge--tier{
    font-size: .7rem !important; padding: .16rem .45rem !important;
    top: 8px !important; inset-inline-end: 8px !important;
  }

  .toprated-swiper .contractor-body .btn.btn-outline{
    width: 100%; padding: .42rem .7rem !important; font-size: .86rem !important; border-radius: 10px !important;
  }
}
/* === Top-rated contractor card · polished === */
.toprated-swiper .contractor-card{
  display:flex; flex-direction:column;
  border:1px solid #e5e7eb; border-radius:14px;
  background:#fff; box-shadow:0 6px 18px rgba(2,6,23,.06);
  transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
  height:100%;
}
.toprated-swiper .contractor-card:hover{
  transform: translateY(-2px);
  box-shadow:0 14px 30px rgba(2,6,23,.1);
  border-color:#e2e8f0;
}

.toprated-swiper .contractor-link{ display:flex; flex-direction:column; height:100%; }

/* رأس الكرت */
.toprated-swiper .contractor-head{
  position:relative;
  display:grid; grid-template-columns: 56px 1fr; gap:.75rem;
  padding:.8rem .9rem .6rem;
  align-items:center;
}
.toprated-swiper .avatar{ width:56px; height:56px; border-radius:50%; overflow:hidden; box-shadow:0 2px 10px rgba(2,6,23,.06); }
.toprated-swiper .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
.toprated-swiper .head-info .name{ font-size:1.02rem; font-weight:800; margin:0 0 .15rem; }
.toprated-swiper .specialization,
.toprated-swiper .region{ color:#64748b; font-size:.86rem; margin:0; line-height:1.25; }

/* شارة المستوى */
.toprated-swiper .badge--tier{
  position:absolute; inset-inline-start:.9rem; top:.8rem;
  background:#111827; color:#fff; border-radius:999px;
  padding:.18rem .55rem; font-size:.72rem; font-weight:800; letter-spacing:.2px;
  box-shadow:0 6px 14px rgba(0,0,0,.14);
}

/* سطر التقييم */
.toprated-swiper .muted{ color:#475569; font-size:.86rem; margin:.35rem 0 0; }
.toprated-swiper .muted strong{ font-weight:800; }

/* جسم الكرت + زر */
.toprated-swiper .contractor-body{
  margin-top:auto; padding:.65rem .9rem .9rem;
  border-top:1px solid #f1f5f9;
}
.toprated-swiper .contractor-body .btn.btn-outline{
  width:100%; padding:.48rem .8rem; border-radius:10px; font-weight:800;
}

/* — الهاتف: أصغر + كرتين — */
@media (max-width:640px){
  .toprated-swiper .contractor-head{ grid-template-columns: 50px 1fr; gap:.6rem; padding:.7rem .75rem .5rem; }
  .toprated-swiper .avatar{ width:50px; height:50px; }
  .toprated-swiper .head-info .name{ font-size:.98rem; }
  .toprated-swiper .specialization, .toprated-swiper .region, .toprated-swiper .muted{ font-size:.82rem; }
  .toprated-swiper .badge--tier{ inset-inline-start:.75rem; top:.7rem;max-width: 50px; font-size:.68rem; padding:.14rem .45rem; }
  .toprated-swiper .contractor-body{ padding:.55rem .75rem .75rem; }
  .toprated-swiper .contractor-body .btn.btn-outline{ padding:.42rem .72rem; font-size:.86rem; }
  /* أسهم الملاحة أصغر أو مخفية إذا ضايقت */
  .toprated-swiper .swiper-button-next,
  .toprated-swiper .swiper-button-prev{ transform:scale(.8); }
}
/* ===== Lightbox base ===== */
.lb{ position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,.92); display:grid; place-items:center; }
.lb[hidden]{ display:none; }
.lb-close{
  position:absolute; top:12px; inset-inline-end:12px; width:40px; height:40px; border-radius:999px;
  border:1px solid rgba(255,255,255,.25); background:rgba(0,0,0,.35); color:#fff; font-size:24px;
  display:grid; place-items:center; cursor:pointer;
}
.lb-close:hover{ background:rgba(255,255,255,.1); }
.lb-swiper{ width:min(100vw,1100px); height:min(100vh,88vh); }
.lb-swiper .swiper-slide{ display:grid; place-items:center; background:transparent; }
.lb-swiper img{ max-width:100%; max-height:100%; object-fit:contain; object-position:center; border-radius:10px; }
.lb .swiper-button-prev,.lb .swiper-button-next{ color:#fff; filter:drop-shadow(0 4px 10px rgba(0,0,0,.6)); transform:scale(1.05); }
.lb .swiper-pagination-bullet{ background:rgba(255,255,255,.85); }
@media (max-width:640px){ .lb-swiper{ width:100vw; height:78vh; } }
/* ===== Top Rated section: match contractors page cards ===== */
.toprated-swiper .swiper-wrapper{ align-items: stretch !important; }
.toprated-swiper .swiper-slide{ height:auto !important; }

/* استعمل نفس كرت contractors.ejs */
.toprated-swiper .contractor-card{
  position:relative !important;
  display:flex !important;
  flex-direction:column !important;
  gap:10px !important;
  padding:14px 12px 12px !important;
  padding-top:42px !important;
  border-radius:18px !important;
  border:1px solid #e5e7eb !important;
  background:linear-gradient(135deg,#ffffff,#f9fafb) !important;
  box-shadow:0 4px 14px rgba(15,23,42,.06) !important;
  height:100% !important;
  min-height:240px !important;
  overflow:hidden !important;
}

/* شارة الخطة مثل صفحة المقاولين */
.toprated-swiper .badge--tier{
  position:absolute !important;
  top:10px !important;
  inset-inline-end:10px !important;
  background:#0f172a !important;
  color:#fff !important;
  border-radius:999px !important;
  font-size:.78rem !important;
  padding:.18rem .7rem !important;
  line-height:1 !important;
  font-weight:700 !important;
}

/* رأس الكرت: صورة + معلومات */
.toprated-swiper .contractor-head{
  display:flex !important;
  align-items:center !important;
  gap:12px !important;
  padding:0 !important;
}
.toprated-swiper .avatar{
  width:68px !important;
  height:68px !important;
  border-radius:999px !important;
  overflow:hidden !important;
  border:3px solid #e5e7eb !important;
  flex-shrink:0 !important;
}
.toprated-swiper .avatar img{
  width:100% !important;
  height:100% !important;
  object-fit:cover !important;
  display:block !important;
}

/* النصوص */
.toprated-swiper .head-info{ min-width:0 !important; }
.toprated-swiper .head-info .name{
  margin:0 !important;
  font-weight:800 !important;
  font-size:1.02rem !important;
  color:#0f172a !important;
  white-space:nowrap !important;
  overflow:hidden !important;
  text-overflow:ellipsis !important;
}
.toprated-swiper .specialization,
.toprated-swiper .region{
  margin:0 !important;
  color:#64748b !important;
  font-size:.88rem !important;
  white-space:nowrap !important;
  overflow:hidden !important;
  text-overflow:ellipsis !important;
}

/* سطر التقييم */
.toprated-swiper .muted{
  margin:.25rem 0 0 !important;
  color:#6b7280 !important;
  font-weight:600 !important;
  font-size:.9rem !important;
}

/* زر أسفل الكرت */
.toprated-swiper .contractor-body{
  margin-top:auto !important;
  padding:0 !important;
  border:0 !important;
}
.toprated-swiper .contractor-body .btn.btn-outline{
  margin-top:auto !important;
  width:100% !important;
  text-align:center !important;
  border:1px solid #0f172a !important;
  border-radius:12px !important;
  padding:.5rem .85rem !important;
  color:#0f172a !important;
  font-weight:700 !important;
  background:#fff !important;
}

/* موبايل: نفس قواعد صفحة المقاولين */
@media (max-width:640px){
  .toprated-swiper .contractor-card{
    padding:12px 10px 10px !important;
    border-radius:14px !important;
    min-height:210px !important;
    box-shadow:0 3px 12px rgba(15,23,42,.08) !important;
  }
  .toprated-swiper .contractor-head{
    flex-direction:column !important;
    align-items:center !important;
    text-align:center !important;
    gap:8px !important;
  }
  .toprated-swiper .avatar{
    width:60px !important;
    height:60px !important;
    border-width:2px !important;
  }
  .toprated-swiper .specialization,
  .toprated-swiper .region{
    white-space:normal !important;
    text-overflow:clip !important;
    font-size:.8rem !important;
  }
  .toprated-swiper .contractor-body .btn.btn-outline{
    font-size:.86rem !important;
    padding:.42rem .7rem !important;
    border-radius:10px !important;
  }
  .toprated-swiper .badge--tier{
    font-size:.72rem !important;
    padding:.16rem .5rem !important;
    top:8px !important;
    inset-inline-end:8px !important;
  }
}

</style>

  <%- include('partials/navbar', { active: 'contractors' }) %>
<%- include('partials/whatsapp') %>
  <% if (!contractor) { %>
    <section class="section">
      <div class="container">
        <h1>المقاول غير موجود</h1>
        <p class="muted">عذرًا، لم نعثر على المقاول المطلوب.</p>
        <a class="btn btn-outline" href="/contractors#list">عودة إلى المقاولين</a>
      </div>
    </section>
  <% } else { 
       const avatar   = contractor.avatar || '/Public/assets/contractors/default.jpg';
       const name     = contractor.name || contractor.companyName || '—';
       const services = Array.isArray(contractor.services) ? contractor.services.join('، ') : (contractor.services || '—');
       const region   = contractor.region || contractor.city || '—';
      const rawTier  = contractor.userTier || contractor.subscriptionTier || 'Basic';
const tier     = ({ vip:'VIP', premium:'Premium', basic:'Basic' }[String(rawTier).toLowerCase()]) || rawTier;

       const photos   = (Array.isArray(contractor.photos) && contractor.photos.length) ? contractor.photos : [avatar];
 // ——— مساعد: تحويل الرقم إلى صيغة MSISDN (digits فقط، بدون +) لواتساب
function toMSISDN(raw){
  raw = String(raw||'').trim();
  let s = raw.replace(/[^\d+]/g,''); // إبقِ الأرقام و+
  if (s.startsWith('+')) s = s.slice(1);
  if (s.startsWith('00')) s = s.slice(2);
  // 09XXXXXXXX → 9639XXXXXXXX
  if (/^0\d{9}$/.test(s)) s = '963' + s.slice(1);
  return /^\d{10,15}$/.test(s) ? s : '';
}

// حاول أخذ رقم واتساب ثم رقم الهاتف كاحتياطي
const waSource  = contractor.whatsapp || contractor.phone || contractor.mobile || '';
const waMsisdn  = toMSISDN(waSource); // مثال: 9639XXXXXXXX
const waDefaultMsg = 'مرحبًا، رأيت ملفك على فارمرز وأرغب بالتواصل';
       %>

  <!-- هيدر / ملخص -->
<header class="contractor-hero">
  <div class="container">
    <div class="hero-grid">
      <!-- الصورة -->
      <figure class="hero-avatar">
        <img src="<%= avatar %>" alt="صورة <%= name %>">
      </figure>

      <!-- المعلومات -->
      <div class="hero-info">
        <h1 class="hero-name"><%= name %></h1>
        <p class="hero-meta"><%= services %></p>
        <p class="hero-meta muted"><%= region %></p>

        <div class="hero-rating" aria-label="التقييم المختصر">
          <span class="stars-inline" aria-hidden="true">⭐</span>
          <strong dir="ltr">
            <%= (contractor.ratingAvg != null)
                  ? (Number(contractor.ratingAvg).toFixed ? Number(contractor.ratingAvg).toFixed(2) : contractor.ratingAvg)
                  : 0 %>
          </strong>
          <small class="muted">(<%= contractor.ratingCount || 0 %>)</small>
          <a class="link rate-link" href="#rating">قيّم الآن</a>
        </div>
      </div>

      <!-- الأزرار -->
      <div class="hero-actions">
        <a class="btn btn-primary" href="#request">طلب خدمة</a>
        <% if (contractor.phone) { %>
          <a class="btn btn-outline" href="tel:<%= contractor.phone.replace(/\s+/g,'') %>">
            اتصل: <%= contractor.phone %>
          </a>
        <% } %>
      </div>
    </div>
  </div>
</header>


  <!-- معرض الأعمال -->
 <section id="gallery" class="section gallery" aria-labelledby="gallery-title">
  <div class="container">
    <h2 id="gallery-title" style="margin-bottom:1rem;">الأعمال :</h2>

    <div class="work-grid" aria-label="صور المعرض">
      <% photos.forEach(function(src){ %>
        <figure class="work-item">
          <img src="<%= src %>" alt="عمل لـ <%= name %>" loading="lazy"
               onerror="this.onerror=null;this.src='/Public/assets/contractors/default.jpg'">
        </figure>
      <% }) %>
    </div>
  </div>
</section>

<%
// دوال مساعدة: تأمين HTML + تحويل الأسطر إلى <br>
// (استخدمنا function عادية لتجنّب أي لخبطة أقواس)
function esc(s) {
  return String(s || '').replace(/[&<>"]/g, function (m) {
    return { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;' }[m];
  });
}
function nl2brSafe(s) { return esc(s).replace(/\r?\n/g, '<br>'); }
%>

<!-- ===== قسم الفيديو التعريفي ===== -->
<% if (contractor.videoUrl) {
     const v  = String(contractor.videoUrl || '').trim();
     const yt = v.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/))([\w-]{11})/);
     const vm = v.match(/vimeo\.com\/(?:video\/)?(\d+)/);
%>
<section id="intro-video" class="section intro-video" aria-labelledby="vid-title">
  <div class="container">
    <h2 id="vid-title" style="margin-bottom:.6rem;">فيديو تعريفي</h2>
    <div style="border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;background:#000;aspect-ratio:16/9">
      <% if (yt) { %>
        <iframe src="https://www.youtube.com/embed/<%= yt[1] %>" title="YouTube video"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen style="width:100%;height:100%;border:0"></iframe>
      <% } else if (vm) { %>
        <iframe src="https://player.vimeo.com/video/<%= vm[1] %>" title="Vimeo video"
                allow="autoplay; fullscreen; picture-in-picture" allowfullscreen
                style="width:100%;height:100%;border:0"></iframe>
      <% } else if (/\.(mp4|webm|ogg)(\?|#|$)/i.test(v)) { %>
        <video controls style="width:100%;height:100%;object-fit:cover">
          <source src="<%= v %>">
        </video>
      <% } else { %>
        <a class="btn btn-outline" href="<%= v %>" target="_blank" rel="noopener">فتح الفيديو</a>
      <% } %>
    </div>
  </div>
</section>
<% } %>

<!-- ===== قسم النبذة ===== -->
<section id="about" class="section about" aria-labelledby="about-title">
  <div class="container">
    <h2 id="about-title" style="margin-bottom:.6rem;">نبذة</h2>
    <% if (contractor.bio) { %>
      <article class="prose" style="max-width:65ch">
        <p><%- nl2brSafe(contractor.bio) %></p>
      </article>
    <% } else { %>
      <p class="muted">لا توجد نبذة بعد.</p>
    <% } %>
  </div>
</section>

<!-- ===== قسم الوصف التفصيلي ===== -->
<section id="description" class="section description" aria-labelledby="desc-title">
  <div class="container">
    <h2 id="desc-title" style="margin-bottom:.6rem;">الوصف :</h2>
    <% if (contractor.description) { %>
      <article class="prose" style="max-width:70ch">
        <p><%- nl2brSafe(contractor.description) %></p>
      </article>
    <% } else { %>
      <p class="muted">لا يوجد وصف بعد.</p>
    <% } %>
  </div>
</section>

  <!-- الخدمات -->
  
 <!-- طلب خدمة -->
<section id="request" class="section request" aria-labelledby="request-title">
  <div class="container">
    <h2 id="request-title">طلب خدمة</h2>
    <p class="muted">املأ بياناتك وسنتواصل معك في أقرب وقت.</p>

    <form id="request-form" action="/request" method="post" novalidate>
      <input type="hidden" name="contractorId" value="<%= contractor._id %>"/>

      <div class="form-grid">
        <div class="field">
          <label class="label" for="rq-name">الاسم</label>
          <input id="rq-name" class="input" name="name" type="text" placeholder="اكتب اسمك" required />
        </div>

        <div class="field">
          <label class="label" for="rq-phone">رقم الهاتف</label>
          <input id="rq-phone" class="input" name="phone" type="tel" placeholder="+963 XXX XXX" required />
        </div>

        <div class="field field--full">
          <label class="label" for="rq-desc">وصف مختصر</label>
          <textarea id="rq-desc" class="input" name="description" rows="4" placeholder="صف طلبك بشكل مختصر"></textarea>
        </div>

        <div class="field field--actions">
          <button class="btn btn-primary" type="submit">إرسال</button>

          <% if (waMsisdn) { %>
            <!-- زر واتساب احتياطي مباشرةً -->
            <a class="btn btn-outline"
               href="https://wa.me/<%= waMsisdn %>?text=<%= encodeURIComponent('أحتاج خدمة من المقاول: '+name) %>"
               target="_blank" rel="noopener">واتساب مباشر</a>
          <% } %>
        </div>
      </div>
    </form>
  </div>
</section>
<script>
(function(){
  const form = document.getElementById('request-form');
  if (!form) return;

  const msisdn = '<%= waMsisdn %>'; // رقم واتساب للمقاول بصيغة MSISDN
  const contractorName = '<%= name %>';

  form.addEventListener('submit', function(e){
    // لو عندنا رقم واتساب صالح للمقاول → افتح واتساب برسالة مكوَّنة من الحقول
    if (msisdn) {
      e.preventDefault();

      const name  = (form.name?.value || '').trim();
      const phone = (form.phone?.value || '').trim();
      const desc  = (form.description?.value || '').trim();

      const msg = `مرحبًا، أنا ${name||'—'} (${phone||'—'}).\n` +
                  `أرغب بطلب خدمة من المقاول: ${contractorName}.\n` +
                  `الوصف: ${desc||'—'}`;

      const url = `https://wa.me/${msisdn}?text=${encodeURIComponent(msg)}`;
      window.open(url, '_blank', 'noopener');

      // (اختياري) لو حابب أيضًا تحفظ الطلب في السيرفر:
      // form.submit(); // ← أزل التعليق لإرسال الخانات لسيرفرك بعد فتح واتساب
    }
    // إن لم يوجد رقم واتساب، يكمل الإرسال العادي إلى /request
  });
})();
</script>
<section id="rating" class="section rating" aria-labelledby="rating-title">
  <div class="container">
    <h2 id="rating-title" style="margin-bottom:.5rem;">التقييم</h2>

    <!-- عرض المتوسط والعدد -->
    <p class="muted" id="ratingSummary"
       data-id="<%= contractor._id %>"
       data-avg="<%= contractor.ratingAvg || 0 %>"
       data-count="<%= contractor.ratingCount || 0 %>">
      التقييم الحالي: <strong dir="ltr"><span id="avgNum"><%= contractor.ratingAvg || 0 %></span>/5</strong>
      — عدد المقيمين: <strong id="countNum"><%= contractor.ratingCount || 0 %></strong>
    </p>

    <!-- نجوم التقييم -->
    <div class="stars" id="rateStars" role="radiogroup" aria-label="قيِّم هذا المقاول">
      <% for (let i=1; i<=5; i++){ %>
        <button type="button"
                class="star"
                role="radio"
                aria-checked="false"
                data-val="<%= i %>"
                title="<%= i %> من 5">★</button>
      <% } %>
    </div>

    <p class="muted" id="rateMsg" style="min-height:1.4rem;margin-top:.5rem"></p>
  </div>
</section>

<style>
  .stars { display:flex; gap:.25rem; font-size: 2rem; line-height:1; }
  .star  {
    background:none; border:0; cursor:pointer; padding:.1rem .2rem;
    color:#cbd5e1; /* رمادي فاتح */
    transition: transform .1s ease, color .1s ease;
  }
  .star.is-hot, .star:hover { color:#f59e0b; transform: translateY(-1px); } /* ذهبي */
</style>

  <% } /* نهاية if(contractor) */ %>
<% if (Array.isArray(topRated) && topRated.length) { %>
<section class="section" aria-labelledby="top-rated-title">
  <div class="container">
    <h2 id="top-rated-title" style="margin-bottom:1rem;">أفضل المقاولين تقييماً</h2>

    <div class="swiper toprated-swiper" dir="rtl">
      <div class="swiper-wrapper">
        <% topRated.forEach(function(c){ 
             const name   = c.name || c.companyName || '—';
             const avatar = c.avatar || '/Public/assets/contractors/default.jpg';
             const svc    = Array.isArray(c.services) ? c.services.join('، ') : (c.services || '—');
             const reg    = c.region || c.city || '—';
             const avg    = Number(c.ratingAvg || 0).toFixed(2);
             const cnt    = Number(c.ratingCount || 0);
        %>
          <div class="swiper-slide">
            <article class="contractor-card">
  <a class="contractor-link" href="/contractor/<%= c._id %>">
    <header class="contractor-head">
      <figure class="avatar"><img src="<%= avatar %>" alt="صورة <%= name %>" loading="lazy"></figure>
      <div class="head-info">
        <h3 class="name"><%= name %></h3>
        <p class="specialization"><%= svc %></p>
        <p class="region"><%= reg %></p>
        <p class="muted">⭐ <strong dir="ltr"><%= avg %></strong> (<%= cnt %>)</p>
      </div>
      <% if (c.subscriptionTier==='VIP') { %>
        <span class="badge badge--tier">VIP</span>
      <% } else if (c.subscriptionTier==='Premium') { %>
        <span class="badge badge--tier">مميز</span>
      <% } %>
    </header>

    <div class="contractor-body">
      <button class="btn btn-outline" type="button">عرض المقاول</button>
    </div>
  </a>
</article>

          </div>
        <% }) %>
      </div>

      <!-- عناصر التحكم -->
      <div class="swiper-button-prev" aria-label="السابق"></div>
      <div class="swiper-button-next" aria-label="التالي"></div>
      <div class="swiper-pagination"></div>
    </div>
  </div>
</section>
<% } %>

  
 <%- include('partials/footer') %>

   <script src="../Public/contractorsingle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script>
  
      new Swiper('.toprated-swiper', {
    watchOverflow: true,
    pagination: { el: '.toprated-swiper .swiper-pagination', clickable: true },
    navigation: {
      nextEl: '.toprated-swiper .swiper-button-next',
      prevEl: '.toprated-swiper .swiper-button-prev'
    },
    /* هاتف: كرتان فعلياً */
    slidesPerView: 2.02,
    spaceBetween: 10,
    breakpoints: {
      480:  { slidesPerView: 2.10, spaceBetween: 12 },
      640:  { slidesPerView: 2.4,  spaceBetween: 14 },
      1024: { slidesPerView: 3.2,  spaceBetween: 18 },
      1280: { slidesPerView: 3.6,  spaceBetween: 20 }
    }
  });
  </script>
  <script>
(() => {
  const wrap   = document.getElementById('ratingSummary');
  const stars  = Array.from(document.querySelectorAll('#rateStars .star'));
  const msg    = document.getElementById('rateMsg');
  if (!wrap || !stars.length) return;

  const id     = wrap.dataset.id;
  const avgEl  = document.getElementById('avgNum');
  const cntEl  = document.getElementById('countNum');

  // تلوين مبدئي (حسب المتوسط)
  function paint(avg){
    const whole = Math.round(avg);
    stars.forEach((s, i) => s.classList.toggle('is-hot', i < whole));
  }
  paint(Number(wrap.dataset.avg||0));

  // إرسال التقييم
  async function sendRating(val){
    msg.textContent = 'جارٍ الإرسال...';
    try {
      const r = await fetch(`/contractor/${id}/rate`, {
        method:'POST',
        headers:{'Content-Type':'application/json','Accept':'application/json'},
        body: JSON.stringify({ value: val })
      });
      const j = await r.json();
      if (!j.ok) throw new Error(j.msg || 'فشل الإرسال');
      // حدّث الواجهة
      avgEl.textContent = j.data.avg.toFixed ? j.data.avg.toFixed(2) : j.data.avg;
      cntEl.textContent = j.data.count;
      paint(Number(j.data.avg||0));
      msg.textContent = 'شكرًا! تم تسجيل تقييمك.';
    } catch(e){
      msg.textContent = e.message || 'تعذّر الإرسال.';
    }
  }

  stars.forEach(btn => {
    btn.addEventListener('click', () => {
      const val = Number(btn.dataset.val);
      stars.forEach(s => s.setAttribute('aria-checked','false'));
      btn.setAttribute('aria-checked','true');
      paint(val);
      sendRating(val);
    });
  });
})();
</script>
<!-- ===== Lightbox / Fullscreen Gallery ===== -->
<div id="lb" class="lb" hidden aria-hidden="true">
  <button class="lb-close" aria-label="إغلاق">×</button>
  <div class="swiper lb-swiper">
    <div class="swiper-wrapper" id="lbWrapper"></div>
    <div class="swiper-button-prev" aria-label="السابق"></div>
    <div class="swiper-button-next" aria-label="التالي"></div>
    <div class="swiper-pagination"></div>
  </div>
</div>
<script>
(function(){
  const grid = document.querySelector('.work-grid');
  if(!grid) return;

  const imgs = Array.from(grid.querySelectorAll('.work-item img'));
  if(!imgs.length) return;

  const sources = imgs.map(img => img.getAttribute('data-full') || img.src);

  const lb = document.getElementById('lb');
  const wrap = document.getElementById('lbWrapper');
  const closeBtn = lb.querySelector('.lb-close');
  let lbSwiper = null, built = false;

  function ensureSwiper(cb){
    if (window.Swiper) return cb();
    const link = document.createElement('link'); link.rel='stylesheet';
    link.href='https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css'; document.head.appendChild(link);
    const s = document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js';
    s.onload=cb; document.head.appendChild(s);
  }
  function buildSlides(){
    if (built) return;
    wrap.innerHTML = sources.map(src => `<div class="swiper-slide"><img src="${src}" alt=""></div>`).join('');
    built = true;
  }
  function openLB(index){
    ensureSwiper(function(){
      buildSlides();
      lb.hidden = false; lb.setAttribute('aria-hidden','false');
      if (lbSwiper){ try{ lbSwiper.destroy(true,true); }catch(_){ } }
      lbSwiper = new Swiper('.lb-swiper', {
        initialSlide: index||0,
        loop: (sources.length>1),
        centeredSlides: true, slidesPerView: 1, spaceBetween: 10,
        pagination: { el: '.lb-swiper .swiper-pagination', clickable: true },
        navigation: { nextEl: '.lb-swiper .swiper-button-next', prevEl: '.lb-swiper .swiper-button-prev' },
        keyboard: { enabled: true }
      });
      document.addEventListener('keydown', onKey);
      lb.addEventListener('click', onBackdrop, { once:true });
    });
  }
  function closeLB(){
    if (lbSwiper){ try{ lbSwiper.destroy(true,true); }catch(_){ } lbSwiper=null; }
    lb.hidden = true; lb.setAttribute('aria-hidden','true');
    document.removeEventListener('keydown', onKey);
  }
  function onKey(e){ if(e.key==='Escape') closeLB(); }
  function onBackdrop(e){
    const inside = e.target.closest('.lb-swiper');
    const isClose = e.target.closest('.lb-close');
    if (!inside || isClose) closeLB();
  }

  imgs.forEach((img,i)=>{
    img.style.cursor='zoom-in';
    img.addEventListener('click', ()=> openLB(i));
  });
  closeBtn.addEventListener('click', closeLB);
})();
</script>

<%- include('partials/mobile-nav', { 
  activeTab: 'contractors',   // غيّرها حسب الصفحة: 'home' | 'sale' | 'rent' | 'contractors' | 'dash'
  isAuth, isAdmin, isContractor, isOwner,
}) %>
</body>
</html>



