<!-- partials/mobile-nav.ejs (hardened) -->
<%
  const active = (typeof activeTab!=='undefined' ? String(activeTab) : '');
  const isActive = (k)=> active===k ? 'is-active' : '';
  let dashHref = '/profile';
  if (typeof isAdmin!=='undefined' && isAdmin) dashHref = '/admin';
  else if (typeof isContractor!=='undefined' && isContractor) dashHref = '/dashboard/contractor';
  else if (typeof isOwner!=='undefined' && isOwner) dashHref = '/dashboard/owner';
%>

<style>
@media (max-width:1023.98px){
  /* ===== حصر التأثير داخل المكوّن + إعادة ضبط آمنة ===== */
  .nvx-tabbar, .nvx-tabbar * { box-sizing: border-box; }
  .nvx-tabbar { 
    --nvx-bg: #fff; --nvx-ink:#0b1a13; --nvx-line:#e5e7eb; 
    --nvx-accent:#22c55e; --nvx-accent-2:#16a34a;
    font-size:14px; /* يقلّل الحجم الإجمالي */
  }

  .nvx-tabbar{
    position:fixed; inset-inline:0; bottom:0; z-index:9999;
    background:linear-gradient(180deg, rgba(255,255,255,.35), rgba(255,255,255,.92));
    -webkit-backdrop-filter:blur(14px); backdrop-filter:blur(14px);
    border-top:1px solid rgba(15,23,42,.08);
    box-shadow:0 -10px 24px rgba(2,6,23,.10);
    padding:.45rem .55rem calc(.55rem + env(safe-area-inset-bottom));
    animation:tabbarPop .42s ease .02s both;
  }
  .nvx-tabbar__wrap{
    max-width:760px; margin:0 auto;
    display:grid; grid-template-columns:repeat(5,1fr); gap:.45rem;
  }

  .nvx-tab{
    position:relative; height:52px !important; /* أصغر من قبل */
    border-radius:12px !important;
    background:var(--nvx-bg) !important; 
    border:1px solid var(--nvx-line) !important; color:var(--nvx-ink) !important;
    text-decoration:none !important; 
    display:grid !important; place-items:center !important; 
    overflow:hidden; isolation:isolate;
    transform:translateY(6px); opacity:0;
    animation:tabIn .45s cubic-bezier(.2,.8,.2,1) var(--d,0s) both;
    transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
  }
  /* أي قواعد عالمية مثل svg {width:100%} يتم إبطالها هنا */
  .nvx-tab svg{ width:20px !important; height:20px !important; flex:0 0 auto !important; }
  .nvx-tab span{
    position:absolute; bottom:6px; font-size:.7rem; font-weight:800; color:#1f2937; opacity:.92;
    line-height:1;
  }
  .nvx-tab:active{ transform:translateY(0) scale(.98); }
  .nvx-tab::after{
    content:""; position:absolute; inset:0; opacity:0;
    background:radial-gradient(110px 110px at var(--rx,50%) var(--ry,50%), rgba(34,197,94,.18), transparent 40%);
    transition:opacity .25s ease;
  }
  .nvx-tab:hover::after{ opacity:1; }

  .nvx-tab.is-active{
    border-color:var(--nvx-accent-2) !important; 
    box-shadow:0 8px 22px rgba(34,197,94,.20) !important;
  }
  .nvx-tab.is-active span{ color:#065f46 !important; }

  /* مساحة سفلية كي لا يغطي الشريط المحتوى */
  body{ padding-bottom:calc(86px + env(safe-area-inset-bottom)); }
}
@keyframes tabbarPop{ from{ transform:translateY(38px); opacity:0 } to{ transform:translateY(0); opacity:1 } }
@keyframes tabIn{ from{ transform:translateY(10px); opacity:0 } to{ transform:translateY(0); opacity:1 } }
</style>

<nav class="nvx-tabbar" role="navigation" aria-label="شريط سفلي">
  <div class="nvx-tabbar__wrap" dir="rtl">
    <a class="nvx-tab <%= isActive('home') %>" href="/" style="--d:.02s">
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M3 12l9-8 9 8" stroke="currentColor" stroke-width="1.4"/>
        <path d="M5 10v10h14V10" stroke="currentColor" stroke-width="1.4"/>
      </svg>
      <span>الرئيسية</span>
    </a>

    <a class="nvx-tab <%= isActive('sale') %>" href="/sale" style="--d:.08s">
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M4 7h16v10H4z" stroke="currentColor" stroke-width="1.4"/>
        <path d="M4 10h16M8 3h8v4H8z" stroke="currentColor" stroke-width="1.2"/>
      </svg>
      <span>مزارع البيع</span>
    </a>

    <a class="nvx-tab <%= isActive('rent') %>" href="/rent" style="--d:.14s">
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <rect x="3.5" y="7" width="17" height="11" rx="2" stroke="currentColor" stroke-width="1.4"/>
        <path d="M7 7V5a2 2 0 012-2h6a2 2 0 012 2v2" stroke="currentColor" stroke-width="1.2"/>
      </svg>
      <span>مزارع الإيجار</span>
    </a>

    <a class="nvx-tab <%= isActive('contractors') %>" href="/contractors" style="--d:.20s">
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M7 21v-4a5 5 0 015-5 5 5 0 015 5v4" stroke="currentColor" stroke-width="1.4"/>
        <circle cx="12" cy="7" r="3.5" stroke="currentColor" stroke-width="1.4"/>
      </svg>
      <span>المقاولون</span>
    </a>

    <% if (typeof isAuth!=='undefined' && isAuth) { %>
    <a class="nvx-tab <%= isActive('dash') %>" href="<%= dashHref %>" style="--d:.20s">
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M4 4h7v7H4zM13 4h7v5h-7zM13 11h7v9h-7zM4 13h7v7H4z" stroke="currentColor" stroke-width="1.4"/>
      </svg>
      <span>لوحة التحكم</span>
    </a>
    <% } else { %>
    <a class="nvx-tab" href="/login" style="--d:.20s">
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M10 12h9M14 8l5 4-5 4" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M14 4H7a2 2 0 00-2 2v12a2 2 0 002 2h7" stroke="currentColor" stroke-width="1.2"/>
      </svg>
      <span>تسجيل</span>
    </a>
    <% } %>
  </div>
</nav>

<script>
(function(){
  const bar = document.querySelector('.nvx-tabbar');
  if (!bar) return;
  bar.addEventListener('pointermove', (e)=>{
    const t = e.target.closest('.nvx-tab'); if(!t) return;
    const r = t.getBoundingClientRect();
    t.style.setProperty('--rx', (e.clientX - r.left) + 'px');
    t.style.setProperty('--ry', (e.clientY - r.top)  + 'px');
  });
})();
</script>
