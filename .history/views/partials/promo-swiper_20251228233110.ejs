<%
/**
 * متوقع أن تصِل:
 * bannersDoc: { enabled:Boolean, items:[{img,title,text,link,btn}] }
 */
const _doc = (typeof bannersDoc!=='undefined' && bannersDoc) ? bannersDoc : { enabled:false, items:[] };
const _items = Array.isArray(_doc.items) ? _doc.items : [];
const _enabled = !!_doc.enabled && _items.length > 0;
%>
<% if (_enabled) { %>
<style>
  .promo-swiper{ border-radius:16px; overflow:hidden; }

  /* Desktop/Tablet الافتراضي */
  .promo-slide{ position:relative; height:320px; background:#0b1a13; color:#fff; }
  .promo-medi{ position:absolute; inset:0 }
  .promo-medi img{ width:100%; height:100%; object-fit:cover; filter:brightness(.88) }
  .promo-overlay{ position:absolute; inset:0; background:linear-gradient(90deg,rgba(0,0,0,.45),rgba(0,0,0,.2) 45%, rgba(0,0,0,0)) }
  .promo-body{ position:relative; z-index:2; display:flex; align-items:center; justify-content:center; gap:.5rem; padding:1.1rem; width:100%; height:100%; text-align:center }
  .promo-title{ margin:.2rem 0 0; font-size:clamp(20px,3vw,34px) }
  .promo-text{ opacity:.95; color:antiquewhite; font-size:clamp(14px,1.4vw,16px) }
  .promo-cta{ display:inline-block; background:#fff; color:#0f172a; text-decoration:none; font-weight:800; border-radius:12px; padding:.55rem 1rem; width:160px; text-align:center }

  /* ===== Mobile tweaks (تصغير قوي على الهاتف) ===== */
  @media (max-width:640px){
    .promo-slide{ height:180px !important; }                /* ↓ كان 320px */
    .promo-body{ padding:.65rem !important; }
    .promo-title{ font-size:clamp(16px,4.2vw,20px) !important; }
    .promo-text{ font-size:.82rem !important; line-height:1.25 !important; opacity:.9; }
    .promo-cta{ padding:.45rem .85rem !important; width:auto; font-size:.9rem }

    /* أزرار السويبر أصغر وأهدأ */
    .promo-swiper{ --swiper-navigation-size: 18px; }
    .promo-swiper .swiper-button-prev,
    .promo-swiper .swiper-button-next{ transform:scale(.85); opacity:.85; }

    /* نقاط التصفح أقرب وأصغر */
    .promo-swiper .swiper-pagination-bullets .swiper-pagination-bullet{
      width:6px; height:6px; margin:0 3px;
    }
  }
</style>

<section class="section" aria-labelledby="bnr-title">
  <div class="container">

    <div class="swiper promo-swiper" dir="rtl">
      <div class="swiper-wrapper">
        <% _items.forEach(function(b){ %>
          <div class="swiper-slide">
            <article class="promo-slide">
       <div class="promo-medi">
  <%
    const imgRaw = (b && b.img) ? String(b.img).trim() : '';
    const safeImg = (/^data:/i.test(imgRaw)) ? '' : imgRaw; // امنع base64
    const bannerImg = (safeImg && safeImg.includes('res.cloudinary.com') && safeImg.includes('/upload/'))
      ? safeImg.replace('/upload/','/upload/f_auto,q_auto,w_900/')
      : safeImg;
  %>

  <img
    src="<%= bannerImg || '/Public/assets/contractors/default.jpg' %>"
    alt="<%= (b.title || '') %>"
    loading="lazy"
    decoding="async"
    fetchpriority="low"
  >
</div>

              <div class="promo-overlay"></div>

              <div class="promo-body">
                <% if (b.title) { %><h3 class="promo-title"><%= b.title %></h3><% } %>
                <% if (b.text)  { %><p class="promo-text"><%= b.text %></p><% } %>
                <% if (b.link)  { %><a class="promo-cta" href="<%= b.link %>"><%= b.btn || 'التفاصيل' %></a><% } %>
              </div>
            </article>
          </div>
        <% }) %>
      </div>

      <div class="swiper-button-prev" aria-label="السابق"></div>
      <div class="swiper-button-next" aria-label="التالي"></div>
      <div class="swiper-pagination"></div>
    </div>
  </div>
</section>
<script>
(function initPromoSwiper(){
  // 1) اعثر على الجذر الصحيح لهذا السويبر فقط
  var root, swiperEl;
  try {
    // أولًا الأقرب إلى هذا السكربت
    root = document.currentScript.closest('.promo-swiper')
        || document.currentScript.closest('.promoTop')
        || document.currentScript.closest('.section');
  } catch (_) {}
  // لو الأقرب غير متاح، جرّب أول سويبر بالصفحة
  if (!root) root = document.querySelector('.promo-swiper')
            || document.querySelector('.promoTop')
            || document.querySelector('.section');
  if (!root) return;

  // لو الجذر هو نفس عنصر السويبر نفسه
  swiperEl = root.classList.contains('promo-swiper')
           ? root
           : root.querySelector('.promo-swiper') || root.querySelector('.swiper');
  if (!swiperEl) return;

  // 2) انتظر مكتبة Swiper لو لم تكن جاهزة بعد
  function ready(fn){ if (document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  function whenSwiper(cb){
    if (window.Swiper) return cb();
    var tries = 0; (function tick(){
      if (window.Swiper) return cb();
      if (++tries > 50) return;          // ~5 ثواني
      setTimeout(tick, 100);
    })();
  }

  // 3) شغّل بعد الجاهزية
  ready(function(){
    whenSwiper(function(){
      var slides = swiperEl.querySelectorAll('.swiper-slide');
      var hasMany = slides.length > 1;

      // لو شريحة واحدة، أخفِ الأسهم/النقاط (لا نغيّر CSSك العام)
      if (!hasMany){
        var h = swiperEl.querySelectorAll('.swiper-button-prev,.swiper-button-next,.swiper-pagination');
        h.forEach(function(el){ if (el) el.style.display = 'none'; });
      }

      var opts = {
        slidesPerView: 1,
        spaceBetween: 8,
        speed: 500,
        loop: hasMany,
        autoplay: hasMany ? { delay: 3500, disableOnInteraction: false } : false,
        observer: true, observeParents: true, watchOverflow: true
      };

      if (hasMany){
        var nextEl = swiperEl.querySelector('.swiper-button-next');
        var prevEl = swiperEl.querySelector('.swiper-button-prev');
        var pagEl  = swiperEl.querySelector('.swiper-pagination');
        if (nextEl && prevEl) opts.navigation = { nextEl: nextEl, prevEl: prevEl };
        if (pagEl)            opts.pagination = { el: pagEl, clickable: true };
      }

      new Swiper(swiperEl, opts);
    });
  });
})();
</script>


<% } %>
