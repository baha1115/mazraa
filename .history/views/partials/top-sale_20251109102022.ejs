<%
  const list = Array.isArray(items) ? items : [];

  // Ù…Ø¹Ø±Ù‘Ù ÙØ±ÙŠØ¯ Ù„Ù…Ù†Ø¹ ØªØ¶Ø§Ø±Ø¨ Ø§Ù„Ø³ÙˆÙŠØ¨Ø±Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
  const uid = 'top-sale-' + Math.random().toString(36).slice(2,9);


function tweakCloudinary(url){
  try{
    var u = new URL(url);
    if (u.hostname.includes('res.cloudinary.com') && u.pathname.includes('/upload/')){
      // ØµÙˆØ± Ø§Ù„ÙƒØ±ÙˆØª: Ø¹Ø±Ø¶ 800 ÙˆØªÙ„Ù‚Ø§Ø¦ÙŠ WebP/AVIF
      u.pathname = u.pathname.replace('/upload/','/upload/f_auto,q_auto,w_800/');
      return u.toString();
    }
  }catch(_){}
  return url;
}

function assetPath(u){
  u = (u || '').toString().trim();
  if (!u) return '/public/assets/farm-default.jpg';

  // Ø§Ù…Ù†Ø¹ Ø­Ù‚Ù† data: Ù„Ø£Ù†Ù‡Ø§ ØªØ«Ù‚Ù‘Ù„ Ø§Ù„ØµÙØ­Ø©
  if (/^data:/i.test(u)) return '/public/assets/farm-default.jpg';

  // https (Cloudinary Ø£Ùˆ ØºÙŠØ±Ù‡): Ù…Ø±Ù‘Ø± Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Cloudinary
  if (/^https?:\/\//i.test(u)) return tweakCloudinary(u);

  // ØªØ·Ø¨ÙŠØ¹ Ù…Ø³Ø§Ø±Ø§Øª Ù‚Ø¯ÙŠÙ…Ø© Ù…Ø­Ù„ÙŠÙ‘Ø©
  u = u.replace(/\\/g,'/')
       .replace(/^\/?Public\//,'/public/')
       .replace(/\/assests\//gi,'/assets/');
  if (u.startsWith('/uploads/') || u.startsWith('/public/')) return u;
  if (u.startsWith('/assets/')) return '/public' + u;
  if (u.startsWith('/')) return '/public' + u;
  return '/uploads/' + u;
}
%>



<section id="<%= uid %>" class="section">
  <div class="container">
    <h3 style="text-align: center;margin-bottom:1rem">Ø£ÙƒØ«Ø± Ù…Ø²Ø§Ø±Ø¹ Ø§Ù„Ø¨ÙŠØ¹ Ù…Ø´Ø§Ù‡Ø¯Ø©</h3>

    <% if (!list.length) { %>
      <p class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±.</p>
    <% } else { %>
      <div class="swiper top-sale-swiper" dir="rtl">
        <div class="swiper-wrapper">
          <% list.forEach(f => {
               const cover = assetPath((Array.isArray(f.photos) && f.photos[0]) ? f.photos[0] : '/assets/farm-default.jpg');
               const loc   = f.city ? ((f.area || '') + ' â€” ' + f.city) : (f.area || 'â€”');
               const price = Number(f.price || 0);
               const views = Number(f.views || 0);
          %>
            <div class="swiper-slide">
              <article class="farm-card">
                <a class="farm-link" href="/farm/<%= f._id %>">
                  <figure class="farm-media" style="position:relative">
                    <img
                      src="<%= cover %>"
                      alt="<%= f.title || 'Ù…Ø²Ø±Ø¹Ø©' %>"
                      loading="lazy"
                      onerror="this.onerror=null;this.src='/public/assets/farm-default.jpg'">
                  </figure>
                  <div class="farm-body">
                    <h4 class="farm-title"><%= f.title || 'â€”' %></h4>
                    <p class="farm-location"><%= loc %></p>
                    <p class="farm-price">
  <%= price ? ((f.currency === 'SYP' ? 'Ù„.Ø³' : '$') + price.toLocaleString('en')) : 'â€”' %>
</p>

                    <div class="card-meta">ğŸ‘ï¸ <%= views.toLocaleString('en') %></div>
                    <!-- Ø²Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ø±Ø§Ø¨Ø· (span Ø­ØªÙ‰ Ù„Ø§ Ù†Ø¶Ø¹ Ø±Ø§Ø¨Ø·Ø§Ù‹ Ø¯Ø§Ø®Ù„ Ø±Ø§Ø¨Ø·) -->
                    <span class="btn btn-outline" role="button" tabindex="0">Ø§Ù„ØªÙØ§ØµÙŠÙ„</span>
                  </div>
                </a>
              </article>
            </div>
          <% }) %>
        </div>

        <div class="swiper-button-prev" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚"></div>
        <div class="swiper-button-next" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ"></div>
        <div class="swiper-pagination"></div>
      </div>
    <% } %>
  </div>
</section>

<script type="module">
  import Swiper from 'https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.mjs';

 (function(){
  var root = document.getElementById('<%= uid %>');
  if (!root) return;
  var container = root.querySelector('.top-sale-swiper');
  if (!container || container.__inited) return;

  function init(){
    container.__inited = true;
    // Ù„Ùˆ Ù…ÙƒØªØ¨Ø© Swiper ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© (ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„)ØŒ Ù†ÙØ¹Ù„ â€œfallbackâ€ Ø£ÙÙ‚ÙŠ Ø¨Ø³ÙŠØ· Ø¨Ø¯Ù„ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ
    if (typeof Swiper === 'undefined') {
      var wrap = container.querySelector('.swiper-wrapper');
      if (wrap){ wrap.style.display='flex'; wrap.style.gap='12px'; wrap.style.overflowX='auto'; wrap.style.scrollSnapType='x mandatory'; }
      container.querySelectorAll('.swiper-slide').forEach(function(s){ s.style.minWidth='260px'; s.style.scrollSnapAlign='start'; });
      return;
    }
    // ØªÙ‡ÙŠØ¦Ø© Swiper (RTL)
    new Swiper(container, {
      direction: 'horizontal',
      slidesPerView: 1.05,
      spaceBetween: 12,
      watchOverflow: true,
      rtl: true,
      pagination: { el: container.querySelector('.swiper-pagination'), clickable: true },
      navigation: {
        nextEl: container.querySelector('.swiper-button-next'),
        prevEl: container.querySelector('.swiper-button-prev')
      },
      breakpoints: {
        480:  { slidesPerView: 1.3, spaceBetween: 14 },
        640:  { slidesPerView: 2.1, spaceBetween: 16 },
        1024: { slidesPerView: 3.2, spaceBetween: 18 },
        1280: { slidesPerView: 4.2, spaceBetween: 20 }
      }
    });
  }

  // Ø¥Ù† ÙƒØ§Ù†Øª Ù…ÙƒØªØ¨Ø© Swiper ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„Ø© Ø¹Ø§Ù„Ù…ÙŠÙ‹Ø§ØŒ Ø­Ù…Ù‘Ù„Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ Ø«Ù… ÙØ¹Ù‘Ù„
  if (typeof Swiper === 'undefined') {
    var s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js';
    s.onload = init;
    document.head.appendChild(s);
  } else {
    init();
  }
})();
</script>

<style>
  #<%= uid %> .swiper-slide { height: auto; }
  #<%= uid %> .farm-card { display:block; border:1px solid #e2e8f0; border-radius:14px; overflow:hidden; background:#fff }
  #<%= uid %> .farm-card img { width:100%; height:220px; object-fit:cover }
  #<%= uid %> .farm-body { padding:.8rem }
  #<%= uid %> .farm-title { margin:.2rem 0 .4rem; font-size:1.05rem }
  #<%= uid %> .farm-location, #<%= uid %> .farm-price { margin:0 0 .25rem; color:#475569 }
  /* Ø²Ø± Ø¨Ø³ÙŠØ· Ù…Ø«Ù„ ØµÙØ­Ø§ØªÙƒ Ø§Ù„Ø£Ø®Ø±Ù‰ */
  #<%= uid %> .btn.btn-outline{display:inline-block;border:1px solid #0f172a;border-radius:10px;padding:.35rem .7rem;text-decoration:none;color:#0f172a;margin-top:.35rem}
</style>
