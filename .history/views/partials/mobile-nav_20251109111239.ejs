<!-- partials/mobile-nav.ejs -->
<%
  const active = (typeof activeTab!=='undefined' ? String(activeTab) : '');
  const isActive = (k)=> active===k ? 'is-active' : '';
%>

<style>
/* ===== NVX Mobile Bottom Bar (RTL) ===== */
@media (max-width:1023.98px){
  .nvx-mbar{
    position:fixed; inset-inline:0; bottom:0; z-index:9999;
    padding:.5rem .6rem calc(.6rem + env(safe-area-inset-bottom));
    background:linear-gradient(180deg, rgba(255,255,255,.30), rgba(255,255,255,.85));
    backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px);
    border-top:1px solid rgba(15,23,42,.08);
    box-shadow:0 -10px 28px rgba(2,6,23,.12);
    animation:nvxMbarPop .45s ease .05s both;
  }
  .nvx-mbar__wrap{
    max-width:760px; margin:0 auto;
    display:grid; grid-template-columns:1fr auto 1fr; gap:.6rem; align-items:end;
  }
  .nvx-mbar__group{ display:grid; grid-template-columns:repeat(2,1fr); gap:.4rem; }

  .nvx-mbar__btn{
    position:relative; height:56px; border-radius:14px;
    background:#fff; border:1px solid #e5e7eb; color:#0b1a13;
    display:grid; place-items:center; text-decoration:none; isolation:isolate; overflow:hidden;
    transition:transform .22s ease, border-color .22s ease, box-shadow .22s ease, background .22s ease;
  }
  .nvx-mbar__btn svg{ width:22px; height:22px; }
  .nvx-mbar__btn span{ position:absolute; bottom:7px; font-size:.72rem; font-weight:800; color:#1f2937; opacity:.85; }
  .nvx-mbar__btn:active{ transform:scale(.98); }
  .nvx-mbar__btn::after{
    content:""; position:absolute; inset:0;
    background:radial-gradient(120px 120px at var(--rx,50%) var(--ry,50%), rgba(34,197,94,.18), transparent 40%);
    opacity:0; transition:opacity .3s ease;
  }
  .nvx-mbar__btn:hover::after{ opacity:1; }

  /* الحالة النشطة (مطابقة للهوية) */
  .nvx-mbar__btn.is-active{
    border-color:#16a34a;
    box-shadow:0 10px 26px rgba(34,197,94,.20);
  }
  .nvx-mbar__btn.is-active span{ color:#065f46; }

  /* FAB */
  .nvx-fab{
    width:68px; height:68px; border-radius:18px; border:none; cursor:pointer;
    background:radial-gradient(140px 120px at 50% 28%, #22c55e, #16a34a); color:#0b1a13;
    box-shadow:0 16px 38px rgba(34,197,94,.35); display:grid; place-items:center;
    transform:translateY(-18%); transition:transform .22s ease, box-shadow .22s ease, border-radius .22s ease;
    outline:none;
  }
  .nvx-fab:active{ transform:translateY(-18%) scale(.98); }
  .nvx-fab__icon{ width:28px; height:28px; color:#fff; transition:transform .32s cubic-bezier(.2,.8,.2,1); }
  .nvx-fab.is-open{ border-radius:50%; box-shadow:0 20px 48px rgba(34,197,94,.45); }
  .nvx-fab.is-open .nvx-fab__icon{ transform:rotate(45deg) scale(1.06); }

  /* منيو شعاعية */
  .nvx-fabmenu{ position:absolute; inset:0; pointer-events:none; }
  .nvx-fabmenu__btn{
    position:absolute; left:50%; top:50%;
    width:48px; height:48px; border-radius:12px; border:1px solid #e5e7eb; background:#fff; color:#0b1a13;
    display:grid; place-items:center; box-shadow:0 12px 28px rgba(2,6,23,.18);
    transform:translate(-50%,-50%) scale(.6); opacity:0; transition:transform .34s cubic-bezier(.2,.8,.2,1), opacity .22s ease;
  }
  .nvx-fabmenu__btn svg{ width:22px; height:22px; }
  .nvx-fab.is-open ~ .nvx-fabmenu .nvx-fabmenu__btn{ pointer-events:auto; opacity:1; }
  .nvx-fab.is-open ~ .nvx-fabmenu .nvx-fabmenu__btn:nth-child(1){ transform:translate(-50%, calc(-50% - 84px)) scale(1); } /* أعلى */
  .nvx-fab.is-open ~ .nvx-fabmenu .nvx-fabmenu__btn:nth-child(2){ transform:translate(calc(-50% - 82px), -50%) scale(1); } /* يسار */
  .nvx-fab.is-open ~ .nvx-fabmenu .nvx-fabmenu__btn:nth-child(3){ transform:translate(calc(-50% + 82px), -50%) scale(1); } /* يمين */

  /* مساحة سفلية للهواتف */
  body{ padding-bottom:calc(90px + env(safe-area-inset-bottom)); }
}
@keyframes nvxMbarPop{ from{ transform:translateY(40px); opacity:0 } to{ transform:translateY(0); opacity:1 } }
</style>

<nav class="nvx-mbar" role="navigation" aria-label="شريط تنقّل سفلي">
  <div class="nvx-mbar__wrap" dir="rtl">
    <!-- يمين -->
    <div class="nvx-mbar__group">
      <a class="nvx-mbar__btn <%= isActive('home') %>" href="/">
        <svg viewBox="0 0 24 24" fill="none"><path d="M3 12l9-8 9 8" stroke="currentColor" stroke-width="1.4"/><path d="M5 10v10h14V10" stroke="currentColor" stroke-width="1.4"/></svg>
        <span>الرئيسية</span>
      </a>
      <a class="nvx-mbar__btn <%= isActive('featured') %>" href="/vip">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 2l3 6.2L22 9l-5 4.8L18 22l-6-3.3L6 22l1-8.2L2 9l7-.8L12 2z" stroke="currentColor" stroke-width="1.2"/></svg>
        <span>المميّزة</span>
      </a>
    </div>

    <!-- زر مركزي -->
    <button class="nvx-fab" id="nvxFab" aria-label="إجراءات سريعة" aria-expanded="false">
      <svg class="nvx-fab__icon" viewBox="0 0 24 24" fill="none">
        <path d="M12 5v14M5 12h14" stroke="#fff" stroke-width="2.2" stroke-linecap="round"/>
      </svg>
    </button>
    <div class="nvx-fabmenu" aria-hidden="true">
      <button class="nvx-fabmenu__btn" title="إضافة مزرعة" onclick="location.href='/owner/farms/new'">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
      <button class="nvx-fabmenu__btn" title="بحث" onclick="location.href='/search'">
        <svg viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="1.6"/><path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
      </button>
      <button class="nvx-fabmenu__btn" title="واتساب" onclick="window.open('https://wa.me/<%= ((user?.phone)||'').replace(/\\D/g,'') || '000' %>','_blank')">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 2a10 10 0 00-8.7 15l-1 4 4-1A10 10 0 1012 2z" stroke="currentColor" stroke-width="1.4"/><path d="M16 14.5c-.3.8-1.7 1.2-2.4 1.2-1.8 0-4.8-2.2-4.8-4.2 0-.6.4-1.8 1.2-2.1.2-.1.5-.1.6 0l1.2 1.5c.1.1.1.3 0 .5-.1.2-.5.6-.5.7 0 .6 1.4 1.9 2 1.9.2 0 .6-.3.8-.4.2-.1.4-.1.5 0l1.4.9z" fill="currentColor"/></svg>
      </button>
    </div>

    <!-- يسار -->
    <div class="nvx-mbar__group">
      <a class="nvx-mbar__btn <%= isActive('alerts') %>" href="/notifications">
        <svg viewBox="0 0 24 24" fill="none"><path d="M6 9a6 6 0 1112 0v4l1.5 3H4.5L6 13V9" stroke="currentColor" stroke-width="1.3"/><path d="M10 19a2 2 0 004 0" stroke="currentColor" stroke-width="1.3"/></svg>
        <span>الإشعارات</span>
      </a>
      <a class="nvx-mbar__btn <%= isActive('account') %>" href="<%= (typeof isAuth!=='undefined' && isAuth) ? '/profile' : '/login' %>">
        <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="1.4"/><path d="M4 20c2.2-3 5-4.5 8-4.5s5.8 1.5 8 4.5" stroke="currentColor" stroke-width="1.4"/></svg>
        <span>حسابي</span>
      </a>
    </div>
  </div>
</nav>

<script>
(function(){
  // ripple coords
  const bar = document.querySelector('.nvx-mbar');
  bar?.addEventListener('pointermove', (e)=>{
    const b = e.target.closest('.nvx-mbar__btn'); if(!b) return;
    const r = b.getBoundingClientRect();
    b.style.setProperty('--rx', (e.clientX - r.left) + 'px');
    b.style.setProperty('--ry', (e.clientY - r.top) + 'px');
  });

  // FAB toggle + close on outside
  const fab = document.getElementById('nvxFab');
  if (fab){
    const set = (open)=>{ fab.classList.toggle('is-open', open); fab.setAttribute('aria-expanded', open?'true':'false'); };
    fab.addEventListener('click', ()=> set(!fab.classList.contains('is-open')));
    document.addEventListener('click', (e)=>{
      if (!fab.contains(e.target) && !e.target.closest('.nvx-fabmenu')) set(false);
    }, true);
  }
})();
</script>
