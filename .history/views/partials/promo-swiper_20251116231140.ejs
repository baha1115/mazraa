<%
// نتوقع متغير bannersDoc مرسَل من الراوتر
const _doc   = (typeof bannersDoc !== 'undefined' && bannersDoc) ? bannersDoc : null;
const _on    = !!(_doc && _doc.enabled);
const _items = Array.isArray(_doc?.items) ? _doc.items.filter(Boolean) : [];
// ID فريد لكل سويبر (مهم لو عندك أكثر من واحد)
const _pid   = (_doc?.key || 'banners').replace(/[^a-z0-9_-]/ig,'-');
%>

<% if (_on && _items.length) { %>
  <!-- Swiper CSS (مرة واحدة يفضَّل وضعه في layout الرئيسي) -->
  <link rel="stylesheet" href="https://unpkg.com/swiper@9/swiper-bundle.min.css"/>

  <section id="promoTop-<%= _pid %>" class="promoTop" dir="rtl" style="position:relative;margin:.4rem 0 .8rem">
    <div class="swiper">
      <div class="swiper-wrapper">
        <% _items.forEach(it => { %>
          <div class="swiper-slide">
            <a href="<%= it.link || '#' %>" style="display:block;border-radius:14px;overflow:hidden">
              <img src="<%= it.img %>" alt="" style="width:100%;height:160px;object-fit:cover">
            </a>
            <% if (it.title || it.text) { %>
              <div style="position:absolute;inset:auto 0 8px 0;display:flex;justify-content:center">
                <div style="background:rgba(0,0,0,.35);color:#fff;padding:.35rem .6rem;border-radius:10px;font-weight:800;backdrop-filter:blur(4px)">
                  <%= it.title || '' %>
                </div>
              </div>
            <% } %>
          </div>
        <% }) %>
      </div>

      <!-- الأسهم -->
      <div class="swiper-button-prev"></div>
      <div class="swiper-button-next"></div>

      <!-- نقاط -->
      <div class="swiper-pagination"></div>
    </div>
  </section>

  <!-- Swiper JS (مرة واحدة يفضَّل وضعه في نهاية layout) -->
  <script src="https://unpkg.com/swiper@9/swiper-bundle.min.js"></script>
  <script>
    (function(){
      const root = document.getElementById('promoTop-<%= _pid %>');
      if (!root) return;
      // لو ما في إلا سلايد واحدة: لا داعي للنافيجيشن/اللّوب
      const slidesCount = root.querySelectorAll('.swiper-slide').length;
      const hasMany = slidesCount > 1;

      new Swiper(root.querySelector('.swiper'), {
        loop: hasMany,
        rtl: true,
        slidesPerView: 1,
        speed: 500,
        spaceBetween: 8,
        autoplay: hasMany ? { delay: 3500, disableOnInteraction: false } : false,
        navigation: hasMany ? {
          nextEl: root.querySelector('.swiper-button-next'),
          prevEl: root.querySelector('.swiper-button-prev')
        } : {},
        pagination: hasMany ? {
          el: root.querySelector('.swiper-pagination'),
          clickable: true
        } : {},
      });
    })();
  </script>

  <style>
    /* لا تجعل أي CSS عام يغيّر display لـ .swiper-wrapper */
    #promoTop-<%= _pid %> .swiper { width: 100%; }
    #promoTop-<%= _pid %> .swiper-button-prev,
    #promoTop-<%= _pid %> .swiper-button-next { color:#fff; text-shadow:0 2px 8px rgba(0,0,0,.3); }
    @media (max-width:640px){
      #promoTop-<%= _pid %> img { height: 140px; }
    }
  </style>
<% } %>
