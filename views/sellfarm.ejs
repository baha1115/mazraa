<!-- File: rent.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Farmers — Farms for Rent</title>
  <meta name="description" content="Browse verified farms for rent. Filter by area, city, price and size. Premium & VIP featured listings." />
  <link rel="stylesheet" href="../Public/styles/rentandfarmdetail.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
  <style>
  .pager{display:flex;gap:.4rem;flex-wrap:wrap;justify-content:center;margin-top:1rem}
  .pager button{min-width:38px;height:38px;border:1px solid #e5e7eb;background:#fff;border-radius:10px;cursor:pointer}
  .pager button.is-active{background:#111827;color:#fff;border-color:#111827}
  .pager button[disabled]{opacity:.5;cursor:not-allowed}
  .vip-sale-section .badge-tier {background:#111827;color:#fff;padding:.15rem .45rem;border-radius:999px;font-size:.85rem}
  .vip-slide-card {position:relative;overflow:hidden;border-radius:12px;border:1px solid #e5e7eb}
  .vip-slide-card img {width:100%;height:260px;object-fit:cover;display:block}
  .vip-slide-body {padding:.6rem .7rem;background:#fff}
  .vip-slide-title {margin:.1rem 0 .3rem;font-weight:700}
  .vip-slide-meta {color:#6b7280;font-size:.95rem}
  .farm-card .badge-tier {background:#111827;color:#fff;padding:.1rem .4rem;border-radius:999px;font-size:.8rem}
  /* === VIP Hero Slider === */
  .vip-hero-swiper { overflow: hidden; }

  .vip-hero-slide {
  position: relative;
  height: 46vh;                 /* موبايل */
  min-height: 320px;
  border-radius: 16px;
  overflow: hidden;
  border: 1px solid #e5e7eb;
  }

/* الصورة كخلفية */
  .vip-hero-bg {
  position: absolute; inset: 0;
  background-size: cover; background-position: center;
  transform: scale(1.02); /* لمسة بسيطة */
  }

/* تدرّج غامق للقراءة */
  .vip-hero-overlay {
  position: absolute; inset: 0;
  background: linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,.1));
  }

/* صندوق النص السفلي */
.vip-hero-body {
  position: absolute; inset-inline: 1.2rem; inset-block-end: 1.1rem;
  color: #fff;
  display: grid; gap: .35rem;
  text-align: start; /* RTL مدعوم */
}

.vip-hero-title {
  margin: 0;
  font-weight: 800;
  line-height: 1.15;
  font-size: 1.35rem;
  text-shadow: 0 2px 12px rgba(0,0,0,.35);
}

.vip-hero-meta {
  opacity: .95;
  font-size: .98rem;
}
.card-meta {display:flex; gap:.6rem; align-items:center; margin-top:.25rem; font-size:.9rem; color:#6b7280;}
.card-meta .meta-views{display:inline-flex; align-items:center; gap:.25rem; white-space:nowrap}
.card-meta .dot{opacity:.35}
.vip-hero-meta .meta-views{margin-inline-start:.5rem; opacity:.95}

/* بادج صغيرة لتمييز VIP إن رغبت */
.vip-hero-badge {
  display:inline-block;
  background: rgba(17,24,39,.85);
  backdrop-filter: blur(2px);
  color:#fff; padding:.2rem .6rem; border-radius:999px;
  font-size:.85rem; font-weight:700;
  width: fit-content;
}
.vip-hero-cta {
  display:inline-block;
  margin-top:.55rem;
  padding:.5rem .9rem;
  border:1px solid rgba(255,255,255,.85);
  background: rgba(17,24,39,.35);
  backdrop-filter: blur(2px);
  width: 150px;
  text-align: center;
  color:#fff;
  text-decoration:none;
  border-radius:10px;
  font-weight:700;
  font-size:.95rem;
  transition: transform .15s ease, background .15s ease;
}
.vip-hero-cta:hover { transform: translateY(-1px); background: rgba(17,24,39,.55); }
.filters-toggle{
  width:100%;
  display:flex; align-items:center; gap:.6rem;
  justify-content:space-between;
  background:#fff; border:1px solid #e5e7eb; border-radius:12px;
  padding:.7rem 1rem; cursor:pointer;
}
.filters-toggle__title{ font-weight:800; }
.filters-toggle__hint{ color:#6b7280; font-size:.9rem; }
.filters-toggle__chev{ transition:transform .2s ease; }
.filters-toggle[aria-expanded="true"] .filters-toggle__chev{ transform:rotate(180deg); }

/* جسم الفلاتر */
.filters-body{
  margin-top:.75rem;
  border:1px solid #e5e7eb; border-radius:12px; padding:1rem;
  background:#fafafa;
}

@media (min-width: 768px){
  .vip-hero-slide { height: 58vh; min-height: 420px; }
  .vip-hero-title { font-size: 1.85rem; }
  .vip-hero-meta  { font-size: 1.05rem; }
}

@media (min-width: 1200px){
  .vip-hero-slide { height: 66vh; min-height: 520px; }
  .vip-hero-title { font-size: 2.25rem; }
  .vip-hero-meta  { font-size: 1.15rem; }
}

</style>

</head>
<body>
  <!-- Header -->
 <%- include('partials/navbar') %>
 

  <!-- Floating WhatsApp Button -->
  <a
    class="fab-whatsapp"
    href="https://wa.me/21600000000?text=Hello%20Farmers%2C%20I%27m%20interested%20in%20renting%20a%20farm"
    target="_blank"
    rel="noopener"
    aria-label="Chat on WhatsApp"
  >
    <span class="fab-whatsapp__icon" aria-hidden="true">واتساب</span>
  </a>

  <!-- 1) Top Banner — Featured Farms Carousel (HTML only; interactive behavior can be added later) -->
  <section id="featured" class="section featured" aria-labelledby="featured-title">
    <h1 id="featured-title" class="visually-hidden">مزارع مميزة للإيجار</h1>

    <!-- Swiper Carousel -->
<!-- 1) Gallery of Previous Work -->
<!-- Featured VIP for Sale -->
<section id="vip-sale" class="vip-sale-section" aria-labelledby="vip-sale-title" hidden>
  <div class="container">
    <header class="section-header">
      <h2 id="vip-sale-title">مزارع للبيع — VIP</h2>
      <p class="muted">عروض كبار الشخصيات تظهر هنا أولًا.</p>
    </header>

    <div class="swiper vip-swiper" dir="rtl">
      <div class="swiper-wrapper" id="vipSwiperWrapper"><!-- slides injected by JS --></div>

      <div class="swiper-button-prev" aria-label="السابق"></div>
      <div class="swiper-button-next" aria-label="التالي"></div>
      <div class="swiper-pagination"></div>
    </div>
  </div>
</section>

  <!-- 2) Filters -->
 <section id="filters" class="section filters" aria-labelledby="filters-title">
  <div class="container">

    <!-- رأس قابل للطي -->
    <button id="filtersToggle"
            class="filters-toggle"
            type="button"
            aria-expanded="false"
            aria-controls="filtersBody">
      <span class="filters-toggle__title" id="filters-title">تصفية النتائج</span>
      <span class="filters-toggle__hint">(اختياري)</span>
      <svg class="filters-toggle__chev" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
        <path d="M6 9l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2"/>
      </svg>
    </button>

    <!-- جسم الفلاتر (مغلق افتراضياً) -->
    <div id="filtersBody" class="filters-body" hidden>
      <form id="rent-filters" class="filters-form" action="#results" method="get" novalidate>
        <div class="filters-grid">
          <!-- المنطقة -->
          <div class="field">
            <label class="label" for="area">المنطقة</label>
            <select id="area" name="area">
              <option value="">جميع المناطق</option>
              <option value="Damascus Countryside">ريف دمشق</option>
              <option value="Hama">حماة</option>
              <option value="Homs">حمص</option>
              <option value="Daraa">درعا</option>
            </select>
          </div>

          <!-- المدينة كإدخال نصي بدلاً من قائمة -->
          <div class="field">
            <label class="label" for="city">المدينة</label>
            <input id="city" style="height: 2.6rem;    width: 100%;
    padding: .75rem .9rem;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
" name="city" type="text" placeholder="مثال: قدسيا / Douma / …" />
          </div>

          <!-- السعر -->
          <div class="field">
            <label class="label" for="price-min">السعر (من)</label>
            <input id="price-min" name="price_min" type="number" placeholder="مثال: 500" />
          </div>
          <div class="field">
            <label class="label" for="price-max">السعر (إلى)</label>
            <input id="price-max" name="price_max" type="number" placeholder="مثال: 2500" />
          </div>

          <!-- المساحة -->
          <div class="field">
            <label class="label" for="size-min">المساحة (من م²)</label>
            <input id="size-min" name="size_min" type="number" placeholder="مثال: 5000" />
          </div>
          <div class="field">
            <label class="label" for="size-max">المساحة (إلى م²)</label>
            <input id="size-max" name="size_max" type="number" placeholder="مثال: 25000" />
          </div>

        

          <!-- زر -->
          <div class="field field--actions">
            <button class="btn btn-primary" type="submit">ابحث</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</section>

  <!-- 3) Farm Cards Grid -->
  <section id="results" class="section results" aria-labelledby="results-title">
  <div class="container">
    <header class="section-header">
      <h2 id="results-title">مزارع للبيع</h2>
      <p class="muted">اضغط على البطاقة لفتح صفحة المزرعة الكاملة.</p>
    </header>

    <div class="cards-grid" id="saleGrid" role="list"><!-- يملؤها السكربت --></div>
    <nav id="pager" class="pager" aria-label="التصفح بالصفحات" hidden></nav>
  </div>
</section>


  <!-- 5) Promotional Banner -->
  
<%- include('partials/promo', { promoContractors }) %>
  <!--

   ========================
       الفوتر
   ======================== -->
<footer class="farm-footer" dir="rtl" aria-labelledby="footer-title">
  <h2 id="footer-title" class="sr-only">تذييل الموقع</h2>

  <div class="footer-top">
    <!-- الشعار والوصف المختصر -->
    <div class="footer-brand">
      <div class="logo-mark" aria-hidden="true">🌿</div>
      <div>
        <strong class="brand-name">مزرعتي</strong>
        <p class="brand-desc">
          منصّة لعرض وطلب المزارع (بيع/إيجار) وربط المزارعين بالمقاولين والخبراء.
        </p>
      </div>
    </div>

    <!-- روابط سريعة -->
    <nav class="footer-links" aria-label="روابط سريعة">
      <div>
        <h3 class="footer-title">تصفح</h3>
        <ul>
          <li><a href="/sale">مزارع للبيع</a></li>
          <li><a href="/rent">مزارع للإيجار</a></li>
          <li><a href="/contractors">المقاولون</a></li>
          <li><a href="/plans">الاشتراكات</a></li>
        </ul>
      </div>
      <div>
        <h3 class="footer-title">الدعم</h3>
        <ul>
          <li><a href="/about">من نحن</a></li>
          <li><a href="/about">الأسئلة الشائعة</a></li>
          <li><a href="/about">سياسة الخصوصية</a></li>
          <li><a href="/about">الشروط والأحكام</a></li>
        </ul>
      </div>
      <div>
        <h3 class="footer-title">تواصل</h3>
        <ul class="contact">
          <li><a href="mailto:info@farmers.example">info@farmers</a></li>
          <li><a href="tel:+963900000000">+963 900 000</a></li>
          <li><a href="https://wa.me/963900000000" target="_blank" rel="noopener">واتساب مباشر</a></li>
        </ul>
      </div>
    </nav>
  </div>

  <div class="footer-bottom">
    <div class="social" aria-label="شبكات اجتماعية">
      <a class="s-link" href="#" aria-label="تويتر" title="تويتر" rel="noopener">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path fill="currentColor" d="M22 5.8c-.7.3-1.5.6-2.3.7.8-.5 1.4-1.3 1.7-2.2-.8.5-1.7.9-2.6 1.1A3.9 3.9 0 0 0 12 8.6c0 .3 0 .5.1.8A11 11 0 0 1 3 5.4a3.9 3.9 0 0 0 1.2 5.2c-.6 0-1.2-.2-1.7-.5v.1c0 1.9 1.3 3.6 3.2 4-.3.1-.7.2-1 .2-.2 0-.5 0-.7-.1.5 1.6 2 2.8 3.8 2.8A7.8 7.8 0 0 1 2 19.5c1.7 1.1 3.8 1.8 6 1.8 7.2 0 11.2-6 11.2-11.2v-.5c.8-.6 1.4-1.3 1.8-2.1z"/></svg>
      </a>
      <a class="s-link" href="#" aria-label="فيسبوك" title="فيسبوك" rel="noopener">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path fill="currentColor" d="M13 22v-8h3l1-4h-4V7c0-1.2.3-2 2-2h2V1h-3c-3 0-5 2-5 5v4H6v4h3v8h4z"/></svg>
      </a>
      <a class="s-link" href="#" aria-label="يوتيوب" title="يوتيوب" rel="noopener">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path fill="currentColor" d="M23.5 6.2a3 3 0 0 0-2.1-2.1C19.2 3.5 12 3.5 12 3.5s-7.2 0-9.4.6A3 3 0 0 0 .5 6.2 31 31 0 0 0 0 12a31 31 0 0 0 .5 5.8 3 3 0 0 0 2.1 2.1c2.2.6 9.4.6 9.4.6s7.2 0 9.4-.6a3 3 0 0 0 2.1-2.1A31 31 0 0 0 24 12a31 31 0 0 0-.5-5.8zM9.8 15.5V8.6l6.2 3.5-6.2 3.4z"/></svg>
      </a>
    </div>

    <p class="copyright">
      © <span id="year-placeholder">2025</span> فارمرز — جميع الحقوق محفوظة.
    </p>

    <div class="mini-links">
      <a href="/about">الخصوصية</a>
      <span class="dot" aria-hidden="true">•</span>
      <a href="/about">الشروط</a>
    </div>
  </div>
</footer>


<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script src="../Public/rent.js"></script>
<script type="module">
  import Swiper from 'https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.mjs';

  // عناصر
  const vipSection = document.getElementById('vip-sale');
  const vipWrapper = document.getElementById('vipSwiperWrapper');
  const saleGrid   = document.getElementById('saleGrid');
  const pager      = document.getElementById('pager');
  const form       = document.querySelector('#saleFilters, #rent-filters, form[data-role="sale-filters"]');

  // أدوات
  const fmt = n => new Intl.NumberFormat('en').format(Number(n)||0);
  const esc = s => (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const toNum = (v, fb) => { const n = parseFloat(v); return Number.isFinite(n) ? n : fb; };

  async function fetchJSON(url){
    const r = await fetch(url, { headers:{'Accept':'application/json'} });
    const j = await r.json().catch(()=>({ok:false}));
    if (!r.ok || !j.ok) throw new Error(j.msg || 'fetch error');
    return j.data || [];
  }

  // بطاقات
 function tierBadge(t){
  if (t === 'VIP')     return '<span class="badge badge--tier">كبار الشخصيات (VIP)</span>';
  if (t === 'Premium') return '<span class="badge badge--tier">مميز</span>';
  return '';
}

function gridCard(f){
  const cover = (Array.isArray(f.photos) && f.photos[0]) ? f.photos[0] : '/assets/farm-default.jpg';
  const loc   = f.city ? `${esc(f.area||'')} — ${esc(f.city)}` : esc(f.area||'—');
  const video = f.videoUrl ? '<span class="badge badge--video">🎥 فيديو</span>' : '';
  const tier  = tierBadge(f.ownerTier || f.subscriptionTier || '');
  const vws   = Number(f.views ?? 0);

  return `
    <article class="farm-card" role="listitem" data-id="${esc(f._id)}">
      <a class="farm-link" href="/farm/${esc(f._id)}" aria-label="${esc(f.title||'مزرعة')}">
        <figure class="farm-media">
          <img src="${esc(cover)}" alt="${esc(f.title||'مزرعة')}" loading="lazy" />
          ${tier}${video}
        </figure>
        <div class="farm-body">
          <h3 class="farm-title">${esc(f.title||'—')}</h3>
          <p class="farm-location">${loc}</p>
          <p class="farm-price">$${fmt(f.price)}</p>
          <div class="card-meta" style="display:flex;align-items:center;gap:.4rem">
            <span class="meta-views">👁️ ${fmt(vws)}</span>
            <span class="dot">•</span>
            <span class="farm-status is-available" style="margin:0">متاحة</span>
          </div>
          <button class="btn btn-outline" type="button">التفاصيل</button>
        </div>
      </a>
    </article>`;
}

function vipSlide(f){
  const cover = (Array.isArray(f.photos) && f.photos[0]) ? f.photos[0] : '/assets/farm-default.jpg';
  const loc   = f.city ? `${esc(f.area||'')} — ${esc(f.city)}` : esc(f.area||'—');
  const vws   = Number(f.views || 0);

  return `
    <div class="swiper-slide">
      <article class="vip-hero-slide">
        <div class="vip-hero-bg" style="background-image:url('${cover}')"></div>
        <div class="vip-hero-overlay"></div>
        <div class="vip-hero-body">
          <span class="vip-hero-badge">VIP</span>
          <h3 class="vip-hero-title">${esc(f.title||'—')}</h3>
          <div class="vip-hero-meta">
            ${loc}<br> • ${fmt(f.size)} م² <br>• $${fmt(f.price)}
            <span class="meta-views">• 👁️ ${fmt(vws)}</span>
          </div>
          <a class="vip-hero-cta" href="/farm/${f._id}">التفاصيل</a>
        </div>
      </article>
    </div>`;
}

  // بيانات + ترقيم
  let allFarms = [];
  let filtered = [];
  let page     = 1;
  const pageSize = 6;

  function buildPager(total, current){
    const pages = Math.max(1, Math.ceil(total / pageSize));
    if (pages <= 1){ pager.hidden = true; pager.innerHTML=''; return; }
    pager.hidden = false;

    let html = '';
    html += `<button type="button" data-go="${current-1}" ${current<=1?'disabled':''}>‹</button>`;
    for (let i=1;i<=pages;i++){
      html += `<button type="button" data-go="${i}" class="${i===current?'is-active':''}">${i}</button>`;
    }
    html += `<button type="button" data-go="${current+1}" ${current>=pages?'disabled':''}>›</button>`;
    pager.innerHTML = html;

    pager.onclick = (e)=>{
      const btn = e.target.closest('button[data-go]');
      if (!btn) return;
      const go = parseInt(btn.dataset.go,10);
      if (!Number.isFinite(go)) return;
      setPage(go);
    };
  }

  function renderPage(){
    const total = filtered.length;
    const pages = Math.max(1, Math.ceil(total / pageSize));
    if (page > pages) page = pages;
    const start = (page-1) * pageSize;
    const end   = start + pageSize;
    const slice = filtered.slice(start, end);

    saleGrid.innerHTML = slice.length
      ? slice.map(gridCard).join('')
      : '<p class="muted">لا توجد نتائج مطابقة.</p>';

    buildPager(total, page);
  }

  function setPage(p){ page = Math.max(1, p); renderPage(); }

  function applyFilters(){
    const f = form;
    if (!f){ filtered = allFarms; page=1; renderPage(); return; }

    const area   = (f.area?.value||'').trim();
    const city   = (f.city?.value||'').trim().toLowerCase();
    const pMin   = toNum(f.price_min?.value, -Infinity);
    const pMax   = toNum(f.price_max?.value,  Infinity);
    const sMin   = toNum(f.size_min?.value,  -Infinity);
    const sMax   = toNum(f.size_max?.value,   Infinity);

    filtered = allFarms.filter(x=>{
      const okArea  = !area || x.area === area;
      const okCity  = !city || (x.city||'').toLowerCase().includes(city);
      const price   = Number(x.price)||0;
      const size    = Number(x.size)||0;
      const okPrice = price>=pMin && price<=pMax;
      const okSize  = size>=sMin  && size<=sMax;
      return okArea && okCity && okPrice && okSize;
    });

    page = 1;
    renderPage();
  }

  async function init(){
    // VIP أولاً (لو عندك)
    try{
      const vip = await fetchJSON('/api/farms/sale?vipOnly=1');
      if (vip.length){
        vipSection.hidden = false;
        vipWrapper.innerHTML = vip.map(vipSlide).join('');
        new Swiper('.vip-swiper', {
          loop:true, centeredSlides:true, slidesPerView:1.02, spaceBetween:18,
          pagination:{ el:'.swiper-pagination', clickable:true },
          navigation:{ nextEl:'.swiper-button-next', prevEl:'.swiper-button-prev' },
          breakpoints:{ 640:{slidesPerView:1.05}, 1024:{slidesPerView:1.08} }
        });
      } else { vipSection.hidden = true; }
    }catch{ vipSection.hidden = true; }

    // كل المزارع + تشغيل الترقيم
    try{
      allFarms = await fetchJSON('/api/farms/sale');
      filtered = allFarms;
      page = 1;
      renderPage();
    }catch(e){
      console.error(e);
      saleGrid.innerHTML = '<p class="muted">تعذّر تحميل المزارع.</p>';
      pager.hidden = true;
    }
  }

  form?.addEventListener('submit', (e)=>{ e.preventDefault(); applyFilters(); });
  init();
</script>

<script>
  (function(){
    const btn  = document.getElementById('filtersToggle');
    const body = document.getElementById('filtersBody');
    if(!btn || !body) return;

    btn.addEventListener('click', ()=>{
      const open = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', String(!open));
      body.hidden = open;
    });

    // (اختياري) افتح تلقائياً على الشاشات الكبيرة
    if (window.matchMedia('(min-width: 1024px)').matches) {
      btn.setAttribute('aria-expanded','true');
      body.hidden = false;
    }
  })();
</script>



</body>
</html>
