<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= contractor ? (contractor.name + ' โ ุชูุงุตูู ุงูููุงูู') : 'ุงูููุงูู ุบูุฑ ููุฌูุฏ' %></title>
  <meta name="description" content="ุชูุงุตูู ููุงูู: ูุนุฑุถ ุงูุฃุนูุงูุ ุงูุฎุฏูุงุชุ ุงูููุงุทู ุงููุบุทูุงุฉุ ููุณุงุฆู ุงูุชูุงุตู." />
  <link rel="stylesheet" href="/Public/styles/contractorsstyle.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
</head>
<body>

  <%- include('partials/navbar', { active: 'contractors' }) %>

  <% if (!contractor) { %>
    <section class="section">
      <div class="container">
        <h1>ุงูููุงูู ุบูุฑ ููุฌูุฏ</h1>
        <p class="muted">ุนุฐุฑูุงุ ูู ูุนุซุฑ ุนูู ุงูููุงูู ุงููุทููุจ.</p>
        <a class="btn btn-outline" href="/contractors#list">ุนูุฏุฉ ุฅูู ุงูููุงูููู</a>
      </div>
    </section>
  <% } else { 
       const avatar   = contractor.avatar || '/Public/assets/contractors/default.jpg';
       const name     = contractor.name || contractor.companyName || 'โ';
       const services = Array.isArray(contractor.services) ? contractor.services.join('ุ ') : (contractor.services || 'โ');
       const region   = contractor.region || contractor.city || 'โ';
       const tier     = contractor.subscriptionTier || 'Basic';
       const photos   = (Array.isArray(contractor.photos) && contractor.photos.length) ? contractor.photos : [avatar];
  %>

  <!-- ููุฏุฑ / ููุฎุต -->
  <header class="contractor-hero">
    <div class="container contractor-hero__inner">
      <div class="hero-top">
        <div class="a avatar--lg">
          <img src="<%= avatar %>" alt="ุตูุฑุฉ <%= name %>" />
        </div>
        <div class="hero-copy">
          <h1 class="name"><%= name %></h1>
          <p class="specialization"><%= services %></p>
          <p class="region"><%= region %></p>
          <ul class="stats" role="list" style="width:100%;display:flex;justify-content:center;align-items:flex-start;flex-direction:column;margin-bottom:-1rem;">
            <li><strong>ุงูุงุดุชุฑุงู:</strong> <span class="tier"><%= tier %></span></li>
          </ul>
          <div class="hero-actions">
            <a class="btn btn-primary" href="#request">ุทูุจ ุฎุฏูุฉ</a>
            <% if (contractor.phone) { %>
              <a class="btn btn-outline" href="tel:<%= contractor.phone.replace(/\s+/g,'') %>">ุงุชุตู: <%= contractor.phone %></a>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </header>
<section id="rating" class="section rating" aria-labelledby="rating-title">
  <div class="container">
    <h2 id="rating-title" style="margin-bottom:.5rem;">ุงูุชูููู</h2>

    <!-- ุนุฑุถ ุงููุชูุณุท ูุงูุนุฏุฏ -->
    <p class="muted" id="ratingSummary"
       data-id="<%= contractor._id %>"
       data-avg="<%= contractor.ratingAvg || 0 %>"
       data-count="<%= contractor.ratingCount || 0 %>">
      ุงูุชูููู ุงูุญุงูู: <strong dir="ltr"><span id="avgNum"><%= contractor.ratingAvg || 0 %></span>/5</strong>
      โ ุนุฏุฏ ุงููููููู: <strong id="countNum"><%= contractor.ratingCount || 0 %></strong>
    </p>

    <!-- ูุฌูู ุงูุชูููู -->
    <div class="stars" id="rateStars" role="radiogroup" aria-label="ููููู ูุฐุง ุงูููุงูู">
      <% for (let i=1; i<=5; i++){ %>
        <button type="button"
                class="star"
                role="radio"
                aria-checked="false"
                data-val="<%= i %>"
                title="<%= i %> ูู 5">โ</button>
      <% } %>
    </div>

    <p class="muted" id="rateMsg" style="min-height:1.4rem;margin-top:.5rem"></p>
  </div>
</section>

<style>
  .stars { display:flex; gap:.25rem; font-size: 2rem; line-height:1; }
  .star  {
    background:none; border:0; cursor:pointer; padding:.1rem .2rem;
    color:#cbd5e1; /* ุฑูุงุฏู ูุงุชุญ */
    transition: transform .1s ease, color .1s ease;
  }
  .star.is-hot, .star:hover { color:#f59e0b; transform: translateY(-1px); } /* ุฐูุจู */
</style>

  <!-- ูุนุฑุถ ุงูุฃุนูุงู -->
  <section id="gallery" class="section gallery" aria-labelledby="gallery-title">
    <div class="container">
      <h2 id="gallery-title" style="margin-bottom:1rem;">ุงูุฃุนูุงู ุงูุณุงุจูุฉ:</h2>
      <div class="swiper gallery-swiper" aria-label="ุตูุฑ ุงููุนุฑุถ">
        <div class="swiper-wrapper">
          <% photos.forEach(function(src){ %>
            <div class="swiper-slide">
              <img src="<%= src %>" alt="ุนูู ูู <%= name %>" loading="lazy" />
            </div>
          <% }) %>
        </div>
        <div class="swiper-button-prev" aria-label="ุงูุณุงุจู"></div>
        <div class="swiper-button-next" aria-label="ุงูุชุงูู"></div>
        <div class="swiper-pagination"></div>
      </div>
    </div>
  </section>

  <!-- ุงูุฎุฏูุงุช -->
  <section id="services" class="section services" aria-labelledby="services-title">
    <div class="container">
      <h2 id="services-title">ุงูุฎุฏูุงุช ุงูููุฏููุฉ</h2>
      <article class="prose">
        <% if (Array.isArray(contractor.services) && contractor.services.length) { %>
          <ul>
            <% contractor.services.forEach(s => { %><li><%= s %></li><% }) %>
          </ul>
        <% } else { %>
          <p class="muted">ูู ูุถู ุงูููุงูู ูุงุฆูุฉ ุฎุฏูุงุช ุจุนุฏ.</p>
        <% } %>
      </article>
    </div>
  </section>

  <!-- ุงูููุงุทู -->
  <section id="coverage" class="section coverage" aria-labelledby="coverage-title">
    <div class="container">
      <h2 id="coverage-title">ุงูููุงุทู ุงููุดูููุฉ</h2>
      <ul class="tags" role="list">
        <li class="tag"><%= region %></li>
      </ul>
    </div>
  </section>

  <!-- ุทูุจ ุฎุฏูุฉ -->
  <section id="request" class="section request" aria-labelledby="request-title">
    <div class="container">
      <h2 id="request-title">ุทูุจ ุฎุฏูุฉ</h2>
      <p class="muted">ุงููุฃ ุจูุงูุงุชู ูุณูุชูุงุตู ูุนู ูู ุฃูุฑุจ ููุช.</p>
      <form id="request-form" action="/request" method="post" novalidate>
        <input type="hidden" name="contractorId" value="<%= contractor._id %>"/>
        <div class="form-grid">
          <div class="field">
            <label class="label" for="rq-name">ุงูุงุณู</label>
            <input id="rq-name" class="input" name="name" type="text" placeholder="ุงูุชุจ ุงุณูู" required />
          </div>
          <div class="field">
            <label class="label" for="rq-phone">ุฑูู ุงููุงุชู</label>
            <input id="rq-phone" class="input" name="phone" type="tel" placeholder="+963 XXX XXX" required />
          </div>
          <div class="field">
            <label class="label" for="rq-service">ููุน ุงูุฎุฏูุฉ</label>
            <select id="rq-service" name="service" required>
              <option value="">ุงุฎุชุฑ ุงูุฎุฏูุฉ</option>
              <option value="Electricity">ููุฑุจุงุก</option>
              <option value="Pumps">ูุถุฎุงุช</option>
              <option value="Solar Energy">ุทุงูุฉ ุดูุณูุฉ</option>
              <option value="Construction">ุจูุงุก</option>
              <option value="Diagnostics">ุชุดุฎูุต ููู</option>
              <option value="Irrigation">ุฑู</option>
            </select>
          </div>
          <div class="field field--full">
            <label class="label" for="rq-desc">ูุตู ูุฎุชุตุฑ</label>
            <textarea id="rq-desc" class="input" name="description" rows="4" placeholder="ุตู ุทูุจู ุจุดูู ูุฎุชุตุฑ"></textarea>
          </div>
          <div class="field field--actions">
            <button class="btn btn-primary" type="submit">ุฅุฑุณุงู</button>
            <a class="btn btn-outline" href="https://wa.me/21600000000?text=<%= encodeURIComponent('ุฃุญุชุงุฌ ุฎุฏูุฉ ูู ุงูููุงูู: '+name) %>" target="_blank" rel="noopener">ูุงุชุณุงุจ</a>
          </div>
        </div>
      </form>
    </div>
  </section>

  <% } /* ููุงูุฉ if(contractor) */ %>
<% if (Array.isArray(topRated) && topRated.length) { %>
<section class="section" aria-labelledby="top-rated-title">
  <div class="container">
    <h2 id="top-rated-title" style="margin-bottom:1rem;">ุฃูุถู ุงูููุงูููู ุชููููุงู</h2>
    <div class="cards-grid">
      <% topRated.forEach(function(c){ 
           const name = c.name || c.companyName || 'โ';
           const avatar = c.avatar || '/Public/assets/contractors/default.jpg';
           const svc = Array.isArray(c.services) ? c.services.join('ุ ') : (c.services || 'โ');
           const reg = c.region || c.city || 'โ';
           const avg = Number(c.ratingAvg || 0).toFixed(2);
           const cnt = Number(c.ratingCount || 0);
      %>
        <article class="contractor-card">
          <a class="contractor-link" href="/contractor/<%= c._id %>">
            <header class="contractor-head">
              <figure class="avatar">
                <img src="<%= avatar %>" alt="ุตูุฑุฉ <%= name %>" loading="lazy" />
              </figure>
              <div class="head-info">
                <h3 class="name"><%= name %></h3>
                <p class="specialization"><%= svc %></p>
                <p class="region"><%= reg %></p>
                <p class="muted">โญ <strong dir="ltr"><%= avg %></strong> (<%= cnt %>)</p>
              </div>
              <% if (c.subscriptionTier==='VIP') { %>
                <span class="badge badge--tier">VIP</span>
              <% } else if (c.subscriptionTier==='Premium') { %>
                <span class="badge badge--tier">ูููุฒ</span>
              <% } %>
            </header>
            <div class="contractor-body">
              <button class="btn btn-outline" type="button">ุนุฑุถ ุงูููุงูู</button>
            </div>
          </a>
        </article>
      <% }) %>
    </div>
  </div>
</section>
<% } %>
  <%- include('partials/promo', { promoContractors }) %>
 <!--

   ========================
       ุงูููุชุฑ
   ======================== -->
<footer class="farm-footer" dir="rtl" aria-labelledby="footer-title">
  <h2 id="footer-title" class="sr-only">ุชุฐููู ุงููููุน</h2>

  <div class="footer-top">
    <!-- ุงูุดุนุงุฑ ูุงููุตู ุงููุฎุชุตุฑ -->
    <div class="footer-brand">
      <div class="logo-mark" aria-hidden="true">๐ฟ</div>
      <div>
        <strong class="brand-name">ูุฒุฑุนุชู</strong>
        <p class="brand-desc">
          ููุตูุฉ ูุนุฑุถ ูุทูุจ ุงููุฒุงุฑุน (ุจูุน/ุฅูุฌุงุฑ) ูุฑุจุท ุงููุฒุงุฑุนูู ุจุงูููุงูููู ูุงูุฎุจุฑุงุก.
        </p>
      </div>
    </div>

    <!-- ุฑูุงุจุท ุณุฑูุนุฉ -->
    <nav class="footer-links" aria-label="ุฑูุงุจุท ุณุฑูุนุฉ">
      <div>
        <h3 class="footer-title">ุชุตูุญ</h3>
        <ul>
          <li><a href="/sale">ูุฒุงุฑุน ููุจูุน</a></li>
          <li><a href="/rent">ูุฒุงุฑุน ููุฅูุฌุงุฑ</a></li>
          <li><a href="/contractors">ุงูููุงูููู</a></li>
          <li><a href="/plans">ุงูุงุดุชุฑุงูุงุช</a></li>
        </ul>
      </div>
      <div>
        <h3 class="footer-title">ุงูุฏุนู</h3>
        <ul>
          <li><a href="/about">ูู ูุญู</a></li>
          <li><a href="/about#faq">ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ</a></li>
          <li><a href="/about#privacy">ุณูุงุณุฉ ุงูุฎุตูุตูุฉ</a></li>
          <li><a href="/about#terms">ุงูุดุฑูุท ูุงูุฃุญูุงู</a></li>
        </ul>
      </div>
      <div>
        <h3 class="footer-title">ุชูุงุตู</h3>
        <ul class="contact">
          <li><a href="mailto:info@farmers.example">info@farmers</a></li>
          <li><a href="tel:+963900000000">+963 900 000</a></li>
          <li><a href="https://wa.me/963900000000" target="_blank" rel="noopener">ูุงุชุณุงุจ ูุจุงุดุฑ</a></li>
        </ul>
      </div>
    </nav>
  </div>

  <div class="footer-bottom">
    <div class="social" aria-label="ุดุจูุงุช ุงุฌุชูุงุนูุฉ">
      <a class="s-link" href="#" aria-label="ุชููุชุฑ" title="ุชููุชุฑ" rel="noopener">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path fill="currentColor" d="M22 5.8c-.7.3-1.5.6-2.3.7.8-.5 1.4-1.3 1.7-2.2-.8.5-1.7.9-2.6 1.1A3.9 3.9 0 0 0 12 8.6c0 .3 0 .5.1.8A11 11 0 0 1 3 5.4a3.9 3.9 0 0 0 1.2 5.2c-.6 0-1.2-.2-1.7-.5v.1c0 1.9 1.3 3.6 3.2 4-.3.1-.7.2-1 .2-.2 0-.5 0-.7-.1.5 1.6 2 2.8 3.8 2.8A7.8 7.8 0 0 1 2 19.5c1.7 1.1 3.8 1.8 6 1.8 7.2 0 11.2-6 11.2-11.2v-.5c.8-.6 1.4-1.3 1.8-2.1z"/></svg>
      </a>
      <a class="s-link" href="#" aria-label="ููุณุจูู" title="ููุณุจูู" rel="noopener">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path fill="currentColor" d="M13 22v-8h3l1-4h-4V7c0-1.2.3-2 2-2h2V1h-3c-3 0-5 2-5 5v4H6v4h3v8h4z"/></svg>
      </a>
      <a class="s-link" href="#" aria-label="ููุชููุจ" title="ููุชููุจ" rel="noopener">
        <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true"><path fill="currentColor" d="M23.5 6.2a3 3 0 0 0-2.1-2.1C19.2 3.5 12 3.5 12 3.5s-7.2 0-9.4.6A3 3 0 0 0 .5 6.2 31 31 0 0 0 0 12a31 31 0 0 0 .5 5.8 3 3 0 0 0 2.1 2.1c2.2.6 9.4.6 9.4.6s7.2 0 9.4-.6a3 3 0 0 0 2.1-2.1A31 31 0 0 0 24 12a31 31 0 0 0-.5-5.8zM9.8 15.5V8.6l6.2 3.5-6.2 3.4z"/></svg>
      </a>
    </div>

    <p class="copyright">
      ยฉ <span id="year-placeholder">2025</span> ูุงุฑูุฑุฒ โ ุฌููุน ุงูุญููู ูุญููุธุฉ.
    </p>

    <div class="mini-links">
      <a href="/about">ุงูุฎุตูุตูุฉ</a>
      <span class="dot" aria-hidden="true">โข</span>
      <a href="/about">ุงูุดุฑูุท</a>
    </div>
  </div>
</footer>

   <script src="../Public/contractorsingle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script>
    new Swiper('.gallery-swiper', {
      loop: true,
      slidesPerView: 1,
      spaceBetween: 12,
      pagination: { el: '.swiper-pagination', clickable: true },
      navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' }
    });
  </script>
  <script>
(() => {
  const wrap   = document.getElementById('ratingSummary');
  const stars  = Array.from(document.querySelectorAll('#rateStars .star'));
  const msg    = document.getElementById('rateMsg');
  if (!wrap || !stars.length) return;

  const id     = wrap.dataset.id;
  const avgEl  = document.getElementById('avgNum');
  const cntEl  = document.getElementById('countNum');

  // ุชูููู ูุจุฏุฆู (ุญุณุจ ุงููุชูุณุท)
  function paint(avg){
    const whole = Math.round(avg);
    stars.forEach((s, i) => s.classList.toggle('is-hot', i < whole));
  }
  paint(Number(wrap.dataset.avg||0));

  // ุฅุฑุณุงู ุงูุชูููู
  async function sendRating(val){
    msg.textContent = 'ุฌุงุฑู ุงูุฅุฑุณุงู...';
    try {
      const r = await fetch(`/contractor/${id}/rate`, {
        method:'POST',
        headers:{'Content-Type':'application/json','Accept':'application/json'},
        body: JSON.stringify({ value: val })
      });
      const j = await r.json();
      if (!j.ok) throw new Error(j.msg || 'ูุดู ุงูุฅุฑุณุงู');
      // ุญุฏูุซ ุงููุงุฌูุฉ
      avgEl.textContent = j.data.avg.toFixed ? j.data.avg.toFixed(2) : j.data.avg;
      cntEl.textContent = j.data.count;
      paint(Number(j.data.avg||0));
      msg.textContent = 'ุดูุฑูุง! ุชู ุชุณุฌูู ุชููููู.';
    } catch(e){
      msg.textContent = e.message || 'ุชุนุฐูุฑ ุงูุฅุฑุณุงู.';
    }
  }

  stars.forEach(btn => {
    btn.addEventListener('click', () => {
      const val = Number(btn.dataset.val);
      stars.forEach(s => s.setAttribute('aria-checked','false'));
      btn.setAttribute('aria-checked','true');
      paint(val);
      sendRating(val);
    });
  });
})();
</script>

</body>
</html>



