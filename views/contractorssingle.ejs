<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= contractor ? (contractor.name + ' — تفاصيل المقاول') : 'المقاول غير موجود' %></title>
  <meta name="description" content="تفاصيل مقاول: معرض الأعمال، الخدمات، المناطق المغطّاة، ووسائل التواصل." />
  <link rel="stylesheet" href="/Public/styles/contractorsstyle.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
</head>
<body>
<style>
  /* لتحسين مظهر الشرائح داخل سويبر أفضل التقييم */
  .toprated-swiper .swiper-slide { height: auto; }
  .toprated-swiper .contractor-card { height: 100%; display: block; }
</style>

  <%- include('partials/navbar', { active: 'contractors' }) %>

  <% if (!contractor) { %>
    <section class="section">
      <div class="container">
        <h1>المقاول غير موجود</h1>
        <p class="muted">عذرًا، لم نعثر على المقاول المطلوب.</p>
        <a class="btn btn-outline" href="/contractors#list">عودة إلى المقاولين</a>
      </div>
    </section>
  <% } else { 
       const avatar   = contractor.avatar || '/Public/assets/contractors/default.jpg';
       const name     = contractor.name || contractor.companyName || '—';
       const services = Array.isArray(contractor.services) ? contractor.services.join('، ') : (contractor.services || '—');
       const region   = contractor.region || contractor.city || '—';
      const rawTier  = contractor.userTier || contractor.subscriptionTier || 'Basic';
const tier     = ({ vip:'VIP', premium:'Premium', basic:'Basic' }[String(rawTier).toLowerCase()]) || rawTier;

       const photos   = (Array.isArray(contractor.photos) && contractor.photos.length) ? contractor.photos : [avatar];
  %>

  <!-- هيدر / ملخص -->
  <header class="contractor-hero">
    <div class="container contractor-hero__inner">
      <div class="hero-top">
        <div class="a avatar--lg">
          <img src="<%= avatar %>" alt="صورة <%= name %>" />
        </div>
        <div class="hero-copy">
          <h1 class="name"><%= name %></h1>
          <p class="specialization"><%= services %></p>
          <p class="region"><%= region %></p>
          <ul class="stats" role="list" style="width:100%;display:flex;justify-content:center;align-items:flex-start;flex-direction:column;margin-bottom:-1rem;">
            <li><strong>الاشتراك:</strong> <span class="tier"><%= tier %></span></li>
          </ul>
          <div class="hero-actions" style="position:absolute;right:2rem;top:12rem;">
            <a class="btn btn-primary" href="#request">طلب خدمة</a>
            <% if (contractor.phone) { %>
              <a class="btn btn-outline" href="tel:<%= contractor.phone.replace(/\s+/g,'') %>">اتصل: <%= contractor.phone %></a>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </header>
<section id="rating" class="section rating" aria-labelledby="rating-title">
  <div class="container">
    <h2 id="rating-title" style="margin-bottom:.5rem;">التقييم</h2>

    <!-- عرض المتوسط والعدد -->
    <p class="muted" id="ratingSummary"
       data-id="<%= contractor._id %>"
       data-avg="<%= contractor.ratingAvg || 0 %>"
       data-count="<%= contractor.ratingCount || 0 %>">
      التقييم الحالي: <strong dir="ltr"><span id="avgNum"><%= contractor.ratingAvg || 0 %></span>/5</strong>
      — عدد المقيمين: <strong id="countNum"><%= contractor.ratingCount || 0 %></strong>
    </p>

    <!-- نجوم التقييم -->
    <div class="stars" id="rateStars" role="radiogroup" aria-label="قيِّم هذا المقاول">
      <% for (let i=1; i<=5; i++){ %>
        <button type="button"
                class="star"
                role="radio"
                aria-checked="false"
                data-val="<%= i %>"
                title="<%= i %> من 5">★</button>
      <% } %>
    </div>

    <p class="muted" id="rateMsg" style="min-height:1.4rem;margin-top:.5rem"></p>
  </div>
</section>

<style>
  .stars { display:flex; gap:.25rem; font-size: 2rem; line-height:1; }
  .star  {
    background:none; border:0; cursor:pointer; padding:.1rem .2rem;
    color:#cbd5e1; /* رمادي فاتح */
    transition: transform .1s ease, color .1s ease;
  }
  .star.is-hot, .star:hover { color:#f59e0b; transform: translateY(-1px); } /* ذهبي */
</style>

  <!-- معرض الأعمال -->
  <section id="gallery" class="section gallery" aria-labelledby="gallery-title">
    <div class="container">
      <h2 id="gallery-title" style="margin-bottom:1rem;">الأعمال السابقة:</h2>
      <div class="swiper gallery-swiper" aria-label="صور المعرض">
        <div class="swiper-wrapper">
          <% photos.forEach(function(src){ %>
            <div class="swiper-slide">
              <img src="<%= src %>" alt="عمل لـ <%= name %>" loading="lazy" />
            </div>
          <% }) %>
        </div>
        <div class="swiper-button-prev" aria-label="السابق"></div>
        <div class="swiper-button-next" aria-label="التالي"></div>
        <div class="swiper-pagination"></div>
      </div>
    </div>
  </section>

  <!-- الخدمات -->
  <section id="services" class="section services" aria-labelledby="services-title">
    <div class="container">
      <h2 id="services-title">الخدمات المقدّمة</h2>
      <article class="prose">
        <% if (Array.isArray(contractor.services) && contractor.services.length) { %>
          <ul>
            <% contractor.services.forEach(s => { %><li><%= s %></li><% }) %>
          </ul>
        <% } else { %>
          <p class="muted">لم يضف المقاول قائمة خدمات بعد.</p>
        <% } %>
      </article>
    </div>
  </section>

  <!-- المناطق -->
  <section id="coverage" class="section coverage" aria-labelledby="coverage-title">
    <div class="container">
      <h2 id="coverage-title">المناطق المشمولة</h2>
      <ul class="tags" role="list">
        <li class="tag"><%= region %></li>
      </ul>
    </div>
  </section>

  <!-- طلب خدمة -->
  <section id="request" class="section request" aria-labelledby="request-title">
    <div class="container">
      <h2 id="request-title">طلب خدمة</h2>
      <p class="muted">املأ بياناتك وسنتواصل معك في أقرب وقت.</p>
      <form id="request-form" action="/request" method="post" novalidate>
        <input type="hidden" name="contractorId" value="<%= contractor._id %>"/>
        <div class="form-grid">
          <div class="field">
            <label class="label" for="rq-name">الاسم</label>
            <input id="rq-name" class="input" name="name" type="text" placeholder="اكتب اسمك" required />
          </div>
          <div class="field">
            <label class="label" for="rq-phone">رقم الهاتف</label>
            <input id="rq-phone" class="input" name="phone" type="tel" placeholder="+963 XXX XXX" required />
          </div>
          <div class="field">
            <label class="label" for="rq-service">نوع الخدمة</label>
            <select id="rq-service" name="service" required>
              <option value="">اختر الخدمة</option>
              <option value="Electricity">كهرباء</option>
              <option value="Pumps">مضخات</option>
              <option value="Solar Energy">طاقة شمسية</option>
              <option value="Construction">بناء</option>
              <option value="Diagnostics">تشخيص فني</option>
              <option value="Irrigation">ري</option>
            </select>
          </div>
          <div class="field field--full">
            <label class="label" for="rq-desc">وصف مختصر</label>
            <textarea id="rq-desc" class="input" name="description" rows="4" placeholder="صف طلبك بشكل مختصر"></textarea>
          </div>
          <div class="field field--actions">
            <button class="btn btn-primary" type="submit">إرسال</button>
            <a class="btn btn-outline" href="https://wa.me/21600000000?text=<%= encodeURIComponent('أحتاج خدمة من المقاول: '+name) %>" target="_blank" rel="noopener">واتساب</a>
          </div>
        </div>
      </form>
    </div>
  </section>

  <% } /* نهاية if(contractor) */ %>
<% if (Array.isArray(topRated) && topRated.length) { %>
<section class="section" aria-labelledby="top-rated-title">
  <div class="container">
    <h2 id="top-rated-title" style="margin-bottom:1rem;">أفضل المقاولين تقييماً</h2>

    <div class="swiper toprated-swiper" dir="rtl">
      <div class="swiper-wrapper">
        <% topRated.forEach(function(c){ 
             const name   = c.name || c.companyName || '—';
             const avatar = c.avatar || '/Public/assets/contractors/default.jpg';
             const svc    = Array.isArray(c.services) ? c.services.join('، ') : (c.services || '—');
             const reg    = c.region || c.city || '—';
             const avg    = Number(c.ratingAvg || 0).toFixed(2);
             const cnt    = Number(c.ratingCount || 0);
        %>
          <div class="swiper-slide">
            <article class="contractor-card">
              <a class="contractor-link" href="/contractor/<%= c._id %>">
                <header class="contractor-head">
                  <figure class="avatar">
                    <img src="<%= avatar %>" alt="صورة <%= name %>" loading="lazy" />
                  </figure>
                  <div class="head-info">
                    <h3 class="name"><%= name %></h3>
                    <p class="specialization"><%= svc %></p>
                    <p class="region"><%= reg %></p>
                    <p class="muted">⭐ <strong dir="ltr"><%= avg %></strong> (<%= cnt %>)</p>
                  </div>
                  <% if (c.subscriptionTier==='VIP') { %>
                    <span class="badge badge--tier">VIP</span>
                  <% } else if (c.subscriptionTier==='Premium') { %>
                    <span class="badge badge--tier">مميز</span>
                  <% } %>
                </header>
                <div class="contractor-body">
                  <button class="btn btn-outline" type="button">عرض المقاول</button>
                </div>
              </a>
            </article>
          </div>
        <% }) %>
      </div>

      <!-- عناصر التحكم -->
      <div class="swiper-button-prev" aria-label="السابق"></div>
      <div class="swiper-button-next" aria-label="التالي"></div>
      <div class="swiper-pagination"></div>
    </div>
  </div>
</section>
<% } %>

  
 <%- include('partials/footer') %>

   <script src="../Public/contractorsingle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script>
    new Swiper('.gallery-swiper', {
      loop: true,
      slidesPerView: 1,
      spaceBetween: 12,
      pagination: { el: '.swiper-pagination', clickable: true },
      navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' }
    });
      new Swiper('.toprated-swiper', {
    slidesPerView: 1.05,
    spaceBetween: 16,
    watchOverflow: true,
    pagination: { el: '.toprated-swiper .swiper-pagination', clickable: true },
    navigation: {
      nextEl: '.toprated-swiper .swiper-button-next',
      prevEl: '.toprated-swiper .swiper-button-prev'
    },
    breakpoints: {
      640:  { slidesPerView: 2,   spaceBetween: 18 },
      1024: { slidesPerView: 3,   spaceBetween: 20 },
      1280: { slidesPerView: 3.5, spaceBetween: 22 }
    }
  });
  </script>
  <script>
(() => {
  const wrap   = document.getElementById('ratingSummary');
  const stars  = Array.from(document.querySelectorAll('#rateStars .star'));
  const msg    = document.getElementById('rateMsg');
  if (!wrap || !stars.length) return;

  const id     = wrap.dataset.id;
  const avgEl  = document.getElementById('avgNum');
  const cntEl  = document.getElementById('countNum');

  // تلوين مبدئي (حسب المتوسط)
  function paint(avg){
    const whole = Math.round(avg);
    stars.forEach((s, i) => s.classList.toggle('is-hot', i < whole));
  }
  paint(Number(wrap.dataset.avg||0));

  // إرسال التقييم
  async function sendRating(val){
    msg.textContent = 'جارٍ الإرسال...';
    try {
      const r = await fetch(`/contractor/${id}/rate`, {
        method:'POST',
        headers:{'Content-Type':'application/json','Accept':'application/json'},
        body: JSON.stringify({ value: val })
      });
      const j = await r.json();
      if (!j.ok) throw new Error(j.msg || 'فشل الإرسال');
      // حدّث الواجهة
      avgEl.textContent = j.data.avg.toFixed ? j.data.avg.toFixed(2) : j.data.avg;
      cntEl.textContent = j.data.count;
      paint(Number(j.data.avg||0));
      msg.textContent = 'شكرًا! تم تسجيل تقييمك.';
    } catch(e){
      msg.textContent = e.message || 'تعذّر الإرسال.';
    }
  }

  stars.forEach(btn => {
    btn.addEventListener('click', () => {
      const val = Number(btn.dataset.val);
      stars.forEach(s => s.setAttribute('aria-checked','false'));
      btn.setAttribute('aria-checked','true');
      paint(val);
      sendRating(val);
    });
  });
})();
</script>

</body>
</html>



