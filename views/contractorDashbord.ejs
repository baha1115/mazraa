<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ â€” Farmers</title>
  <meta name="description" content="Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„ØŒ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ÙˆØ§Ù„Ù…Ù†Ø§Ø·Ù‚ØŒ Ø§Ù„Ù…Ø¹Ø±Ø¶ØŒ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.">

  <style>
    :root{
      --g700:#047857; --g600:#059669; --g500:#10b981;
      --y500:#eab308;
      --ink:#0f172a; --ink70:#334155; --ink50:#64748b;
      --white:#fff; --bg:#f7faf7;
      --radius:16px; --rsm:12px;
      --sh1:0 10px 26px rgba(2,44,34,.10);
      --ring:0 0 0 3px rgba(5,150,105,.28);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--ink);
      font:16px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:
        radial-gradient(900px 360px at 110% -10%, #fef9c3 0%, transparent 60%),
        radial-gradient(900px 360px at -10% 120%, #ecfccb 0%, transparent 60%),
        linear-gradient(#f7fff8,#fbfdf6);
    }
    .container{width:min(1180px,92%);margin-inline:auto}
    a{color:inherit;text-decoration:none}
    img{display:block;max-width:100%}
    button{font:inherit;cursor:pointer}
    :focus-visible{outline:none;box-shadow:var(--ring);border-radius:10px}

    .topbar{position:sticky;top:0;z-index:40;background:rgba(255,255,255,.9);border-bottom:1px solid #e5e7eb;backdrop-filter:blur(8px)}
    .topbar__inner{display:flex;justify-content:space-between;align-items:center;padding:.8rem 0}
    .brand{display:flex;gap:.6rem;align-items:center;font-weight:900}
    .brand__mark{width:36px;height:36px;border-radius:10px;color:#fff;display:grid;place-items:center;background:linear-gradient(135deg,var(--g600),var(--y500))}
    .topbar__actions{display:flex;gap:.5rem}

    .btn{display:inline-flex;align-items:center;gap:.4rem;padding:.6rem .9rem;border-radius:12px;border:1px solid transparent;font-weight:800;background:linear-gradient(135deg,var(--g600),var(--g700));color:#fff;box-shadow:0 10px 24px rgba(4,120,87,.2)}
    .btn--ghost{background:#fff;border-color:#d1d5db;color:var(--ink)}
    .btn--danger{background:linear-gradient(135deg,#ef4444,#dc2626)}
    .btn--small{padding:.45rem .65rem}
    .btn--outline{background:#fff;border-color:#d1d5db;color:var(--ink)}
    .input{width:100%;padding:.65rem .8rem;border:1px solid #e2e8f0;border-radius:12px;background:#fff}

    .layout{display:grid;grid-template-columns:260px 1fr;gap:1rem;margin:1rem 0}
    .sidebar{border:1px solid #e2e8f0;border-radius:16px;background:#fff;box-shadow:var(--sh1);display:flex;flex-direction:column;min-height:60vh}
    .menu{display:grid;padding:.5rem}
    .menu__item{border:1px solid transparent;border-radius:12px;padding:.65rem .75rem;text-align:right;font-weight:800;color:var(--ink70);background:#fff}
    .menu__item:hover{background:#f9fafb}
    .menu__item.is-active{background:linear-gradient(135deg,var(--g600),var(--g700));color:#fff}
    .sidebar__footer{margin-top:auto;padding:.8rem;border-top:1px solid #e5e7eb;color:var(--ink50)}

    .content{min-width:0}
    .panel{display:none;border:1px solid #e2e8f0;border-radius:16px;background:#fff;box-shadow:var(--sh1);padding:1rem}
    .panel.is-visible{display:block}
    .panel__head{display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem}

    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.8rem}
    .field{display:grid;gap:.3rem}
    .field--full{grid-column:1/-1}
    .label{font-weight:800;color:var(--ink70)}
    .actions{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.35rem}
    .muted{color:var(--ink50)}
    .avatar{display:flex;gap:.8rem;align-items:center}
    .avatar img{width:84px;height:84px;border-radius:12px;object-fit:cover;border:1px solid #e5e7eb}

    /* Ù…Ø¹Ø±Ø¶ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ */
    .drop{border:2px dashed #cbd5e1;border-radius:16px;padding:1rem;display:grid;place-items:center;text-align:center;background:#fafafa;margin-top:.6rem}
    .drop.is-over{background:#f1f5f9;border-color:#94a3b8}
    .drop__hint{margin:.4rem 0;color:var(--ink50)}
    .thumbs{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:.5rem;margin-top:.6rem}
    .thumb{position:relative;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;background:#0000000a}
    .thumb img{display:block;width:100%;height:110px;object-fit:cover}
    .thumb button{position:absolute;inset:.3rem .3rem auto auto;border:0;border-radius:9px;background:#fff;padding:.2rem .5rem;cursor:pointer}
    .thumb button:hover{background:#ffe7e7}

    .toasts{position:fixed;left:16px;bottom:16px;display:grid;gap:.5rem;z-index:50}
    .toast{padding:.55rem .8rem;border-radius:12px;border:1px solid #e2e8f0;background:#fff;box-shadow:var(--sh1);font-weight:800}
    .toast--ok{border-color:#a7f3d0;background:#ecfdf5;color:#065f46}
    .toast--warn{border-color:#fde68a;background:#fffbeb;color:#92400e}

    @media (max-width:980px){
      .layout{grid-template-columns:1fr}
      .grid2{grid-template-columns:1fr}
      .thumbs{grid-template-columns:repeat(3,1fr)}
    }
    @media (max-width:640px){
      .thumbs{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
  <!-- Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ -->
<%- include('partials/navbar') %>

<%
  const safeUser    = (typeof user !== 'undefined' && user) ? user : {};
  const safeProfile = (typeof profile !== 'undefined' && profile) ? profile : {};
  const safeErrors  = (typeof errors !== 'undefined' && errors) ? errors : {};
%>

  <main class="container layout">
    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
    <aside class="sidebar" aria-label="Ù‚Ø§Ø¦Ù…Ø©">
      <nav class="menu">
        
        <button class="menu__item is-active" data-view="profile">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</button>
        <button class="menu__item" data-view="requests">Ø·Ù„Ø¨Ø§ØªÙŠ</button>
        <button class="menu__item" data-view="services" style="display: none;">Ø§Ù„ØªØ®ØµØµØ§Øª ÙˆØ§Ù„Ù…Ù†Ø§Ø·Ù‚</button>
        <button class="menu__item" data-view="subscription">Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</button>
        <button class="menu__item" data-view="settings" style="display: none;">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      </nav>
      <div class="sidebar__footer">
        <small>Â© <span data-year>2025</span> Farmers</small>
      </div>
    </aside>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
    <section class="content">
      <!-- Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
<section id="view-requests" class="panel is-visible">
  <header class="panel__head"><h2>Ø·Ù„Ø¨Ø§ØªÙŠ</h2></header>
  <div id="requestsList" class="cards"></div>
  <p id="requestsEmpty" class="muted" hidden>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</p>
</section>

      <!-- Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ + Ø§Ù„Ù…Ø¹Ø±Ø¶ + Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ø³Ø³Ø© (ÙƒÙ„Ù‡Ø§ ØªÙØ±Ø³Ù„ Ù…Ø¹Ù‹Ø§) -->
      <section class="panel is-visible" id="view-profile">
        <header class="panel__head"><h2>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h2></header>

        <form id="formProfile" class="form grid2" novalidate>
          <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
          <label class="field">
            <span class="label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</span>
            <input maxlength="100" type="text" name="name" class="input" required value="<%= safeProfile.name || safeUser.name || '' %>" />
            <% if (safeErrors.name){ %><small class="muted" style="color:#b91c1c"><%= safeErrors.name %></small><% } %>
          </label>

          <label class="field">
            <span class="label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</span>
            <input type="email" name="email" class="input" required value="<%= safeProfile.email || safeUser.email || '' %>" />
            <% if (safeErrors.email){ %><small class="muted" style="color:#b91c1c"><%= safeErrors.email %></small><% } %>
          </label>

          <label class="field">
            <span class="label">Ø§Ù„Ù‡Ø§ØªÙ</span>
            <input type="tel" name="phone" class="input" value="<%= safeProfile.phone || '' %>" />
          </label>

    <label class="field">
  <span class="label">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</span>
  <select name="city" id="city" class="input" required>
    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©â€¦</option>
    <option value="Ø¯Ù…Ø´Ù‚"        <%= (safeProfile.city==='Ø¯Ù…Ø´Ù‚')        ? 'selected' : '' %>>Ø¯Ù…Ø´Ù‚</option>
    <option value="Ø±ÙŠÙ Ø¯Ù…Ø´Ù‚"    <%= (safeProfile.city==='Ø±ÙŠÙ Ø¯Ù…Ø´Ù‚')    ? 'selected' : '' %>>Ø±ÙŠÙ Ø¯Ù…Ø´Ù‚</option>
    <option value="Ø­Ù„Ø¨"         <%= (safeProfile.city==='Ø­Ù„Ø¨')         ? 'selected' : '' %>>Ø­Ù„Ø¨</option>
    <option value="Ø­Ù…Øµ"         <%= (safeProfile.city==='Ø­Ù…Øµ')         ? 'selected' : '' %>>Ø­Ù…Øµ</option>
    <option value="Ø­Ù…Ø§Ø©"        <%= (safeProfile.city==='Ø­Ù…Ø§Ø©')        ? 'selected' : '' %>>Ø­Ù…Ø§Ø©</option>
    <option value="Ø§Ù„Ù„Ø§Ø°Ù‚ÙŠØ©"    <%= (safeProfile.city==='Ø§Ù„Ù„Ø§Ø°Ù‚ÙŠØ©')    ? 'selected' : '' %>>Ø§Ù„Ù„Ø§Ø°Ù‚ÙŠØ©</option>
    <option value="Ø·Ø±Ø·ÙˆØ³"       <%= (safeProfile.city==='Ø·Ø±Ø·ÙˆØ³')       ? 'selected' : '' %>>Ø·Ø±Ø·ÙˆØ³</option>
    <option value="Ø¥Ø¯Ù„Ø¨"        <%= (safeProfile.city==='Ø¥Ø¯Ù„Ø¨')        ? 'selected' : '' %>>Ø¥Ø¯Ù„Ø¨</option>
    <option value="Ø¯ÙŠØ± Ø§Ù„Ø²ÙˆØ±"   <%= (safeProfile.city==='Ø¯ÙŠØ± Ø§Ù„Ø²ÙˆØ±')   ? 'selected' : '' %>>Ø¯ÙŠØ± Ø§Ù„Ø²ÙˆØ±</option>
    <option value="Ø§Ù„Ø­Ø³ÙƒØ©"      <%= (safeProfile.city==='Ø§Ù„Ø­Ø³ÙƒØ©')      ? 'selected' : '' %>>Ø§Ù„Ø­Ø³ÙƒØ©</option>
    <option value="Ø§Ù„Ø±Ù‚Ø©"       <%= (safeProfile.city==='Ø§Ù„Ø±Ù‚Ø©')       ? 'selected' : '' %>>Ø§Ù„Ø±Ù‚Ø©</option>
    <option value="Ø¯Ø±Ø¹Ø§"        <%= (safeProfile.city==='Ø¯Ø±Ø¹Ø§')        ? 'selected' : '' %>>Ø¯Ø±Ø¹Ø§</option>
    <option value="Ø§Ù„Ù‚Ù†ÙŠØ·Ø±Ø©"    <%= (safeProfile.city==='Ø§Ù„Ù‚Ù†ÙŠØ·Ø±Ø©')    ? 'selected' : '' %>>Ø§Ù„Ù‚Ù†ÙŠØ·Ø±Ø©</option>
    <option value="Ø§Ù„Ø³ÙˆÙŠØ¯Ø§Ø¡"    <%= (safeProfile.city==='Ø§Ù„Ø³ÙˆÙŠØ¯Ø§Ø¡')    ? 'selected' : '' %>>Ø§Ù„Ø³ÙˆÙŠØ¯Ø§Ø¡</option>
  </select>
</label>

          <label class="field field--full">
            <span class="label">Ù†Ø¨Ø°Ø© Ù…Ø®ØªØµØ±Ø©</span>
            <textarea name="bio" maxlength="1500" rows="3" class="input" placeholder="Ø®Ø¨Ø±ØªÙƒ ÙˆÙ…Ù‡Ø§Ø±Ø§ØªÙƒâ€¦"><%= safeProfile.bio || '' %></textarea>
          </label>

          <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ø³Ø³Ø© (Ø¨Ø¯ÙŠÙ„ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„) -->
          <label class="field">
            <span class="label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</span>
            <input maxlength="100" name="companyName" class="input" required value="<%= safeProfile.companyName || '' %>">
          </label>

          <% const selectedService = Array.isArray(safeProfile.services)
      ? (safeProfile.services[0] || '')
      : (safeProfile.services || ''); %>

<label class="field">
  <span class="label">Ø§Ù„Ø®Ø¯Ù…Ø© / Ø§Ù„ØªØ®ØµØµ</span>
  <select name="services" id="serviceSelect" class="input" required>
    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø©â€¦</option>

    <option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø²Ø±Ø§Ø¹ÙŠØ©" <%= selectedService==='ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø²Ø±Ø§Ø¹ÙŠØ©' ? 'selected' : '' %>>ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø²Ø±Ø§Ø¹ÙŠØ©</option>
    <option value="Ù…Ø¶Ø®Ø§Øª"         <%= selectedService==='Ù…Ø¶Ø®Ø§Øª' ? 'selected' : '' %>>Ù…Ø¶Ø®Ø§Øª</option>
    <option value="Ø·Ø§Ù‚Ø© Ø´Ù…Ø³ÙŠØ©"    <%= selectedService==='Ø·Ø§Ù‚Ø© Ø´Ù…Ø³ÙŠØ©' ? 'selected' : '' %>>Ø·Ø§Ù‚Ø© Ø´Ù…Ø³ÙŠØ©</option>
    <option value="Ø±ÙŠ (ØªÙ†Ù‚ÙŠØ·/Ø±Ø´)" <%= selectedService==='Ø±ÙŠ (ØªÙ†Ù‚ÙŠØ·/Ø±Ø´)' ? 'selected' : '' %>>Ø±ÙŠ (ØªÙ†Ù‚ÙŠØ·/Ø±Ø´)</option>
    <option value="Ø¨Ù†Ø§Ø¡ Ø±ÙŠÙÙŠ"     <%= selectedService==='Ø¨Ù†Ø§Ø¡ Ø±ÙŠÙÙŠ' ? 'selected' : '' %>>Ø¨Ù†Ø§Ø¡ Ø±ÙŠÙÙŠ</option>
    <option value="ØªØ´Ø®ÙŠØµ ÙÙ†ÙŠ"     <%= selectedService==='ØªØ´Ø®ÙŠØµ ÙÙ†ÙŠ' ? 'selected' : '' %>>ØªØ´Ø®ÙŠØµ ÙÙ†ÙŠ</option>
    <option value="ØµÙŠØ§Ù†Ø© ÙˆØªØ±ÙƒÙŠØ¨Ø§Øª"<%= selectedService==='ØµÙŠØ§Ù†Ø© ÙˆØªØ±ÙƒÙŠØ¨Ø§Øª' ? 'selected' : '' %>>ØµÙŠØ§Ù†Ø© ÙˆØªØ±ÙƒÙŠØ¨Ø§Øª</option>
    <option value="Ø­Ø¯Ø§Ø¯Ø©/Ù„Ø­Ø§Ù…"    <%= selectedService==='Ø­Ø¯Ø§Ø¯Ø©/Ù„Ø­Ø§Ù…' ? 'selected' : '' %>>Ø­Ø¯Ø§Ø¯Ø©/Ù„Ø­Ø§Ù…</option>
    <option value="Ø£Ù„Ù…Ù†ÙŠÙˆÙ…"       <%= selectedService==='Ø£Ù„Ù…Ù†ÙŠÙˆÙ…' ? 'selected' : '' %>>Ø£Ù„Ù…Ù†ÙŠÙˆÙ…</option>
    <option value="ØªØ¨Ø±ÙŠØ¯/ØªÙƒÙŠÙŠÙ Ø²Ø±Ø§Ø¹ÙŠ" <%= selectedService==='ØªØ¨Ø±ÙŠØ¯/ØªÙƒÙŠÙŠÙ Ø²Ø±Ø§Ø¹ÙŠ' ? 'selected' : '' %>>ØªØ¨Ø±ÙŠØ¯/ØªÙƒÙŠÙŠÙ Ø²Ø±Ø§Ø¹ÙŠ</option>
  </select>
</label>

      <label class="field">
  <span class="label">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</span>
  <input
    name="region" maxlength="80"
    class="input"
    placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©"
    value="<%= safeProfile?.region || '' %>"
  />
</label>

      

          <label class="field field--full">
            <span class="label">Ø§Ù„ÙˆØµÙ</span>
            <textarea name="description" maxlength="2000" rows="4" class="input"><%= safeProfile.description || '' %></textarea>
          </label>
     <!-- Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
<label class="field field--full">
  <span class="label">Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ (YouTube/Vimeo Ø£Ùˆ Ù…Ù„Ù mp4)</span>
  <input name="videoUrl" class="input" placeholder="https://youtu.be/XXXX Ø£Ùˆ https://example.com/video.mp4"
         value="<%= (safeProfile?.videoUrl || '') %>">
  <small class="muted">Ø¥Ù† ÙˆÙØ¬Ø¯ØŒ Ø³ÙŠØ¸Ù‡Ø± ÙÙŠ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø£Ø¯Ù…Ù†.</small>
</label>

          <!-- ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ© -->
          <div class="field field--full">
            <div class="avatar">
              <img id="avatarPreview" src="<%= safeProfile.avatar || '/assets/contractor-1.jpg' %>" alt="ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ©" />
              <div>
                <label class="label">ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</label>
                <div id="avatarDrop" class="drop" tabindex="0" aria-label="Ø±ÙØ¹ ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ©">
                  <div>
                    <strong>Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª ØµÙˆØ±Ø© Ù‡Ù†Ø§</strong>
                    <div class="drop__hint">Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ</div>
                    <button type="button" class="btn btn--ghost btn--small" id="pickAvatar">Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©</button>
                    <input id="avatarInput" type="file" accept="image/*" hidden>
                  </div>
                </div>
                <small class="muted">ØªØ­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Base64 Ù„Ù„ØªØ¬Ø±Ø¨Ø©.</small>
              </div>
            </div>
          </div>

          <!-- Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
          <div class="field field--full">
            <span class="label">Ø§Ù„Ù…Ø¹Ø±Ø¶ (ØµÙˆØ± Ø§Ù„Ø£Ø¹Ù…Ø§Ù„)</span>
            <div id="workDrop" class="drop" tabindex="0" aria-label="Ø±ÙØ¹ ØµÙˆØ± Ø§Ù„Ø£Ø¹Ù…Ø§Ù„">
              <div>
                <strong>Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª Ø§Ù„ØµÙˆØ± Ù‡Ù†Ø§</strong>
                <div class="drop__hint">Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ (ÙŠØ¯Ø¹Ù… ØµÙˆØ± Ù…ØªØ¹Ø¯Ø¯Ø©)</div>
                <button type="button" class="btn btn--ghost btn--small" id="pickWork">Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±</button>
                <input id="workInput" type="file" accept="image/*" multiple hidden>
              </div>
            </div>
            <div id="thumbs" class="thumbs" aria-live="polite"></div>
          </div>

          <div class="actions field--full">
            <button class="btn" type="submit">Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
            <span class="muted">Ù„Ù† ÙŠÙÙ†Ø´Ø± Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.</span>
          </div>
        </form>
      </section>

      <!-- Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ -->
     <section class="panel" id="view-subscription">
  <header class="panel__head"><h2>Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h2></header>
  <p class="muted" style="margin:.3rem 0">
    Ø®Ø·ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <strong><%= (safeUser.subscriptionTier || 'Basic') %></strong>
  </p>

  <form id="contractorSubscribeForm" class="grid2" style="max-width:600px">
    <label class="field">
      <span class="label">Ø§Ù„Ø®Ø·Ø©</span>
      <select name="plan" class="input" required>
        <option value="Premium">Premium (2 Ù†Ø´Ø±Ø§Øª)</option>
        <option value="VIP">VIP (ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯)</option>
      </select>
    </label>

    <label class="field">
      <span class="label">Ø§Ù„Ø§Ø³Ù…</span>
      <input name="name" class="input" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„" required>
    </label>

    <label class="field">
      <span class="label">ÙˆØ§ØªØ³Ø§Ø¨</span>
      <input name="whatsapp" class="input" placeholder="+216XXXXXXXX" required>
    </label>

    <label class="field field--full">
      <span class="label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
      <textarea name="notes" rows="3" class="input" placeholder="Ø£ÙŠ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©â€¦"></textarea>
    </label>

    <div class="actions field--full">
      <button class="btn" type="submit">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙˆÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨</button>
      <small class="muted">Ø³ÙŠÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø±Ø³Ø§Ù„Ø© Ø¬Ø§Ù‡Ø²Ø©ØŒ ÙˆØ³ÙŠØ¸Ù‡Ø± Ø·Ù„Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.</small>
    </div>
  </form>
</section>


      <!-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
   

  <!-- ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
  <div id="toasts" class="toasts" aria-live="polite" aria-atomic="true"></div>
<!-- Ø­Ù‚Ù† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© ÙƒÙ€ JSON Ø¢Ù…Ù† -->
<!-- Ø¶Ø¹ Ù‡Ø°ÙŠÙ† Ø§Ù„ÙˆØ³Ù…ÙŠÙ† (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·) ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø°ÙŠ ØªØ¶Ø¹ ÙÙŠÙ‡ Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª -->
<script id="initial-photos" type="application/json">
  <%- JSON.stringify(Array.isArray(safeProfile?.photos) ? safeProfile.photos : []) %>
</script>
<script id="initial-avatar" type="application/json">
  <%- JSON.stringify(safeProfile?.avatar || "") %>
</script>

<script>
(() => {
  'use strict';
  const qs  = (s, r=document)=>r.querySelector(s);
  const qsa = (s, r=document)=>Array.from(r.querySelectorAll(s));

  /* ================= Toasts ================ */
  const toastBox = qs('#toasts');
  function toast(msg, kind='ok', ms=2200){
    const t = document.createElement('div');
    t.className = 'toast ' + (kind==='ok' ? 'toast--ok' : 'toast--warn');
    t.textContent = msg;
    toastBox?.appendChild(t);
    setTimeout(()=>t.remove(), ms);
  }

  // helper
  function esc(s){
    return (s??'').toString().replace(/[&<>"']/g, m => (
      {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
    ));
  }

  // Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  qsa('[data-year]').forEach(el => el.textContent = String(new Date().getFullYear()));

  /* ============== ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ============== */
  const views = {
    profile:      qs('#view-profile'),
    services:     qs('#view-services'),
    subscription: qs('#view-subscription'),
    settings:     qs('#view-settings'),
    requests:     qs('#view-requests'),
  };
  qsa('.menu__item').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      qsa('.menu__item').forEach(b=>b.classList.remove('is-active'));
      btn.classList.add('is-active');
      const target = btn.dataset.view;
      Object.entries(views).forEach(([k,sec])=>sec?.classList.toggle('is-visible', k===target));
    });
  });

  /* ============== Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ± ============== */
  function readAsDataURL(file){
    return new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload = ()=>resolve(r.result);
      r.onerror= reject;
      r.readAsDataURL(file);
    });
  }

  /* ============== Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ============== */
  const form          = qs('#formProfile');
  const avatarDrop    = qs('#avatarDrop');
  const avatarInput   = qs('#avatarInput');
  const pickAvatar    = qs('#pickAvatar');
  const avatarPreview = qs('#avatarPreview');

  const photos = JSON.parse((qs('#initial-photos')?.textContent || '[]'));
  let   avatar = JSON.parse((qs('#initial-avatar')?.textContent || '""'));

  // Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø§Ø±ÙŠ ØªØ¹Ø¯ÙŠÙ„Ù‡ (Ø¥Ù† ÙˆØ¬Ø¯)
  let editingId = null;

  /* ============== Ù…Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ ============== */
  const workDrop  = qs('#workDrop');
  const workInput = qs('#workInput');
  const pickWork  = qs('#pickWork');
  const thumbs    = qs('#thumbs');

   const MAX_TOTAL_BYTES = 5 * 1024 * 1024;

  // ØªÙ‚Ø¯ÙŠØ± Ø­Ø¬Ù… DataURL Ø¨Ø§Ù„Ø¨Ø§ÙŠØªØ§Øª
  function dataUrlBytes(src){
    if (typeof src !== 'string') return 0;
    const comma = src.indexOf(',');
    if (comma < 0) return 0;
    const b64 = src.slice(comma+1);
    // ØªØ­ÙˆÙŠÙ„ Ø·ÙˆÙ„ base64 Ø¥Ù„Ù‰ bytes:
    return Math.max(0, Math.floor(b64.length * 3 / 4) - (b64.endsWith('==') ? 2 : b64.endsWith('=') ? 1 : 0));
  }

  // Ø§Ø­Ø³Ø¨ Ø¨Ø§ÙŠØªØ§Øª Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ (DataURL ÙÙ‚Ø·Ø› Ø§Ù„Ø±ÙˆØ§Ø¨Ø· http ØªÙØ­Ø³Ø¨ 0 Ù„Ø£Ù† Ø­Ø¬Ù…Ù‡Ø§ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ)
  function currentGalleryBytes(photosArr){
    return (photosArr||[]).reduce((sum,src)=> sum + (src.startsWith('data:image') ? dataUrlBytes(src) : 0), 0);
  }

  // Ø§Ø­Ø³Ø¨ Ø¨Ø§ÙŠØªØ§Øª Ù…Ù„Ù avatar Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù† ÙƒØ§Ù† DataURL
  function currentAvatarBytes(avatarSrc){
    return (typeof avatarSrc === 'string' && avatarSrc.startsWith('data:image')) ? dataUrlBytes(avatarSrc) : 0;
  }

  // Ø§Ø­Ø³Ø¨ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£Ø­Ø¬Ø§Ù…: Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø­Ø§Ù„ÙŠØ§Ù‹ (avatar + photos) + Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  function willExceedTotalLimit({ existingPhotos, existingAvatar, newFiles = [] }){
    const existing = currentGalleryBytes(existingPhotos) + currentAvatarBytes(existingAvatar);
    const incoming = newFiles.reduce((s,f)=> s + (f?.size||0), 0);
    return (existing + incoming) > MAX_TOTAL_BYTES;
  }

  function renderThumbs(){
    if (!thumbs) return;
    thumbs.innerHTML = '';
    if (!photos.length){
      const p = document.createElement('p');
      p.className='muted';
      p.textContent='Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ø¨Ø¹Ø¯.';
      thumbs.appendChild(p);
      return;
    }
    photos.forEach((src, i)=>{
      const t = document.createElement('div');
      t.className='thumb';
      t.innerHTML = `<img src="${src}" alt=""><button type="button" data-i="${i}">Ø­Ø°Ù</button>`;
      thumbs.appendChild(t);
    });
  }
  thumbs?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-i]'); if(!btn) return;
    const i = parseInt(btn.dataset.i,10);
    if (!Number.isNaN(i)) photos.splice(i,1);
    renderThumbs();
  });

  // Ø¥Ø³Ù‚Ø§Ø·/Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ± Ø§Ù„Ù…Ø¹Ø±Ø¶
  ;['dragenter','dragover'].forEach(ev=>{
    workDrop?.addEventListener(ev, e=>{ e.preventDefault(); workDrop.classList.add('is-over'); });
  });
  ;['dragleave','drop'].forEach(ev=>{
    workDrop?.addEventListener(ev, e=>{ e.preventDefault(); workDrop.classList.remove('is-over'); });
  });
  workDrop?.addEventListener('click', ()=> workInput?.click());
  pickWork?.addEventListener('click', ()=> workInput?.click());
    workDrop?.addEventListener('drop', async (e)=>{
    const files = Array.from(e.dataTransfer?.files||[]).filter(f=>f.type.startsWith('image/'));
    if (!files.length) return toast('Ø§Ø®ØªØ± ØµÙˆØ±Ù‹Ø§ ÙÙ‚Ø·','warn');

    // ØªØ­Ù‚Ù‚ Ø¥Ø¬Ù…Ø§Ù„ÙŠ 5MB (Ø§Ù„Ù…Ø¹Ø±Ø¶ + avatar + Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©)
    if (willExceedTotalLimit({ existingPhotos: photos, existingAvatar: avatar, newFiles: files })) {
      return toast('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ± (Ø§Ù„Ù…Ø¹Ø±Ø¶ + Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©) ÙŠØªØ¬Ø§ÙˆØ² 5MB','warn');
    }

    for (const f of files){ photos.push(await readAsDataURL(f)); }
    renderThumbs();
  });

  workInput?.addEventListener('change', async (e)=>{
    const files = Array.from(e.target.files||[]).filter(f=>f.type.startsWith('image/'));
    if (!files.length) return toast('Ø§Ø®ØªØ± ØµÙˆØ±Ù‹Ø§ ÙÙ‚Ø·','warn');

    if (willExceedTotalLimit({ existingPhotos: photos, existingAvatar: avatar, newFiles: files })) {
      // Ù„Ø§ Ù†Ø¶ÙŠÙ Ø´ÙŠØ¦Ù‹Ø§
      e.target.value = ''; // Ù…Ø³Ø­ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
      return toast('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ± (Ø§Ù„Ù…Ø¹Ø±Ø¶ + Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©) ÙŠØªØ¬Ø§ÙˆØ² 5MB','warn');
    }

    for (const f of files){ photos.push(await readAsDataURL(f)); }
    renderThumbs();
  });

  /* ============== ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ© ============== */
  ;['dragenter','dragover'].forEach(ev=>{
    avatarDrop?.addEventListener(ev, e=>{ e.preventDefault(); avatarDrop.classList.add('is-over'); });
  });
  ;['dragleave','drop'].forEach(ev=>{
    avatarDrop?.addEventListener(ev, e=>{ e.preventDefault(); avatarDrop.classList.remove('is-over'); });
  });
  avatarDrop?.addEventListener('drop', async (e)=>{
    const file = (e.dataTransfer?.files||[])[0];
    if(!file || !file.type.startsWith('image/')) return toast('Ø§Ø®ØªØ± ØµÙˆØ±Ø© ØµØ­ÙŠØ­Ø©','warn');

    // ØªØ­Ù‚Ù‚ Ø¥Ø¬Ù…Ø§Ù„ÙŠ 5MB = (ØµÙˆØ± Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠØ© + avatar Ø§Ù„Ø¬Ø¯ÙŠØ¯)
    if (willExceedTotalLimit({ existingPhotos: photos, existingAvatar: '', newFiles: [file] })) {
      return toast('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙˆØ± Ø³ÙŠØªØ¬Ø§ÙˆØ² 5MB. Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ© Ø£ØµØºØ±.','warn');
    }

    avatar = await readAsDataURL(file);
    if (avatarPreview) avatarPreview.src = avatar;
  });
  pickAvatar?.addEventListener('click', ()=> avatarInput?.click());
  avatarInput?.addEventListener('change', async (e)=>{
    const f=e.target.files?.[0];
    if(!f || !f.type.startsWith('image/')) return toast('Ø§Ø®ØªØ± ØµÙˆØ±Ø© ØµØ­ÙŠØ­Ø©','warn');

    if (willExceedTotalLimit({ existingPhotos: photos, existingAvatar: '', newFiles: [f] })) {
      e.target.value = '';
      return toast('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙˆØ± Ø³ÙŠØªØ¬Ø§ÙˆØ² 5MB. Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ© Ø£ØµØºØ±.','warn');
    }

    avatar = await readAsDataURL(f);
    if (avatarPreview) avatarPreview.src = avatar;
  });

  /* ============== Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù (POST Ø£Ùˆ PATCH) ============== */
  form?.addEventListener('submit', async (e)=>{
    e.preventDefault();
     const totalB64 = currentGalleryBytes(photos) + currentAvatarBytes(avatar);
    if (totalB64 > MAX_TOTAL_BYTES) {
      e.preventDefault();
      return toast('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙˆØ± ÙŠØªØ¬Ø§ÙˆØ² 5MB â€” Ù‚Ù„Ù‘Ù„ Ø¹Ø¯Ø¯/Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±.','warn');
    }
    const fd = new FormData(form);
     const service = (fd.get('services')||'').toString().trim();
    const payload = {
      name:        (fd.get('name')||'').toString().trim(),
      email:       (fd.get('email')||'').toString().trim(),
      phone:       (fd.get('phone')||'').toString().trim(),
      region:      (fd.get('region')||'').toString().trim(),
      bio:         (fd.get('bio')||'').toString().trim(),
      companyName: (fd.get('companyName')||'').toString().trim(),
      services: service ? [service] : [],
      city:        (fd.get('city')||'').toString().trim(),
      description: (fd.get('description')||'').toString().trim(),
      videoUrl: (fd.get('videoUrl')||'').toString().trim(),   // â† Ø£Ø¶ÙÙ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
      avatar,
      photos,
      submitForReview: true
    };

    const url    = editingId ? ('/contractor/requests/' + editingId) : '/contractor/profile';
    const method = editingId ? 'PATCH' : 'POST';

    try{
      const res  = await fetch(url, { method, headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
      const json = await res.json().catch(()=>({ok:false}));
      if (json && json.ok){
        toast(editingId ? 'ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' : 'ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©','ok');
        editingId = null;
        renderRequests();
      } else {
        toast(json.msg || 'ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸','warn');
      }
    }catch(err){
      console.error(err); toast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„','warn');
    }
  });

  /* ============== Ø·Ù„Ø¨Ø§ØªÙŠ (ÙƒØ±ÙˆØª Ø¨Ø³ÙŠØ·Ø©) ============== */
  const reqList  = document.getElementById('requestsList');
  const reqEmpty = document.getElementById('requestsEmpty');
  let   _lastRequests = [];

  function badge(status){
    if (status === 'approved') return '<span class="pill" style="background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:.1rem .45rem;border-radius:999px">Ù…Ù‚Ø¨ÙˆÙ„</span>';
    if (status === 'rejected') return '<span class="pill" style="background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:.1rem .45rem;border-radius:999px">Ù…Ø±ÙÙˆØ¶</span>';
    return '<span class="pill" style="background:#fffbeb;border:1px solid #fde68a;color:#92400e;padding:.1rem .45rem;border-radius:999px">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>';
  }

  async function fetchMyRequests(){
    const res  = await fetch('/contractor/requests', { headers: {'Accept':'application/json'} });
    const json = await res.json();
    if (!json.ok) throw new Error(json.msg || 'fetch error');
    return json.data || [];
  }

  async function renderRequests(){
    if (!reqList) return;
    reqList.innerHTML = '';
    let rows = [];
    try { rows = await fetchMyRequests(); } catch { rows = []; }
    _lastRequests = rows;

    if (!rows.length){ if(reqEmpty) reqEmpty.hidden = false; return; }
    if (reqEmpty) reqEmpty.hidden = true;

    rows.forEach(doc=>{
      const card = document.createElement('article');
      card.className = 'card';
      card.style.display = 'grid';
      card.style.gridTemplateColumns = '72px 1fr auto';
      card.style.alignItems = 'center';
      card.style.gap = '.8rem';

      const av   = doc.avatar || '/assets/contractor-1.jpg';
      const title= doc.name || doc.companyName || 'â€”';
      const sub  = `${esc(doc.city||'â€”')} â€” ${esc(doc.region||'â€”')}`;

      const videoLink = doc.videoUrl
        ? `<a href="${esc(doc.videoUrl)}" target="_blank" rel="noopener" class="btn btn--outline btn--small" style="margin-inline-start:.4rem">Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</a>`
        : '';

      card.innerHTML = `
        <div style="width:72px;height:72px;border-radius:10px;overflow:hidden;border:1px solid #e5e7eb;background:#0b1a13">
          <img src="${av}" alt="" style="width:100%;height:100%;object-fit:cover">
        </div>
        <div>
          <div class="title" style="margin:0 0 .15rem 0">${esc(title)}</div>
          <div class="muted" style="font-size:.93rem">${sub}</div>
          <div style="margin-top:.35rem">${badge(doc.status)}${
            (doc.status==='rejected' && doc.reviewNote)
              ? `<span class="muted" style="margin-inline-start:.5rem">â€¢ Ø§Ù„Ø³Ø¨Ø¨: ${esc(doc.reviewNote)}</span>`
              : ''
          }${videoLink}</div>
        </div>
        <div style="display:flex;gap:.4rem;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn btn--ghost btn--sm" data-act="edit"   data-id="${doc._id}">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn btn--danger btn--sm" data-act="delete" data-id="${doc._id}">Ø­Ø°Ù</button>
        </div>
      `;
      reqList.appendChild(card);
    });
  }

  // Ø£Ø²Ø±Ø§Ø± ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù
  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act][data-id]'); if(!btn) return;
    const id  = btn.dataset.id;
    const act = btn.dataset.act;

    if (act === 'delete'){
      if (!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ')) return;
      try{
        const res  = await fetch('/contractor/requests/'+id, { method:'DELETE' });
        const json = await res.json().catch(()=>({ok:false}));
        if (json.ok){ toast('ØªÙ… Ø§Ù„Ø­Ø°Ù','ok'); renderRequests(); }
        else toast(json.msg || 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­Ø°Ù','warn');
      }catch(_){ toast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„','warn'); }
      return;
    }

    if (act === 'edit'){
      // Ù†Ù…Ù„Ø£ ÙÙˆØ±Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ù‚ÙŠÙ… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© + ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      const doc = _lastRequests.find(x=>x._id===id); if(!doc) return;
      editingId = id;
      const setVal = (sel,val)=>{ const el=form?.querySelector(sel); if(!el) return; el.value = (val||''); };
      setVal('[name="name"]'       , doc.name || '');
      setVal('[name="email"]'      , doc.email || '');
      setVal('[name="phone"]'      , doc.phone || '');
      setVal('[name="region"]'     , doc.region || '');
      setVal('[name="companyName"]', doc.companyName || '');
      const svcEl = form?.querySelector('[name="services"]');
if (svcEl) {
  const v = Array.isArray(doc.services) ? (doc.services[0] || '') : (doc.services || '');
  svcEl.value = v;
}

      setVal('[name="city"]'       , doc.city || '');
      setVal('[name="description"]', doc.description || '');
      setVal('[name="videoUrl"]'   , doc.videoUrl || '');             // â† NEW
      if (doc.avatar){ avatar = doc.avatar; if (avatarPreview) avatarPreview.src = avatar; }
      if (Array.isArray(doc.photos)){ photos.splice(0, photos.length, ...doc.photos); renderThumbs(); }

      // ÙØ¹Ù‘Ù„ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
      document.querySelectorAll('.menu__item').forEach(b=>b.classList.remove('is-active'));
      document.querySelector('.menu__item[data-view="profile"]')?.classList.add('is-active');
      Object.entries(views).forEach(([k,sec])=>sec?.classList.toggle('is-visible', k==='profile'));
      toast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙÙˆØ±Ù… â€” Ø¹Ø¯Ù‘Ù„ Ø«Ù… Ø§Ø­ÙØ¸','ok');
      return;
    }
  });

  /* ============== Ø®Ø±ÙˆØ¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ============== */
  const btnLogout = qs('#btnLogout');
  btnLogout?.addEventListener('click', ()=>{ window.location.href = '/logout'; });

  /* ============== ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ ============== */
  function init(){
    if (avatar && avatarPreview) avatarPreview.src = avatar;
    renderThumbs();
    renderRequests();
  }
 (async function contractorQuota(){
  const box = document.getElementById('contractorQuotaMsg') || document.createElement('div');
  box.id = 'contractorQuotaMsg';
  box.style.margin = '.5rem 0';
  const form = document.getElementById('contractorForm');
  if (form && !form.previousElementSibling?.id?.includes('contractorQuotaMsg')) {
    form.parentNode.insertBefore(box, form);
  }
  try{
    const r = await fetch('/contractor/quota', { headers:{'Accept':'application/json'}});
    const j = await r.json();
    if (!j.ok) throw 0;

    const { plan, limit, used, left, unlimited } = j.data;

    const limTxt = unlimited ? 'ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯' : String(limit);
    const lftTxt = unlimited ? 'ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯' : String(left);

    // Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·Ø© ÙÙŠ DOM
    box.innerHTML = `<small>Ø®Ø·ØªÙƒ: <b>${plan}</b> â€¢ Ø§Ù„Ù…Ø³Ù…ÙˆØ­: <b>${limTxt}</b> â€¢ Ø§Ù„Ù…ÙØ³ØªØ®Ø¯Ù…: <b>${used}</b> â€¢ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <b>${lftTxt}</b></small>`;

    // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø¹Ù†ØµØ± ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø®Ø·Ø© ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©:
    const planEl = document.querySelector('#planText');
    if (planEl) planEl.textContent = plan;

    const submitBtn = form?.querySelector('button[type="submit"]');
    if (submitBtn) {
      if (!unlimited && Number(left) <= 0) {
        submitBtn.disabled = true;
        submitBtn.title = 'Ø¨Ù„ØºØª Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ ÙÙŠ Ø®Ø·ØªÙƒ';
      } else {
        submitBtn.disabled = false;
        submitBtn.title = '';
      }
    }
  }catch{
    box.innerHTML = `<small class="muted">ØªØ¹Ø°Ù‘Ø± Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­ØµÙ‘Ø©.</small>`;
  }
})();


  init();
  
})();
</script>
<script>
(() => {
  const form = document.getElementById('contractorSubscribeForm');
  if (!form) return;

  const ADMIN_WA_PREMIUM = '+21620353915';
  const ADMIN_WA_VIP     = '+21620353915';

  function isValidWa(num){
    const n = (num||'').toString().trim().replace(/\s+/g,'');
    return /^\+?\d{6,15}$/.test(n);
  }
  function waLink(to, text){
    const num = to.replace(/\D/g,'');
    return `https://wa.me/${num}?text=${encodeURIComponent(text)}`;
  }
  function toastOk(msg){ const t=document.createElement('div'); t.className='toast toast--ok'; t.textContent=msg; document.getElementById('toasts').appendChild(t); setTimeout(()=>t.remove(),2200); }
  function toastWarn(msg){ const t=document.createElement('div'); t.className='toast toast--warn'; t.textContent=msg; document.getElementById('toasts').appendChild(t); setTimeout(()=>t.remove(),2200); }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd    = new FormData(form);
    const plan  = (fd.get('plan')||'Premium').toString();
    const name  = (fd.get('name')||'').toString().trim();
    const wa    = (fd.get('whatsapp')||'').toString().trim();
    const notes = (fd.get('notes')||'').toString().trim();

    if (!name){ return toastWarn('Ø§Ù…Ù„Ø£ Ø§Ù„Ø§Ø³Ù…'); }
    if (!isValidWa(wa)){ return toastWarn('Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­'); }

    const to   = plan === 'VIP' ? ADMIN_WA_VIP : ADMIN_WA_PREMIUM;
    const msg  = [
      'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¥Ø¯Ø§Ø±Ø© Farmers ğŸ‘‹',
      `Ø·Ù„Ø¨ Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„`,
      `Ø§Ù„Ø®Ø·Ø©: ${plan}`,
      `Ø§Ù„Ø§Ø³Ù…: ${name}`,
      `ÙˆØ§ØªØ³Ø§Ø¨: ${wa}`,
      notes ? `Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${notes}` : null,
      'Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒÙ….'
    ].filter(Boolean).join('\n');

    // Ø®Ø²Ù‘Ù† Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ù„ÙŠØ¸Ù‡Ø± Ù„Ù„Ø£Ø¯Ù…Ù†
    try{
      const res  = await fetch('/contractor/subscriptions', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ plan, name, whatsapp: wa, notes })
      });
      const json = await res.json().catch(()=>({ok:false}));
      if (!json.ok) toastWarn(json.msg || 'ØªØ¹Ø°Ù‘Ø± Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…');
      else toastOk('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…');
    }catch(err){
      console.warn(err);
      toastWarn('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± â€” Ø³ÙŠØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ù„Ù‰ Ø£ÙŠ Ø­Ø§Ù„');
    }

    // Ø§ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨
    window.open(waLink(to, msg), '_blank', 'noopener');
  });
})();
</script>

</body>
</html>
